DOMPurify.setConfig({FORBID_TAGS:["img","svg","script","style"],FORBID_ATTR:["onerror","onclick","onload"]});function safeHTML(n){return DOMPurify.sanitize(n,{ALLOWED_TAGS:["br","span","i"],ALLOWED_ATTR:["class"]})}let supabaseClient=window.supabaseClient||null;async function ensureSupabaseClient(){if(supabaseClient)return supabaseClient;if(window.supabaseReady&&await window.supabaseReady,supabaseClient=window.supabaseClient||null,!supabaseClient)throw new Error("Supabase client is not available");return supabaseClient}const RECAPTCHA_REQUIRED_AT=3;let recaptchaWidgetId=null,recaptchaScriptPromise=null,recaptchaLastInitError="";function setRecaptchaInitError(n){recaptchaLastInitError=String(n||"").trim()}function getRecaptchaInitError(){return recaptchaLastInitError}function getRecaptchaSiteKey(){var o;const n=String(((o=window.WOLF_RECAPTCHA_PUBLIC_CONFIG)==null?void 0:o.siteKey)||"").trim();return!n||n.includes("__WOLF_RECAPTCHA_SITE_KEY__")?"":n}function getRecaptchaClient(){return window.grecaptcha&&typeof window.grecaptcha.getResponse=="function"?window.grecaptcha:window.grecaptcha&&window.grecaptcha.enterprise&&typeof window.grecaptcha.enterprise.getResponse=="function"?window.grecaptcha.enterprise:null}function getRecaptchaRenderClient(){return window.grecaptcha&&typeof window.grecaptcha.render=="function"?window.grecaptcha:window.grecaptcha&&window.grecaptcha.enterprise&&typeof window.grecaptcha.enterprise.render=="function"?window.grecaptcha.enterprise:null}async function waitForRecaptchaRenderClient(n=4e3){const o=Date.now();for(;Date.now()-o<n;){const i=getRecaptchaRenderClient();if(i)return i;await new Promise(d=>setTimeout(d,60))}return null}function loadRecaptchaScriptOnce(){return recaptchaScriptPromise||(recaptchaScriptPromise=new Promise((n,o)=>{if(typeof window.grecaptcha!="undefined")return n(!0);const i=document.createElement("script");i.src="https://www.google.com/recaptcha/api.js?render=explicit",i.async=!0,i.defer=!0,i.onload=()=>n(!0),i.onerror=()=>o(new Error("Failed to load reCAPTCHA script")),document.head.appendChild(i)}),recaptchaScriptPromise)}async function ensureRecaptchaRendered(){const n=document.getElementById("recaptchaWrap"),o=document.getElementById("recaptchaWidget");if(!n||!o)return setRecaptchaInitError("reCAPTCHA container is missing in DOM."),!1;const i=getRecaptchaSiteKey();if(!i)return n.hidden=!0,setRecaptchaInitError("Missing PUBLIC_RECAPTCHA_SITE_KEY in build env."),!1;try{await loadRecaptchaScriptOnce()}catch(w){return n.hidden=!0,setRecaptchaInitError((w==null?void 0:w.message)||"Failed to load reCAPTCHA script."),!1}if(getRecaptchaResponseToken())return setRecaptchaInitError(""),n.hidden=!0,!0;const p=await waitForRecaptchaRenderClient(4500);if(!p)return n.hidden=!0,setRecaptchaInitError("reCAPTCHA API loaded without render() function."),!1;if(recaptchaWidgetId==null)try{recaptchaWidgetId=p.render(o,{sitekey:i,theme:"dark",callback:()=>{n.hidden=!0,setRecaptchaInitError("")},"expired-callback":()=>{n.hidden=!1},"error-callback":()=>{n.hidden=!1,setRecaptchaInitError("reCAPTCHA encountered a client error.")}})}catch(w){return n.hidden=!0,setRecaptchaInitError((w==null?void 0:w.message)||"reCAPTCHA render failed."),!1}return setRecaptchaInitError(""),n.hidden=!1,!0}function getRecaptchaResponseToken(){const n=getRecaptchaClient();return recaptchaWidgetId==null||!n?"":String(n.getResponse(recaptchaWidgetId)||"").trim()}function resetRecaptcha(){const n=getRecaptchaClient();if(!(recaptchaWidgetId==null||!n))try{n.reset(recaptchaWidgetId)}catch(o){}}function getRecaptchaRequiredAt(){var o;const n=Number((o=window.WOLF_RECAPTCHA_PUBLIC_CONFIG)==null?void 0:o.requiredAt);return Number.isFinite(n)?Math.max(0,Math.floor(n)):RECAPTCHA_REQUIRED_AT}async function verifyRecaptchaToken(n){const o=await fetch("/.netlify/functions/verify-recaptcha",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:n})});if(!o.ok){let i=null;try{i=await o.json()}catch(d){i=null}return{ok:!1,payload:i}}return{ok:!0,payload:null}}const MAX_ATTEMPTS=5,LOGIN_LOCKOUT_MINUTES=5,OTP_CLICK_SPAM_WINDOW_MS=1e3,OTP_CLICK_SPAM_THRESHOLD=3,OTP_CLICK_SPAM_LOCK_SECONDS=30,OTP_COOLDOWN_STORAGE_KEY="wolf_otp_cooldown_ends_at",REMEMBER_DEVICE_KEY="wolf_remember_device",QUICK_LOGIN_QR_CACHE_KEY="wolf_quick_login_qr_cache",QUICK_LOGIN_POLL_MS=1800,QUICK_LOGIN_EXPIRE_FALLBACK_SECONDS=120,QUICK_LOGIN_REGEN_COOLDOWN_FALLBACK_SECONDS=8,WOLF_ADMIN_EMAILS=new Set(["adrianangeles2212@gmail.com","ktorrazo123@gmail.com"]),WOLF_STAFF_EMAILS=new Set(["adrianangeles2213@gmail.com"]),typewriterWords=["Beyond Strength","Beyond Limit","Wolf Palomar","Secure. Reliable. Fast."];function normalizeRoleEmail(n){return String(n||"").trim().toLowerCase()}function resolveRoleFromUser(n){var d;const o=normalizeRoleEmail(n==null?void 0:n.email);if(!o)return null;if(WOLF_ADMIN_EMAILS.has(o))return"admin";if(WOLF_STAFF_EMAILS.has(o))return"staff";const i=String(((d=n==null?void 0:n.app_metadata)==null?void 0:d.role)||"").trim().toLowerCase();return i==="admin"||i==="staff"?i:null}let wordIdx=0,charIdx=0,isDeleting=!1;function typeCarousel(){const n=document.getElementById("typewriterText");if(!n)return;const o=typewriterWords[wordIdx];let i=o.substring(0,charIdx);if(i.includes(" ")){const p=i.split(" ");n.innerHTML=safeHTML(`${p[0]} <br> <span>${p[1]}</span>`)}else n.innerHTML=i;let d=isDeleting?50:150;!isDeleting&&charIdx===o.length?(d=3e3,isDeleting=!0):isDeleting&&charIdx===0&&(isDeleting=!1,wordIdx=(wordIdx+1)%typewriterWords.length,d=500),isDeleting?charIdx--:charIdx++,setTimeout(typeCarousel,d)}let loginTimerInterval=null,loginOutputHideTimer=null,loginOutputHideAnimationTimer=null;const resetOutputHideTimers=new WeakMap,resetOutputHideAnimationTimers=new WeakMap;async function getClientIP(){try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch(n){return"unknown_device"}}function isConnectivityAuthError(n){const o=String((n==null?void 0:n.name)||"").toLowerCase(),i=String((n==null?void 0:n.message)||"").toLowerCase(),d=Number(n==null?void 0:n.status),p=Number.isFinite(d);return typeof navigator!="undefined"&&navigator.onLine===!1||p&&d===0||p&&d>=502&&d<=504?!0:o.includes("fetch")||i.includes("failed to fetch")||i.includes("fetch failed")||i.includes("networkerror")||i.includes("network error")||i.includes("network request failed")||i.includes("gateway")||i.includes("service unavailable")||i.includes("timed out")}function isRememberDeviceEnabled(){var n;try{return(n=window.wolfAuthStorage)!=null&&n.shouldRememberDevice?!!window.wolfAuthStorage.shouldRememberDevice():window.localStorage.getItem(REMEMBER_DEVICE_KEY)==="1"}catch(o){return!1}}function setRememberDeviceEnabled(n){var o;try{if((o=window.wolfAuthStorage)!=null&&o.setRememberDevice){window.wolfAuthStorage.setRememberDevice(!!n);return}n?window.localStorage.setItem(REMEMBER_DEVICE_KEY,"1"):window.localStorage.removeItem(REMEMBER_DEVICE_KEY)}catch(i){}}function shakeField(n){n&&(n.classList.remove("shake-error"),n.offsetWidth,n.classList.add("shake-error"),setTimeout(()=>{n.classList.remove("shake-error")},420))}function hideLoginOutput(n=!1){const o=document.getElementById("loginOutput");if(o){if(loginOutputHideTimer&&(clearTimeout(loginOutputHideTimer),loginOutputHideTimer=null),loginOutputHideAnimationTimer&&(clearTimeout(loginOutputHideAnimationTimer),loginOutputHideAnimationTimer=null),n){o.classList.remove("is-entering","is-hiding","is-visible"),o.textContent="";return}o.classList.remove("is-entering"),o.classList.add("is-hiding"),loginOutputHideAnimationTimer=setTimeout(()=>{o.classList.remove("is-hiding","is-visible"),o.textContent="",loginOutputHideAnimationTimer=null},220)}}function showLoginOutput(n,{color:o="var(--wolf-red)",html:i=!1,autoHide:d=!0,duration:p=5e3,animate:w=!0}={}){const u=document.getElementById("loginOutput");u&&(loginOutputHideTimer&&(clearTimeout(loginOutputHideTimer),loginOutputHideTimer=null),loginOutputHideAnimationTimer&&(clearTimeout(loginOutputHideAnimationTimer),loginOutputHideAnimationTimer=null),u.style.color=o,u.classList.remove("is-hiding"),i?u.innerHTML=n:u.textContent=n,w?(u.classList.remove("is-visible","is-entering"),u.offsetWidth,u.classList.add("is-visible","is-entering"),setTimeout(()=>{u.classList.remove("is-entering")},260)):(u.classList.remove("is-entering"),u.classList.add("is-visible")),d&&(loginOutputHideTimer=setTimeout(()=>{hideLoginOutput(!1),loginOutputHideTimer=null},p)))}function getResetOutputElement(n=null){if(n)return n;const o=document.querySelector("#recoveryStep1 #resetOutput"),i=document.querySelector("#recoveryStep2 #resetOutput");return i&&i.offsetParent!==null?i:o||i||document.getElementById("resetOutput")}function clearResetOutputTimers(n){const o=resetOutputHideTimers.get(n);o&&(clearTimeout(o),resetOutputHideTimers.delete(n));const i=resetOutputHideAnimationTimers.get(n);i&&(clearTimeout(i),resetOutputHideAnimationTimers.delete(n))}function hideResetOutput({immediate:n=!1,targetEl:o=null}={}){const i=getResetOutputElement(o);if(!i)return;if(clearResetOutputTimers(i),n){i.classList.remove("is-entering","is-hiding","is-visible"),i.textContent="";return}i.classList.remove("is-entering"),i.classList.add("is-hiding");const d=setTimeout(()=>{i.classList.remove("is-hiding","is-visible"),i.textContent="",resetOutputHideAnimationTimers.delete(i)},220);resetOutputHideAnimationTimers.set(i,d)}function showResetOutput(n,{color:o="var(--wolf-red)",autoHide:i=!1,duration:d=5e3,animate:p=!0,targetEl:w=null}={}){const u=getResetOutputElement(w);if(u){if(clearResetOutputTimers(u),u.style.color=o,u.classList.remove("is-hiding"),u.textContent=n,p){u.classList.remove("is-visible","is-entering"),u.offsetWidth,u.classList.add("is-visible","is-entering");const v=setTimeout(()=>{u.classList.remove("is-entering"),resetOutputHideAnimationTimers.delete(u)},260);resetOutputHideAnimationTimers.set(u,v)}else u.classList.remove("is-entering"),u.classList.add("is-visible");if(i){const v=setTimeout(()=>{hideResetOutput({immediate:!1,targetEl:u}),resetOutputHideTimers.delete(u)},d);resetOutputHideTimers.set(u,v)}}}function startLoginCountdown(n){loginTimerInterval&&clearInterval(loginTimerInterval);const o=document.getElementById("loginBtn"),i=p=>{if(p<=0){o.disabled=!1,o.textContent="AUTHORIZE ACCESS",hideLoginOutput(!0),clearInterval(loginTimerInterval);return}o.disabled=!0;const w=Math.floor(p/60),u=p%60;o.textContent=`LOCKED: ${w}m ${u}s`,showLoginOutput("[ERR_403] Security protocol active. Terminal locked.",{color:"var(--wolf-red)",autoHide:!1,animate:!1})};let d=n;i(d),loginTimerInterval=setInterval(()=>{d--,i(d)},1e3)}async function getLoginAttemptState(n){await ensureSupabaseClient();const o=String(n||"").trim();if(!o||o==="unknown_device")return{attempts:0,locked:!1,remainingSeconds:0};const{data:i}=await supabaseClient.from("login_attempts").select("*").eq("ip_address",o).maybeSingle();if(!i)return{attempts:0,locked:!1,remainingSeconds:0};const d=(Date.now()-new Date(i.last_attempt_at).getTime())/6e4;if(d>=LOGIN_LOCKOUT_MINUTES)return await supabaseClient.from("login_attempts").delete().eq("ip_address",o),{attempts:0,locked:!1,remainingSeconds:0};if(i.attempts>=MAX_ATTEMPTS){const p=Math.ceil((LOGIN_LOCKOUT_MINUTES-d)*60);return{attempts:Number(i.attempts||0),locked:!0,remainingSeconds:p}}return{attempts:Number(i.attempts||0),locked:!1,remainingSeconds:0}}async function checkLoginLockoutStatus(n=null,{enforceCaptcha:o=!1}={}){const i=document.getElementById("loginBtn"),d=document.getElementById("recaptchaWrap"),p=String(n||"").trim()||await getClientIP(),w=await getLoginAttemptState(p);if(w.locked){const I=Number(w.remainingSeconds)||LOGIN_LOCKOUT_MINUTES*60;return startLoginCountdown(I),!0}i&&i.textContent.startsWith("LOCKED:")&&(i.disabled=!1,i.textContent="AUTHORIZE ACCESS",hideLoginOutput(!0));const u=getRecaptchaRequiredAt();if(!(!!getRecaptchaSiteKey()&&(u<=0||w.attempts>=Math.max(0,u-1))))return d&&(d.hidden=!0),resetRecaptcha(),!1;let R=!1;try{R=await ensureRecaptchaRendered()}catch(I){R=!1}if(!R){if(o){const I=getRecaptchaInitError();return showLoginOutput(I?`[ERR_503] CAPTCHA_UNAVAILABLE: ${I}`:"[ERR_503] CAPTCHA_UNAVAILABLE: Verification module failed to initialize.",{color:"var(--wolf-red)"}),window.wolfAudio&&window.wolfAudio.play("error"),i&&(i.disabled=!1,i.textContent="AUTHORIZE ACCESS"),!0}return!1}if(!o)return!1;const O=getRecaptchaResponseToken();return O?(await verifyRecaptchaToken(O)).ok?!1:(d&&(d.hidden=!1),showLoginOutput("[ERR_403] CAPTCHA_FAILED: Verification denied. Please try again.",{color:"var(--wolf-red)"}),window.wolfAudio&&window.wolfAudio.play("denied"),resetRecaptcha(),i&&(i.disabled=!1,i.textContent="AUTHORIZE ACCESS"),!0):(showLoginOutput("[ERR_402] CAPTCHA_REQUIRED: Please complete the verification challenge.",{color:"var(--wolf-red)"}),window.wolfAudio&&window.wolfAudio.play("denied"),i&&(i.disabled=!1,i.textContent="AUTHORIZE ACCESS"),!0)}document.addEventListener("DOMContentLoaded",async()=>{try{await ensureSupabaseClient()}catch(e){showLoginOutput("[ERR_503] Secure database handshake failed. Try again later.");return}const n=document.getElementById("flipCardInner"),o=document.getElementById("recoveryContainer"),i=document.getElementById("confirmExitModal"),d=document.querySelector(".auth-split-container");let p=null,w=0,u=[],v=null,M=null,R=null,O=0,k=null,I=!1;const C=document.getElementById("quickLoginModal"),J=document.getElementById("quickLoginLaunch"),W=document.getElementById("quickLoginClose"),G=document.getElementById("quickLoginBackdrop"),E=document.getElementById("quickLoginRefresh"),N=document.getElementById("quickLoginStatus"),x=document.getElementById("quickLoginRef"),B=document.getElementById("quickLoginTimer"),T=document.getElementById("quickLoginQrCanvas");setTimeout(()=>{d.classList.add("is-ready"),window.wolfAudio&&window.wolfAudio.play("notif")},100),typeCarousel();async function X(){const e=document.querySelector(".flip-card");d.classList.add("auth-verifying"),showLoginOutput(safeHTML("<i class='bx bx-loader-alt bx-spin'></i> LOGIN SUCCESSFUL. INITIATING SYSTEM..."),{color:"var(--wolf-blue)",html:!0,autoHide:!1}),window.wolfAudio&&window.wolfAudio.play("notif"),setTimeout(async()=>{window.WOLF_IS_ANIMATING_OUT=!0;const t=await getClientIP();await supabaseClient.from("login_attempts").delete().eq("ip_address",t),window.wolfAudio&&(wolfAudio.play("woosh"),wolfAudio.play("success")),d&&d.classList.add("outro"),e&&e.classList.add("outro"),showLoginOutput(safeHTML("<i class='bx bx-check-shield'></i> ACCESS GRANTED. BOOTING SYSTEM..."),{color:"#4ade80",html:!0,autoHide:!1}),window.triggerStarWarp&&window.triggerStarWarp(),setTimeout(()=>{window.wolfRouter&&typeof window.wolfRouter.goToMain=="function"?window.wolfRouter.goToMain("dashboard",{replace:!0,seamless:!0}):window.location.replace("/pages/main.html")},5e3)},1200)}function L(e,t="info"){N&&(N.textContent=e,N.classList.remove("is-error","is-success"),t==="error"&&N.classList.add("is-error"),t==="success"&&N.classList.add("is-success"))}function D(){v&&(clearInterval(v),v=null),M&&(clearInterval(M),M=null)}function oe(){try{const e=localStorage.getItem(QUICK_LOGIN_QR_CACHE_KEY);if(!e)return null;const t=JSON.parse(e);return!t||typeof t!="object"?null:t}catch(e){return null}}function K(){try{localStorage.removeItem(QUICK_LOGIN_QR_CACHE_KEY)}catch(e){}}function re(){const e=oe();if(!e)return null;const t=e.expiresAt?new Date(e.expiresAt).getTime():0;return t>0&&t<=Date.now()?(K(),null):e}function ae(e){try{localStorage.setItem(QUICK_LOGIN_QR_CACHE_KEY,JSON.stringify(e))}catch(t){}}function P(e,t="bx bx-refresh"){E&&(E.innerHTML=`<i class="${t}"></i><span>${e}</span>`)}function Y(e=!0){R&&(clearInterval(R),R=null),O=0,E&&(I||(E.disabled=!1),e&&P("Regenerate QR","bx bx-refresh"))}function ee(e){const t=Math.max(0,Number(e||0));if(t<=0){Y(!0);return}R&&(clearInterval(R),R=null),O=Date.now()+t*1e3;const r=()=>{const a=Math.max(0,Math.ceil((O-Date.now())/1e3));if(E){if(a<=0){Y(!0);return}E.disabled=!0,P(`Regenerate in ${a}s`,"bx bx-time-five")}};r(),R=setInterval(r,1e3)}function se(e){const t=Date.now()+QUICK_LOGIN_EXPIRE_FALLBACK_SECONDS*1e3,r=e?new Date(e).getTime():t,a=()=>{const s=Math.max(0,Math.ceil((r-Date.now())/1e3));B&&(B.textContent=`${s}s`),s<=0&&(D(),L("QR session expired. Regenerate to continue.","error"))};a(),M=setInterval(a,1e3)}async function le(e){var g;if(!T)return;T.classList.remove("is-ready");const t=window.matchMedia("(max-width: 640px)").matches?300:340;if((g=window.QRCode)!=null&&g.toCanvas){await window.QRCode.toCanvas(T,e,{width:t,margin:1,errorCorrectionLevel:"L",color:{dark:"#0f1012",light:"#ffffff"}}),T.classList.add("is-ready");return}if(typeof window.qrcode!="function")throw new Error("QR renderer is not available. Reload and try again.");const r=window.qrcode(0,"M");r.addData(String(e||"")),r.make();const a=T.getContext("2d");if(!a)throw new Error("QR canvas context is unavailable");const s=t,l=6,f=r.getModuleCount(),c=s-l*2;T.width=s,T.height=s,a.imageSmoothingEnabled=!1,a.clearRect(0,0,s,s),a.fillStyle="#ffffff",a.fillRect(0,0,s,s),a.fillStyle="#0f1012";for(let m=0;m<f;m++)for(let y=0;y<f;y++){if(!r.isDark(m,y))continue;const S=l+Math.floor(y*c/f),U=l+Math.floor(m*c/f),Z=Math.ceil((y+1)*c/f)-Math.floor(y*c/f),Q=Math.ceil((m+1)*c/f)-Math.floor(m*c/f);a.fillRect(S,U,Z,Q)}T.classList.add("is-ready")}async function te(e=!1){if(!(!C||I)){I=!0;try{E&&(E.disabled=!0,P("Generating...","bx bx-loader-alt bx-spin")),L("Generating one-time QR session...","info"),D();const t=re(),r=(t==null?void 0:t.previewContext)||null,a=(t==null?void 0:t.previewSig)||null,s=await fetch("/.netlify/functions/quick-login-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({forceNew:!!e,cachedPreviewContext:r,cachedPreviewSig:a})});let l={};try{l=await s.json()}catch(m){l={}}if(!s.ok){if(s.status===429){const m=Number(l.remainingTime||0);m>0&&ee(m)}throw new Error(l.error||"Unable to create quick login request")}let f=l.qrValue,c=l.previewContext||null,g=l.previewSig||null;(!c||!g)&&t&&t.requestId===l.requestId&&t.qrValue&&(f=t.qrValue,c=t.previewContext||c,g=t.previewSig||g),k={...l,qrValue:f,previewContext:c,previewSig:g},x&&(x.textContent=String(l.requestId||"---").slice(0,8).toUpperCase()),await le(f),c&&g&&ae({requestId:l.requestId,qrValue:f,expiresAt:l.expiresAt,previewContext:c,previewSig:g}),se(l.expiresAt),L(l.reusedPending?"Resumed pending QR session on this device.":"Waiting for secure approval from trusted device..."),ee(Number(l.regenerateRemainingSeconds||l.regenerateCooldownSeconds||QUICK_LOGIN_REGEN_COOLDOWN_FALLBACK_SECONDS)),ce()}catch(t){const r=H(t,String((t==null?void 0:t.message)||t));L(r||"[ERR_500] SYSTEM_FAULT: Quick-login setup failed.","error"),x&&(x.textContent="---"),B&&(B.textContent="--s")}finally{if(I=!1,!E||O>Date.now())return;E.disabled=!1,P("Regenerate QR","bx bx-refresh")}}}async function ne(){if(!(!k||I))try{const e=await fetch("/.netlify/functions/quick-login-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requestId:k.requestId,requestSecret:k.requestSecret,consume:!0})});let t={};try{t=await e.json()}catch(l){t={}}if(!e.ok){if(e.status===404||e.status===410){D(),L("Quick-login request expired. Regenerate QR.","error");return}throw new Error(t.error||"Failed to verify quick-login status")}if(t.status==="pending")return;if(t.status==="expired"||t.status==="rejected"||t.status==="consumed"){D(),K(),L(t.status==="consumed"?"Quick-login code already used. Regenerate QR.":"Quick-login request was not approved.","error");return}if(t.status!=="approved")return;D(),K(),L("Approval received. Synchronizing secure session...","success");const{data:r,error:a}=await supabaseClient.auth.setSession({access_token:t.accessToken,refresh_token:t.refreshToken});if(a)throw new Error(a.message||"Unable to restore quick-login session");const s=r==null?void 0:r.user;if(!s||resolveRoleFromUser(s)!=="admin")throw await supabaseClient.auth.signOut(),new Error("Quick-login approval requires an admin account");window.wolfAudio&&window.wolfAudio.play("success"),setTimeout(()=>{C&&(C.classList.remove("is-open"),C.setAttribute("aria-hidden","true")),X()},550)}catch(e){const t=H(e,String((e==null?void 0:e.message)||e));L(t||"[ERR_500] SYSTEM_FAULT: Quick-login polling failed.","error")}}function ce(){v&&clearInterval(v),v=setInterval(ne,QUICK_LOGIN_POLL_MS),ne()}function $(){C&&(C.classList.remove("is-open"),C.setAttribute("aria-hidden","true"),D(),Y(!0),k=null,T&&T.classList.remove("is-ready"),x&&(x.textContent="---"),B&&(B.textContent="--s"),L("Initializing secure QR channel..."))}function ue(){C&&(C.classList.add("is-open"),C.setAttribute("aria-hidden","false"),te(!1))}function de(){!C||!J||(J.addEventListener("click",e=>{e.preventDefault(),ue()}),W==null||W.addEventListener("click",$),G==null||G.addEventListener("click",$),E==null||E.addEventListener("click",async()=>{await te(!0)}),document.addEventListener("keydown",e=>{e.key==="Escape"&&C.classList.contains("is-open")&&$()}))}function q(){p&&(clearInterval(p),p=null),u=[],b=!1;const e=document.getElementById("recoveryStep2");e&&e.remove(),o.classList.remove("step1-exit","step2-enter"),hideResetOutput({immediate:!0}),hideLoginOutput(!0);const t=document.getElementById("otpForm");t&&t.reset();const r=document.getElementById("forgotEmail");r&&(r.value="");const a=document.getElementById("sendOtpBtn"),s=document.getElementById("resendOtpBtn"),l=A();l>0?h(l):(a&&(a.disabled=!1,a.style.pointerEvents="auto",a.style.opacity="1",a.setAttribute("aria-disabled","false"),a.textContent="SEND SECURITY OTP"),s&&(s.style.pointerEvents="auto",s.style.opacity="1",s.textContent="RESEND SECURITY CODE"));const f=document.getElementById("resetBtn");f&&(f.disabled=!1,f.textContent="RESTORE SYSTEM ACCESS"),document.querySelectorAll(".otp-field").forEach(m=>{m.value=""});const g=document.getElementById("newPassword");g&&(g.value=""),i&&(i.style.display="none"),n.classList.remove("flipped")}async function fe(){const e=document.getElementById("loginBtn"),t=document.getElementById("loginAgreement"),r=document.getElementById("rememberDevice");if(!e.disabled){e.disabled=!0,e.textContent="AUTHORIZING...",hideLoginOutput(!0);try{if(t&&!t.checked){showLoginOutput("[ERR_003] AGREE_FAILED: Please agree to the data security policy to continue.",{color:"var(--wolf-red)"}),window.wolfAudio&&window.wolfAudio.play("denied"),e.disabled=!1,e.textContent="AUTHORIZE ACCESS";return}const a=await getClientIP();if(await checkLoginLockoutStatus(a,{enforceCaptcha:!0}))return;const l=document.getElementById("email").value,f=document.getElementById("password").value;setRememberDeviceEnabled(!!(r!=null&&r.checked));const{data:c,error:g}=await supabaseClient.auth.signInWithPassword({email:l,password:f});if(g){if(isConnectivityAuthError(g)){showLoginOutput("[ERR_521] LINK_OFFLINE: Security gateway is unreachable. Check internet connection.",{color:"var(--wolf-red)"}),window.wolfAudio&&window.wolfAudio.play("error"),e.disabled=!1,e.textContent="AUTHORIZE ACCESS";return}shakeField(document.getElementById("password")),wolfAudio.play("denied");const{data:m}=await supabaseClient.from("login_attempts").select("*").eq("ip_address",a).maybeSingle();let y=1;m&&(y=(Date.now()-new Date(m.last_attempt_at).getTime())/6e4<LOGIN_LOCKOUT_MINUTES?m.attempts+1:1),await supabaseClient.from("login_attempts").upsert({ip_address:a,attempts:y,last_attempt_at:new Date().toISOString()}),y>=MAX_ATTEMPTS?startLoginCountdown(LOGIN_LOCKOUT_MINUTES*60):(showLoginOutput(`[ERR_101] Access denied. ${MAX_ATTEMPTS-y} attempts left.`,{color:"var(--wolf-red)"}),document.getElementById("password").value="",e.disabled=!1,e.textContent="AUTHORIZE ACCESS")}else resolveRoleFromUser(c==null?void 0:c.user)?await X():(wolfAudio.play("error"),showLoginOutput("[ERR_102] ACCESS_DENIED: Account is not authorized."),await supabaseClient.auth.signOut(),e.disabled=!1,e.textContent="AUTHORIZE ACCESS")}catch(a){showLoginOutput("[ERR_500] System Fault."),window.wolfAudio&&window.wolfAudio.play("error"),window.Swal.fire({title:"[ERR_500] TERMINAL_FAULT",html:`<div style="color:var(--wolf-red); font-size:4rem; margin-bottom:15px;"><i class='bx bx-error-alt'></i></div>
               <p style="color:#888; font-size:14px;">CRITICAL_ERROR: ${a.message}</p>`,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-red",title:"wolf-swal-title",confirmButton:"btn-wolf-red"},confirmButtonText:"RE-INITIALIZE"}),e.disabled=!1}}}checkLoginLockoutStatus(),de();const j=document.getElementById("loginAgreement");j&&j.addEventListener("change",()=>{var e;j.checked&&(((e=document.getElementById("loginOutput"))==null?void 0:e.textContent)||"").includes("Please agree to the data security policy")&&hideLoginOutput(!0)});const F=document.getElementById("rememberDevice");F&&(F.checked=isRememberDeviceEnabled(),F.addEventListener("change",()=>{setRememberDeviceEnabled(!!F.checked)}));function me(){try{const e=localStorage.getItem(OTP_COOLDOWN_STORAGE_KEY);if(!e)return 0;const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}catch(e){return 0}}function z(e){try{if(!Number.isFinite(e)||e<=Date.now()){localStorage.removeItem(OTP_COOLDOWN_STORAGE_KEY);return}localStorage.setItem(OTP_COOLDOWN_STORAGE_KEY,String(Math.ceil(e)))}catch(t){}}function A(){const e=Date.now(),t=me(),r=Math.max(w||0,t||0);return!r||r<=e?(w=0,z(0),0):(w=r,Math.max(0,Math.ceil((r-e)/1e3)))}function _(e){return`Wait for ${Math.max(0,Math.ceil(Number(e||0)))}s to resend code`}function ge(e){return/^\[ERR_[A-Z0-9_]+\]/i.test(String(e||"").trim())}function H(e,t=""){if(!e||typeof e!="object")return String(t||"").trim();const r=String(e.error||e.message||"").trim();if(ge(r))return r;const a=String(e.errorCode||"").trim(),s=String(e.errorLabel||"").trim();if(a&&s){const l=r||String(e.errorMeaning||"").trim()||t;return`[ERR_${a}] ${s}: ${String(l||"").trim()}`}return r||String(t||"").trim()}function h(e){p&&clearInterval(p);const t=Math.max(0,Number(e||0));w=t>0?Date.now()+t*1e3:0,z(w);const r=s=>{const l=document.getElementById("sendOtpBtn"),f=document.getElementById("resendOtpBtn"),c=s>0?_(s):null;l&&(l.disabled=s>0,l.style.pointerEvents=s>0?"none":"auto",l.style.opacity=s>0?"0.65":"1",l.setAttribute("aria-disabled",s>0?"true":"false"),l.textContent=c||"SEND SECURITY OTP"),f&&(f.style.pointerEvents=s>0?"none":"auto",f.style.opacity=s>0?"0.5":"1",f.textContent=c||"RESEND SECURITY CODE"),s<=0&&(w=0,z(0))};let a=t;r(a),p=setInterval(()=>{a--,r(a),a<=0&&clearInterval(p)},1e3)}async function V(){try{const e=await fetch("/.netlify/functions/check-otp-cooldown",{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)return A();const t=await e.json();return(t==null?void 0:t.canSend)===!1?Number(t.remainingTime||0):0}catch(e){return A()}}async function pe(e=0){try{const r=await(await fetch("pages/verifyotp.html")).text(),a=DOMPurify.sanitize(r,{ALLOWED_TAGS:["div","p","form","input","button","a","span","i"],ALLOWED_ATTR:["id","class","type","placeholder","required","maxlength","inputmode","pattern","title","href","style"]}),f=new DOMParser().parseFromString(a,"text/html").getElementById("recoveryStep2");f&&(o.appendChild(f),o.classList.add("step1-exit"),setTimeout(async()=>{o.classList.add("step2-enter"),ye(),we();const c=A();let g=0;c<=0&&(g=await V());const m=Math.max(Number(e||0),c,g);m>0&&h(m)},50))}catch(t){showResetOutput("[ERR_500] Failed to load verification module.")}}let b=!1;async function ie(){var l;const e=A();if(e>0){h(e),showResetOutput(`[ERR_429] ${_(e)}.`,{color:"var(--wolf-red)",autoHide:!1});return}const t=Date.now();if(u=u.filter(f=>t-f<=OTP_CLICK_SPAM_WINDOW_MS),u.push(t),u.length>=OTP_CLICK_SPAM_THRESHOLD){u=[],h(OTP_CLICK_SPAM_LOCK_SECONDS),showResetOutput(`[ERR_429] ${_(OTP_CLICK_SPAM_LOCK_SECONDS)}.`,{color:"var(--wolf-red)",autoHide:!1}),b=!1;return}if(b)return;const r=document.getElementById("sendOtpBtn"),a=document.getElementById("resendOtpBtn");b=!0,showResetOutput("Establishing connection to server...",{color:"#888",autoHide:!1}),r&&(r.disabled=!0,r.textContent="TRANSMITTING..."),a&&(a.style.pointerEvents="none",a.style.opacity="0.5",a.textContent="RESENDING OTP CODES TO EMAIL...");const s=((l=document.getElementById("forgotEmail"))==null?void 0:l.value)||"";try{const f=A();if(f>0){h(f),showResetOutput(`[ERR_429] ${_(f)}.`,{color:"var(--wolf-red)",autoHide:!1}),b=!1;return}const c=await V();if(c>0){h(c),showResetOutput(`[ERR_429] ${_(c)}.`,{color:"var(--wolf-red)",autoHide:!1}),b=!1;return}showResetOutput("Checking existing email...",{color:"#888",autoHide:!1});const g=await fetch("/.netlify/functions/request-otp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s})});if(g.ok){let m={};try{m=await g.json()}catch(U){m={}}const y=Number((m==null?void 0:m.remainingTime)||0),S=Number.isFinite(y)&&y>0?y:60;h(S),wolfAudio.play("notif"),showResetOutput("Your OTP key has been sent to your email.",{color:"#4ade80",autoHide:!1}),document.getElementById("recoveryStep2")||await pe(S)}else{let m=null,y="",S=0;try{m=await g.json(),y=H(m,"Server error while requesting OTP."),S=Number((m==null?void 0:m.remainingTime)||0)}catch(U){}if(wolfAudio.play("error"),g.status===404)S>0&&h(S),showResetOutput(y||"[ERR_404] RESOURCE_MISSING: Email unauthorized.");else if(g.status===429){const Z=String(y||"").includes("OTP cooldown active")?30:60,Q=S>0?S:Z;h(Q),showResetOutput(`[ERR_429] ${_(Q)}.`,{color:"var(--wolf-red)",autoHide:!1})}else g.status===400?showResetOutput(y||"[ERR_400] REQUEST_INVALID: Invalid request."):showResetOutput(y||"[ERR_500] SYSTEM_FAULT: Server error while requesting OTP.");b=!1,g.status!==429&&S<=0&&(r&&(r.disabled=!1,r.textContent="SEND SECURITY OTP"),a&&(a.style.pointerEvents="auto",a.style.opacity="1",a.textContent="RESEND SECURITY CODE"))}}catch(f){const c=A();c>0?(h(c),showResetOutput(`[ERR_429] ${_(c)}.`,{color:"var(--wolf-red)",autoHide:!1})):showResetOutput("[ERR_503] Gateway timeout. Terminal offline."),b=!1,c<=0&&(r&&(r.disabled=!1,r.style.pointerEvents="auto",r.style.opacity="1",r.setAttribute("aria-disabled","false"),r.textContent="SEND SECURITY OTP"),a&&(a.style.pointerEvents="auto",a.style.opacity="1",a.textContent="RESEND SECURITY CODE"))}finally{setTimeout(()=>{b=!1},1e3)}}function we(){const e=document.getElementById("verifyResetForm"),t=document.getElementById("recoveryStep2");if(!e||!t)return;const r=t.querySelector("#resetOutput");e.onsubmit=async a=>{a.preventDefault();const s=e.querySelector('button[type="submit"]');s.disabled=!0,s.textContent="RECONFIGURING...",showResetOutput("Verifying OTP Code Credential...",{color:"#888",autoHide:!1,targetEl:r});const l=document.getElementById("forgotEmail").value,f=document.getElementById("newPassword").value,c=Array.from(document.querySelectorAll(".otp-field")).map(g=>g.value).join("");try{const g=await fetch("/.netlify/functions/verify-otp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:l,otp:c,newPassword:f})});if(g.ok)wolfAudio.play("success"),showResetOutput("Protocol success. Password updated.",{color:"#4ade80",autoHide:!1,targetEl:r}),window.wolfAudio&&window.wolfAudio.play("success"),window.Swal.fire({title:"SUCCESS",html:`<div style="color:#08ea1b; font-size:4rem; margin-bottom:15px;"><i class='bx bx-check-shield'></i></div>
               <p style="color:#888; font-size:14px;">Credentials re-mapped successfully. Terminal access granted.</p>`,background:"#111",timer:3e3,timerProgressBar:!0,showConfirmButton:!1,customClass:{popup:"wolf-swal-popup wolf-border-green",title:"wolf-swal-title"},didClose:()=>{q()}});else{let m=null;try{m=await g.json()}catch(S){m=null}wolfAudio.play("denied");const y=H(m,"Security key invalid or expired.");showResetOutput(y||"[ERR_602] KEY_EXPIRED: Security key invalid or expired.",{targetEl:r}),s.disabled=!1,s.textContent="RESTORE SYSTEM ACCESS"}}catch(g){wolfAudio.play("error"),s.disabled=!1,showResetOutput("[ERR_500] Database synchronization fault.",{targetEl:r})}}}(async()=>{const e=A();e>0&&h(e);const t=await V(),r=Math.max(e,Number(t||0));r>0&&h(r)})(),document.getElementById("loginForm").onsubmit=e=>{e.preventDefault(),fe()},document.getElementById("otpForm").onsubmit=e=>{e.preventDefault();const t=A();if(t>0){h(t),showResetOutput(`[ERR_429] ${_(t)}.`,{color:"var(--wolf-red)",autoHide:!1});return}ie("sendOtpBtn")},document.getElementById("forgotLink").onclick=e=>{e.preventDefault(),n.classList.add("flipped")},document.addEventListener("click",e=>{e.target.id==="forgotLink"&&(e.preventDefault(),document.getElementById("flipCardInner").classList.add("flipped")),(e.target.id==="resendOtpBtn"||e.target.closest("#resendOtpBtn"))&&(e.preventDefault(),console.log("Wolf OS: Resend requested..."),ie()),(e.target.id==="backToLoginTrigger"||e.target.id==="backToLoginTriggerSecondary")&&(e.preventDefault(),document.getElementById("recoveryStep2")?(window.wolfAudio&&window.wolfAudio.play("notif"),window.Swal.fire({title:"ABANDON RECOVERY?",html:`<div style="color:#b47023; font-size:4rem; margin-bottom:15px;"><i class='bx bx-shield-quarter'></i></div>
               <p style="color:#888; font-size:14px;">Terminating handshake will void the current security key. Proceed?</p>`,showCancelButton:!0,confirmButtonText:"YES, EXIT",cancelButtonText:"STAY",reverseButtons:!0,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-orange",title:"wolf-swal-title",confirmButton:"btn-wolf-orange",cancelButton:"btn-wolf-secondary"}}).then(t=>{t.isConfirmed&&q()})):n.classList.remove("flipped"))}),document.getElementById("confirmExitBtn").onclick=()=>{i.style.display="none",q()},document.getElementById("cancelExitBtn").onclick=()=>i.style.display="none",document.getElementById("closeModalBtn").onclick=()=>q(),document.getElementById("descContainer").onclick=function(){this.classList.toggle("expanded")};function ye(){const e=document.querySelectorAll(".otp-field");e.forEach((t,r)=>{t.oninput=a=>{t.value=t.value.replace(/[^0-9]/g,""),t.value&&r<5&&e[r+1].focus()},t.onkeydown=a=>{a.key==="Backspace"&&!t.value&&r>0&&e[r-1].focus()},t.onpaste=a=>{a.preventDefault();const l=(a.clipboardData||window.clipboardData).getData("text").replace(/[^0-9]/g,"");for(let c=0;c<l.length&&r+c<e.length;c++)e[r+c].value=l[c];const f=Math.min(r+l.length,5);e[f].focus()}})}});
