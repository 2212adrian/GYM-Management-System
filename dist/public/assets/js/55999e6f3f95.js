DOMPurify.setConfig({FORBID_TAGS:["img","svg","script","style"],FORBID_ATTR:["onerror","onclick","onload"]});function safeHTML(o){return DOMPurify.sanitize(o,{ALLOWED_TAGS:["br","span","i"],ALLOWED_ATTR:["class"]})}let supabaseClient=window.supabaseClient||null;async function ensureSupabaseClient(){if(supabaseClient)return supabaseClient;if(window.supabaseReady&&await window.supabaseReady,supabaseClient=window.supabaseClient||null,!supabaseClient)throw new Error("Supabase client is not available");return supabaseClient}const MAX_ATTEMPTS=5,LOGIN_LOCKOUT_MINUTES=5,OTP_CLICK_SPAM_WINDOW_MS=1e3,OTP_CLICK_SPAM_THRESHOLD=3,OTP_CLICK_SPAM_LOCK_SECONDS=30,OTP_COOLDOWN_STORAGE_KEY="wolf_otp_cooldown_ends_at",REMEMBER_DEVICE_KEY="wolf_remember_device",QUICK_LOGIN_QR_CACHE_KEY="wolf_quick_login_qr_cache",QUICK_LOGIN_POLL_MS=1800,QUICK_LOGIN_EXPIRE_FALLBACK_SECONDS=120,QUICK_LOGIN_REGEN_COOLDOWN_FALLBACK_SECONDS=8,typewriterWords=["Beyond Strength","Beyond Limit","Wolf Palomar","Secure. Reliable. Fast."];let wordIdx=0,charIdx=0,isDeleting=!1;function typeCarousel(){const o=document.getElementById("typewriterText");if(!o)return;const a=typewriterWords[wordIdx];let l=a.substring(0,charIdx);if(l.includes(" ")){const w=l.split(" ");o.innerHTML=safeHTML(`${w[0]} <br> <span>${w[1]}</span>`)}else o.innerHTML=l;let p=isDeleting?50:150;!isDeleting&&charIdx===a.length?(p=3e3,isDeleting=!0):isDeleting&&charIdx===0&&(isDeleting=!1,wordIdx=(wordIdx+1)%typewriterWords.length,p=500),isDeleting?charIdx--:charIdx++,setTimeout(typeCarousel,p)}let loginTimerInterval=null,loginOutputHideTimer=null,loginOutputHideAnimationTimer=null;const resetOutputHideTimers=new WeakMap,resetOutputHideAnimationTimers=new WeakMap;async function getClientIP(){try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch(o){return"unknown_device"}}function isRememberDeviceEnabled(){var o;try{return(o=window.wolfAuthStorage)!=null&&o.shouldRememberDevice?!!window.wolfAuthStorage.shouldRememberDevice():window.localStorage.getItem(REMEMBER_DEVICE_KEY)==="1"}catch(a){return!1}}function setRememberDeviceEnabled(o){var a;try{if((a=window.wolfAuthStorage)!=null&&a.setRememberDevice){window.wolfAuthStorage.setRememberDevice(!!o);return}o?window.localStorage.setItem(REMEMBER_DEVICE_KEY,"1"):window.localStorage.removeItem(REMEMBER_DEVICE_KEY)}catch(l){}}function shakeField(o){o&&(o.classList.remove("shake-error"),o.offsetWidth,o.classList.add("shake-error"),setTimeout(()=>{o.classList.remove("shake-error")},420))}function hideLoginOutput(o=!1){const a=document.getElementById("loginOutput");if(a){if(loginOutputHideTimer&&(clearTimeout(loginOutputHideTimer),loginOutputHideTimer=null),loginOutputHideAnimationTimer&&(clearTimeout(loginOutputHideAnimationTimer),loginOutputHideAnimationTimer=null),o){a.classList.remove("is-entering","is-hiding","is-visible"),a.textContent="";return}a.classList.remove("is-entering"),a.classList.add("is-hiding"),loginOutputHideAnimationTimer=setTimeout(()=>{a.classList.remove("is-hiding","is-visible"),a.textContent="",loginOutputHideAnimationTimer=null},220)}}function showLoginOutput(o,{color:a="var(--wolf-red)",html:l=!1,autoHide:p=!0,duration:w=5e3,animate:h=!0}={}){const d=document.getElementById("loginOutput");d&&(loginOutputHideTimer&&(clearTimeout(loginOutputHideTimer),loginOutputHideTimer=null),loginOutputHideAnimationTimer&&(clearTimeout(loginOutputHideAnimationTimer),loginOutputHideAnimationTimer=null),d.style.color=a,d.classList.remove("is-hiding"),l?d.innerHTML=o:d.textContent=o,h?(d.classList.remove("is-visible","is-entering"),d.offsetWidth,d.classList.add("is-visible","is-entering"),setTimeout(()=>{d.classList.remove("is-entering")},260)):(d.classList.remove("is-entering"),d.classList.add("is-visible")),p&&(loginOutputHideTimer=setTimeout(()=>{hideLoginOutput(!1),loginOutputHideTimer=null},w)))}function getResetOutputElement(o=null){if(o)return o;const a=document.querySelector("#recoveryStep1 #resetOutput"),l=document.querySelector("#recoveryStep2 #resetOutput");return l&&l.offsetParent!==null?l:a||l||document.getElementById("resetOutput")}function clearResetOutputTimers(o){const a=resetOutputHideTimers.get(o);a&&(clearTimeout(a),resetOutputHideTimers.delete(o));const l=resetOutputHideAnimationTimers.get(o);l&&(clearTimeout(l),resetOutputHideAnimationTimers.delete(o))}function hideResetOutput({immediate:o=!1,targetEl:a=null}={}){const l=getResetOutputElement(a);if(!l)return;if(clearResetOutputTimers(l),o){l.classList.remove("is-entering","is-hiding","is-visible"),l.textContent="";return}l.classList.remove("is-entering"),l.classList.add("is-hiding");const p=setTimeout(()=>{l.classList.remove("is-hiding","is-visible"),l.textContent="",resetOutputHideAnimationTimers.delete(l)},220);resetOutputHideAnimationTimers.set(l,p)}function showResetOutput(o,{color:a="var(--wolf-red)",autoHide:l=!1,duration:p=5e3,animate:w=!0,targetEl:h=null}={}){const d=getResetOutputElement(h);if(d){if(clearResetOutputTimers(d),d.style.color=a,d.classList.remove("is-hiding"),d.textContent=o,w){d.classList.remove("is-visible","is-entering"),d.offsetWidth,d.classList.add("is-visible","is-entering");const C=setTimeout(()=>{d.classList.remove("is-entering"),resetOutputHideAnimationTimers.delete(d)},260);resetOutputHideAnimationTimers.set(d,C)}else d.classList.remove("is-entering"),d.classList.add("is-visible");if(l){const C=setTimeout(()=>{hideResetOutput({immediate:!1,targetEl:d}),resetOutputHideTimers.delete(d)},p);resetOutputHideTimers.set(d,C)}}}function startLoginCountdown(o){loginTimerInterval&&clearInterval(loginTimerInterval);const a=document.getElementById("loginBtn"),l=w=>{if(w<=0){a.disabled=!1,a.textContent="AUTHORIZE ACCESS",hideLoginOutput(!0),clearInterval(loginTimerInterval);return}a.disabled=!0;const h=Math.floor(w/60),d=w%60;a.textContent=`LOCKED: ${h}m ${d}s`,showLoginOutput("[ERR_403] Security protocol active. Terminal locked.",{color:"var(--wolf-red)",autoHide:!1,animate:!1})};let p=o;l(p),loginTimerInterval=setInterval(()=>{p--,l(p)},1e3)}async function checkLoginLockoutStatus(){await ensureSupabaseClient();const o=await getClientIP(),{data:a}=await supabaseClient.from("login_attempts").select("*").eq("ip_address",o).maybeSingle();if(a){const l=(Date.now()-new Date(a.last_attempt_at).getTime())/6e4;if(a.attempts>=MAX_ATTEMPTS&&l<LOGIN_LOCKOUT_MINUTES){const p=Math.ceil((LOGIN_LOCKOUT_MINUTES-l)*60);return startLoginCountdown(p),!0}else l>=LOGIN_LOCKOUT_MINUTES&&await supabaseClient.from("login_attempts").delete().eq("ip_address",o)}return!1}document.addEventListener("DOMContentLoaded",async()=>{try{await ensureSupabaseClient()}catch(e){showLoginOutput("[ERR_503] Secure database handshake failed. Try again later.");return}const o=document.getElementById("flipCardInner"),a=document.getElementById("recoveryContainer"),l=document.getElementById("confirmExitModal"),p=document.querySelector(".auth-split-container");let w=null,h=0,d=[],C=null,M=null,O=null,q=0,A=null,B=!1;const S=document.getElementById("quickLoginModal"),V=document.getElementById("quickLoginLaunch"),U=document.getElementById("quickLoginClose"),G=document.getElementById("quickLoginBackdrop"),E=document.getElementById("quickLoginRefresh"),D=document.getElementById("quickLoginStatus"),x=document.getElementById("quickLoginRef"),k=document.getElementById("quickLoginTimer"),I=document.getElementById("quickLoginQrCanvas");setTimeout(()=>{p.classList.add("is-ready"),window.wolfAudio&&window.wolfAudio.play("notif")},100),typeCarousel();async function Z(){const e=document.querySelector(".flip-card");p.classList.add("auth-verifying"),showLoginOutput(safeHTML("<i class='bx bx-loader-alt bx-spin'></i> LOGIN SUCCESSFUL. INITIATING SYSTEM..."),{color:"var(--wolf-blue)",html:!0,autoHide:!1}),window.wolfAudio&&window.wolfAudio.play("notif"),setTimeout(async()=>{window.WOLF_IS_ANIMATING_OUT=!0;const t=await getClientIP();await supabaseClient.from("login_attempts").delete().eq("ip_address",t),window.wolfAudio&&(wolfAudio.play("woosh"),wolfAudio.play("success")),p&&p.classList.add("outro"),e&&e.classList.add("outro"),showLoginOutput(safeHTML("<i class='bx bx-check-shield'></i> ACCESS GRANTED. BOOTING SYSTEM..."),{color:"#4ade80",html:!0,autoHide:!1}),window.triggerStarWarp&&window.triggerStarWarp(),setTimeout(()=>{window.wolfRouter&&typeof window.wolfRouter.goToMain=="function"?window.wolfRouter.goToMain("dashboard",{replace:!0,seamless:!0}):window.location.replace("/pages/main.html")},5e3)},1200)}function R(e,t="info"){D&&(D.textContent=e,D.classList.remove("is-error","is-success"),t==="error"&&D.classList.add("is-error"),t==="success"&&D.classList.add("is-success"))}function _(){C&&(clearInterval(C),C=null),M&&(clearInterval(M),M=null)}function ne(){try{const e=localStorage.getItem(QUICK_LOGIN_QR_CACHE_KEY);if(!e)return null;const t=JSON.parse(e);return!t||typeof t!="object"?null:t}catch(e){return null}}function W(){try{localStorage.removeItem(QUICK_LOGIN_QR_CACHE_KEY)}catch(e){}}function ie(){const e=ne();if(!e)return null;const t=e.expiresAt?new Date(e.expiresAt).getTime():0;return t>0&&t<=Date.now()?(W(),null):e}function oe(e){try{localStorage.setItem(QUICK_LOGIN_QR_CACHE_KEY,JSON.stringify(e))}catch(t){}}function N(e,t="bx bx-refresh"){E&&(E.innerHTML=`<i class="${t}"></i><span>${e}</span>`)}function $(e=!0){O&&(clearInterval(O),O=null),q=0,E&&(B||(E.disabled=!1),e&&N("Regenerate QR","bx bx-refresh"))}function J(e){const t=Math.max(0,Number(e||0));if(t<=0){$(!0);return}O&&(clearInterval(O),O=null),q=Date.now()+t*1e3;const n=()=>{const i=Math.max(0,Math.ceil((q-Date.now())/1e3));if(E){if(i<=0){$(!0);return}E.disabled=!0,N(`Regenerate in ${i}s`,"bx bx-time-five")}};n(),O=setInterval(n,1e3)}function se(e){const t=Date.now()+QUICK_LOGIN_EXPIRE_FALLBACK_SECONDS*1e3,n=e?new Date(e).getTime():t,i=()=>{const r=Math.max(0,Math.ceil((n-Date.now())/1e3));k&&(k.textContent=`${r}s`),r<=0&&(_(),R("QR session expired. Regenerate to continue.","error"))};i(),M=setInterval(i,1e3)}async function re(e){var f;if(!I)return;I.classList.remove("is-ready");const t=window.matchMedia("(max-width: 640px)").matches?300:340;if((f=window.QRCode)!=null&&f.toCanvas){await window.QRCode.toCanvas(I,e,{width:t,margin:1,errorCorrectionLevel:"L",color:{dark:"#0f1012",light:"#ffffff"}}),I.classList.add("is-ready");return}if(typeof window.qrcode!="function")throw new Error("QR renderer is not available. Reload and try again.");const n=window.qrcode(0,"M");n.addData(String(e||"")),n.make();const i=I.getContext("2d");if(!i)throw new Error("QR canvas context is unavailable");const r=t,s=6,c=n.getModuleCount(),u=r-s*2;I.width=r,I.height=r,i.imageSmoothingEnabled=!1,i.clearRect(0,0,r,r),i.fillStyle="#ffffff",i.fillRect(0,0,r,r),i.fillStyle="#0f1012";for(let m=0;m<c;m++)for(let g=0;g<c;g++){if(!n.isDark(m,g))continue;const y=s+Math.floor(g*u/c),F=s+Math.floor(m*u/c),H=Math.ceil((g+1)*u/c)-Math.floor(g*u/c),pe=Math.ceil((m+1)*u/c)-Math.floor(m*u/c);i.fillRect(y,F,H,pe)}I.classList.add("is-ready")}async function X(e=!1){if(!(!S||B)){B=!0;try{E&&(E.disabled=!0,N("Generating...","bx bx-loader-alt bx-spin")),R("Generating one-time QR session...","info"),_();const t=ie(),n=(t==null?void 0:t.previewContext)||null,i=(t==null?void 0:t.previewSig)||null,r=await fetch("/.netlify/functions/quick-login-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({forceNew:!!e,cachedPreviewContext:n,cachedPreviewSig:i})});let s={};try{s=await r.json()}catch(m){s={}}if(!r.ok){if(r.status===429){const m=Number(s.remainingTime||0);m>0&&J(m)}throw new Error(s.error||"Unable to create quick login request")}let c=s.qrValue,u=s.previewContext||null,f=s.previewSig||null;(!u||!f)&&t&&t.requestId===s.requestId&&t.qrValue&&(c=t.qrValue,u=t.previewContext||u,f=t.previewSig||f),A={...s,qrValue:c,previewContext:u,previewSig:f},x&&(x.textContent=String(s.requestId||"---").slice(0,8).toUpperCase()),await re(c),u&&f&&oe({requestId:s.requestId,qrValue:c,expiresAt:s.expiresAt,previewContext:u,previewSig:f}),se(s.expiresAt),R(s.reusedPending?"Resumed pending QR session on this device.":"Waiting for secure approval from trusted device..."),J(Number(s.regenerateRemainingSeconds||s.regenerateCooldownSeconds||QUICK_LOGIN_REGEN_COOLDOWN_FALLBACK_SECONDS)),ae()}catch(t){R(`[ERR_QL1] ${t.message}`,"error"),x&&(x.textContent="---"),k&&(k.textContent="--s")}finally{if(B=!1,!E||q>Date.now())return;E.disabled=!1,N("Regenerate QR","bx bx-refresh")}}}async function ee(){var e;if(!(!A||B))try{const t=await fetch("/.netlify/functions/quick-login-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requestId:A.requestId,requestSecret:A.requestSecret,consume:!0})});let n={};try{n=await t.json()}catch(c){n={}}if(!t.ok){if(t.status===404||t.status===410){_(),R("Quick-login request expired. Regenerate QR.","error");return}throw new Error(n.error||"Failed to verify quick-login status")}if(n.status==="pending")return;if(n.status==="expired"||n.status==="rejected"||n.status==="consumed"){_(),W(),R(n.status==="consumed"?"Quick-login code already used. Regenerate QR.":"Quick-login request was not approved.","error");return}if(n.status!=="approved")return;_(),W(),R("Approval received. Synchronizing secure session...","success");const{data:i,error:r}=await supabaseClient.auth.setSession({access_token:n.accessToken,refresh_token:n.refreshToken});if(r)throw new Error(r.message||"Unable to restore quick-login session");const s=i==null?void 0:i.user;if(!s||((e=s.user_metadata)==null?void 0:e.role)!=="admin")throw await supabaseClient.auth.signOut(),new Error("Quick-login approved by a non-admin account");window.wolfAudio&&window.wolfAudio.play("success"),setTimeout(()=>{S&&(S.classList.remove("is-open"),S.setAttribute("aria-hidden","true")),Z()},550)}catch(t){R(`[ERR_QL2] ${t.message}`,"error")}}function ae(){C&&clearInterval(C),C=setInterval(ee,QUICK_LOGIN_POLL_MS),ee()}function Y(){S&&(S.classList.remove("is-open"),S.setAttribute("aria-hidden","true"),_(),$(!0),A=null,I&&I.classList.remove("is-ready"),x&&(x.textContent="---"),k&&(k.textContent="--s"),R("Initializing secure QR channel..."))}function le(){S&&(S.classList.add("is-open"),S.setAttribute("aria-hidden","false"),X(!1))}function ce(){!S||!V||(V.addEventListener("click",e=>{e.preventDefault(),le()}),U==null||U.addEventListener("click",Y),G==null||G.addEventListener("click",Y),E==null||E.addEventListener("click",async()=>{await X(!0)}),document.addEventListener("keydown",e=>{e.key==="Escape"&&S.classList.contains("is-open")&&Y()}))}function P(){w&&(clearInterval(w),w=null),d=[],T=!1;const e=document.getElementById("recoveryStep2");e&&e.remove(),a.classList.remove("step1-exit","step2-enter"),hideResetOutput({immediate:!0}),hideLoginOutput(!0);const t=document.getElementById("otpForm");t&&t.reset();const n=document.getElementById("forgotEmail");n&&(n.value="");const i=document.getElementById("sendOtpBtn"),r=document.getElementById("resendOtpBtn"),s=L();s>0?v(s):(i&&(i.disabled=!1,i.style.pointerEvents="auto",i.style.opacity="1",i.setAttribute("aria-disabled","false"),i.textContent="SEND SECURITY OTP"),r&&(r.style.pointerEvents="auto",r.style.opacity="1",r.textContent="RESEND SECURITY CODE"));const c=document.getElementById("resetBtn");c&&(c.disabled=!1,c.textContent="RESTORE SYSTEM ACCESS"),document.querySelectorAll(".otp-field").forEach(m=>{m.value=""});const f=document.getElementById("newPassword");f&&(f.value=""),l&&(l.style.display="none"),o.classList.remove("flipped")}async function ue(){const e=document.getElementById("loginBtn"),t=document.getElementById("loginAgreement"),n=document.getElementById("rememberDevice");if(!e.disabled){e.disabled=!0,e.textContent="AUTHORIZING...",hideLoginOutput(!0);try{if(t&&!t.checked){showLoginOutput("[ERR_105] Please agree to the data security policy to continue.",{color:"var(--wolf-red)"}),window.wolfAudio&&window.wolfAudio.play("denied"),e.disabled=!1,e.textContent="AUTHORIZE ACCESS";return}const i=await getClientIP();if(await checkLoginLockoutStatus())return;const s=document.getElementById("email").value,c=document.getElementById("password").value;setRememberDeviceEnabled(!!(n!=null&&n.checked));const{data:u,error:f}=await supabaseClient.auth.signInWithPassword({email:s,password:c});if(f){shakeField(document.getElementById("password")),wolfAudio.play("denied");const{data:m}=await supabaseClient.from("login_attempts").select("*").eq("ip_address",i).maybeSingle();let g=1;m&&(g=(Date.now()-new Date(m.last_attempt_at).getTime())/6e4<LOGIN_LOCKOUT_MINUTES?m.attempts+1:1),await supabaseClient.from("login_attempts").upsert({ip_address:i,attempts:g,last_attempt_at:new Date().toISOString()}),g>=MAX_ATTEMPTS?startLoginCountdown(LOGIN_LOCKOUT_MINUTES*60):(showLoginOutput(`[ERR_101] Access denied. ${MAX_ATTEMPTS-g} attempts left.`,{color:"var(--wolf-red)"}),document.getElementById("password").value="",e.disabled=!1,e.textContent="AUTHORIZE ACCESS")}else u.user.user_metadata.role==="admin"?await Z():(wolfAudio.play("error"),showLoginOutput("[ERR_102] Unauthorized role."),await supabaseClient.auth.signOut(),e.disabled=!1,e.textContent="AUTHORIZE ACCESS")}catch(i){showLoginOutput("[ERR_500] System Fault."),window.wolfAudio&&window.wolfAudio.play("error"),window.Swal.fire({title:"[ERR_500] TERMINAL_FAULT",html:`<div style="color:var(--wolf-red); font-size:4rem; margin-bottom:15px;"><i class='bx bx-error-alt'></i></div>
               <p style="color:#888; font-size:14px;">CRITICAL_ERROR: ${i.message}</p>`,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-red",title:"wolf-swal-title",confirmButton:"btn-wolf-red"},confirmButtonText:"RE-INITIALIZE"}),e.disabled=!1}}}checkLoginLockoutStatus(),ce();const j=document.getElementById("loginAgreement");j&&j.addEventListener("change",()=>{var e;j.checked&&(((e=document.getElementById("loginOutput"))==null?void 0:e.textContent)||"").includes("Please agree to the data security policy")&&hideLoginOutput(!0)});const Q=document.getElementById("rememberDevice");Q&&(Q.checked=isRememberDeviceEnabled(),Q.addEventListener("change",()=>{setRememberDeviceEnabled(!!Q.checked)}));function de(){try{const e=localStorage.getItem(OTP_COOLDOWN_STORAGE_KEY);if(!e)return 0;const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}catch(e){return 0}}function z(e){try{if(!Number.isFinite(e)||e<=Date.now()){localStorage.removeItem(OTP_COOLDOWN_STORAGE_KEY);return}localStorage.setItem(OTP_COOLDOWN_STORAGE_KEY,String(Math.ceil(e)))}catch(t){}}function L(){const e=Date.now(),t=de(),n=Math.max(h||0,t||0);return!n||n<=e?(h=0,z(0),0):(h=n,Math.max(0,Math.ceil((n-e)/1e3)))}function b(e){return`Wait for ${Math.max(0,Math.ceil(Number(e||0)))}s to resend code`}function v(e){w&&clearInterval(w);const t=Math.max(0,Number(e||0));h=t>0?Date.now()+t*1e3:0,z(h);const n=r=>{const s=document.getElementById("sendOtpBtn"),c=document.getElementById("resendOtpBtn"),u=r>0?b(r):null;s&&(s.disabled=r>0,s.style.pointerEvents=r>0?"none":"auto",s.style.opacity=r>0?"0.65":"1",s.setAttribute("aria-disabled",r>0?"true":"false"),s.textContent=u||"SEND SECURITY OTP"),c&&(c.style.pointerEvents=r>0?"none":"auto",c.style.opacity=r>0?"0.5":"1",c.textContent=u||"RESEND SECURITY CODE"),r<=0&&(h=0,z(0))};let i=t;n(i),w=setInterval(()=>{i--,n(i),i<=0&&clearInterval(w)},1e3)}async function K(){try{const e=await fetch("/.netlify/functions/check-otp-cooldown",{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)return L();const t=await e.json();return(t==null?void 0:t.canSend)===!1?Number(t.remainingTime||0):0}catch(e){return L()}}async function fe(e=0){try{const n=await(await fetch("pages/verifyotp.html")).text(),i=DOMPurify.sanitize(n,{ALLOWED_TAGS:["div","p","form","input","button","a","span","i"],ALLOWED_ATTR:["id","class","type","placeholder","required","maxlength","inputmode","pattern","title","href","style"]}),c=new DOMParser().parseFromString(i,"text/html").getElementById("recoveryStep2");c&&(a.appendChild(c),a.classList.add("step1-exit"),setTimeout(async()=>{a.classList.add("step2-enter"),ge(),me();const u=L();let f=0;u<=0&&(f=await K());const m=Math.max(Number(e||0),u,f);m>0&&v(m)},50))}catch(t){showResetOutput("[ERR_500] Failed to load verification module.")}}let T=!1;async function te(){var s;const e=L();if(e>0){v(e),showResetOutput(`[ERR_429] ${b(e)}.`,{color:"var(--wolf-red)",autoHide:!1});return}const t=Date.now();if(d=d.filter(c=>t-c<=OTP_CLICK_SPAM_WINDOW_MS),d.push(t),d.length>=OTP_CLICK_SPAM_THRESHOLD){d=[],v(OTP_CLICK_SPAM_LOCK_SECONDS),showResetOutput(`[ERR_429] ${b(OTP_CLICK_SPAM_LOCK_SECONDS)}.`,{color:"var(--wolf-red)",autoHide:!1}),T=!1;return}if(T)return;const n=document.getElementById("sendOtpBtn"),i=document.getElementById("resendOtpBtn");T=!0,showResetOutput("Establishing connection to server...",{color:"#888",autoHide:!1}),n&&(n.disabled=!0,n.textContent="TRANSMITTING..."),i&&(i.style.pointerEvents="none",i.style.opacity="0.5",i.textContent="RESENDING OTP CODES TO EMAIL...");const r=((s=document.getElementById("forgotEmail"))==null?void 0:s.value)||"";try{const c=L();if(c>0){v(c),showResetOutput(`[ERR_429] ${b(c)}.`,{color:"var(--wolf-red)",autoHide:!1}),T=!1;return}const u=await K();if(u>0){v(u),showResetOutput(`[ERR_429] ${b(u)}.`,{color:"var(--wolf-red)",autoHide:!1}),T=!1;return}showResetOutput("Checking existing email...",{color:"#888",autoHide:!1});const f=await fetch("/.netlify/functions/request-otp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r})});if(f.ok){let m={};try{m=await f.json()}catch(F){m={}}const g=Number((m==null?void 0:m.remainingTime)||0),y=Number.isFinite(g)&&g>0?g:60;v(y),wolfAudio.play("notif"),showResetOutput("Your OTP key has been sent to your email.",{color:"#4ade80",autoHide:!1}),document.getElementById("recoveryStep2")||await fe(y)}else{let m="",g=0;try{const y=await f.json();m=(y==null?void 0:y.error)||"",g=Number((y==null?void 0:y.remainingTime)||0)}catch(y){}if(wolfAudio.play("error"),f.status===404)g>0&&v(g),showResetOutput("[ERR_401] Identification failed. Email unauthorized.");else if(f.status===429){const F=String(m||"").includes("OTP cooldown active")?30:60,H=g>0?g:F;v(H),showResetOutput(`[ERR_429] ${b(H)}.`,{color:"var(--wolf-red)",autoHide:!1})}else f.status===400?showResetOutput(`[ERR_400] ${m||"Invalid request."}`):showResetOutput(`[ERR_500] ${m||"Server error while requesting OTP."}`);T=!1,f.status!==429&&g<=0&&(n&&(n.disabled=!1,n.textContent="SEND SECURITY OTP"),i&&(i.style.pointerEvents="auto",i.style.opacity="1",i.textContent="RESEND SECURITY CODE"))}}catch(c){const u=L();u>0?(v(u),showResetOutput(`[ERR_429] ${b(u)}.`,{color:"var(--wolf-red)",autoHide:!1})):showResetOutput("[ERR_503] Gateway timeout. Terminal offline."),T=!1,u<=0&&(n&&(n.disabled=!1,n.style.pointerEvents="auto",n.style.opacity="1",n.setAttribute("aria-disabled","false"),n.textContent="SEND SECURITY OTP"),i&&(i.style.pointerEvents="auto",i.style.opacity="1",i.textContent="RESEND SECURITY CODE"))}finally{setTimeout(()=>{T=!1},1e3)}}function me(){const e=document.getElementById("verifyResetForm"),t=document.getElementById("recoveryStep2");if(!e||!t)return;const n=t.querySelector("#resetOutput");e.onsubmit=async i=>{i.preventDefault();const r=e.querySelector('button[type="submit"]');r.disabled=!0,r.textContent="RECONFIGURING...",showResetOutput("Verifying OTP Code Credential...",{color:"#888",autoHide:!1,targetEl:n});const s=document.getElementById("forgotEmail").value,c=document.getElementById("newPassword").value,u=Array.from(document.querySelectorAll(".otp-field")).map(f=>f.value).join("");try{const f=await fetch("/.netlify/functions/verify-otp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,otp:u,newPassword:c})});f.ok?(wolfAudio.play("success"),showResetOutput("Protocol success. Password updated.",{color:"#4ade80",autoHide:!1,targetEl:n}),window.wolfAudio&&window.wolfAudio.play("success"),window.Swal.fire({title:"SUCCESS",html:`<div style="color:#08ea1b; font-size:4rem; margin-bottom:15px;"><i class='bx bx-check-shield'></i></div>
               <p style="color:#888; font-size:14px;">Credentials re-mapped successfully. Terminal access granted.</p>`,background:"#111",timer:3e3,timerProgressBar:!0,showConfirmButton:!1,customClass:{popup:"wolf-swal-popup wolf-border-green",title:"wolf-swal-title"},didClose:()=>{P()}})):(await f.json(),wolfAudio.play("denied"),showResetOutput("[ERR_602] Security key invalid or expired.",{targetEl:n}),r.disabled=!1,r.textContent="RESTORE SYSTEM ACCESS")}catch(f){wolfAudio.play("error"),r.disabled=!1,showResetOutput("[ERR_500] Database synchronization fault.",{targetEl:n})}}}(async()=>{const e=L();e>0&&v(e);const t=await K(),n=Math.max(e,Number(t||0));n>0&&v(n)})(),document.getElementById("loginForm").onsubmit=e=>{e.preventDefault(),ue()},document.getElementById("otpForm").onsubmit=e=>{e.preventDefault();const t=L();if(t>0){v(t),showResetOutput(`[ERR_429] ${b(t)}.`,{color:"var(--wolf-red)",autoHide:!1});return}te("sendOtpBtn")},document.getElementById("forgotLink").onclick=e=>{e.preventDefault(),o.classList.add("flipped")},document.addEventListener("click",e=>{e.target.id==="forgotLink"&&(e.preventDefault(),document.getElementById("flipCardInner").classList.add("flipped")),(e.target.id==="resendOtpBtn"||e.target.closest("#resendOtpBtn"))&&(e.preventDefault(),console.log("Wolf OS: Resend requested..."),te()),(e.target.id==="backToLoginTrigger"||e.target.id==="backToLoginTriggerSecondary")&&(e.preventDefault(),document.getElementById("recoveryStep2")?(window.wolfAudio&&window.wolfAudio.play("notif"),window.Swal.fire({title:"ABANDON RECOVERY?",html:`<div style="color:#b47023; font-size:4rem; margin-bottom:15px;"><i class='bx bx-shield-quarter'></i></div>
               <p style="color:#888; font-size:14px;">Terminating handshake will void the current security key. Proceed?</p>`,showCancelButton:!0,confirmButtonText:"YES, EXIT",cancelButtonText:"STAY",reverseButtons:!0,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-orange",title:"wolf-swal-title",confirmButton:"btn-wolf-orange",cancelButton:"btn-wolf-secondary"}}).then(t=>{t.isConfirmed&&P()})):o.classList.remove("flipped"))}),document.getElementById("confirmExitBtn").onclick=()=>{l.style.display="none",P()},document.getElementById("cancelExitBtn").onclick=()=>l.style.display="none",document.getElementById("closeModalBtn").onclick=()=>P(),document.getElementById("descContainer").onclick=function(){this.classList.toggle("expanded")};function ge(){const e=document.querySelectorAll(".otp-field");e.forEach((t,n)=>{t.oninput=i=>{t.value=t.value.replace(/[^0-9]/g,""),t.value&&n<5&&e[n+1].focus()},t.onkeydown=i=>{i.key==="Backspace"&&!t.value&&n>0&&e[n-1].focus()},t.onpaste=i=>{i.preventDefault();const s=(i.clipboardData||window.clipboardData).getData("text").replace(/[^0-9]/g,"");for(let u=0;u<s.length&&n+u<e.length;u++)e[n+u].value=s[u];const c=Math.min(n+s.length,5);e[c].focus()}})}});
