async function moveToTrash(e,a,t){console.log(`Wolf OS: Moving ${a} from ${e} to Trash...`);const{error:i}=await supabaseClient.from("trash_bin").insert([{original_table:e,original_id:a,payload:t}]);if(i)throw i}window.wolfData=null;const wolfData={selectedDate:new Date,serverToday:new Date,activeMode:"sales",isFetching:!1,allSales:[],currentLedgerPage:1,ledgerPageSize:12,currentLedgerRows:[],lastTotal:0,activeAF:null,lastTraffic:0,summaryHUDReady:!1,currencySymbol:"₱",defaultWalkInFee:80,goalTargets:{DAILY:0,WEEKLY:0,MONTHLY:0},goalActuals:{DAILY:0,WEEKLY:0,MONTHLY:0},targetCycle:["DAILY","WEEKLY","MONTHLY"],targetModeIndex:0,targetBoxBound:!1,targetDisplayPct:{DAILY:0,WEEKLY:0,MONTHLY:0},targetLastActual:{DAILY:null,WEEKLY:null,MONTHLY:null},targetSyncTimer:null,targetFxTimers:[],targetValueAF:null,targetDisplayedActual:{DAILY:0,WEEKLY:0,MONTHLY:0},goalReachedCelebrated:{DAILY:!1,WEEKLY:!1,MONTHLY:!1},targetThemeWatchBound:!1,targetThemeObserver:null,targetCinematicHideTimer:null,targetCinematicStartTimer:null,targetCinematicAF:null,formatCurrency(e=0){return`${this.currencySymbol}${Number(e||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`},formatServerClock(e){const a=new Date(e);return!e||Number.isNaN(a.getTime())?"--:--":new Intl.DateTimeFormat("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0,timeZone:"Asia/Manila"}).format(a)},isMoneyMode(){return this.activeMode==="sales"||this.activeMode==="logbook"},syncNavigationUI(e){console.log(`Wolf OS: Navigation UI Lock engaged for [${e}]`),document.querySelectorAll(".nav-item[data-page], .sidebar-link[data-page]").forEach(t=>{t.getAttribute("data-page")===e?t.classList.add("active"):t.classList.remove("active")})},animateValue(e,a,t,i){this.activeAF&&cancelAnimationFrame(this.activeAF);let s=null;const r=this.isMoneyMode(),l=n=>{s||(s=n);const o=Math.min((n-s)/i,1),g=o*(t-a)+a;r?e.textContent=this.formatCurrency(g):e.textContent=Math.floor(g),o<1?this.activeAF=window.requestAnimationFrame(l):(this.activeAF=null,setTimeout(()=>{this.activeAF||e.classList.remove("increasing","decreasing")},300))};this.activeAF=window.requestAnimationFrame(l)},refreshSummaryHUD(e=null){const a=document.getElementById("ledger-summary-amount");if(!a)return;let t=e!==null?e:(this.allSales||[]).reduce((i,s)=>i+Number(s.total_amount||0),0);if(!this.summaryHUDReady){this.lastTotal=t,a.textContent=this.isMoneyMode()?this.formatCurrency(t):t,this.summaryHUDReady=!0;return}t!==this.lastTotal&&(a.classList.remove("increasing","decreasing"),a.offsetWidth,t>this.lastTotal?a.classList.add("increasing"):a.classList.add("decreasing"),this.animateValue(a,this.lastTotal,t,800),this.lastTotal=t,this.updateTargetBox())},async loadGoalTargets(){if(!window.supabaseClient)return;const e=["DAILY","WEEKLY","MONTHLY"];for(const a of e){const{data:t,error:i}=await supabaseClient.from("goal_target").select("*").eq("period_type",a).limit(200);if(!i&&Array.isArray(t)&&t.length>0){const s=t.slice().sort((r,l)=>{const n=new Date((r==null?void 0:r.start_date)||0).getTime(),o=new Date((l==null?void 0:l.start_date)||0).getTime(),g=new Date((r==null?void 0:r.updated_at)||(r==null?void 0:r.created_at)||0).getTime(),m=new Date((l==null?void 0:l.updated_at)||(l==null?void 0:l.created_at)||0).getTime();return(Number.isFinite(o)?o:0)-(Number.isFinite(n)?n:0)||(Number.isFinite(m)?m:0)-(Number.isFinite(g)?g:0)})[0];this.goalTargets[a]=Number((s==null?void 0:s.target_amount)||0)}}await this.loadGoalActuals(),this.bindTargetBoxRotation(),this.bindTargetThemeObserver(),this.ensureTargetCinematicOverlay(),this.updateTargetBox()},async loadGoalActuals(){if(!window.supabaseClient)return;const e=new Date,a=new Date(e);a.setHours(0,0,0,0);const t=new Date(a);t.setDate(t.getDate()+1);const i=new Date(a);i.setDate(i.getDate()-i.getDay());const s=new Date(a.getFullYear(),a.getMonth(),1),r={DAILY:[a.toISOString(),t.toISOString()],WEEKLY:[i.toISOString(),t.toISOString()],MONTHLY:[s.toISOString(),t.toISOString()]},l=async(o,g)=>{const{data:m,error:c}=await supabaseClient.from("sales").select("total_amount,qty,unit_price,created_at").gte("created_at",o).lt("created_at",g);return c||!Array.isArray(m)?0:m.reduce((f,h)=>{const d=Number(h.total_amount||0);return d>0?f+d:f+Number(h.qty||0)*Number(h.unit_price||0)},0)},n=async(o,g)=>{const{data:m,error:c}=await supabaseClient.from("check_in_logs").select("entry_fee,paid_amount,is_paid,time_in").gte("time_in",o).lt("time_in",g);return c||!Array.isArray(m)?0:m.reduce((f,h)=>{const d=Number(h.paid_amount||0);return d>0?f+d:h.is_paid?f+Number(h.entry_fee||0):f},0)};for(const o of this.targetCycle){const[g,m]=r[o],[c,f]=await Promise.all([l(g,m),n(g,m)]);this.goalActuals[o]=Number(c||0)+Number(f||0)}},getCurrentTargetPeriod(){return this.targetCycle[this.targetModeIndex]||"DAILY"},rotateTargetPeriod(){this.targetModeIndex=(this.targetModeIndex+1)%this.targetCycle.length,this.updateTargetBox({animate:!1})},bindTargetBoxRotation(){if(this.targetBoxBound)return;const e=document.getElementById("sidebar-target-box");e&&(this.targetBoxBound=!0,e.addEventListener("click",()=>this.rotateTargetPeriod()))},clearTargetFxTimers(){Array.isArray(this.targetFxTimers)&&(this.targetFxTimers.forEach(e=>clearTimeout(e)),this.targetFxTimers=[])},getTargetThemePalette(){return document.body.classList.contains("light-theme")?{active:"#2a8dff",glow:"rgba(42, 141, 255, 0.62)"}:{active:"#ff3b30",glow:"rgba(255, 59, 48, 0.75)"}},bindTargetThemeObserver(){if(this.targetThemeWatchBound)return;this.targetThemeWatchBound=!0;const e=document.body;!e||typeof MutationObserver=="undefined"||(this.targetThemeObserver=new MutationObserver(()=>{this.updateTargetBox({animate:!1})}),this.targetThemeObserver.observe(e,{attributes:!0,attributeFilter:["class"]}))},ensureTargetCinematicOverlay(){let e=document.getElementById("wolf-target-cinematic");return e||(e=document.createElement("div"),e.id="wolf-target-cinematic",e.setAttribute("aria-hidden","true"),e.innerHTML=`
      <div class="wtc-head">
        <div class="wtc-label" id="wolf-target-cinematic-label">TARGET UPDATE</div>
        <div class="wtc-value" id="wolf-target-cinematic-value">0%</div>
      </div>
      <div class="wtc-track">
        <div class="wtc-ghost" id="wolf-target-cinematic-ghost"></div>
        <div class="wtc-fill" id="wolf-target-cinematic-fill"></div>
      </div>
      <div class="wtc-state" id="wolf-target-cinematic-state">SYNCHRONIZING</div>
    `,document.body.appendChild(e),e)},renderTargetCinematic({period:e,pct:a,previousPct:t,actual:i,previousActual:s=i,target:r,isGain:l,isDrop:n,animate:o=!0}){const g=this.ensureTargetCinematicOverlay();if(!g)return;const m=document.getElementById("wolf-target-cinematic-label"),c=document.getElementById("wolf-target-cinematic-value"),f=document.getElementById("wolf-target-cinematic-state"),h=document.getElementById("wolf-target-cinematic-fill"),d=document.getElementById("wolf-target-cinematic-ghost");if(!c||!h||!d)return;const b={DAILY:"TODAY TARGET",WEEKLY:"THIS WEEK TARGET",MONTHLY:"THIS MONTH TARGET"};if(m&&(m.textContent=`${b[e]||"TARGET"} UPDATE`),c.textContent=`${Math.round(t)}% -> ${Math.round(a)}%  |  ${this.formatCurrency(s)} -> ${this.formatCurrency(i)}`,f&&(f.textContent=l?"INCOME RISING":n?"INCOME DROP DETECTED":"SYNCHRONIZED"),g.classList.toggle("is-light",document.body.classList.contains("light-theme")),g.classList.toggle("is-gain",!!l),g.classList.toggle("is-drop",!!n),!o){h.style.width=`${a}%`,d.style.width=`${a}%`,d.style.opacity="0";return}this.targetCinematicStartTimer&&clearTimeout(this.targetCinematicStartTimer),this.targetCinematicHideTimer&&clearTimeout(this.targetCinematicHideTimer),this.targetCinematicAF&&(cancelAnimationFrame(this.targetCinematicAF),this.targetCinematicAF=null),g.classList.add("is-active");const p=Number.isFinite(Number(t))?Number(t):a,u=Number.isFinite(Number(a))?Number(a):p;h.style.transition="none",h.style.width=`${p}%`,d.style.transition="none",d.style.width=`${p}%`,d.style.opacity=n?"0.92":"0",h.offsetWidth;const w=n?1250:1100,y=180,T=performance.now()+y,D=v=>1-Math.pow(1-v,3);this.targetCinematicStartTimer=setTimeout(()=>{const v=C=>{const L=Math.min(1,(C-T)/w),S=D(Math.max(0,L)),I=p+(u-p)*S;h.style.width=`${I}%`,n&&(d.style.width=`${p+(u-p)*S}%`,d.style.opacity=`${.92*(1-S)}`);const E=s+(i-s)*S;c.textContent=`${Math.round(p+(u-p)*S)}% -> ${Math.round(u)}%  |  ${this.formatCurrency(E)} -> ${this.formatCurrency(i)}`,L<1?this.targetCinematicAF=requestAnimationFrame(v):(this.targetCinematicAF=null,d.style.opacity="0")};this.targetCinematicAF=requestAnimationFrame(v)},y),this.targetCinematicHideTimer=setTimeout(()=>{g.classList.remove("is-active","is-gain","is-drop")},w+y+700)},scheduleGoalActualsSync(e=260){this.targetSyncTimer&&clearTimeout(this.targetSyncTimer),this.targetSyncTimer=setTimeout(async()=>{try{await this.loadGoalActuals(),this.updateTargetBox({animate:!0})}catch(a){console.error("Wolf OS Target Sync Fault:",a)}},e)},clearTargetValueAnimation(){this.targetValueAF&&(cancelAnimationFrame(this.targetValueAF),this.targetValueAF=null)},animateTargetReadout({fromActual:e,toActual:a,fromPct:t,toPct:i,target:s,percentEl:r,amountEl:l,duration:n=520}){this.clearTargetValueAnimation();const o=performance.now(),g=c=>1-(1-c)*(1-c),m=c=>{const f=Math.min(1,(c-o)/n),h=g(f),d=e+(a-e)*h,b=t+(i-t)*h;r&&(r.textContent=`${Math.round(b)}%`),l&&(l.textContent=`${this.formatCurrency(d)} / ${this.formatCurrency(s)}`),f<1?this.targetValueAF=requestAnimationFrame(m):this.targetValueAF=null};this.targetValueAF=requestAnimationFrame(m)},updateTargetBox(e={}){var T,D,v,C,L,S,I,E;const{animate:a=!0}=e,t=this.getCurrentTargetPeriod(),i=Number(((T=this.goalTargets)==null?void 0:T[t])||0),s=Number(((D=this.goalActuals)==null?void 0:D[t])||0),r=document.getElementById("sidebar-target-percent"),l=document.getElementById("sidebar-target-bar"),n=document.getElementById("sidebar-target-ghost"),o=document.getElementById("sidebar-target-box"),g=document.getElementById("sidebar-target-label"),m=document.getElementById("sidebar-target-state"),c=document.getElementById("sidebar-target-amount");if(!r||!l||!o)return;const f={DAILY:"TODAY TARGET",WEEKLY:"THIS WEEK TARGET",MONTHLY:"THIS MONTH TARGET"};g&&(g.textContent=f[t]||"TARGET");const h=this.getTargetThemePalette();if(o.style.setProperty("--target-active-color",h.active),o.style.setProperty("--target-glow-color",h.glow),o.style.setProperty("--target-warn-color","#ff2d2d"),o.classList.remove("target-gaining","target-dropping","target-drop-warning","target-changing"),this.clearTargetFxTimers(),i<=0){this.clearTargetValueAnimation(),r.textContent="0%",l.style.width="0%",n&&(n.style.width="0%",n.style.opacity="0"),m&&(m.textContent=`ACTIVE: ${t}`),c&&(c.textContent=`${this.formatCurrency(s)} / ${this.formatCurrency(0)}`),this.targetDisplayPct[t]=0,this.targetLastActual[t]=s,this.targetDisplayedActual[t]=s,this.renderTargetCinematic({period:t,pct:0,previousPct:0,actual:s,previousActual:s,target:0,isGain:!1,isDrop:!1,animate:!1});return}const d=Math.min(100,Math.max(0,s/i*100)),b=((v=this.targetLastActual)==null?void 0:v[t])===null||((C=this.targetLastActual)==null?void 0:C[t])===void 0?s:Number(this.targetLastActual[t]),p=((L=this.targetDisplayPct)==null?void 0:L[t])===null||((S=this.targetDisplayPct)==null?void 0:S[t])===void 0?d:Number(this.targetDisplayPct[t]),u=p<100&&d>=100;m&&(m.textContent=`${d>=100?"REACHED":"ACTIVE"}: ${t}`);const w=((I=this.targetDisplayedActual)==null?void 0:I[t])===null||((E=this.targetDisplayedActual)==null?void 0:E[t])===void 0?b:Number(this.targetDisplayedActual[t]);if(!a||s===b){this.clearTargetValueAnimation(),r.textContent=`${Math.round(d)}%`,c&&(c.textContent=`${this.formatCurrency(s)} / ${this.formatCurrency(i)}`),l.style.width=`${d}%`,n&&(n.style.width=`${d}%`,n.style.opacity="0"),this.targetDisplayPct[t]=d,this.targetLastActual[t]=s,this.targetDisplayedActual[t]=s,this.renderTargetCinematic({period:t,pct:d,previousPct:d,actual:s,previousActual:s,target:i,isGain:!1,isDrop:!1,animate:!1});return}this.animateTargetReadout({fromActual:w,toActual:s,fromPct:p,toPct:d,target:i,percentEl:r,amountEl:c,duration:s>b?560:520}),o.classList.add("target-changing");const y=setTimeout(()=>{o.classList.remove("target-changing")},720);if(this.targetFxTimers.push(y),s>b){n&&(n.style.width=`${d}%`,n.style.opacity="0"),l.style.width=`${d}%`,o.classList.add("target-gaining");const A=setTimeout(()=>{o.classList.remove("target-gaining")},520);this.targetFxTimers.push(A),this.renderTargetCinematic({period:t,pct:d,previousPct:p,actual:s,previousActual:b,target:i,isGain:!0,isDrop:!1,animate:!0})}else{o.classList.add("target-dropping","target-drop-warning"),n&&(n.style.transition="none",n.style.width=`${p}%`,n.style.opacity="0.95",n.offsetWidth),l.style.width=`${d}%`;const A=setTimeout(()=>{o.classList.remove("target-drop-warning")},220);if(this.targetFxTimers.push(A),n){const k=setTimeout(()=>{n.style.transition="width 0.95s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.95s ease",n.style.width=`${d}%`,n.style.opacity="0"},26);this.targetFxTimers.push(k)}const x=setTimeout(()=>{o.classList.remove("target-dropping")},980);this.targetFxTimers.push(x),this.renderTargetCinematic({period:t,pct:d,previousPct:p,actual:s,previousActual:b,target:i,isGain:!1,isDrop:!0,animate:!0})}this.targetDisplayPct[t]=d,this.targetLastActual[t]=s,this.targetDisplayedActual[t]=s,d<100?this.goalReachedCelebrated[t]=!1:u&&!this.goalReachedCelebrated[t]&&(this.goalReachedCelebrated[t]=!0,window.wolfAudio&&window.wolfAudio.play("confetti"))},async addSaleRow(e){const a=document.getElementById("ledger-list-container");if(!a)return;const t=this.renderSingleSaleCard(e,0);a.insertAdjacentHTML("afterbegin",t),this.scheduleGoalActualsSync(),form.addEventListener("submit",async i=>{var m,c;i.preventDefault();const s=skuInput.value.trim(),r=nameInput.value.trim(),l=parseFloat(priceInput.value||"0"),n=unlimitedCheckbox!=null&&unlimitedCheckbox.checked?999999:parseInt(qtyInput.value||"0",10),o=((m=document.getElementById("master-desc"))==null?void 0:m.value)||null,g=((c=document.getElementById("master-brand"))==null?void 0:c.value)||null;if(!r||!n||!l){statusEl&&(statusEl.textContent="Name, quantity, and price are required.");return}if(!s&&!selectedImageUrl){statusEl&&(statusEl.textContent="Please select one image before adding to sales.");return}try{let h=form.dataset.productId||null;if(!h){const{data:p,error:u}=await supabaseClient.from("products").insert({sku:s||void 0,name:r,description:o,price:l,qty:n,image_url:selectedImageUrl||null,is_active:!0}).select().single();if(u)throw u;h=p.productid}const{data:d,error:b}=await supabaseClient.from("sales").insert({productid:h,qty:n,price:l}).select().single();if(b)throw b;window.wolfData&&typeof window.wolfData.addSaleRow=="function"&&window.wolfData.addSaleRow(d),statusEl&&(statusEl.textContent="Sale added."),modal.style.display="none"}catch(f){console.error(f),statusEl&&(statusEl.textContent="Error adding sale.")}})},updateSaleRow(e){const a=this.salesData.findIndex(t=>t.id===e.id);a>-1&&(this.salesData[a]=e),this.updateLedgerRevenue(),Toastify({text:`Sale updated: ${e.id}`,duration:2e3,gravity:"top",position:"right"}).showToast()},removeSaleRow(e){const a=document.getElementById(`row-${e}`);a&&(a.classList.add("removing"),setTimeout(()=>a.remove(),400)),this.allSales=(this.allSales||[]).filter(t=>t.id!==e),this.refreshSummaryHUD(),this.scheduleGoalActualsSync(),alert("test")},updateProductUI(e){Toastify({text:`Product updated: ${e.name}`,duration:2e3,gravity:"top",position:"right",backgroundColor:"#ff9800"}).showToast()},updateLedgerRevenue(){const e=document.getElementById("ledger-summary-amount");if(!e)return;const a=(this.allSales||[]).reduce((t,i)=>t+Number(i.total_amount||0),0);if(this.currentTotal===0&&a!==0){this.currentTotal=a,e.textContent=this.formatCurrency(a);return}a!==this.currentTotal&&(a>this.currentTotal?e.className="summary-value increasing":e.className="summary-value decreasing",this.animateNumber(e,this.currentTotal,a),this.currentTotal=a)},async syncServerTime(){console.log("Wolf OS: Synchronizing with Atomic Clock...");try{const{data:e,error:a}=await supabaseClient.rpc("get_server_time");if(a)throw a;const t=Array.isArray(e)?e[0]:e;if(t)this.selectedDate=new Date(t),this.serverToday=new Date(t);else throw new Error("No timestamp returned")}catch(e){console.error("Wolf OS: Sync Fault. Falling back to system clock.",e),this.selectedDate=new Date,this.serverToday=new Date}isNaN(this.selectedDate.getTime())&&(this.selectedDate=new Date,this.serverToday=new Date)},async syncTime(){console.log("Wolf OS: Syncing with Atomic Server Clock...");try{const{data:e,error:a}=await supabaseClient.rpc("get_server_time");if(e&&e[0]){const t=e[0].server_date.split("-");this.serverToday=new Date(t[0],t[1]-1,t[2]),this.selectedDate=new Date(this.serverToday)}}catch(e){console.warn("Wolf OS: Time Sync Failed, using local clock.")}return this.selectedDate},get realTodayIndex(){return new Date().getDay()},get realTodayISO(){return new Date().toISOString().split("T")[0]},async initLedger(e){this.activeMode=e,this.lastTotal=0,this.summaryHUDReady=!1,await this.syncTime();const a=document.getElementById("ledger-title"),t=document.getElementById("ledger-summary-label"),i=document.getElementById("ledger-search-container");a&&(e==="sales"?(a.innerText="SALES",t.innerText="Daily Income Summary"):(a.innerText="LOGBOOK",t.innerText="Floor Income Summary")),i&&(i.style.display="block",i.classList.remove("active")),this.syncNavigationUI(e),this.initChrono(e),await this.syncServerTime(),await this.loadGoalTargets()},initChrono(e){if(this.fp&&typeof this.fp.destroy=="function")try{this.fp.destroy()}catch(r){console.warn("Wolf OS: Non-critical - could not destroy old flatpickr instance.")}this.fp=null;const a=document.getElementById("chrono-picker-trigger"),t=document.getElementById("hidden-chrono-input");if(!t){console.error("Wolf OS: Chrono Input not found in DOM.");return}const i=this.serverToday||new Date,s=flatpickr(t,{disableMobile:!0,maxDate:i,animate:!0,positionElement:a,position:"below",onReady:(r,l,n)=>{const o=n.calendarContainer;o.classList.remove("wolf-calendar-v2","wolf-calendar-v3"),o.classList.add("wolf-calendar"),o.classList.remove("open")},onOpen:(r,l,n)=>{requestAnimationFrame(()=>{n.calendarContainer.classList.add("open")})},onClose:(r,l,n)=>{n.calendarContainer.classList.remove("open")},onChange:r=>{r.length>0&&(this.selectedDate=r[0],this.calculateWeek(e))}});this.fp=Array.isArray(s)?s[0]:s,a&&this.fp&&(a.onclick=null,a.onclick=r=>{r.preventDefault(),r.stopPropagation(),this.fp.isOpen?this.fp.close():this.fp.open()}),this.calculateWeek(e)},calculateWeek(e){const a=new Date(this.selectedDate),t=a.getDay(),i=new Date(a);i.setDate(a.getDate()-t);const s=new Date(i);s.setDate(i.getDate()+6),this.updateChronoUI(i,s,t,e)},shiftWeek(e,a){this.selectedDate.setDate(this.selectedDate.getDate()+e),this.calculateWeek(a)},async updateChronoUI(e,a,t){if(!e||isNaN(e.getTime())||!a||isNaN(a.getTime()))return;this.fp&&typeof this.fp.setDate=="function"&&this.fp.setDate(this.selectedDate,!1);const i=h=>h.toLocaleDateString("en-US",{month:"short",day:"numeric"}).toUpperCase(),s=document.getElementById("week-range-display");s&&(s.innerText=`${i(e)} - ${i(a)}`);const r=this.serverToday||new Date,l=r.toLocaleDateString("en-CA"),n=new Date(r);n.setDate(r.getDate()-r.getDay());const o=n.toLocaleDateString("en-CA"),g=e.toLocaleDateString("en-CA"),m=document.getElementById("snap-today-btn");if(m){const h=g<o;m.classList.toggle("visible",h),m.disabled=!h,m.tabIndex=h?0:-1,m.setAttribute("aria-hidden",h?"false":"true"),m.style.pointerEvents=h?"":"none"}document.querySelectorAll("#ledger-day-picker .day-btn").forEach((h,d)=>{const b=new Date(e);b.setDate(e.getDate()+d);const p=b.toLocaleDateString("en-CA");h.setAttribute("data-date",p),h.classList.toggle("active",d===t),h.disabled=p>l});const f=this.selectedDate.toLocaleDateString("en-CA");this.isReadOnly=f!==l,this.applyLockdownUI(),this.activeMode==="sales"?await this.loadSales():await this.loadLogbook()},currentLogDay:new Date().getDay(),currentSalesDay:new Date().getDay(),realToday:new Date().getDay(),salesDataCache:[],sanitizePlain(e){const a=String(e!=null?e:"");return window.DOMPurify?window.DOMPurify.sanitize(a,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]}):a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},parseLogNotes(e=""){var n,o,g;const a=String(e||""),t=a.match(/\|MEMBERSHIP:([^|]+)/i),i=a.match(/\|PAID:([0-9]+(?:\.[0-9]+)?)/i),s=a.match(/^WALK-IN:\s*([^|]+)/i),r=a.match(/^MEMBER_ENTRY:\s*([^|]+)/i),l=a.replace(/\|MEMBERSHIP:[^|]*/gi,"").replace(/\|PAID:[^|]*/gi,"").trim();return{raw:a,baseNote:l,membershipLabel:((n=t==null?void 0:t[1])==null?void 0:n.trim())||"",isPaidFromNote:!!i,paidAmountFromNote:i?Number(i[1]):null,walkInName:((o=s==null?void 0:s[1])==null?void 0:o.trim())||"",memberToken:((g=r==null?void 0:r[1])==null?void 0:g.trim())||""}},buildLogNotes(e,a,t,i){const r=[String(e||"").trim()||"WALK-IN: GUEST"];return a&&r.push(`MEMBERSHIP:${String(a).trim().toUpperCase()}`),t&&r.push(`PAID:${Number(i||0).toFixed(2)}`),r.join("|")},async loadLogbook(e={}){window.salesManager&&(window.salesManager.currentTrashMode="logbook");const a=document.getElementById("ledger-list-container");if(!a)return;a.children.length===0&&(a.innerHTML=`<div style="text-align:center; padding:50px; opacity:0.3;"><i class='bx bx-loader-alt bx-spin' style='font-size:2rem;'></i></div>`);const t=this.selectedDate.toLocaleDateString("en-CA");try{e!=null&&e.preservePage||(this.currentLedgerPage=1);const{data:i,error:s}=await supabaseClient.from("check_in_logs").select("*").gte("time_in",`${t}T00:00:00+08:00`).lte("time_in",`${t}T23:59:59+08:00`).order("time_in",{ascending:!1});if(s)throw s;const r=i||[],l=[...new Set(r.map(u=>u.profile_id).filter(Boolean))];let n=new Map;if(l.length>0){const{data:u,error:w}=await supabaseClient.from("members").select("profile_id, full_name, member_code").in("profile_id",l);!w&&u&&(n=new Map(u.map(y=>[y.profile_id,y])))}let o=r.map(u=>{var k,M,_,N,O;const w=this.parseLogNotes(u.notes),y=u.profile_id?n.get(u.profile_id):null,T=((k=w.memberToken.match(/ME-[A-Z0-9]{2,}/i))==null?void 0:k[0])||"",D=w.memberToken.replace(/ME-[A-Z0-9]{2,}/gi,"").trim(),v=!!(y||T||u.profile_id),C=(y==null?void 0:y.full_name)||w.walkInName||D||w.memberToken||"Walk-in Guest",L=this.sanitizePlain(C).toUpperCase(),S=this.sanitizePlain(String((y==null?void 0:y.member_code)||T||"").toUpperCase()),I=this.sanitizePlain(String(u.membership_label||w.membershipLabel||(v?"MONTHLY MEMBERSHIP":"REGULAR (NON-MEMBER)")).toUpperCase()),E=Number((_=(M=u.entry_fee)!=null?M:w.paidAmountFromNote)!=null?_:v?0:this.defaultWalkInFee),A=!!(typeof u.is_paid=="boolean"?u.is_paid:w.isPaidFromNote),x=Number((O=u.paid_amount)!=null?O:A?(N=w.paidAmountFromNote)!=null?N:E:0);return{...u,resolvedName:L,memberCode:S,membershipLabel:I,entryFee:E,isPaid:A,paidAmount:A?x:0,noteBase:w.baseNote}});const g=document.getElementById("ledger-main-search");if(g&&g.value){const u=g.value.toLowerCase();o=o.filter(w=>w.resolvedName.toLowerCase().includes(u)||w.membershipLabel.toLowerCase().includes(u)||w.memberCode.toLowerCase().includes(u))}const m=document.getElementById("ledger-summary-label"),c=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];m&&(m.innerText=`${c[this.selectedDate.getDay()]} Floor Income`);const f=o.reduce((u,w)=>u+(w.isPaid?Number(w.paidAmount||0):0),0);if(this.refreshSummaryHUD(f),o.length===0){a.innerHTML=`<div style="text-align:center; padding:80px; opacity:0.2;"><i class='bx bx-user-x' style='font-size:3rem;'></i><p style="font-size:10px; font-weight:900; margin-top:10px;">NO DATA LOGGED</p></div>`;return}this.currentLedgerRows=o;const h=o.length,d=Math.max(1,Math.ceil(h/this.ledgerPageSize));this.currentLedgerPage>d&&(this.currentLedgerPage=d);const b=(this.currentLedgerPage-1)*this.ledgerPageSize,p=o.slice(b,b+this.ledgerPageSize);a.innerHTML=p.map((u,w)=>{const y=u.time_out!==null,T=this.formatServerClock(u.time_in),D=y?this.formatServerClock(u.time_out):"--:--",v=u.isPaid?"badge-paid":"badge-unpaid",C=u.isPaid?"PAID":"UNPAID",L=y?"UNDO CHECK OUT":"CHECK OUT",S=y?`OUT ${D}`:"ACTIVE",I=y?"btn-logbook-neutral":"btn-logbook-danger",E=u.isPaid?"UNDO PAID":`COLLECT ${this.formatCurrency(u.entryFee)}`,A=u.isPaid?"btn-logbook-neutral":"btn-logbook-success",x=this.isReadOnly?"disabled":"";return`
          <div class="list-item-card" id="row-${u.id}" style="animation-delay: ${w*.04}s;">
            <div class="card-header logbook-card-header" style="margin-bottom:0;">
              <div class="status-icon logbook-status-icon ${y?"":"active"}" style="background:var(--bg-dark); color:var(--wolf-red);">
                <i class='bx ${y?"bx-check":"bx-time-five"}'></i>
              </div>
              <div class="item-info logbook-item-info">
                <h4>${u.resolvedName}</h4>
                <div class="sub">${u.memberCode?`MEMBER • ${u.memberCode}`:u.membershipLabel}</div>
                <div class="time">IN: ${T}</div>
              </div>
              <div class="logbook-inline-kpis">
                <div class="kpi-item">
                  <span class="kpi-label">CHECK-IN</span>
                  <span class="kpi-val">${T}</span>
                </div>
                <div class="kpi-item">
                  <span class="kpi-label">ENTRY FEE</span>
                  <span class="kpi-val">${this.formatCurrency(u.entryFee)}</span>
                </div>
              </div>
              <div class="card-actions logbook-card-actions" style="display:flex; align-items:center; gap:8px;">
                <span class="status-badge ${v}">${C}</span>
                ${this.isReadOnly?"":`<i class='bx bx-trash' style="cursor:pointer; color:#333; font-size:14px;" onclick="wolfData.deleteLog('${u.id}')"></i>`}
              </div>
            </div>
            <div class="logbook-actions">
              <button class="logbook-action-btn ${I}" ${x} onclick="wolfData.toggleLogCheckout('${u.id}', ${y})">
                <span class="btn-main">${L}</span>
                <span class="btn-sub">${S}</span>
              </button>
              <button class="logbook-action-btn ${A}" ${x} onclick="wolfData.toggleLogPaid('${u.id}', ${u.isPaid}, ${u.entryFee})">
                <span class="btn-main">${E}</span>
                <span class="btn-sub">${u.isPaid?"SET UNPAID":"MARK AS PAID"}</span>
              </button>
            </div>
          </div>`}).join(""),a.innerHTML+=this.renderLedgerPagination(h,d)}catch(i){console.error("Wolf OS Logbook Fault:",i)}},async loadSales(){if(window.salesManager&&(window.salesManager.currentTrashMode="sales"),this.isFetching)return;this.isFetching=!0;const e=document.getElementById("ledger-list-container");if(!e)return;e.children.length===0&&(e.innerHTML=`<div style="text-align:center; padding:50px; opacity:0.3;"><i class='bx bx-loader-alt bx-spin' style='font-size:2rem;'></i></div>`);const a=this.selectedDate.toLocaleDateString("en-CA");try{this.currentLedgerPage=1;const{data:t,error:i}=await supabaseClient.from("sales").select("*, products(name, sku, image_url, brand)").gte("created_at",`${a}T00:00:00+08:00`).lte("created_at",`${a}T23:59:59+08:00`).order("created_at",{ascending:!1});if(i)throw i;this.allSales=t||[];const s=document.getElementById("ledger-main-search"),r=s?s.value:"";this.renderSales(this.selectedDate.getDay(),r),this.scheduleGoalActualsSync()}catch(t){console.error("Wolf OS Sales Fault:",t)}finally{this.isFetching=!1}},renderSales(e,a=""){const t=document.getElementById("ledger-list-container");if(!t)return;const i=document.getElementById("ledger-summary-label"),s=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];i&&(i.innerText=`${s[e]} Total Income`);let r=[...this.allSales];if(a!==""){const c=a.toLowerCase();r=r.filter(f=>{var b,p;const h=String(((b=f.products)==null?void 0:b.name)||"").toLowerCase(),d=String(((p=f.products)==null?void 0:p.sku)||"").toLowerCase();return h.includes(c)||d.includes(c)})}const l=r.reduce((c,f)=>c+Number(f.total_amount||0),0);if(this.refreshSummaryHUD(l),r.length===0){t.innerHTML=`<div style="text-align:center; padding:80px; opacity:0.2;"><i class='bx bx-shopping-bag' style='font-size:3rem;'></i><p style="font-size:10px; font-weight:900; margin-top:10px;">NO DATA LOGGED</p></div>`;return}this.currentLedgerRows=r;const n=r.length,o=Math.max(1,Math.ceil(n/this.ledgerPageSize));this.currentLedgerPage>o&&(this.currentLedgerPage=o);const g=(this.currentLedgerPage-1)*this.ledgerPageSize,m=r.slice(g,g+this.ledgerPageSize);t.innerHTML=m.map((c,f)=>{var y,T,D,v;const h=Number(c.total_amount||0),d=DOMPurify.sanitize(((y=c.products)==null?void 0:y.name)||"Item"),b=DOMPurify.sanitize(((T=c.products)==null?void 0:T.sku)||"N/A"),p=DOMPurify.sanitize(((D=c.products)==null?void 0:D.brand)||""),u=DOMPurify.sanitize(String(((v=c.products)==null?void 0:v.image_url)||"/assets/images/placeholder.png")),w=new Date(c.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return`
        <div class="list-item-card sale-row-card" id="row-${c.id}" style="animation-delay: ${f*.06}s;">
          <div class="card-header sale-card-header" style="margin-bottom: 0;">
            <div class="status-icon sale-thumb" style="background: var(--bg-dark); color: var(--wolf-red); overflow:hidden;">
              <img src="${u}" alt="${d}" onerror="this.onerror=null;this.src='/assets/images/placeholder.png';" />
            </div>
            <div class="item-info sale-item-info">
              <h4>${d.toUpperCase()}</h4>
              <div class="sub">${b.toUpperCase()}${p?` • ${p.toUpperCase()}`:""}</div>
              <div class="time">${w} • x${c.qty}</div>
            </div>
            <div class="card-actions sale-card-actions">
              <div class="sale-price-chip">${this.formatCurrency(h)}</div>
              ${this.isReadOnly?"":`<button type="button" class="sale-delete-btn" onclick="wolfData.deleteSale('${c.id}')" aria-label="Delete sale"><i class='bx bxs-trash'></i></button>`}
            </div>
          </div>
        </div>`}).join(""),t.innerHTML+=this.renderLedgerPagination(n,o)},renderLedgerPagination(e,a){return e<=this.ledgerPageSize?"":`
      <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-top:10px;">
        <button onclick="wolfData.setLedgerPage(${this.currentLedgerPage-1})" ${this.currentLedgerPage<=1?"disabled":""} style="width:34px; height:34px; border-radius:10px; border:1px solid rgba(255,255,255,0.16); background:rgba(255,255,255,0.06); color:#e7edf8;"><i class='bx bx-chevron-left'></i></button>
        <span style="font-size:10px; letter-spacing:1px; text-transform:uppercase; color:#97a4ba;">Page ${this.currentLedgerPage} of ${a}</span>
        <button onclick="wolfData.setLedgerPage(${this.currentLedgerPage+1})" ${this.currentLedgerPage>=a?"disabled":""} style="width:34px; height:34px; border-radius:10px; border:1px solid rgba(255,255,255,0.16); background:rgba(255,255,255,0.06); color:#e7edf8;"><i class='bx bx-chevron-right'></i></button>
      </div>
    `},setLedgerPage(e){const a=Number(e);if(!(!Number.isFinite(a)||a<1)){if(this.currentLedgerPage=a,this.activeMode==="sales"){const t=document.getElementById("ledger-main-search");this.renderSales(this.selectedDate.getDay(),t?t.value:"");return}this.loadLogbook({preservePage:!0})}},updateDayUI(e,a){a=parseInt(a),this.realToday=new Date().getDay();const t=e==="logbook"?"#logbook-day-picker":"#sales-day-picker";document.querySelectorAll(`${t} .day-btn`).forEach(s=>{const r=parseInt(s.getAttribute("data-day"));s.classList.toggle("active",r===a),r>this.realToday?s.disabled=!0:s.disabled=!1}),this.isReadOnly=a!==this.realToday,this.applyLockdownUI()},applyLockdownUI(){var i,s;const e=document.querySelector(".icon-btn.red"),a=(i=document.querySelector(".icon-btn:not(.red) i.bx-trash"))==null?void 0:i.parentElement,t=document.querySelector(".brand");this.isReadOnly?(e&&e.classList.add("crud-hidden"),a&&a.classList.add("crud-hidden"),t&&!document.querySelector(".archive-mode-indicator")&&t.insertAdjacentHTML("beforebegin",'<span class="archive-mode-indicator">[ ARCHIVE_LOCKED ]</span>')):(e&&e.classList.remove("crud-hidden"),a&&a.classList.remove("crud-hidden"),(s=document.querySelector(".archive-mode-indicator"))==null||s.remove())},toggleReadOnlyMode(e){var i;const a=document.querySelector(".icon-btn.red"),t=(i=document.querySelector(".icon-btn:not(.red) i.bx-trash"))==null?void 0:i.parentElement;a&&a.classList.toggle("crud-hidden",e),t&&t.classList.toggle("crud-hidden",e),this.isReadOnly=e},async toggleLogCheckout(e,a){if(!this.isReadOnly)try{let t=new Date().toISOString();try{const{data:r,error:l}=await supabaseClient.rpc("get_server_time");if(!l&&r){const n=Array.isArray(r)?r[0]:r;if(typeof n=="string")t=new Date(n).toISOString();else if(n&&typeof n=="object"){const o=n.server_iso_timestamp||n.server_time||n.now||n.timestamp;o&&(t=new Date(o).toISOString())}}}catch(r){}const i=a?null:t,{error:s}=await supabaseClient.from("check_in_logs").update({time_out:i}).eq("id",e);if(s)throw s;window.wolfAudio&&window.wolfAudio.play("notif"),await this.loadLogbook()}catch(t){console.error("Wolf OS Checkout Toggle Fault:",t),window.wolfAudio&&window.wolfAudio.play("error")}},async toggleLogPaid(e,a,t=0){var i,s,r;if(!this.isReadOnly)try{const{data:l,error:n}=await supabaseClient.from("check_in_logs").select("*").eq("id",e).single();if(n||!l)throw n||new Error("Log row not found");const o=this.parseLogNotes(l.notes),g=String(l.membership_label||o.membershipLabel||(l.profile_id?"MONTHLY MEMBERSHIP":"REGULAR (NON-MEMBER)")).trim().toUpperCase(),m=Number((r=(s=(i=l.entry_fee)!=null?i:o.paidAmountFromNote)!=null?s:t)!=null?r:l.profile_id?0:this.defaultWalkInFee),c=!a,f=c?m:0,h=c?new Date().toISOString():null,d=this.buildLogNotes(o.baseNote,g,c,f),b={notes:d,membership_label:g,entry_fee:m,is_paid:c,paid_amount:f,paid_at:h};let{error:p}=await supabaseClient.from("check_in_logs").update(b).eq("id",e);if(p&&/column .* does not exist|schema cache|invalid input syntax/i.test(String(p.message||""))&&(p=(await supabaseClient.from("check_in_logs").update({notes:d}).eq("id",e)).error),p)throw p;window.wolfAudio&&window.wolfAudio.play("success"),await this.loadLogbook()}catch(l){console.error("Wolf OS Payment Toggle Fault:",l),window.wolfAudio&&window.wolfAudio.play("error")}},async deleteLog(e){if(!(!window.Swal||!(await window.Swal.fire({title:"REMOVE ENTRY?",html:'<p class="wolf-swal-text">WARNING: THIS RECORD WILL BE MOVED TO TRASH bin. PROCEED?</p>',showCancelButton:!0,confirmButtonText:"REMOVE",cancelButtonText:"CANCEL",background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup-orange",confirmButton:"wolf-swal-confirm-orange",cancelButton:"wolf-swal-cancel"}})).isConfirmed))try{const t=document.getElementById(`row-${e}`);t&&(t.classList.add("removing"),await new Promise(s=>setTimeout(s,400)),t.remove());const{data:i}=await supabaseClient.from("check_in_logs").select("*").eq("id",e).single();await supabaseClient.from("trash_bin").insert([{original_id:e,table_name:"check_in_logs",deleted_data:i}]),await supabaseClient.from("check_in_logs").delete().eq("id",e),window.wolfAudio&&window.wolfAudio.play("notif"),await this.loadLogbook()}catch(t){console.error(t)}},async adjustSaleQty(e,a=0){var i,s,r,l;if(this.isReadOnly)return;const t=Number(a);if(!(t!==1&&t!==-1))try{const n=(this.allSales||[]).find(y=>y.id===e),{data:o,error:g}=await supabaseClient.from("sales").select("id, product_id, qty, unit_price, total_amount").eq("id",e).single();if(g||!o)throw g||new Error("SALE_NOT_FOUND");const m=Number(o.qty||0),c=m+t;if(c<1){(i=window.salesManager)==null||i.showSystemAlert("MINIMUM QTY IS 1. USE DELETE TO REMOVE ITEM.","warning");return}const{data:f,error:h}=await supabaseClient.from("products").select("qty, name").eq("productid",o.product_id).single();if(h||!f)throw h||new Error("PRODUCT_NOT_FOUND");const d=Number(f.qty||0),b=d<999999;if(t>0&&b&&d<1){(r=window.salesManager)==null||r.showSystemAlert(`OUT OF STOCK: ${String(f.name||((s=n==null?void 0:n.products)==null?void 0:s.name)||"PRODUCT").toUpperCase()}`,"error");return}if(b){const y=t>0?d-1:d+1,{error:T}=await supabaseClient.from("products").update({qty:y}).eq("productid",o.product_id);if(T)throw T}const u=Number(o.unit_price||(m>0?Number(o.total_amount||0)/m:0))*c,{error:w}=await supabaseClient.from("sales").update({qty:c,total_amount:u}).eq("id",e);if(w)throw w;window.wolfAudio&&window.wolfAudio.play("click"),await this.loadSales(),this.scheduleGoalActualsSync()}catch(n){console.error("Sale qty adjust fault:",n),window.wolfAudio&&window.wolfAudio.play("error"),(l=window.salesManager)==null||l.showSystemAlert("FAILED TO UPDATE SALE QTY","error")}},async deleteSale(e){if(!window.Swal||!(await window.Swal.fire({title:"REMOVE PRODUCT?",html:`
      <div style="color: #b47023; font-size: 4.5rem; margin-bottom: 10px;">
        <i class='bx bx-error-alt'></i>
      </div>
      <p class="wolf-swal-text" style="text-transform: uppercase; letter-spacing: 1px;">
        WARNING: THIS RECORD WILL BE MOVED TO TRASH BIN. PROCEED?
      </p>
    `,showCancelButton:!0,confirmButtonText:"REMOVE",cancelButtonText:"CANCEL",reverseButtons:!0,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup-orange",title:"wolf-swal-title",confirmButton:"wolf-swal-confirm-orange",cancelButton:"wolf-swal-cancel"}})).isConfirmed)return;const t=document.getElementById(`row-${e}`);try{t&&(t.classList.add("removing"),await new Promise(o=>setTimeout(o,400)),t.remove());const{data:i,error:s}=await supabaseClient.from("sales").select("*").eq("id",e).single();if(s||!i)throw s;const{data:r}=await supabaseClient.from("products").select("qty, name").eq("productid",i.product_id).single();r&&r.qty<999999&&await supabaseClient.from("products").update({qty:r.qty+i.qty}).eq("productid",i.product_id),await supabaseClient.from("trash_bin").insert([{original_id:e,table_name:"sales",deleted_data:i}]),await supabaseClient.from("sales").delete().eq("id",e),this.allSales=(this.allSales||[]).filter(o=>o.id!==e);const l=this.allSales.reduce((o,g)=>o+Number(g.total_amount||0),0);this.refreshSummaryHUD(l),this.scheduleGoalActualsSync();const n=`${(r==null?void 0:r.name)||"Product"}, X${i.qty} WAS REMOVED`;window.salesManager.showSystemAlert(n,"success"),Toastify({text:n,duration:5e3,gravity:"top",position:"right",stopOnFocus:!0,style:{border:"1px solid #ff9800",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast(),window.wolfAudio&&window.wolfAudio.play("success")}catch(i){console.error("Void Protocol Fault:",i),window.wolfAudio&&window.wolfAudio.play("error"),this.loadSales()}},async reopenLog(e){await supabaseClient.from("check_in_logs").update({time_out:null}).eq("id",e),this.loadLogbook(this.currentLogDay)},addLogbookRow(){this.loadLogbook()},updateLogbookRow(){this.loadLogbook()},removeLogbookRow(){this.loadLogbook()}};window.wolfData=wolfData,wolfData.addSaleRow=function(e){Array.isArray(this.salesData)||(this.salesData=[]),this.salesData.push(e);const a=document.querySelector("#sales-table-body");if(a){const t=document.createElement("tr");t.id=`sale-row-${e.id}`,t.innerHTML=`
      <td>${e.id}</td>
      <td>${e.product_name}</td>
      <td>${e.quantity}</td>
      <td>${e.price}</td>
      <td>${(e.quantity*e.price).toFixed(2)}</td>
      <td><button onclick="wolfData.deleteSale('${e.id}')">Delete</button></td>
    `,a.appendChild(t)}this.updateLedgerRevenue(),this.scheduleGoalActualsSync()},wolfData.removeSaleRow=function(e){this.allSales=(this.allSales||[]).filter(t=>t.id!==e);const a=document.getElementById(`row-${e}`);a&&a.remove(),this.updateLedgerRevenue(),this.scheduleGoalActualsSync()},wolfData.initRealtime=async function(){if(this.updateLedgerRevenue(),this.scheduleGoalActualsSync(50),this.realtimeChannel)return;this.selectedDate||await this.syncServerTime();const e=supabaseClient.channel("wolf-ledger-sync-stable").on("postgres_changes",{event:"INSERT",schema:"public",table:"sales"},t=>{if(this.scheduleGoalActualsSync(80),this.activeMode!=="sales")return;const i=t.new;this.allSales.unshift(i),this.renderSales(this.selectedDate.getDay())}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"sales"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="sales"&&(this.updateSaleRow(t.new),this.updateLedgerRevenue(),Toastify({text:`Sale updated: ${t.new.id}`,duration:5e3,gravity:"top",position:"right"}).showToast())}).on("postgres_changes",{event:"DELETE",schema:"public",table:"sales"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="sales"&&this.removeSaleRow(t.old.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"check_in_logs"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="logbook"&&(this.addLogbookRow(t.new),Toastify({text:`Log added: ${t.new.id}`,duration:5e3,gravity:"top",position:"right",style:{border:"1px solid #4dff00",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast())}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"check_in_logs"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="logbook"&&(this.updateLogbookRow(t.new),Toastify({text:`Log updated: ${t.new.id}`,duration:5e3,gravity:"top",position:"right",style:{border:"1px solid #6fff00",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast())}).on("postgres_changes",{event:"DELETE",schema:"public",table:"check_in_logs"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="logbook"&&(this.removeLogbookRow(t.old.id),Toastify({text:`Log removed: ${t.old.id}`,duration:5e3,gravity:"top",position:"right",style:{border:"1prgb(255, 0, 0) #ff9800",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast())}),{error:a}=await e.subscribe(t=>{var i;t==="SUBSCRIBED"&&((i=this.showRealtimeToast)==null||i.call(this))});if(a){Toastify({text:"Realtime subscription failed",duration:5e3,gravity:"top",position:"right",backgroundColor:"#f44336"}).showToast(),console.error("Realtime subscription failed:",a);return}this.realtimeChannel=e},wolfData.updateLedgerRevenue=function(){const e=document.getElementById("ledger-summary-amount");if(!e)return;const a=(this.allSales||[]).reduce((t,i)=>t+Number(i.total_amount||0),0);e.textContent=this.formatCurrency(a)},wolfData.showRealtimeToast=function(){const e=document.createElement("span");e.innerHTML=DOMPurify.sanitize(`
    <i class="bx bx-rfid" style="margin-right: 8px; font-size:18px; color:var(--wolf-red);"></i>
    LIVE_SYNC_ESTABLISHED
  `),Toastify({node:e,duration:5e3,gravity:"top",position:"right",style:{background:"#0a0a0a",border:"1px solid #ffffff",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast()},document.addEventListener("input",e=>{if(e.target.id==="ledger-main-search"){const a=e.target.value.trim(),t=document.getElementById("search-clear-btn");t&&(t.style.display=a.length>0?"block":"none"),wolfData.currentLedgerPage=1,wolfData.activeMode==="sales"?wolfData.renderSales(wolfData.selectedDate.getDay(),a):wolfData.loadLogbook()}}),document.addEventListener("click",async e=>{if(e.target.closest("#muteToggleBtn")){e.preventDefault(),e.stopPropagation(),window.wolfAudio.toggleMute()||window.wolfAudio.play("notif");return}const t=wolfData.activeMode,i=(wolfData.serverToday||new Date).toLocaleDateString("en-CA"),s=e.target.closest("#toggle-search-btn");if(s){const o=s.closest("#sales-main-view, #logbook-main-view, #main-content, .ledger-page-wrapper")||document,g=o.querySelector("#ledger-search-container"),m=o.querySelector("#ledger-main-search");if(g&&m){e.preventDefault(),e.stopPropagation();const c=g.classList.toggle("active");if(s.classList.toggle("active",c),c)setTimeout(()=>{m.focus()},180),window.wolfAudio&&window.wolfAudio.play("notif");else{m.value="";const f=o.querySelector("#search-clear-btn");f&&(f.style.display="none"),wolfRefreshView()}return}}const r=e.target.closest("#prev-week-btn, #next-week-btn");if(r){const o=r.id==="prev-week-btn"?-7:7,g=new Date,m=g.toLocaleDateString("en-CA"),c=new Date(wolfData.selectedDate);c.setDate(c.getDate()+o);const f=c.toLocaleDateString("en-CA");if(o>0)if(f>m)if(wolfData.selectedDate.toLocaleDateString("en-CA")===m){window.salesManager&&window.salesManager.showSystemAlert("CHRONOLOCK_ACTIVE: FUTURE PROJECTION BLOCKED","error");return}else console.log("WolfChrono: Jump exceeds today. Snapping to current date."),wolfData.selectedDate=g;else wolfData.selectedDate=c;else wolfData.selectedDate=c;wolfData.calculateWeek(t);return}if(e.target.closest("#chrono-picker-trigger")){wolfData.fp&&wolfData.fp.open();return}const l=e.target.closest(".day-btn");if(l){const o=l.getAttribute("data-date");if(o){if(o>i){window.salesManager&&window.salesManager.showSystemAlert("INVALID_PROTOCOL: FUTURE_DATE_LOCKED","error");return}const g=o.split("-");wolfData.selectedDate=new Date(g[0],g[1]-1,g[2]),wolfData.calculateWeek(t)}}if(e.target.closest("#add-ledger-btn")){const o=wolfData.activeMode;window.wolfAudio&&window.wolfAudio.play("notif"),wolfData.activeMode==="sales"?window.salesManager.openSaleTerminal():window.logbookManager.openLogbookTerminal()}if(e.target.closest("#clear-ledger-btn")){const o=wolfData.activeMode;Toastify({text:`Opening ${o.toUpperCase()} Trash Bin...`,duration:5e3,gravity:"top",position:"right",style:{background:"#343434",borderRadius:"10px",fontWeight:"bold",color:"#fff"}}).showToast(),window.salesManager&&window.salesManager.openTrashBin(o)}const n=e.target.closest("#snap-today-btn");if(n){if(!n.classList.contains("visible")||n.disabled)return;console.log("WolfChrono: Snap-to-Today triggered."),await wolfData.syncServerTime(),wolfData.fp&&wolfData.fp.setDate(wolfData.selectedDate,!1),wolfData.calculateWeek(wolfData.activeMode),window.salesManager&&window.salesManager.showSystemAlert("RETURNED TO TODAY'S WEEK!","success");return}}),document.addEventListener("click",()=>{setTimeout(()=>{const e=document.getElementById("week-range-display");if(e&&(e.innerText==="--- - ---"||e.innerText==="")){const a=document.getElementById("sales-day-picker")?"sales":"logbook";console.log(`WolfChrono: Auto-initializing ${a} view...`),wolfData.initChrono(a)}},100)}),window.addEventListener("load",()=>{const a=new URLSearchParams(window.location.search).get("p")||"home";wolfData.syncNavigationUI(a),setTimeout(()=>{wolfData.loadGoalTargets().catch(()=>{})},300),(a==="sales"||a==="logbook")&&setTimeout(async()=>{document.getElementById("ledger-page")&&(wolfData.syncServerTime&&await wolfData.syncServerTime(),await wolfData.initLedger(a),wolfData.initRealtime())},500)});
