async function moveToTrash(e,a,t){console.log(`Wolf OS: Moving ${a} from ${e} to Trash...`);const{error:s}=await supabaseClient.from("trash_bin").insert([{original_table:e,original_id:a,payload:t}]);if(s)throw s}window.wolfData=null;const wolfData={selectedDate:new Date,serverToday:new Date,activeMode:"sales",isFetching:!1,allSales:[],currentLedgerPage:1,ledgerPageSize:12,currentLedgerRows:[],lastTotal:0,activeAF:null,lastTraffic:0,summaryHUDReady:!1,currencySymbol:"₱",defaultWalkInFee:80,goalTargets:{DAILY:0,WEEKLY:0,MONTHLY:0,QUARTERLY:0,YEARLY:0,CUSTOM:0},goalActuals:{DAILY:0,WEEKLY:0,MONTHLY:0,QUARTERLY:0,YEARLY:0,CUSTOM:0},targetCycle:["DAILY","WEEKLY","MONTHLY","QUARTERLY","YEARLY","CUSTOM"],targetModeIndex:0,targetBoxBound:!1,targetDisplayPct:{DAILY:0,WEEKLY:0,MONTHLY:0,QUARTERLY:0,YEARLY:0,CUSTOM:0},targetLastActual:{DAILY:null,WEEKLY:null,MONTHLY:null,QUARTERLY:null,YEARLY:null,CUSTOM:null},targetSyncTimer:null,targetFxTimers:[],targetValueAF:null,targetDisplayedActual:{DAILY:0,WEEKLY:0,MONTHLY:0,QUARTERLY:0,YEARLY:0,CUSTOM:0},goalReachedCelebrated:{DAILY:!1,WEEKLY:!1,MONTHLY:!1,QUARTERLY:!1,YEARLY:!1,CUSTOM:!1},targetThemeWatchBound:!1,targetThemeObserver:null,targetCinematicHideTimer:null,targetCinematicStartTimer:null,targetCinematicAF:null,formatCurrency(e=0){return`${this.currencySymbol}${Number(e||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`},getLocalGoalTargetMap(){const e={};try{const a=localStorage.getItem("wolf_local_goal_targets"),t=a?JSON.parse(a):[];if(!Array.isArray(t))return e;t.forEach(s=>{const i=String((s==null?void 0:s.period_type)||"").trim().toUpperCase();i&&(e[i]=Number((s==null?void 0:s.target_amount)||0))})}catch(a){return e}return e},getCustomGoalConfig(){const e=new Date,a=new Date(e);a.setHours(0,0,0,0);const t=new Date(a);t.setDate(t.getDate()-14);try{const s=localStorage.getItem("wolf_local_goal_custom_config"),i=s?JSON.parse(s):{},r=Number((i==null?void 0:i.target_amount)||0),d=String((i==null?void 0:i.start_date)||t.toISOString().slice(0,10)),n=String((i==null?void 0:i.end_date)||a.toISOString().slice(0,10));return{target_amount:r>0?r:5e4,start_date:d,end_date:n}}catch(s){return{target_amount:5e4,start_date:t.toISOString().slice(0,10),end_date:a.toISOString().slice(0,10)}}},isoDate(e){const a=new Date(e);if(Number.isNaN(a.getTime()))return"";const t=a.getFullYear(),s=String(a.getMonth()+1).padStart(2,"0"),i=String(a.getDate()).padStart(2,"0");return`${t}-${s}-${i}`},formatServerClock(e){const a=new Date(e);return!e||Number.isNaN(a.getTime())?"--:--":new Intl.DateTimeFormat("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0,timeZone:"Asia/Manila"}).format(a)},isMoneyMode(){return this.activeMode==="sales"||this.activeMode==="logbook"},syncNavigationUI(e){console.log(`Wolf OS: Navigation UI Lock engaged for [${e}]`),document.querySelectorAll(".nav-item[data-page], .sidebar-link[data-page]").forEach(t=>{t.getAttribute("data-page")===e?t.classList.add("active"):t.classList.remove("active")})},animateValue(e,a,t,s){this.activeAF&&cancelAnimationFrame(this.activeAF);let i=null;const r=this.isMoneyMode(),d=n=>{i||(i=n);const o=Math.min((n-i)/s,1),c=o*(t-a)+a;r?e.textContent=this.formatCurrency(c):e.textContent=Math.floor(c),o<1?this.activeAF=window.requestAnimationFrame(d):(this.activeAF=null,setTimeout(()=>{this.activeAF||e.classList.remove("increasing","decreasing")},300))};this.activeAF=window.requestAnimationFrame(d)},refreshSummaryHUD(e=null){const a=document.getElementById("ledger-summary-amount");if(!a)return;let t=e!==null?e:(this.allSales||[]).reduce((s,i)=>s+Number(i.total_amount||0),0);if(!this.summaryHUDReady){this.lastTotal=t,a.textContent=this.isMoneyMode()?this.formatCurrency(t):t,this.summaryHUDReady=!0;return}t!==this.lastTotal&&(a.classList.remove("increasing","decreasing"),a.offsetWidth,t>this.lastTotal?a.classList.add("increasing"):a.classList.add("decreasing"),this.animateValue(a,this.lastTotal,t,800),this.lastTotal=t,this.updateTargetBox())},async loadGoalTargets(){if(!window.supabaseClient)return;const e=this.getLocalGoalTargetMap();Object.keys(e).forEach(r=>{this.goalTargets[r]=Number(e[r]||0)});const a=["DAILY","WEEKLY","MONTHLY"];for(const r of a){const{data:d,error:n}=await supabaseClient.from("goal_target").select("*").eq("period_type",r).limit(200);if(!n&&Array.isArray(d)&&d.length>0){const o=d.slice().sort((c,g)=>{const u=new Date((c==null?void 0:c.start_date)||0).getTime(),b=new Date((g==null?void 0:g.start_date)||0).getTime(),h=new Date((c==null?void 0:c.updated_at)||(c==null?void 0:c.created_at)||0).getTime(),f=new Date((g==null?void 0:g.updated_at)||(g==null?void 0:g.created_at)||0).getTime();return(Number.isFinite(b)?b:0)-(Number.isFinite(u)?u:0)||(Number.isFinite(f)?f:0)-(Number.isFinite(h)?h:0)})[0];this.goalTargets[r]=Number((o==null?void 0:o.target_amount)||0)}}const t=Number(this.goalTargets.MONTHLY||0),s=Number(this.goalTargets.WEEKLY||0);Number(this.goalTargets.QUARTERLY||0)||(this.goalTargets.QUARTERLY=t>0?t*3:s*13),Number(this.goalTargets.YEARLY||0)||(this.goalTargets.YEARLY=t>0?t*12:s*52);const i=this.getCustomGoalConfig();this.goalTargets.CUSTOM=Number(i.target_amount||0),await this.loadGoalActuals(),this.bindTargetBoxSelector(),this.bindTargetThemeObserver(),this.ensureTargetCinematicOverlay(),this.updateTargetBox()},async loadGoalActuals(){if(!window.supabaseClient)return;const e=new Date,a=new Date(e);a.setHours(0,0,0,0);const t=new Date(a);t.setDate(t.getDate()+1);const s=new Date(a);s.setDate(s.getDate()-s.getDay());const i=new Date(a.getFullYear(),a.getMonth(),1),r=new Date(a.getFullYear(),Math.floor(a.getMonth()/3)*3,1),d=new Date(a.getFullYear(),0,1),n=this.getCustomGoalConfig(),o=new Date(n.start_date);o.setHours(0,0,0,0);const c=new Date(n.end_date);c.setHours(0,0,0,0),c.getTime()<o.getTime()&&c.setTime(o.getTime());const g=new Date(c);g.setDate(g.getDate()+1);const u={DAILY:[a.toISOString(),t.toISOString()],WEEKLY:[s.toISOString(),t.toISOString()],MONTHLY:[i.toISOString(),t.toISOString()],QUARTERLY:[r.toISOString(),t.toISOString()],YEARLY:[d.toISOString(),t.toISOString()],CUSTOM:[o.toISOString(),g.toISOString()]},b=async(f,m)=>{const{data:p,error:l}=await supabaseClient.from("sales").select("total_amount,qty,unit_price,created_at").gte("created_at",f).lt("created_at",m);return l||!Array.isArray(p)?0:p.reduce((y,w)=>{const T=Number(w.total_amount||0);return T>0?y+T:y+Number(w.qty||0)*Number(w.unit_price||0)},0)},h=async(f,m)=>{const{data:p,error:l}=await supabaseClient.from("check_in_logs").select("entry_fee,paid_amount,is_paid,time_in").gte("time_in",f).lt("time_in",m);return l||!Array.isArray(p)?0:p.reduce((y,w)=>{const T=Number(w.paid_amount||0);return T>0?y+T:w.is_paid?y+Number(w.entry_fee||0):y},0)};for(const f of this.targetCycle){const[m,p]=u[f],[l,y]=await Promise.all([b(m,p),h(m,p)]);this.goalActuals[f]=Number(l||0)+Number(y||0)}},getCurrentTargetPeriod(){return this.targetCycle[this.targetModeIndex]||"DAILY"},setTargetPeriod(e){const a=String(e||"").trim().toUpperCase(),t=this.targetCycle.indexOf(a);t<0||(this.targetModeIndex=t,this.updateTargetBox({animate:!1}))},bindTargetBoxSelector(){if(this.targetBoxBound)return;const e=document.getElementById("sidebar-target-select");e&&(this.targetBoxBound=!0,e.addEventListener("change",a=>{var s;const t=String(((s=a==null?void 0:a.target)==null?void 0:s.value)||"").toUpperCase();this.setTargetPeriod(t)}))},clearTargetFxTimers(){Array.isArray(this.targetFxTimers)&&(this.targetFxTimers.forEach(e=>clearTimeout(e)),this.targetFxTimers=[])},getTargetThemePalette(){return document.body.classList.contains("light-theme")?{active:"#2a8dff",glow:"rgba(42, 141, 255, 0.62)"}:{active:"#ff3b30",glow:"rgba(255, 59, 48, 0.75)"}},bindTargetThemeObserver(){if(this.targetThemeWatchBound)return;this.targetThemeWatchBound=!0;const e=document.body;!e||typeof MutationObserver=="undefined"||(this.targetThemeObserver=new MutationObserver(()=>{this.updateTargetBox({animate:!1})}),this.targetThemeObserver.observe(e,{attributes:!0,attributeFilter:["class"]}))},ensureTargetCinematicOverlay(){let e=document.getElementById("wolf-target-cinematic");return e||(e=document.createElement("div"),e.id="wolf-target-cinematic",e.setAttribute("aria-hidden","true"),e.innerHTML=`
      <div class="wtc-head">
        <div class="wtc-label" id="wolf-target-cinematic-label">TARGET UPDATE</div>
        <div class="wtc-value" id="wolf-target-cinematic-value">0%</div>
      </div>
      <div class="wtc-track">
        <div class="wtc-ghost" id="wolf-target-cinematic-ghost"></div>
        <div class="wtc-fill" id="wolf-target-cinematic-fill"></div>
      </div>
      <div class="wtc-state" id="wolf-target-cinematic-state">SYNCHRONIZING</div>
    `,document.body.appendChild(e),e)},renderTargetCinematic({period:e,pct:a,previousPct:t,actual:s,previousActual:i=s,target:r,isGain:d,isDrop:n,animate:o=!0}){const c=this.ensureTargetCinematicOverlay();if(!c)return;const g=document.getElementById("wolf-target-cinematic-label"),u=document.getElementById("wolf-target-cinematic-value"),b=document.getElementById("wolf-target-cinematic-state"),h=document.getElementById("wolf-target-cinematic-fill"),f=document.getElementById("wolf-target-cinematic-ghost");if(!u||!h||!f)return;const m={DAILY:"TODAY TARGET",WEEKLY:"THIS WEEK TARGET",MONTHLY:"THIS MONTH TARGET",QUARTERLY:"THIS QUARTER TARGET",YEARLY:"THIS YEAR TARGET",CUSTOM:"CUSTOM TARGET"};if(g&&(g.textContent=`${m[e]||"TARGET"} UPDATE`),u.textContent=`${Math.round(t)}% -> ${Math.round(a)}%  |  ${this.formatCurrency(i)} -> ${this.formatCurrency(s)}`,b&&(b.textContent=d?"INCOME RISING":n?"INCOME DROP DETECTED":"SYNCHRONIZED"),c.classList.toggle("is-light",document.body.classList.contains("light-theme")),c.classList.toggle("is-gain",!!d),c.classList.toggle("is-drop",!!n),!o){h.style.width=`${a}%`,f.style.width=`${a}%`,f.style.opacity="0";return}this.targetCinematicStartTimer&&clearTimeout(this.targetCinematicStartTimer),this.targetCinematicHideTimer&&clearTimeout(this.targetCinematicHideTimer),this.targetCinematicAF&&(cancelAnimationFrame(this.targetCinematicAF),this.targetCinematicAF=null),c.classList.add("is-active");const p=Number.isFinite(Number(t))?Number(t):a,l=Number.isFinite(Number(a))?Number(a):p;h.style.transition="none",h.style.width=`${p}%`,f.style.transition="none",f.style.width=`${p}%`,f.style.opacity=n?"0.92":"0",h.offsetWidth;const y=n?1250:1100,w=180,T=performance.now()+w,L=S=>1-Math.pow(1-S,3);this.targetCinematicStartTimer=setTimeout(()=>{const S=D=>{const v=Math.min(1,(D-T)/y),E=L(Math.max(0,v)),C=p+(l-p)*E;h.style.width=`${C}%`,n&&(f.style.width=`${p+(l-p)*E}%`,f.style.opacity=`${.92*(1-E)}`);const A=i+(s-i)*E;u.textContent=`${Math.round(p+(l-p)*E)}% -> ${Math.round(l)}%  |  ${this.formatCurrency(A)} -> ${this.formatCurrency(s)}`,v<1?this.targetCinematicAF=requestAnimationFrame(S):(this.targetCinematicAF=null,f.style.opacity="0")};this.targetCinematicAF=requestAnimationFrame(S)},w),this.targetCinematicHideTimer=setTimeout(()=>{c.classList.remove("is-active","is-gain","is-drop")},y+w+700)},scheduleGoalActualsSync(e=260){this.targetSyncTimer&&clearTimeout(this.targetSyncTimer),this.targetSyncTimer=setTimeout(async()=>{try{await this.loadGoalActuals(),this.updateTargetBox({animate:!0})}catch(a){console.error("Wolf OS Target Sync Fault:",a)}},e)},clearTargetValueAnimation(){this.targetValueAF&&(cancelAnimationFrame(this.targetValueAF),this.targetValueAF=null)},animateTargetReadout({fromActual:e,toActual:a,fromPct:t,toPct:s,target:i,percentEl:r,amountEl:d,duration:n=520}){this.clearTargetValueAnimation();const o=performance.now(),c=u=>1-(1-u)*(1-u),g=u=>{const b=Math.min(1,(u-o)/n),h=c(b),f=e+(a-e)*h,m=t+(s-t)*h;r&&(r.textContent=`${Math.round(m)}%`),d&&(d.textContent=`${this.formatCurrency(f)} / ${this.formatCurrency(i)}`),b<1?this.targetValueAF=requestAnimationFrame(g):this.targetValueAF=null};this.targetValueAF=requestAnimationFrame(g)},updateTargetBox(e={}){var L,S,D,v,E,C,A,I;const{animate:a=!0}=e,t=this.getCurrentTargetPeriod(),s=Number(((L=this.goalTargets)==null?void 0:L[t])||0),i=Number(((S=this.goalActuals)==null?void 0:S[t])||0),r=document.getElementById("sidebar-target-percent"),d=document.getElementById("sidebar-target-bar"),n=document.getElementById("sidebar-target-ghost"),o=document.getElementById("sidebar-target-box"),c=document.getElementById("sidebar-target-label"),g=document.getElementById("sidebar-target-state"),u=document.getElementById("sidebar-target-amount");if(!r||!d||!o)return;const b={DAILY:"TODAY TARGET",WEEKLY:"THIS WEEK TARGET",MONTHLY:"THIS MONTH TARGET",QUARTERLY:"THIS QUARTER TARGET",YEARLY:"THIS YEAR TARGET",CUSTOM:"CUSTOM TARGET"};c&&(c.textContent=b[t]||"TARGET");const h=document.getElementById("sidebar-target-select");h&&h.value!==t&&(h.value=t);const f=this.getTargetThemePalette();if(o.style.setProperty("--target-active-color",f.active),o.style.setProperty("--target-glow-color",f.glow),o.style.setProperty("--target-warn-color","#ff2d2d"),o.classList.remove("target-gaining","target-dropping","target-drop-warning","target-changing"),this.clearTargetFxTimers(),s<=0){this.clearTargetValueAnimation(),r.textContent="0%",d.style.width="0%",n&&(n.style.width="0%",n.style.opacity="0"),g&&(g.textContent=`ACTIVE: ${t}`),u&&(u.textContent=`${this.formatCurrency(i)} / ${this.formatCurrency(0)}`),this.targetDisplayPct[t]=0,this.targetLastActual[t]=i,this.targetDisplayedActual[t]=i,this.renderTargetCinematic({period:t,pct:0,previousPct:0,actual:i,previousActual:i,target:0,isGain:!1,isDrop:!1,animate:!1});return}const m=Math.min(100,Math.max(0,i/s*100)),p=((D=this.targetLastActual)==null?void 0:D[t])===null||((v=this.targetLastActual)==null?void 0:v[t])===void 0?i:Number(this.targetLastActual[t]),l=((E=this.targetDisplayPct)==null?void 0:E[t])===null||((C=this.targetDisplayPct)==null?void 0:C[t])===void 0?m:Number(this.targetDisplayPct[t]),y=l<100&&m>=100;g&&(g.textContent=`${m>=100?"REACHED":"ACTIVE"}: ${t}`);const w=((A=this.targetDisplayedActual)==null?void 0:A[t])===null||((I=this.targetDisplayedActual)==null?void 0:I[t])===void 0?p:Number(this.targetDisplayedActual[t]);if(!a||i===p){this.clearTargetValueAnimation(),r.textContent=`${Math.round(m)}%`,u&&(u.textContent=`${this.formatCurrency(i)} / ${this.formatCurrency(s)}`),d.style.width=`${m}%`,n&&(n.style.width=`${m}%`,n.style.opacity="0"),this.targetDisplayPct[t]=m,this.targetLastActual[t]=i,this.targetDisplayedActual[t]=i,this.renderTargetCinematic({period:t,pct:m,previousPct:m,actual:i,previousActual:i,target:s,isGain:!1,isDrop:!1,animate:!1});return}this.animateTargetReadout({fromActual:w,toActual:i,fromPct:l,toPct:m,target:s,percentEl:r,amountEl:u,duration:i>p?560:520}),o.classList.add("target-changing");const T=setTimeout(()=>{o.classList.remove("target-changing")},720);if(this.targetFxTimers.push(T),i>p){n&&(n.style.width=`${m}%`,n.style.opacity="0"),d.style.width=`${m}%`,o.classList.add("target-gaining");const M=setTimeout(()=>{o.classList.remove("target-gaining")},520);this.targetFxTimers.push(M),this.renderTargetCinematic({period:t,pct:m,previousPct:l,actual:i,previousActual:p,target:s,isGain:!0,isDrop:!1,animate:!0})}else{o.classList.add("target-dropping","target-drop-warning"),n&&(n.style.transition="none",n.style.width=`${l}%`,n.style.opacity="0.95",n.offsetWidth),d.style.width=`${m}%`;const M=setTimeout(()=>{o.classList.remove("target-drop-warning")},220);if(this.targetFxTimers.push(M),n){const x=setTimeout(()=>{n.style.transition="width 0.95s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.95s ease",n.style.width=`${m}%`,n.style.opacity="0"},26);this.targetFxTimers.push(x)}const _=setTimeout(()=>{o.classList.remove("target-dropping")},980);this.targetFxTimers.push(_),this.renderTargetCinematic({period:t,pct:m,previousPct:l,actual:i,previousActual:p,target:s,isGain:!1,isDrop:!0,animate:!0})}this.targetDisplayPct[t]=m,this.targetLastActual[t]=i,this.targetDisplayedActual[t]=i,m<100?this.goalReachedCelebrated[t]=!1:y&&!this.goalReachedCelebrated[t]&&(this.goalReachedCelebrated[t]=!0,window.wolfAudio&&window.wolfAudio.play("confetti"))},async addSaleRow(e){const a=document.getElementById("ledger-list-container");if(!a)return;const t=this.renderSingleSaleCard(e,0);a.insertAdjacentHTML("afterbegin",t),this.scheduleGoalActualsSync(),form.addEventListener("submit",async s=>{var g,u;s.preventDefault();const i=skuInput.value.trim(),r=nameInput.value.trim(),d=parseFloat(priceInput.value||"0"),n=unlimitedCheckbox!=null&&unlimitedCheckbox.checked?999999:parseInt(qtyInput.value||"0",10),o=((g=document.getElementById("master-desc"))==null?void 0:g.value)||null,c=((u=document.getElementById("master-brand"))==null?void 0:u.value)||null;if(!r||!n||!d){statusEl&&(statusEl.textContent="Name, quantity, and price are required.");return}if(!i&&!selectedImageUrl){statusEl&&(statusEl.textContent="Please select one image before adding to sales.");return}try{let h=form.dataset.productId||null;if(!h){const{data:p,error:l}=await supabaseClient.from("products").insert({sku:i||void 0,name:r,description:o,price:d,qty:n,image_url:selectedImageUrl||null,is_active:!0}).select().single();if(l)throw l;h=p.productid}const{data:f,error:m}=await supabaseClient.from("sales").insert({productid:h,qty:n,price:d}).select().single();if(m)throw m;window.wolfData&&typeof window.wolfData.addSaleRow=="function"&&window.wolfData.addSaleRow(f),statusEl&&(statusEl.textContent="Sale added."),modal.style.display="none"}catch(b){console.error(b),statusEl&&(statusEl.textContent="Error adding sale.")}})},updateSaleRow(e){const a=this.salesData.findIndex(t=>t.id===e.id);a>-1&&(this.salesData[a]=e),this.updateLedgerRevenue(),Toastify({text:`Sale updated: ${e.id}`,duration:2e3,gravity:"top",position:"right"}).showToast()},removeSaleRow(e){const a=document.getElementById(`row-${e}`);a&&(a.classList.add("removing"),setTimeout(()=>a.remove(),400)),this.allSales=(this.allSales||[]).filter(t=>t.id!==e),this.refreshSummaryHUD(),this.scheduleGoalActualsSync(),alert("test")},updateProductUI(e){Toastify({text:`Product updated: ${e.name}`,duration:2e3,gravity:"top",position:"right",backgroundColor:"#ff9800"}).showToast()},updateLedgerRevenue(){const e=document.getElementById("ledger-summary-amount");if(!e)return;const a=(this.allSales||[]).reduce((t,s)=>t+Number(s.total_amount||0),0);if(this.currentTotal===0&&a!==0){this.currentTotal=a,e.textContent=this.formatCurrency(a);return}a!==this.currentTotal&&(a>this.currentTotal?e.className="summary-value increasing":e.className="summary-value decreasing",this.animateNumber(e,this.currentTotal,a),this.currentTotal=a)},async syncServerTime(){console.log("Wolf OS: Synchronizing with Atomic Clock...");try{const{data:e,error:a}=await supabaseClient.rpc("get_server_time");if(a)throw a;const t=Array.isArray(e)?e[0]:e;if(t)this.selectedDate=new Date(t),this.serverToday=new Date(t);else throw new Error("No timestamp returned")}catch(e){console.error("Wolf OS: Sync Fault. Falling back to system clock.",e),this.selectedDate=new Date,this.serverToday=new Date}isNaN(this.selectedDate.getTime())&&(this.selectedDate=new Date,this.serverToday=new Date)},async syncTime(){console.log("Wolf OS: Syncing with Atomic Server Clock...");try{const{data:e,error:a}=await supabaseClient.rpc("get_server_time");if(e&&e[0]){const t=e[0].server_date.split("-");this.serverToday=new Date(t[0],t[1]-1,t[2]),this.selectedDate=new Date(this.serverToday)}}catch(e){console.warn("Wolf OS: Time Sync Failed, using local clock.")}return this.selectedDate},get realTodayIndex(){return new Date().getDay()},get realTodayISO(){return new Date().toISOString().split("T")[0]},async initLedger(e){this.activeMode=e,this.lastTotal=0,this.summaryHUDReady=!1,await this.syncTime();const a=document.getElementById("ledger-title"),t=document.getElementById("ledger-summary-label"),s=document.getElementById("ledger-search-container");a&&(e==="sales"?(a.innerText="SALES",t.innerText="Daily Income Summary"):(a.innerText="LOGBOOK",t.innerText="Floor Income Summary")),s&&(s.style.display="block",s.classList.remove("active")),this.syncNavigationUI(e),this.initChrono(e),await this.syncServerTime(),await this.loadGoalTargets()},initChrono(e){if(this.fp&&typeof this.fp.destroy=="function")try{this.fp.destroy()}catch(r){console.warn("Wolf OS: Non-critical - could not destroy old flatpickr instance.")}this.fp=null;const a=document.getElementById("chrono-picker-trigger"),t=document.getElementById("hidden-chrono-input");if(!t){console.error("Wolf OS: Chrono Input not found in DOM.");return}const s=this.serverToday||new Date,i=flatpickr(t,{disableMobile:!0,maxDate:s,animate:!0,positionElement:a,position:"below",onReady:(r,d,n)=>{const o=n.calendarContainer;o.classList.remove("wolf-calendar-v2","wolf-calendar-v3"),o.classList.add("wolf-calendar"),o.classList.remove("open")},onOpen:(r,d,n)=>{requestAnimationFrame(()=>{n.calendarContainer.classList.add("open")})},onClose:(r,d,n)=>{n.calendarContainer.classList.remove("open")},onChange:r=>{r.length>0&&(this.selectedDate=r[0],this.calculateWeek(e))}});this.fp=Array.isArray(i)?i[0]:i,a&&this.fp&&(a.onclick=null,a.onclick=r=>{r.preventDefault(),r.stopPropagation(),this.fp.isOpen?this.fp.close():this.fp.open()}),this.calculateWeek(e)},calculateWeek(e){const a=new Date(this.selectedDate),t=a.getDay(),s=new Date(a);s.setDate(a.getDate()-t);const i=new Date(s);i.setDate(s.getDate()+6),this.updateChronoUI(s,i,t,e)},shiftWeek(e,a){this.selectedDate.setDate(this.selectedDate.getDate()+e),this.calculateWeek(a)},async updateChronoUI(e,a,t){if(!e||isNaN(e.getTime())||!a||isNaN(a.getTime()))return;this.fp&&typeof this.fp.setDate=="function"&&this.fp.setDate(this.selectedDate,!1);const s=h=>h.toLocaleDateString("en-US",{month:"short",day:"numeric"}).toUpperCase(),i=document.getElementById("week-range-display");i&&(i.innerText=`${s(e)} - ${s(a)}`);const r=this.serverToday||new Date,d=r.toLocaleDateString("en-CA"),n=new Date(r);n.setDate(r.getDate()-r.getDay());const o=n.toLocaleDateString("en-CA"),c=e.toLocaleDateString("en-CA"),g=document.getElementById("snap-today-btn");if(g){const h=c<o;g.classList.toggle("visible",h),g.disabled=!h,g.tabIndex=h?0:-1,g.setAttribute("aria-hidden",h?"false":"true"),g.style.pointerEvents=h?"":"none"}document.querySelectorAll("#ledger-day-picker .day-btn").forEach((h,f)=>{const m=new Date(e);m.setDate(e.getDate()+f);const p=m.toLocaleDateString("en-CA");h.setAttribute("data-date",p),h.classList.toggle("active",f===t),h.disabled=p>d});const b=this.selectedDate.toLocaleDateString("en-CA");this.isReadOnly=b!==d,this.applyLockdownUI(),this.activeMode==="sales"?await this.loadSales():await this.loadLogbook()},currentLogDay:new Date().getDay(),currentSalesDay:new Date().getDay(),realToday:new Date().getDay(),salesDataCache:[],sanitizePlain(e){const a=String(e!=null?e:"");return window.DOMPurify?window.DOMPurify.sanitize(a,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]}):a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},parseLogNotes(e=""){var n,o,c;const a=String(e||""),t=a.match(/\|MEMBERSHIP:([^|]+)/i),s=a.match(/\|PAID:([0-9]+(?:\.[0-9]+)?)/i),i=a.match(/^WALK-IN:\s*([^|]+)/i),r=a.match(/^MEMBER_ENTRY:\s*([^|]+)/i),d=a.replace(/\|MEMBERSHIP:[^|]*/gi,"").replace(/\|PAID:[^|]*/gi,"").trim();return{raw:a,baseNote:d,membershipLabel:((n=t==null?void 0:t[1])==null?void 0:n.trim())||"",isPaidFromNote:!!s,paidAmountFromNote:s?Number(s[1]):null,walkInName:((o=i==null?void 0:i[1])==null?void 0:o.trim())||"",memberToken:((c=r==null?void 0:r[1])==null?void 0:c.trim())||""}},buildLogNotes(e,a,t,s){const r=[String(e||"").trim()||"WALK-IN: GUEST"];return a&&r.push(`MEMBERSHIP:${String(a).trim().toUpperCase()}`),t&&r.push(`PAID:${Number(s||0).toFixed(2)}`),r.join("|")},async loadLogbook(e={}){window.salesManager&&(window.salesManager.currentTrashMode="logbook");const a=document.getElementById("ledger-list-container");if(!a)return;a.children.length===0&&(a.innerHTML=`<div style="text-align:center; padding:50px; opacity:0.3;"><i class='bx bx-loader-alt bx-spin' style='font-size:2rem;'></i></div>`);const t=this.selectedDate.toLocaleDateString("en-CA");try{e!=null&&e.preservePage||(this.currentLedgerPage=1);const{data:s,error:i}=await supabaseClient.from("check_in_logs").select("*").gte("time_in",`${t}T00:00:00+08:00`).lte("time_in",`${t}T23:59:59+08:00`).order("time_in",{ascending:!1});if(i)throw i;const r=s||[],d=[...new Set(r.map(l=>l.profile_id).filter(Boolean))];let n=new Map;if(d.length>0){const{data:l,error:y}=await supabaseClient.from("members").select("profile_id, full_name, member_code").in("profile_id",d);!y&&l&&(n=new Map(l.map(w=>[w.profile_id,w])))}let o=r.map(l=>{var _,x,O,R,k;const y=this.parseLogNotes(l.notes),w=l.profile_id?n.get(l.profile_id):null,T=((_=y.memberToken.match(/ME-[A-Z0-9]{2,}/i))==null?void 0:_[0])||"",L=y.memberToken.replace(/ME-[A-Z0-9]{2,}/gi,"").trim(),S=!!(w||T||l.profile_id),D=(w==null?void 0:w.full_name)||y.walkInName||L||y.memberToken||"Walk-in Guest",v=this.sanitizePlain(D).toUpperCase(),E=this.sanitizePlain(String((w==null?void 0:w.member_code)||T||"").toUpperCase()),C=this.sanitizePlain(String(l.membership_label||y.membershipLabel||(S?"MONTHLY MEMBERSHIP":"REGULAR (NON-MEMBER)")).toUpperCase()),A=Number((O=(x=l.entry_fee)!=null?x:y.paidAmountFromNote)!=null?O:S?0:this.defaultWalkInFee),I=!!(typeof l.is_paid=="boolean"?l.is_paid:y.isPaidFromNote),M=Number((k=l.paid_amount)!=null?k:I?(R=y.paidAmountFromNote)!=null?R:A:0);return{...l,resolvedName:v,memberCode:E,membershipLabel:C,entryFee:A,isPaid:I,paidAmount:I?M:0,noteBase:y.baseNote}});const c=document.getElementById("ledger-main-search");if(c&&c.value){const l=c.value.toLowerCase();o=o.filter(y=>y.resolvedName.toLowerCase().includes(l)||y.membershipLabel.toLowerCase().includes(l)||y.memberCode.toLowerCase().includes(l))}const g=document.getElementById("ledger-summary-label"),u=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];g&&(g.innerText=`${u[this.selectedDate.getDay()]} Floor Income`);const b=o.reduce((l,y)=>l+(y.isPaid?Number(y.paidAmount||0):0),0);if(this.refreshSummaryHUD(b),o.length===0){a.innerHTML=`<div style="text-align:center; padding:80px; opacity:0.2;"><i class='bx bx-user-x' style='font-size:3rem;'></i><p style="font-size:10px; font-weight:900; margin-top:10px;">NO DATA LOGGED</p></div>`;return}this.currentLedgerRows=o;const h=o.length,f=Math.max(1,Math.ceil(h/this.ledgerPageSize));this.currentLedgerPage>f&&(this.currentLedgerPage=f);const m=(this.currentLedgerPage-1)*this.ledgerPageSize,p=o.slice(m,m+this.ledgerPageSize);a.innerHTML=p.map((l,y)=>{const w=l.time_out!==null,T=this.formatServerClock(l.time_in),L=w?this.formatServerClock(l.time_out):"--:--",S=l.isPaid?"badge-paid":"badge-unpaid",D=l.isPaid?"PAID":"UNPAID",v=w?"UNDO CHECK OUT":"CHECK OUT",E=w?`OUT ${L}`:"ACTIVE",C=w?"btn-logbook-neutral":"btn-logbook-danger",A=l.isPaid?"UNDO PAID":`COLLECT ${this.formatCurrency(l.entryFee)}`,I=l.isPaid?"btn-logbook-neutral":"btn-logbook-success",M=this.isReadOnly?"disabled":"";return`
          <div class="list-item-card" id="row-${l.id}" style="animation-delay: ${y*.04}s;">
            <div class="card-header logbook-card-header" style="margin-bottom:0;">
              <div class="status-icon logbook-status-icon ${w?"":"active"}" style="background:var(--bg-dark); color:var(--wolf-red);">
                <i class='bx ${w?"bx-check":"bx-time-five"}'></i>
              </div>
              <div class="item-info logbook-item-info">
                <h4>${l.resolvedName}</h4>
                <div class="sub">${l.memberCode?`MEMBER • ${l.memberCode}`:l.membershipLabel}</div>
                <div class="time">IN: ${T}</div>
              </div>
              <div class="logbook-inline-kpis">
                <div class="kpi-item">
                  <span class="kpi-label">CHECK-IN</span>
                  <span class="kpi-val">${T}</span>
                </div>
                <div class="kpi-item">
                  <span class="kpi-label">ENTRY FEE</span>
                  <span class="kpi-val">${this.formatCurrency(l.entryFee)}</span>
                </div>
              </div>
              <div class="card-actions logbook-card-actions" style="display:flex; align-items:center; gap:8px;">
                <span class="status-badge ${S}">${D}</span>
                ${this.isReadOnly?"":`<i class='bx bx-trash' style="cursor:pointer; color:#333; font-size:14px;" onclick="wolfData.deleteLog('${l.id}')"></i>`}
              </div>
            </div>
            <div class="logbook-actions">
              <button class="logbook-action-btn ${C}" ${M} onclick="wolfData.toggleLogCheckout('${l.id}', ${w})">
                <span class="btn-main">${v}</span>
                <span class="btn-sub">${E}</span>
              </button>
              <button class="logbook-action-btn ${I}" ${M} onclick="wolfData.toggleLogPaid('${l.id}', ${l.isPaid}, ${l.entryFee})">
                <span class="btn-main">${A}</span>
                <span class="btn-sub">${l.isPaid?"SET UNPAID":"MARK AS PAID"}</span>
              </button>
            </div>
          </div>`}).join(""),a.innerHTML+=this.renderLedgerPagination(h,f)}catch(s){console.error("Wolf OS Logbook Fault:",s)}},async loadSales(){if(window.salesManager&&(window.salesManager.currentTrashMode="sales"),this.isFetching)return;this.isFetching=!0;const e=document.getElementById("ledger-list-container");if(!e)return;e.children.length===0&&(e.innerHTML=`<div style="text-align:center; padding:50px; opacity:0.3;"><i class='bx bx-loader-alt bx-spin' style='font-size:2rem;'></i></div>`);const a=this.selectedDate.toLocaleDateString("en-CA");try{this.currentLedgerPage=1;const{data:t,error:s}=await supabaseClient.from("sales").select("*, products(name, sku, image_url, brand)").gte("created_at",`${a}T00:00:00+08:00`).lte("created_at",`${a}T23:59:59+08:00`).order("created_at",{ascending:!1});if(s)throw s;this.allSales=t||[];const i=document.getElementById("ledger-main-search"),r=i?i.value:"";this.renderSales(this.selectedDate.getDay(),r),this.scheduleGoalActualsSync()}catch(t){console.error("Wolf OS Sales Fault:",t)}finally{this.isFetching=!1}},renderSales(e,a=""){const t=document.getElementById("ledger-list-container");if(!t)return;const s=document.getElementById("ledger-summary-label"),i=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];s&&(s.innerText=`${i[e]} Total Income`);let r=[...this.allSales];if(a!==""){const u=a.toLowerCase();r=r.filter(b=>{var m,p;const h=String(((m=b.products)==null?void 0:m.name)||"").toLowerCase(),f=String(((p=b.products)==null?void 0:p.sku)||"").toLowerCase();return h.includes(u)||f.includes(u)})}const d=r.reduce((u,b)=>u+Number(b.total_amount||0),0);if(this.refreshSummaryHUD(d),r.length===0){t.innerHTML=`<div style="text-align:center; padding:80px; opacity:0.2;"><i class='bx bx-shopping-bag' style='font-size:3rem;'></i><p style="font-size:10px; font-weight:900; margin-top:10px;">NO DATA LOGGED</p></div>`;return}this.currentLedgerRows=r;const n=r.length,o=Math.max(1,Math.ceil(n/this.ledgerPageSize));this.currentLedgerPage>o&&(this.currentLedgerPage=o);const c=(this.currentLedgerPage-1)*this.ledgerPageSize,g=r.slice(c,c+this.ledgerPageSize);t.innerHTML=g.map((u,b)=>{var w,T,L,S;const h=Number(u.total_amount||0),f=DOMPurify.sanitize(((w=u.products)==null?void 0:w.name)||"Item"),m=DOMPurify.sanitize(((T=u.products)==null?void 0:T.sku)||"N/A"),p=DOMPurify.sanitize(((L=u.products)==null?void 0:L.brand)||""),l=DOMPurify.sanitize(String(((S=u.products)==null?void 0:S.image_url)||"/assets/images/placeholder.png")),y=new Date(u.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return`
        <div class="list-item-card sale-row-card" id="row-${u.id}" style="animation-delay: ${b*.06}s;">
          <div class="card-header sale-card-header" style="margin-bottom: 0;">
            <div class="status-icon sale-thumb" style="background: var(--bg-dark); color: var(--wolf-red); overflow:hidden;">
              <img src="${l}" alt="${f}" onerror="this.onerror=null;this.src='/assets/images/placeholder.png';" />
            </div>
            <div class="item-info sale-item-info">
              <h4>${f.toUpperCase()}</h4>
              <div class="sub">${m.toUpperCase()}${p?` • ${p.toUpperCase()}`:""}</div>
              <div class="time">${y} • x${u.qty}</div>
            </div>
            <div class="card-actions sale-card-actions">
              <div class="sale-price-chip">${this.formatCurrency(h)}</div>
              ${this.isReadOnly?"":`<button type="button" class="sale-delete-btn" onclick="wolfData.deleteSale('${u.id}')" aria-label="Delete sale"><i class='bx bxs-trash'></i></button>`}
            </div>
          </div>
        </div>`}).join(""),t.innerHTML+=this.renderLedgerPagination(n,o)},renderLedgerPagination(e,a){return e<=this.ledgerPageSize?"":`
      <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-top:10px;">
        <button onclick="wolfData.setLedgerPage(${this.currentLedgerPage-1})" ${this.currentLedgerPage<=1?"disabled":""} style="width:34px; height:34px; border-radius:10px; border:1px solid rgba(255,255,255,0.16); background:rgba(255,255,255,0.06); color:#e7edf8;"><i class='bx bx-chevron-left'></i></button>
        <span style="font-size:10px; letter-spacing:1px; text-transform:uppercase; color:#97a4ba;">Page ${this.currentLedgerPage} of ${a}</span>
        <button onclick="wolfData.setLedgerPage(${this.currentLedgerPage+1})" ${this.currentLedgerPage>=a?"disabled":""} style="width:34px; height:34px; border-radius:10px; border:1px solid rgba(255,255,255,0.16); background:rgba(255,255,255,0.06); color:#e7edf8;"><i class='bx bx-chevron-right'></i></button>
      </div>
    `},setLedgerPage(e){const a=Number(e);if(!(!Number.isFinite(a)||a<1)){if(this.currentLedgerPage=a,this.activeMode==="sales"){const t=document.getElementById("ledger-main-search");this.renderSales(this.selectedDate.getDay(),t?t.value:"");return}this.loadLogbook({preservePage:!0})}},updateDayUI(e,a){a=parseInt(a),this.realToday=new Date().getDay();const t=e==="logbook"?"#logbook-day-picker":"#sales-day-picker";document.querySelectorAll(`${t} .day-btn`).forEach(i=>{const r=parseInt(i.getAttribute("data-day"));i.classList.toggle("active",r===a),r>this.realToday?i.disabled=!0:i.disabled=!1}),this.isReadOnly=a!==this.realToday,this.applyLockdownUI()},applyLockdownUI(){var s,i;const e=document.querySelector(".icon-btn.red"),a=(s=document.querySelector(".icon-btn:not(.red) i.bx-trash"))==null?void 0:s.parentElement,t=document.querySelector(".brand");this.isReadOnly?(e&&e.classList.add("crud-hidden"),a&&a.classList.add("crud-hidden"),t&&!document.querySelector(".archive-mode-indicator")&&t.insertAdjacentHTML("beforebegin",'<span class="archive-mode-indicator">[ ARCHIVE_LOCKED ]</span>')):(e&&e.classList.remove("crud-hidden"),a&&a.classList.remove("crud-hidden"),(i=document.querySelector(".archive-mode-indicator"))==null||i.remove())},toggleReadOnlyMode(e){var s;const a=document.querySelector(".icon-btn.red"),t=(s=document.querySelector(".icon-btn:not(.red) i.bx-trash"))==null?void 0:s.parentElement;a&&a.classList.toggle("crud-hidden",e),t&&t.classList.toggle("crud-hidden",e),this.isReadOnly=e},async toggleLogCheckout(e,a){if(!this.isReadOnly)try{let t=new Date().toISOString();try{const{data:r,error:d}=await supabaseClient.rpc("get_server_time");if(!d&&r){const n=Array.isArray(r)?r[0]:r;if(typeof n=="string")t=new Date(n).toISOString();else if(n&&typeof n=="object"){const o=n.server_iso_timestamp||n.server_time||n.now||n.timestamp;o&&(t=new Date(o).toISOString())}}}catch(r){}const s=a?null:t,{error:i}=await supabaseClient.from("check_in_logs").update({time_out:s}).eq("id",e);if(i)throw i;window.wolfAudio&&window.wolfAudio.play("notif"),await this.loadLogbook()}catch(t){console.error("Wolf OS Checkout Toggle Fault:",t),window.wolfAudio&&window.wolfAudio.play("error")}},async toggleLogPaid(e,a,t=0){var s,i,r;if(!this.isReadOnly)try{const{data:d,error:n}=await supabaseClient.from("check_in_logs").select("*").eq("id",e).single();if(n||!d)throw n||new Error("Log row not found");const o=this.parseLogNotes(d.notes),c=String(d.membership_label||o.membershipLabel||(d.profile_id?"MONTHLY MEMBERSHIP":"REGULAR (NON-MEMBER)")).trim().toUpperCase(),g=Number((r=(i=(s=d.entry_fee)!=null?s:o.paidAmountFromNote)!=null?i:t)!=null?r:d.profile_id?0:this.defaultWalkInFee),u=!a,b=u?g:0,h=u?new Date().toISOString():null,f=this.buildLogNotes(o.baseNote,c,u,b),m={notes:f,membership_label:c,entry_fee:g,is_paid:u,paid_amount:b,paid_at:h};let{error:p}=await supabaseClient.from("check_in_logs").update(m).eq("id",e);if(p&&/column .* does not exist|schema cache|invalid input syntax/i.test(String(p.message||""))&&(p=(await supabaseClient.from("check_in_logs").update({notes:f}).eq("id",e)).error),p)throw p;window.wolfAudio&&window.wolfAudio.play("success"),await this.loadLogbook()}catch(d){console.error("Wolf OS Payment Toggle Fault:",d),window.wolfAudio&&window.wolfAudio.play("error")}},async deleteLog(e){if(!(!window.Swal||!(await window.Swal.fire({title:"REMOVE ENTRY?",html:'<p class="wolf-swal-text">WARNING: THIS RECORD WILL BE MOVED TO TRASH bin. PROCEED?</p>',showCancelButton:!0,confirmButtonText:"REMOVE",cancelButtonText:"CANCEL",background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup-orange",confirmButton:"wolf-swal-confirm-orange",cancelButton:"wolf-swal-cancel"}})).isConfirmed))try{const t=document.getElementById(`row-${e}`);t&&(t.classList.add("removing"),await new Promise(i=>setTimeout(i,400)),t.remove());const{data:s}=await supabaseClient.from("check_in_logs").select("*").eq("id",e).single();await supabaseClient.from("trash_bin").insert([{original_id:e,table_name:"check_in_logs",deleted_data:s}]),await supabaseClient.from("check_in_logs").delete().eq("id",e),window.wolfAudio&&window.wolfAudio.play("notif"),await this.loadLogbook()}catch(t){console.error(t)}},async adjustSaleQty(e,a=0){var s,i,r,d;if(this.isReadOnly)return;const t=Number(a);if(!(t!==1&&t!==-1))try{const n=(this.allSales||[]).find(w=>w.id===e),{data:o,error:c}=await supabaseClient.from("sales").select("id, product_id, qty, unit_price, total_amount").eq("id",e).single();if(c||!o)throw c||new Error("SALE_NOT_FOUND");const g=Number(o.qty||0),u=g+t;if(u<1){(s=window.salesManager)==null||s.showSystemAlert("MINIMUM QTY IS 1. USE DELETE TO REMOVE ITEM.","warning");return}const{data:b,error:h}=await supabaseClient.from("products").select("qty, name").eq("productid",o.product_id).single();if(h||!b)throw h||new Error("PRODUCT_NOT_FOUND");const f=Number(b.qty||0),m=f<999999;if(t>0&&m&&f<1){(r=window.salesManager)==null||r.showSystemAlert(`OUT OF STOCK: ${String(b.name||((i=n==null?void 0:n.products)==null?void 0:i.name)||"PRODUCT").toUpperCase()}`,"error");return}if(m){const w=t>0?f-1:f+1,{error:T}=await supabaseClient.from("products").update({qty:w}).eq("productid",o.product_id);if(T)throw T}const l=Number(o.unit_price||(g>0?Number(o.total_amount||0)/g:0))*u,{error:y}=await supabaseClient.from("sales").update({qty:u,total_amount:l}).eq("id",e);if(y)throw y;window.wolfAudio&&window.wolfAudio.play("click"),await this.loadSales(),this.scheduleGoalActualsSync()}catch(n){console.error("Sale qty adjust fault:",n),window.wolfAudio&&window.wolfAudio.play("error"),(d=window.salesManager)==null||d.showSystemAlert("FAILED TO UPDATE SALE QTY","error")}},async deleteSale(e){if(!window.Swal||!(await window.Swal.fire({title:"REMOVE PRODUCT?",html:`
      <div style="color: #b47023; font-size: 4.5rem; margin-bottom: 10px;">
        <i class='bx bx-error-alt'></i>
      </div>
      <p class="wolf-swal-text" style="text-transform: uppercase; letter-spacing: 1px;">
        WARNING: THIS RECORD WILL BE MOVED TO TRASH BIN. PROCEED?
      </p>
    `,showCancelButton:!0,confirmButtonText:"REMOVE",cancelButtonText:"CANCEL",reverseButtons:!0,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup-orange",title:"wolf-swal-title",confirmButton:"wolf-swal-confirm-orange",cancelButton:"wolf-swal-cancel"}})).isConfirmed)return;const t=document.getElementById(`row-${e}`);try{t&&(t.classList.add("removing"),await new Promise(o=>setTimeout(o,400)),t.remove());const{data:s,error:i}=await supabaseClient.from("sales").select("*").eq("id",e).single();if(i||!s)throw i;const{data:r}=await supabaseClient.from("products").select("qty, name").eq("productid",s.product_id).single();r&&r.qty<999999&&await supabaseClient.from("products").update({qty:r.qty+s.qty}).eq("productid",s.product_id),await supabaseClient.from("trash_bin").insert([{original_id:e,table_name:"sales",deleted_data:s}]),await supabaseClient.from("sales").delete().eq("id",e),this.allSales=(this.allSales||[]).filter(o=>o.id!==e);const d=this.allSales.reduce((o,c)=>o+Number(c.total_amount||0),0);this.refreshSummaryHUD(d),this.scheduleGoalActualsSync();const n=`${(r==null?void 0:r.name)||"Product"}, X${s.qty} WAS REMOVED`;window.salesManager.showSystemAlert(n,"success"),Toastify({text:n,duration:5e3,gravity:"top",position:"right",stopOnFocus:!0,style:{border:"1px solid #ff9800",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast(),window.wolfAudio&&window.wolfAudio.play("success")}catch(s){console.error("Void Protocol Fault:",s),window.wolfAudio&&window.wolfAudio.play("error"),this.loadSales()}},async reopenLog(e){await supabaseClient.from("check_in_logs").update({time_out:null}).eq("id",e),this.loadLogbook(this.currentLogDay)},addLogbookRow(){this.loadLogbook()},updateLogbookRow(){this.loadLogbook()},removeLogbookRow(){this.loadLogbook()}};window.wolfData=wolfData,wolfData.addSaleRow=function(e){Array.isArray(this.salesData)||(this.salesData=[]),this.salesData.push(e);const a=document.querySelector("#sales-table-body");if(a){const t=document.createElement("tr");t.id=`sale-row-${e.id}`,t.innerHTML=`
      <td>${e.id}</td>
      <td>${e.product_name}</td>
      <td>${e.quantity}</td>
      <td>${e.price}</td>
      <td>${(e.quantity*e.price).toFixed(2)}</td>
      <td><button onclick="wolfData.deleteSale('${e.id}')">Delete</button></td>
    `,a.appendChild(t)}this.updateLedgerRevenue(),this.scheduleGoalActualsSync()},wolfData.removeSaleRow=function(e){this.allSales=(this.allSales||[]).filter(t=>t.id!==e);const a=document.getElementById(`row-${e}`);a&&a.remove(),this.updateLedgerRevenue(),this.scheduleGoalActualsSync()},wolfData.initRealtime=async function(){if(this.updateLedgerRevenue(),this.scheduleGoalActualsSync(50),this.realtimeChannel)return;this.selectedDate||await this.syncServerTime();const e=supabaseClient.channel("wolf-ledger-sync-stable").on("postgres_changes",{event:"INSERT",schema:"public",table:"sales"},t=>{if(this.scheduleGoalActualsSync(80),this.activeMode!=="sales")return;const s=t.new;this.allSales.unshift(s),this.renderSales(this.selectedDate.getDay())}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"sales"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="sales"&&(this.updateSaleRow(t.new),this.updateLedgerRevenue(),Toastify({text:`Sale updated: ${t.new.id}`,duration:5e3,gravity:"top",position:"right"}).showToast())}).on("postgres_changes",{event:"DELETE",schema:"public",table:"sales"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="sales"&&this.removeSaleRow(t.old.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"check_in_logs"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="logbook"&&(this.addLogbookRow(t.new),Toastify({text:`Log added: ${t.new.id}`,duration:5e3,gravity:"top",position:"right",style:{border:"1px solid #4dff00",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast())}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"check_in_logs"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="logbook"&&(this.updateLogbookRow(t.new),Toastify({text:`Log updated: ${t.new.id}`,duration:5e3,gravity:"top",position:"right",style:{border:"1px solid #6fff00",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast())}).on("postgres_changes",{event:"DELETE",schema:"public",table:"check_in_logs"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="logbook"&&(this.removeLogbookRow(t.old.id),Toastify({text:`Log removed: ${t.old.id}`,duration:5e3,gravity:"top",position:"right",style:{border:"1prgb(255, 0, 0) #ff9800",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast())}),{error:a}=await e.subscribe(t=>{var s;t==="SUBSCRIBED"&&((s=this.showRealtimeToast)==null||s.call(this))});if(a){Toastify({text:"Realtime subscription failed",duration:5e3,gravity:"top",position:"right",backgroundColor:"#f44336"}).showToast(),console.error("Realtime subscription failed:",a);return}this.realtimeChannel=e},wolfData.updateLedgerRevenue=function(){const e=document.getElementById("ledger-summary-amount");if(!e)return;const a=(this.allSales||[]).reduce((t,s)=>t+Number(s.total_amount||0),0);e.textContent=this.formatCurrency(a)},wolfData.showRealtimeToast=function(){const e=document.createElement("span");e.innerHTML=DOMPurify.sanitize(`
    <i class="bx bx-rfid" style="margin-right: 8px; font-size:18px; color:var(--wolf-red);"></i>
    LIVE_SYNC_ESTABLISHED
  `),Toastify({node:e,duration:5e3,gravity:"top",position:"right",style:{background:"#0a0a0a",border:"1px solid #ffffff",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast()},document.addEventListener("input",e=>{if(e.target.id==="ledger-main-search"){const a=e.target.value.trim(),t=document.getElementById("search-clear-btn");t&&(t.style.display=a.length>0?"block":"none"),wolfData.currentLedgerPage=1,wolfData.activeMode==="sales"?wolfData.renderSales(wolfData.selectedDate.getDay(),a):wolfData.loadLogbook()}}),document.addEventListener("click",async e=>{if(e.target.closest("#muteToggleBtn")){e.preventDefault(),e.stopPropagation(),window.wolfAudio.toggleMute()||window.wolfAudio.play("notif");return}const t=wolfData.activeMode,s=(wolfData.serverToday||new Date).toLocaleDateString("en-CA"),i=e.target.closest("#toggle-search-btn");if(i){const o=i.closest("#sales-main-view, #logbook-main-view, #main-content, .ledger-page-wrapper")||document,c=o.querySelector("#ledger-search-container"),g=o.querySelector("#ledger-main-search");if(c&&g){e.preventDefault(),e.stopPropagation();const u=c.classList.toggle("active");if(i.classList.toggle("active",u),u)setTimeout(()=>{g.focus()},180),window.wolfAudio&&window.wolfAudio.play("notif");else{g.value="";const b=o.querySelector("#search-clear-btn");b&&(b.style.display="none"),wolfRefreshView()}return}}const r=e.target.closest("#prev-week-btn, #next-week-btn");if(r){const o=r.id==="prev-week-btn"?-7:7,c=new Date,g=c.toLocaleDateString("en-CA"),u=new Date(wolfData.selectedDate);u.setDate(u.getDate()+o);const b=u.toLocaleDateString("en-CA");if(o>0)if(b>g)if(wolfData.selectedDate.toLocaleDateString("en-CA")===g){window.salesManager&&window.salesManager.showSystemAlert("CHRONOLOCK_ACTIVE: FUTURE PROJECTION BLOCKED","error");return}else console.log("WolfChrono: Jump exceeds today. Snapping to current date."),wolfData.selectedDate=c;else wolfData.selectedDate=u;else wolfData.selectedDate=u;wolfData.calculateWeek(t);return}if(e.target.closest("#chrono-picker-trigger")){wolfData.fp&&wolfData.fp.open();return}const d=e.target.closest(".day-btn");if(d){const o=d.getAttribute("data-date");if(o){if(o>s){window.salesManager&&window.salesManager.showSystemAlert("INVALID_PROTOCOL: FUTURE_DATE_LOCKED","error");return}const c=o.split("-");wolfData.selectedDate=new Date(c[0],c[1]-1,c[2]),wolfData.calculateWeek(t)}}if(e.target.closest("#add-ledger-btn")){const o=wolfData.activeMode;window.wolfAudio&&window.wolfAudio.play("notif"),wolfData.activeMode==="sales"?window.salesManager.openSaleTerminal():window.logbookManager.openLogbookTerminal()}if(e.target.closest("#clear-ledger-btn")){const o=wolfData.activeMode;Toastify({text:`Opening ${o.toUpperCase()} Trash Bin...`,duration:5e3,gravity:"top",position:"right",style:{background:"#343434",borderRadius:"10px",fontWeight:"bold",color:"#fff"}}).showToast(),window.salesManager&&window.salesManager.openTrashBin(o)}const n=e.target.closest("#snap-today-btn");if(n){if(!n.classList.contains("visible")||n.disabled)return;console.log("WolfChrono: Snap-to-Today triggered."),await wolfData.syncServerTime(),wolfData.fp&&wolfData.fp.setDate(wolfData.selectedDate,!1),wolfData.calculateWeek(wolfData.activeMode),window.salesManager&&window.salesManager.showSystemAlert("RETURNED TO TODAY'S WEEK!","success");return}}),document.addEventListener("click",()=>{setTimeout(()=>{const e=document.getElementById("week-range-display");if(e&&(e.innerText==="--- - ---"||e.innerText==="")){const a=document.getElementById("sales-day-picker")?"sales":"logbook";console.log(`WolfChrono: Auto-initializing ${a} view...`),wolfData.initChrono(a)}},100)}),window.addEventListener("load",()=>{const a=new URLSearchParams(window.location.search).get("p")||"home";wolfData.syncNavigationUI(a),setTimeout(()=>{wolfData.loadGoalTargets().catch(()=>{})},300),(a==="sales"||a==="logbook")&&setTimeout(async()=>{document.getElementById("ledger-page")&&(wolfData.syncServerTime&&await wolfData.syncServerTime(),await wolfData.initLedger(a),wolfData.initRealtime())},500)});
