async function moveToTrash(e,a,t){console.log(`Wolf OS: Moving ${a} from ${e} to Trash...`);const{error:i}=await supabaseClient.from("trash_bin").insert([{original_table:e,original_id:a,payload:t}]);if(i)throw i}window.wolfData=null;const wolfData={selectedDate:new Date,serverToday:new Date,activeMode:"sales",isFetching:!1,allSales:[],currentLedgerPage:1,ledgerPageSize:12,currentLedgerRows:[],lastTotal:0,activeAF:null,lastTraffic:0,summaryHUDReady:!1,searchLayoutBound:!1,salesFilterMode:"all",salesSortMode:"latest",salesMinAmount:0,salesInsights:{mostSoldName:"NO SALES YET",mostSoldQty:0,mostSoldAmount:0,previousTotal:0},searchToggleBound:!1,currencySymbol:"₱",defaultWalkInFee:80,goalTargets:{DAILY:0,WEEKLY:0,MONTHLY:0,QUARTERLY:0,YEARLY:0,CUSTOM:0},goalActuals:{DAILY:0,WEEKLY:0,MONTHLY:0,QUARTERLY:0,YEARLY:0,CUSTOM:0},targetCycle:["DAILY","WEEKLY","MONTHLY","QUARTERLY","YEARLY","CUSTOM"],targetModeIndex:0,targetBoxBound:!1,targetDisplayPct:{DAILY:0,WEEKLY:0,MONTHLY:0,QUARTERLY:0,YEARLY:0,CUSTOM:0},targetLastActual:{DAILY:null,WEEKLY:null,MONTHLY:null,QUARTERLY:null,YEARLY:null,CUSTOM:null},targetSyncTimer:null,targetFxTimers:[],targetValueAF:null,targetDisplayedActual:{DAILY:0,WEEKLY:0,MONTHLY:0,QUARTERLY:0,YEARLY:0,CUSTOM:0},goalReachedCelebrated:{DAILY:!1,WEEKLY:!1,MONTHLY:!1,QUARTERLY:!1,YEARLY:!1,CUSTOM:!1},targetThemeWatchBound:!1,targetThemeObserver:null,targetCinematicHideTimer:null,targetCinematicStartTimer:null,targetCinematicAF:null,formatCurrency(e=0){return`${this.currencySymbol}${Number(e||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`},getLocalGoalTargetMap(){const e={};try{const a=localStorage.getItem("wolf_local_goal_targets"),t=a?JSON.parse(a):[];if(!Array.isArray(t))return e;t.forEach(i=>{const s=String((i==null?void 0:i.period_type)||"").trim().toUpperCase();s&&(e[s]=Number((i==null?void 0:i.target_amount)||0))})}catch(a){return e}return e},getCustomGoalConfig(){const e=new Date,a=new Date(e);a.setHours(0,0,0,0);const t=new Date(a);t.setDate(t.getDate()-14);try{const i=localStorage.getItem("wolf_local_goal_custom_config"),s=i?JSON.parse(i):{},n=Number((s==null?void 0:s.target_amount)||0),o=String((s==null?void 0:s.start_date)||t.toISOString().slice(0,10)),r=String((s==null?void 0:s.end_date)||a.toISOString().slice(0,10));return{target_amount:n>0?n:5e4,start_date:o,end_date:r}}catch(i){return{target_amount:5e4,start_date:t.toISOString().slice(0,10),end_date:a.toISOString().slice(0,10)}}},applySalesInsightCards(){var i,s,n,o;const e=document.getElementById("ledger-most-sold-name"),a=document.getElementById("ledger-most-sold-meta"),t=document.getElementById("ledger-prevday-amount");if(e&&(e.textContent=String(((i=this.salesInsights)==null?void 0:i.mostSoldName)||"NO SALES YET").trim().toUpperCase()),a){const r=Number(((s=this.salesInsights)==null?void 0:s.mostSoldQty)||0),l=Number(((n=this.salesInsights)==null?void 0:n.mostSoldAmount)||0);a.textContent=`Units: ${Math.max(0,Math.round(r))} | ${this.formatCurrency(l)}`}t&&(t.textContent=this.formatCurrency(Number(((o=this.salesInsights)==null?void 0:o.previousTotal)||0)))},refreshMostSoldToday(e=[]){const a=Array.isArray(e)?e:[],t=new Map;a.forEach(s=>{var p,h;const n=Number(s==null?void 0:s.qty),o=Number.isFinite(n)&&n>0?n:1,r=String(((p=s==null?void 0:s.products)==null?void 0:p.name)||(s==null?void 0:s.product_name)||"Unknown Product"),l=String(((h=s==null?void 0:s.products)==null?void 0:h.sku)||(s==null?void 0:s.sku)||""),d=String((s==null?void 0:s.product_id)||`${r}::${l}`).trim(),m=t.get(d)||{name:r,qty:0,amount:0},f=Number((s==null?void 0:s.total_amount)||0),c=Number((s==null?void 0:s.unit_price)||0),g=f>0?f:c*o;m.qty+=o,m.amount+=g,t.set(d,m)});const i=Array.from(t.values()).sort((s,n)=>n.qty!==s.qty?n.qty-s.qty:n.amount-s.amount)[0]||null;this.salesInsights.mostSoldName=(i==null?void 0:i.name)||"NO SALES YET",this.salesInsights.mostSoldQty=Number((i==null?void 0:i.qty)||0),this.salesInsights.mostSoldAmount=Number((i==null?void 0:i.amount)||0),this.applySalesInsightCards()},syncLedgerSearchLayoutState(){const e=document.getElementById("ledger-search-container"),a=document.getElementById("toggle-search-btn");if(!e)return;if(this.activeMode==="sales"&&window.matchMedia("(min-width: 1100px)").matches){e.classList.add("active"),a&&a.classList.add("active");return}a&&a.classList.toggle("active",e.classList.contains("active"))},toggleLedgerSearch(e,a,t,i){if(!e||!a||!t)return;if(this.activeMode==="sales"&&window.matchMedia("(min-width: 1100px)").matches){e.classList.add("active"),a.classList.add("active"),setTimeout(()=>t.focus(),120),window.wolfAudio&&window.wolfAudio.play("notif");return}const n=!e.classList.contains("active");if(e.classList.toggle("active",n),a.classList.toggle("active",n),n){setTimeout(()=>t.focus(),120),window.wolfAudio&&window.wolfAudio.play("notif");return}const o=(i||document).querySelector("#search-clear-btn");o&&!t.value.trim()&&(o.style.display="none")},bindLedgerSearchToggle(){const e=document.getElementById("toggle-search-btn"),a=document.getElementById("ledger-search-container"),t=document.getElementById("ledger-main-search");!e||!a||!t||e.dataset.bound!=="1"&&(e.dataset.bound="1",e.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.toggleLedgerSearch(a,e,t,document)}))},syncSalesGuidePlacement(){const e=document.getElementById("sales-guide-card"),a=document.querySelector("#ledger-page .ledger-left-rail"),t=document.getElementById("ledger-page");if(!e||!a||!t)return;if(this.activeMode==="sales"&&window.matchMedia("(max-width: 1099px)").matches){e.parentElement!==t&&t.appendChild(e);return}e.parentElement!==a&&a.appendChild(e)},isoDate(e){const a=new Date(e);if(Number.isNaN(a.getTime()))return"";const t=a.getFullYear(),i=String(a.getMonth()+1).padStart(2,"0"),s=String(a.getDate()).padStart(2,"0");return`${t}-${i}-${s}`},formatServerClock(e){const a=new Date(e);return!e||Number.isNaN(a.getTime())?"--:--":new Intl.DateTimeFormat("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0,timeZone:"Asia/Manila"}).format(a)},isMoneyMode(){return this.activeMode==="sales"||this.activeMode==="logbook"},syncNavigationUI(e){console.log(`Wolf OS: Navigation UI Lock engaged for [${e}]`),document.querySelectorAll(".nav-item[data-page], .sidebar-link[data-page]").forEach(t=>{t.getAttribute("data-page")===e?t.classList.add("active"):t.classList.remove("active")})},animateValue(e,a,t,i){this.activeAF&&cancelAnimationFrame(this.activeAF);let s=null;const n=this.isMoneyMode(),o=r=>{s||(s=r);const l=Math.min((r-s)/i,1),d=l*(t-a)+a;n?e.textContent=this.formatCurrency(d):e.textContent=Math.floor(d),l<1?this.activeAF=window.requestAnimationFrame(o):(this.activeAF=null,setTimeout(()=>{this.activeAF||e.classList.remove("increasing","decreasing")},300))};this.activeAF=window.requestAnimationFrame(o)},refreshSummaryHUD(e=null){const a=document.getElementById("ledger-summary-amount");if(!a)return;let t=e!==null?e:(this.allSales||[]).reduce((i,s)=>i+Number(s.total_amount||0),0);if(!this.summaryHUDReady){this.lastTotal=t,a.textContent=this.isMoneyMode()?this.formatCurrency(t):t,this.summaryHUDReady=!0;return}t!==this.lastTotal&&(a.classList.remove("increasing","decreasing"),a.offsetWidth,t>this.lastTotal?a.classList.add("increasing"):a.classList.add("decreasing"),this.animateValue(a,this.lastTotal,t,800),this.lastTotal=t,this.updateTargetBox())},async loadGoalTargets(){if(!window.supabaseClient)return;const e=this.getLocalGoalTargetMap();Object.keys(e).forEach(n=>{this.goalTargets[n]=Number(e[n]||0)});const a=["DAILY","WEEKLY","MONTHLY"];for(const n of a){const{data:o,error:r}=await supabaseClient.from("goal_target").select("*").eq("period_type",n).limit(200);if(!r&&Array.isArray(o)&&o.length>0){const l=o.slice().sort((d,m)=>{const f=new Date((d==null?void 0:d.start_date)||0).getTime(),c=new Date((m==null?void 0:m.start_date)||0).getTime(),g=new Date((d==null?void 0:d.updated_at)||(d==null?void 0:d.created_at)||0).getTime(),p=new Date((m==null?void 0:m.updated_at)||(m==null?void 0:m.created_at)||0).getTime();return(Number.isFinite(c)?c:0)-(Number.isFinite(f)?f:0)||(Number.isFinite(p)?p:0)-(Number.isFinite(g)?g:0)})[0];this.goalTargets[n]=Number((l==null?void 0:l.target_amount)||0)}}const t=Number(this.goalTargets.MONTHLY||0),i=Number(this.goalTargets.WEEKLY||0);Number(this.goalTargets.QUARTERLY||0)||(this.goalTargets.QUARTERLY=t>0?t*3:i*13),Number(this.goalTargets.YEARLY||0)||(this.goalTargets.YEARLY=t>0?t*12:i*52);const s=this.getCustomGoalConfig();this.goalTargets.CUSTOM=Number(s.target_amount||0),await this.loadGoalActuals(),this.bindTargetBoxSelector(),this.bindTargetThemeObserver(),this.ensureTargetCinematicOverlay(),this.updateTargetBox()},async loadGoalActuals(){if(!window.supabaseClient)return;const e=new Date,a=new Date(e);a.setHours(0,0,0,0);const t=new Date(a);t.setDate(t.getDate()+1);const i=new Date(a);i.setDate(i.getDate()-i.getDay());const s=new Date(a.getFullYear(),a.getMonth(),1),n=new Date(a.getFullYear(),Math.floor(a.getMonth()/3)*3,1),o=new Date(a.getFullYear(),0,1),r=this.getCustomGoalConfig(),l=new Date(r.start_date);l.setHours(0,0,0,0);const d=new Date(r.end_date);d.setHours(0,0,0,0),d.getTime()<l.getTime()&&d.setTime(l.getTime());const m=new Date(d);m.setDate(m.getDate()+1);const f={DAILY:[a.toISOString(),t.toISOString()],WEEKLY:[i.toISOString(),t.toISOString()],MONTHLY:[s.toISOString(),t.toISOString()],QUARTERLY:[n.toISOString(),t.toISOString()],YEARLY:[o.toISOString(),t.toISOString()],CUSTOM:[l.toISOString(),m.toISOString()]},c=async(p,h)=>{const{data:y,error:u}=await supabaseClient.from("sales").select("total_amount,qty,unit_price,created_at").gte("created_at",p).lt("created_at",h);return u||!Array.isArray(y)?0:y.reduce((w,b)=>{const T=Number(b.total_amount||0);return T>0?w+T:w+Number(b.qty||0)*Number(b.unit_price||0)},0)},g=async(p,h)=>{const{data:y,error:u}=await supabaseClient.from("check_in_logs").select("entry_fee,paid_amount,is_paid,time_in").gte("time_in",p).lt("time_in",h);return u||!Array.isArray(y)?0:y.reduce((w,b)=>{const T=Number(b.paid_amount||0);return T>0?w+T:b.is_paid?w+Number(b.entry_fee||0):w},0)};for(const p of this.targetCycle){const[h,y]=f[p],[u,w]=await Promise.all([c(h,y),g(h,y)]);this.goalActuals[p]=Number(u||0)+Number(w||0)}},getCurrentTargetPeriod(){return this.targetCycle[this.targetModeIndex]||"DAILY"},setTargetPeriod(e){const a=String(e||"").trim().toUpperCase(),t=this.targetCycle.indexOf(a);t<0||(this.targetModeIndex=t,this.updateTargetBox({animate:!1}))},bindTargetBoxSelector(){if(this.targetBoxBound)return;const e=document.getElementById("sidebar-target-select");e&&(this.targetBoxBound=!0,e.addEventListener("change",a=>{var i;const t=String(((i=a==null?void 0:a.target)==null?void 0:i.value)||"").toUpperCase();this.setTargetPeriod(t)}))},clearTargetFxTimers(){Array.isArray(this.targetFxTimers)&&(this.targetFxTimers.forEach(e=>clearTimeout(e)),this.targetFxTimers=[])},getTargetThemePalette(){return document.body.classList.contains("light-theme")?{active:"#2a8dff",glow:"rgba(42, 141, 255, 0.62)"}:{active:"#ff3b30",glow:"rgba(255, 59, 48, 0.75)"}},bindTargetThemeObserver(){if(this.targetThemeWatchBound)return;this.targetThemeWatchBound=!0;const e=document.body;!e||typeof MutationObserver=="undefined"||(this.targetThemeObserver=new MutationObserver(()=>{this.updateTargetBox({animate:!1})}),this.targetThemeObserver.observe(e,{attributes:!0,attributeFilter:["class"]}))},ensureTargetCinematicOverlay(){let e=document.getElementById("wolf-target-cinematic");return e||(e=document.createElement("div"),e.id="wolf-target-cinematic",e.setAttribute("aria-hidden","true"),e.innerHTML=`
      <div class="wtc-head">
        <div class="wtc-label" id="wolf-target-cinematic-label">TARGET UPDATE</div>
        <div class="wtc-value" id="wolf-target-cinematic-value">0%</div>
      </div>
      <div class="wtc-track">
        <div class="wtc-ghost" id="wolf-target-cinematic-ghost"></div>
        <div class="wtc-fill" id="wolf-target-cinematic-fill"></div>
      </div>
      <div class="wtc-state" id="wolf-target-cinematic-state">SYNCHRONIZING</div>
    `,document.body.appendChild(e),e)},renderTargetCinematic({period:e,pct:a,previousPct:t,actual:i,previousActual:s=i,target:n,isGain:o,isDrop:r,animate:l=!0}){const d=this.ensureTargetCinematicOverlay();if(!d)return;const m=document.getElementById("wolf-target-cinematic-label"),f=document.getElementById("wolf-target-cinematic-value"),c=document.getElementById("wolf-target-cinematic-state"),g=document.getElementById("wolf-target-cinematic-fill"),p=document.getElementById("wolf-target-cinematic-ghost");if(!f||!g||!p)return;const h={DAILY:"TODAY TARGET",WEEKLY:"THIS WEEK TARGET",MONTHLY:"THIS MONTH TARGET",QUARTERLY:"THIS QUARTER TARGET",YEARLY:"THIS YEAR TARGET",CUSTOM:"CUSTOM TARGET"};if(m&&(m.textContent=`${h[e]||"TARGET"} UPDATE`),f.textContent=`${Math.round(t)}% -> ${Math.round(a)}%  |  ${this.formatCurrency(s)} -> ${this.formatCurrency(i)}`,c&&(c.textContent=o?"INCOME RISING":r?"INCOME DROP DETECTED":"SYNCHRONIZED"),d.classList.toggle("is-light",document.body.classList.contains("light-theme")),d.classList.toggle("is-gain",!!o),d.classList.toggle("is-drop",!!r),!l){g.style.width=`${a}%`,p.style.width=`${a}%`,p.style.opacity="0";return}this.targetCinematicStartTimer&&clearTimeout(this.targetCinematicStartTimer),this.targetCinematicHideTimer&&clearTimeout(this.targetCinematicHideTimer),this.targetCinematicAF&&(cancelAnimationFrame(this.targetCinematicAF),this.targetCinematicAF=null),d.classList.add("is-active");const y=Number.isFinite(Number(t))?Number(t):a,u=Number.isFinite(Number(a))?Number(a):y;g.style.transition="none",g.style.width=`${y}%`,p.style.transition="none",p.style.width=`${y}%`,p.style.opacity=r?"0.92":"0",g.offsetWidth;const w=r?1250:1100,b=180,T=performance.now()+b,v=S=>1-Math.pow(1-S,3);this.targetCinematicStartTimer=setTimeout(()=>{const S=L=>{const A=Math.min(1,(L-T)/w),E=v(Math.max(0,A)),C=y+(u-y)*E;g.style.width=`${C}%`,r&&(p.style.width=`${y+(u-y)*E}%`,p.style.opacity=`${.92*(1-E)}`);const D=s+(i-s)*E;f.textContent=`${Math.round(y+(u-y)*E)}% -> ${Math.round(u)}%  |  ${this.formatCurrency(D)} -> ${this.formatCurrency(i)}`,A<1?this.targetCinematicAF=requestAnimationFrame(S):(this.targetCinematicAF=null,p.style.opacity="0")};this.targetCinematicAF=requestAnimationFrame(S)},b),this.targetCinematicHideTimer=setTimeout(()=>{d.classList.remove("is-active","is-gain","is-drop")},w+b+700)},scheduleGoalActualsSync(e=260){this.targetSyncTimer&&clearTimeout(this.targetSyncTimer),this.targetSyncTimer=setTimeout(async()=>{try{await this.loadGoalActuals(),this.updateTargetBox({animate:!0})}catch(a){console.error("Wolf OS Target Sync Fault:",a)}},e)},clearTargetValueAnimation(){this.targetValueAF&&(cancelAnimationFrame(this.targetValueAF),this.targetValueAF=null)},animateTargetReadout({fromActual:e,toActual:a,fromPct:t,toPct:i,target:s,percentEl:n,amountEl:o,duration:r=520}){this.clearTargetValueAnimation();const l=performance.now(),d=f=>1-(1-f)*(1-f),m=f=>{const c=Math.min(1,(f-l)/r),g=d(c),p=e+(a-e)*g,h=t+(i-t)*g;n&&(n.textContent=`${Math.round(h)}%`),o&&(o.textContent=`${this.formatCurrency(p)} / ${this.formatCurrency(s)}`),c<1?this.targetValueAF=requestAnimationFrame(m):this.targetValueAF=null};this.targetValueAF=requestAnimationFrame(m)},updateTargetBox(e={}){var v,S,L,A,E,C,D,I;const{animate:a=!0}=e,t=this.getCurrentTargetPeriod(),i=Number(((v=this.goalTargets)==null?void 0:v[t])||0),s=Number(((S=this.goalActuals)==null?void 0:S[t])||0),n=document.getElementById("sidebar-target-percent"),o=document.getElementById("sidebar-target-bar"),r=document.getElementById("sidebar-target-ghost"),l=document.getElementById("sidebar-target-box"),d=document.getElementById("sidebar-target-label"),m=document.getElementById("sidebar-target-state"),f=document.getElementById("sidebar-target-amount");if(!n||!o||!l)return;const c={DAILY:"TODAY TARGET",WEEKLY:"THIS WEEK TARGET",MONTHLY:"THIS MONTH TARGET",QUARTERLY:"THIS QUARTER TARGET",YEARLY:"THIS YEAR TARGET",CUSTOM:"CUSTOM TARGET"};d&&(d.textContent=c[t]||"TARGET");const g=document.getElementById("sidebar-target-select");g&&g.value!==t&&(g.value=t);const p=this.getTargetThemePalette();if(l.style.setProperty("--target-active-color",p.active),l.style.setProperty("--target-glow-color",p.glow),l.style.setProperty("--target-warn-color","#ff2d2d"),l.classList.remove("target-gaining","target-dropping","target-drop-warning","target-changing"),this.clearTargetFxTimers(),i<=0){this.clearTargetValueAnimation(),n.textContent="0%",o.style.width="0%",r&&(r.style.width="0%",r.style.opacity="0"),m&&(m.textContent=`ACTIVE: ${t}`),f&&(f.textContent=`${this.formatCurrency(s)} / ${this.formatCurrency(0)}`),this.targetDisplayPct[t]=0,this.targetLastActual[t]=s,this.targetDisplayedActual[t]=s,this.renderTargetCinematic({period:t,pct:0,previousPct:0,actual:s,previousActual:s,target:0,isGain:!1,isDrop:!1,animate:!1});return}const h=Math.min(100,Math.max(0,s/i*100)),y=((L=this.targetLastActual)==null?void 0:L[t])===null||((A=this.targetLastActual)==null?void 0:A[t])===void 0?s:Number(this.targetLastActual[t]),u=((E=this.targetDisplayPct)==null?void 0:E[t])===null||((C=this.targetDisplayPct)==null?void 0:C[t])===void 0?h:Number(this.targetDisplayPct[t]),w=u<100&&h>=100;m&&(m.textContent=`${h>=100?"REACHED":"ACTIVE"}: ${t}`);const b=((D=this.targetDisplayedActual)==null?void 0:D[t])===null||((I=this.targetDisplayedActual)==null?void 0:I[t])===void 0?y:Number(this.targetDisplayedActual[t]);if(!a||s===y){this.clearTargetValueAnimation(),n.textContent=`${Math.round(h)}%`,f&&(f.textContent=`${this.formatCurrency(s)} / ${this.formatCurrency(i)}`),o.style.width=`${h}%`,r&&(r.style.width=`${h}%`,r.style.opacity="0"),this.targetDisplayPct[t]=h,this.targetLastActual[t]=s,this.targetDisplayedActual[t]=s,this.renderTargetCinematic({period:t,pct:h,previousPct:h,actual:s,previousActual:s,target:i,isGain:!1,isDrop:!1,animate:!1});return}this.animateTargetReadout({fromActual:b,toActual:s,fromPct:u,toPct:h,target:i,percentEl:n,amountEl:f,duration:s>y?560:520}),l.classList.add("target-changing");const T=setTimeout(()=>{l.classList.remove("target-changing")},720);if(this.targetFxTimers.push(T),s>y){r&&(r.style.width=`${h}%`,r.style.opacity="0"),o.style.width=`${h}%`,l.classList.add("target-gaining");const M=setTimeout(()=>{l.classList.remove("target-gaining")},520);this.targetFxTimers.push(M),this.renderTargetCinematic({period:t,pct:h,previousPct:u,actual:s,previousActual:y,target:i,isGain:!0,isDrop:!1,animate:!0})}else{l.classList.add("target-dropping","target-drop-warning"),r&&(r.style.transition="none",r.style.width=`${u}%`,r.style.opacity="0.95",r.offsetWidth),o.style.width=`${h}%`;const M=setTimeout(()=>{l.classList.remove("target-drop-warning")},220);if(this.targetFxTimers.push(M),r){const _=setTimeout(()=>{r.style.transition="width 0.95s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.95s ease",r.style.width=`${h}%`,r.style.opacity="0"},26);this.targetFxTimers.push(_)}const N=setTimeout(()=>{l.classList.remove("target-dropping")},980);this.targetFxTimers.push(N),this.renderTargetCinematic({period:t,pct:h,previousPct:u,actual:s,previousActual:y,target:i,isGain:!1,isDrop:!0,animate:!0})}this.targetDisplayPct[t]=h,this.targetLastActual[t]=s,this.targetDisplayedActual[t]=s,h<100?this.goalReachedCelebrated[t]=!1:w&&!this.goalReachedCelebrated[t]&&(this.goalReachedCelebrated[t]=!0,window.wolfAudio&&window.wolfAudio.play("confetti"))},async addSaleRow(e){const a=document.getElementById("ledger-list-container");if(!a)return;const t=this.renderSingleSaleCard(e,0);a.insertAdjacentHTML("afterbegin",t),this.scheduleGoalActualsSync(),form.addEventListener("submit",async i=>{var m,f;i.preventDefault();const s=skuInput.value.trim(),n=nameInput.value.trim(),o=parseFloat(priceInput.value||"0"),r=unlimitedCheckbox!=null&&unlimitedCheckbox.checked?999999:parseInt(qtyInput.value||"0",10),l=((m=document.getElementById("master-desc"))==null?void 0:m.value)||null,d=((f=document.getElementById("master-brand"))==null?void 0:f.value)||null;if(!n||!r||!o){statusEl&&(statusEl.textContent="Name, quantity, and price are required.");return}if(!s&&!selectedImageUrl){statusEl&&(statusEl.textContent="Please select one image before adding to sales.");return}try{let g=form.dataset.productId||null;if(!g){const{data:y,error:u}=await supabaseClient.from("products").insert({sku:s||void 0,name:n,description:l,price:o,qty:r,image_url:selectedImageUrl||null,is_active:!0}).select().single();if(u)throw u;g=y.productid}const{data:p,error:h}=await supabaseClient.from("sales").insert({productid:g,qty:r,price:o}).select().single();if(h)throw h;window.wolfData&&typeof window.wolfData.addSaleRow=="function"&&window.wolfData.addSaleRow(p),statusEl&&(statusEl.textContent="Sale added."),modal.style.display="none"}catch(c){console.error(c),statusEl&&(statusEl.textContent="Error adding sale.")}})},updateSaleRow(e){const a=this.salesData.findIndex(t=>t.id===e.id);a>-1&&(this.salesData[a]=e),this.updateLedgerRevenue(),Toastify({text:`Sale updated: ${e.id}`,duration:2e3,gravity:"top",position:"right"}).showToast()},removeSaleRow(e){const a=document.getElementById(`row-${e}`);a&&(a.classList.add("removing"),setTimeout(()=>a.remove(),400)),this.allSales=(this.allSales||[]).filter(t=>t.id!==e),this.refreshSummaryHUD(),this.scheduleGoalActualsSync(),alert("test")},updateProductUI(e){Toastify({text:`Product updated: ${e.name}`,duration:2e3,gravity:"top",position:"right",backgroundColor:"#ff9800"}).showToast()},updateLedgerRevenue(){const e=document.getElementById("ledger-summary-amount");if(!e)return;const a=(this.allSales||[]).reduce((t,i)=>t+Number(i.total_amount||0),0);if(this.currentTotal===0&&a!==0){this.currentTotal=a,e.textContent=this.formatCurrency(a);return}a!==this.currentTotal&&(a>this.currentTotal?e.className="summary-value increasing":e.className="summary-value decreasing",this.animateNumber(e,this.currentTotal,a),this.currentTotal=a)},async syncServerTime(){console.log("Wolf OS: Synchronizing with Atomic Clock...");try{const{data:e,error:a}=await supabaseClient.rpc("get_server_time");if(a)throw a;const t=Array.isArray(e)?e[0]:e;if(t)this.selectedDate=new Date(t),this.serverToday=new Date(t);else throw new Error("No timestamp returned")}catch(e){console.error("Wolf OS: Sync Fault. Falling back to system clock.",e),this.selectedDate=new Date,this.serverToday=new Date}isNaN(this.selectedDate.getTime())&&(this.selectedDate=new Date,this.serverToday=new Date)},async syncTime(){console.log("Wolf OS: Syncing with Atomic Server Clock...");try{const{data:e,error:a}=await supabaseClient.rpc("get_server_time");if(e&&e[0]){const t=e[0].server_date.split("-");this.serverToday=new Date(t[0],t[1]-1,t[2]),this.selectedDate=new Date(this.serverToday)}}catch(e){console.warn("Wolf OS: Time Sync Failed, using local clock.")}return this.selectedDate},get realTodayIndex(){return new Date().getDay()},get realTodayISO(){return new Date().toISOString().split("T")[0]},async initLedger(e){this.activeMode=e,this.lastTotal=0,this.summaryHUDReady=!1,await this.syncTime();const a=document.getElementById("ledger-title"),t=document.getElementById("ledger-summary-label"),i=document.getElementById("ledger-search-container"),s=document.getElementById("ledger-page"),n=document.getElementById("ledger-records-title"),o=document.getElementById("ledger-records-sub"),r=document.getElementById("sales-filter-panel"),l=document.querySelector(".sales-insight-grid");if(s&&(s.classList.toggle("sales-mode",e==="sales"),s.classList.toggle("logbook-mode",e!=="sales")),a&&(e==="sales"?(a.innerText="SALES",t.innerText="Daily Income Summary",n&&(n.innerText="Transactions"),o&&(o.innerText="Live sales feed by selected day")):(a.innerText="LOGBOOK",t.innerText="Floor Income Summary",n&&(n.innerText="Check-In Records"),o&&(o.innerText="Live logbook feed by selected day"))),r&&(r.style.display=e==="sales"?"":"none"),l&&(l.style.display=e==="sales"?"":"none"),i&&this.syncLedgerSearchLayoutState(),this.bindLedgerSearchToggle(),e==="sales"){this.salesFilterMode="all",this.salesSortMode="latest",this.salesMinAmount=0;const d=document.getElementById("sales-min-amount");d&&(d.value="");const m=document.getElementById("sales-sort-select");m&&(m.value="latest"),document.querySelectorAll("[data-sales-filter]").forEach(f=>f.classList.toggle("is-active",f.getAttribute("data-sales-filter")==="all"))}this.searchLayoutBound||(this.searchLayoutBound=!0,window.addEventListener("resize",()=>{this.syncLedgerSearchLayoutState(),this.syncSalesGuidePlacement()})),this.syncSalesGuidePlacement(),this.syncNavigationUI(e),this.initChrono(e),await this.syncServerTime(),await this.loadGoalTargets()},initChrono(e){if(this.fp&&typeof this.fp.destroy=="function")try{this.fp.destroy()}catch(n){console.warn("Wolf OS: Non-critical - could not destroy old flatpickr instance.")}this.fp=null;const a=document.getElementById("chrono-picker-trigger"),t=document.getElementById("hidden-chrono-input");if(!t){console.error("Wolf OS: Chrono Input not found in DOM.");return}const i=this.serverToday||new Date,s=flatpickr(t,{disableMobile:!0,maxDate:i,animate:!0,positionElement:a,position:"below",onReady:(n,o,r)=>{const l=r.calendarContainer;l.classList.remove("wolf-calendar-v2","wolf-calendar-v3"),l.classList.add("wolf-calendar"),l.classList.remove("open")},onOpen:(n,o,r)=>{requestAnimationFrame(()=>{r.calendarContainer.classList.add("open")})},onClose:(n,o,r)=>{r.calendarContainer.classList.remove("open")},onChange:n=>{n.length>0&&(this.selectedDate=n[0],this.calculateWeek(e))}});this.fp=Array.isArray(s)?s[0]:s,a&&this.fp&&(a.onclick=null,a.onclick=n=>{n.preventDefault(),n.stopPropagation(),this.fp.isOpen?this.fp.close():this.fp.open()}),this.calculateWeek(e)},calculateWeek(e){const a=new Date(this.selectedDate),t=a.getDay(),i=new Date(a);i.setDate(a.getDate()-t);const s=new Date(i);s.setDate(i.getDate()+6),this.updateChronoUI(i,s,t,e)},shiftWeek(e,a){this.selectedDate.setDate(this.selectedDate.getDate()+e),this.calculateWeek(a)},async updateChronoUI(e,a,t){if(!e||isNaN(e.getTime())||!a||isNaN(a.getTime()))return;this.fp&&typeof this.fp.setDate=="function"&&this.fp.setDate(this.selectedDate,!1);const i=g=>g.toLocaleDateString("en-US",{month:"short",day:"numeric"}).toUpperCase(),s=document.getElementById("week-range-display");s&&(s.innerText=`${i(e)} - ${i(a)}`);const n=this.serverToday||new Date,o=n.toLocaleDateString("en-CA"),r=new Date(n);r.setDate(n.getDate()-n.getDay());const l=r.toLocaleDateString("en-CA"),d=e.toLocaleDateString("en-CA"),m=document.getElementById("snap-today-btn");if(m){const g=d<l;m.classList.toggle("visible",g),m.disabled=!g,m.tabIndex=g?0:-1,m.setAttribute("aria-hidden",g?"false":"true"),m.style.pointerEvents=g?"":"none"}document.querySelectorAll("#ledger-day-picker .day-btn").forEach((g,p)=>{const h=new Date(e);h.setDate(e.getDate()+p);const y=h.toLocaleDateString("en-CA");g.setAttribute("data-date",y),g.classList.toggle("active",p===t),g.disabled=y>o});const c=this.selectedDate.toLocaleDateString("en-CA");this.isReadOnly=c!==o,this.applyLockdownUI(),this.activeMode==="sales"?await this.loadSales():await this.loadLogbook()},currentLogDay:new Date().getDay(),currentSalesDay:new Date().getDay(),realToday:new Date().getDay(),salesDataCache:[],sanitizePlain(e){const a=String(e!=null?e:"");return window.DOMPurify?window.DOMPurify.sanitize(a,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]}):a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},parseLogNotes(e=""){var r,l,d;const a=String(e||""),t=a.match(/\|MEMBERSHIP:([^|]+)/i),i=a.match(/\|PAID:([0-9]+(?:\.[0-9]+)?)/i),s=a.match(/^WALK-IN:\s*([^|]+)/i),n=a.match(/^MEMBER_ENTRY:\s*([^|]+)/i),o=a.replace(/\|MEMBERSHIP:[^|]*/gi,"").replace(/\|PAID:[^|]*/gi,"").trim();return{raw:a,baseNote:o,membershipLabel:((r=t==null?void 0:t[1])==null?void 0:r.trim())||"",isPaidFromNote:!!i,paidAmountFromNote:i?Number(i[1]):null,walkInName:((l=s==null?void 0:s[1])==null?void 0:l.trim())||"",memberToken:((d=n==null?void 0:n[1])==null?void 0:d.trim())||""}},buildLogNotes(e,a,t,i){const n=[String(e||"").trim()||"WALK-IN: GUEST"];return a&&n.push(`MEMBERSHIP:${String(a).trim().toUpperCase()}`),t&&n.push(`PAID:${Number(i||0).toFixed(2)}`),n.join("|")},async loadLogbook(e={}){window.salesManager&&(window.salesManager.currentTrashMode="logbook");const a=document.getElementById("ledger-list-container");if(!a)return;a.children.length===0&&(a.innerHTML=`<div style="text-align:center; padding:50px; opacity:0.3;"><i class='bx bx-loader-alt bx-spin' style='font-size:2rem;'></i></div>`);const t=this.selectedDate.toLocaleDateString("en-CA");try{e!=null&&e.preservePage||(this.currentLedgerPage=1);const{data:i,error:s}=await supabaseClient.from("check_in_logs").select("*").gte("time_in",`${t}T00:00:00+08:00`).lte("time_in",`${t}T23:59:59+08:00`).order("time_in",{ascending:!1});if(s)throw s;const n=i||[],o=[...new Set(n.map(u=>u.profile_id).filter(Boolean))];let r=new Map;if(o.length>0){const{data:u,error:w}=await supabaseClient.from("members").select("profile_id, full_name, member_code").in("profile_id",o);!w&&u&&(r=new Map(u.map(b=>[b.profile_id,b])))}let l=n.map(u=>{var N,_,x,O,k;const w=this.parseLogNotes(u.notes),b=u.profile_id?r.get(u.profile_id):null,T=((N=w.memberToken.match(/ME-[A-Z0-9]{2,}/i))==null?void 0:N[0])||"",v=w.memberToken.replace(/ME-[A-Z0-9]{2,}/gi,"").trim(),S=!!(b||T||u.profile_id),L=(b==null?void 0:b.full_name)||w.walkInName||v||w.memberToken||"Walk-in Guest",A=this.sanitizePlain(L).toUpperCase(),E=this.sanitizePlain(String((b==null?void 0:b.member_code)||T||"").toUpperCase()),C=this.sanitizePlain(String(u.membership_label||w.membershipLabel||(S?"MONTHLY MEMBERSHIP":"REGULAR (NON-MEMBER)")).toUpperCase()),D=Number((x=(_=u.entry_fee)!=null?_:w.paidAmountFromNote)!=null?x:S?0:this.defaultWalkInFee),I=!!(typeof u.is_paid=="boolean"?u.is_paid:w.isPaidFromNote),M=Number((k=u.paid_amount)!=null?k:I?(O=w.paidAmountFromNote)!=null?O:D:0);return{...u,resolvedName:A,memberCode:E,membershipLabel:C,entryFee:D,isPaid:I,paidAmount:I?M:0,noteBase:w.baseNote}});const d=document.getElementById("ledger-main-search");if(d&&d.value){const u=d.value.toLowerCase();l=l.filter(w=>w.resolvedName.toLowerCase().includes(u)||w.membershipLabel.toLowerCase().includes(u)||w.memberCode.toLowerCase().includes(u))}const m=document.getElementById("ledger-summary-label"),f=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];m&&(m.innerText=`${f[this.selectedDate.getDay()]} Floor Income`);const c=l.reduce((u,w)=>u+(w.isPaid?Number(w.paidAmount||0):0),0);if(this.refreshSummaryHUD(c),l.length===0){a.innerHTML=`<div style="text-align:center; padding:80px; opacity:0.2;"><i class='bx bx-user-x' style='font-size:3rem;'></i><p style="font-size:10px; font-weight:900; margin-top:10px;">NO DATA LOGGED</p></div>`;return}this.currentLedgerRows=l;const g=l.length,p=Math.max(1,Math.ceil(g/this.ledgerPageSize));this.currentLedgerPage>p&&(this.currentLedgerPage=p);const h=(this.currentLedgerPage-1)*this.ledgerPageSize,y=l.slice(h,h+this.ledgerPageSize);a.innerHTML=y.map((u,w)=>{const b=u.time_out!==null,T=this.formatServerClock(u.time_in),v=b?this.formatServerClock(u.time_out):"--:--",S=u.isPaid?"badge-paid":"badge-unpaid",L=u.isPaid?"PAID":"UNPAID",A=b?"UNDO CHECK OUT":"CHECK OUT",E=b?`OUT ${v}`:"ACTIVE",C=b?"btn-logbook-neutral":"btn-logbook-danger",D=u.isPaid?"UNDO PAID":`COLLECT ${this.formatCurrency(u.entryFee)}`,I=u.isPaid?"btn-logbook-neutral":"btn-logbook-success",M=this.isReadOnly?"disabled":"";return`
          <div class="list-item-card" id="row-${u.id}" style="animation-delay: ${w*.04}s;">
            <div class="card-header logbook-card-header" style="margin-bottom:0;">
              <div class="status-icon logbook-status-icon ${b?"":"active"}" style="background:var(--bg-dark); color:var(--wolf-red);">
                <i class='bx ${b?"bx-check":"bx-time-five"}'></i>
              </div>
              <div class="item-info logbook-item-info">
                <h4>${u.resolvedName}</h4>
                <div class="sub">${u.memberCode?`MEMBER • ${u.memberCode}`:u.membershipLabel}</div>
                <div class="time">IN: ${T}</div>
              </div>
              <div class="logbook-inline-kpis">
                <div class="kpi-item">
                  <span class="kpi-label">CHECK-IN</span>
                  <span class="kpi-val">${T}</span>
                </div>
                <div class="kpi-item">
                  <span class="kpi-label">ENTRY FEE</span>
                  <span class="kpi-val">${this.formatCurrency(u.entryFee)}</span>
                </div>
              </div>
              <div class="card-actions logbook-card-actions" style="display:flex; align-items:center; gap:8px;">
                <span class="status-badge ${S}">${L}</span>
                ${this.isReadOnly?"":`<i class='bx bx-trash' style="cursor:pointer; color:#333; font-size:14px;" onclick="wolfData.deleteLog('${u.id}')"></i>`}
              </div>
            </div>
            <div class="logbook-actions">
              <button class="logbook-action-btn ${C}" ${M} onclick="wolfData.toggleLogCheckout('${u.id}', ${b})">
                <span class="btn-main">${A}</span>
                <span class="btn-sub">${E}</span>
              </button>
              <button class="logbook-action-btn ${I}" ${M} onclick="wolfData.toggleLogPaid('${u.id}', ${u.isPaid}, ${u.entryFee})">
                <span class="btn-main">${D}</span>
                <span class="btn-sub">${u.isPaid?"SET UNPAID":"MARK AS PAID"}</span>
              </button>
            </div>
          </div>`}).join(""),a.innerHTML+=this.renderLedgerPagination(g,p)}catch(i){console.error("Wolf OS Logbook Fault:",i)}},async loadSales(){if(window.salesManager&&(window.salesManager.currentTrashMode="sales"),this.isFetching)return;this.isFetching=!0;const e=document.getElementById("ledger-list-container");if(!e)return;e.children.length===0&&(e.innerHTML=`<div style="text-align:center; padding:50px; opacity:0.3;"><i class='bx bx-loader-alt bx-spin' style='font-size:2rem;'></i></div>`);const a=this.selectedDate.toLocaleDateString("en-CA"),t=new Date(this.selectedDate);t.setHours(0,0,0,0);const i=new Date(t);i.setDate(i.getDate()-1);const s=i.toLocaleDateString("en-CA");try{this.currentLedgerPage=1;const[n,o]=await Promise.all([supabaseClient.from("sales").select("*, products(name, sku, image_url, brand, qty)").gte("created_at",`${a}T00:00:00+08:00`).lte("created_at",`${a}T23:59:59+08:00`).order("created_at",{ascending:!1}),supabaseClient.from("sales").select("total_amount,qty,unit_price").gte("created_at",`${s}T00:00:00+08:00`).lte("created_at",`${s}T23:59:59+08:00`)]);if(n.error)throw n.error;this.allSales=n.data||[];const l=((o==null?void 0:o.data)||[]).reduce((f,c)=>{const g=Number((c==null?void 0:c.total_amount)||0);return g>0?f+g:f+Number((c==null?void 0:c.qty)||0)*Number((c==null?void 0:c.unit_price)||0)},0);this.salesInsights={previousTotal:l,mostSoldName:"NO SALES YET",mostSoldQty:0,mostSoldAmount:0},this.refreshMostSoldToday(this.allSales);const d=document.getElementById("ledger-main-search"),m=d?d.value:"";this.renderSales(this.selectedDate.getDay(),m),this.scheduleGoalActualsSync()}catch(n){console.error("Wolf OS Sales Fault:",n)}finally{this.isFetching=!1}},renderSales(e,a=""){const t=document.getElementById("ledger-list-container");if(!t)return;const i=document.getElementById("ledger-summary-label"),s=document.getElementById("ledger-filter-count"),n=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];i&&(i.innerText=`${n[e]} Total Income`);let o=[...this.allSales];if(a!==""){const c=a.toLowerCase();o=o.filter(g=>{var y,u;const p=String(((y=g.products)==null?void 0:y.name)||"").toLowerCase(),h=String(((u=g.products)==null?void 0:u.sku)||"").toLowerCase();return p.includes(c)||h.includes(c)})}if(this.salesFilterMode==="high-value"?o=o.filter(c=>Number((c==null?void 0:c.total_amount)||0)>=250):this.salesFilterMode==="bulk"&&(o=o.filter(c=>Number((c==null?void 0:c.qty)||0)>=2)),Number(this.salesMinAmount||0)>0){const c=Number(this.salesMinAmount||0);o=o.filter(g=>Number((g==null?void 0:g.total_amount)||0)>=c)}this.salesSortMode==="amount-desc"?o.sort((c,g)=>Number((g==null?void 0:g.total_amount)||0)-Number((c==null?void 0:c.total_amount)||0)):this.salesSortMode==="name-asc"?o.sort((c,g)=>{var y,u;const p=String(((y=c==null?void 0:c.products)==null?void 0:y.name)||""),h=String(((u=g==null?void 0:g.products)==null?void 0:u.name)||"");return p.localeCompare(h)}):o.sort((c,g)=>new Date((g==null?void 0:g.created_at)||0)-new Date((c==null?void 0:c.created_at)||0));const r=o.reduce((c,g)=>c+Number(g.total_amount||0),0);if(this.refreshSummaryHUD(r),this.refreshMostSoldToday(this.allSales),s&&(s.textContent=`${o.length} record${o.length===1?"":"s"}`),o.length===0){t.innerHTML=`<div style="text-align:center; padding:80px; opacity:0.2;"><i class='bx bx-shopping-bag' style='font-size:3rem;'></i><p style="font-size:10px; font-weight:900; margin-top:10px;">NO DATA LOGGED</p></div>`;return}this.currentLedgerRows=o;const l=o.length,d=Math.max(1,Math.ceil(l/this.ledgerPageSize));this.currentLedgerPage>d&&(this.currentLedgerPage=d);const m=(this.currentLedgerPage-1)*this.ledgerPageSize,f=o.slice(m,m+this.ledgerPageSize);t.innerHTML=f.map((c,g)=>{var T,v,S,L;const p=Number(c.total_amount||0),h=DOMPurify.sanitize(((T=c.products)==null?void 0:T.name)||"Item"),y=DOMPurify.sanitize(((v=c.products)==null?void 0:v.sku)||"N/A"),u=DOMPurify.sanitize(((S=c.products)==null?void 0:S.brand)||""),w=DOMPurify.sanitize(String(((L=c.products)==null?void 0:L.image_url)||"/assets/images/placeholder.png")),b=new Date(c.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return`
        <div class="list-item-card sale-row-card" id="row-${c.id}" style="animation-delay: ${g*.06}s;">
          <div class="card-header sale-card-header" style="margin-bottom: 0;">
            <div class="status-icon sale-thumb" style="background: var(--bg-dark); color: var(--wolf-red); overflow:hidden;">
              <img src="${w}" alt="${h}" onerror="this.onerror=null;this.src='/assets/images/placeholder.png';" />
            </div>
            <div class="item-info sale-item-info">
              <h4>${h.toUpperCase()}</h4>
              <div class="sub">${y.toUpperCase()}${u?` • ${u.toUpperCase()}`:""}</div>
              <div class="time">${b} • x${c.qty}</div>
            </div>
            <div class="card-actions sale-card-actions">
              <div class="sale-price-chip">${this.formatCurrency(p)}</div>
              ${this.isReadOnly?"":`<button type="button" class="sale-delete-btn" onclick="wolfData.deleteSale('${c.id}')" aria-label="Delete sale"><i class='bx bxs-trash'></i></button>`}
            </div>
          </div>
        </div>`}).join(""),t.innerHTML+=this.renderLedgerPagination(l,d)},renderLedgerPagination(e,a){return e<=this.ledgerPageSize?"":`
      <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-top:10px;">
        <button onclick="wolfData.setLedgerPage(${this.currentLedgerPage-1})" ${this.currentLedgerPage<=1?"disabled":""} style="width:34px; height:34px; border-radius:10px; border:1px solid rgba(255,255,255,0.16); background:rgba(255,255,255,0.06); color:#e7edf8;"><i class='bx bx-chevron-left'></i></button>
        <span style="font-size:10px; letter-spacing:1px; text-transform:uppercase; color:#97a4ba;">Page ${this.currentLedgerPage} of ${a}</span>
        <button onclick="wolfData.setLedgerPage(${this.currentLedgerPage+1})" ${this.currentLedgerPage>=a?"disabled":""} style="width:34px; height:34px; border-radius:10px; border:1px solid rgba(255,255,255,0.16); background:rgba(255,255,255,0.06); color:#e7edf8;"><i class='bx bx-chevron-right'></i></button>
      </div>
    `},setLedgerPage(e){const a=Number(e);if(!(!Number.isFinite(a)||a<1)){if(this.currentLedgerPage=a,this.activeMode==="sales"){const t=document.getElementById("ledger-main-search");this.renderSales(this.selectedDate.getDay(),t?t.value:"");return}this.loadLogbook({preservePage:!0})}},updateDayUI(e,a){a=parseInt(a),this.realToday=new Date().getDay();const t=e==="logbook"?"#logbook-day-picker":"#sales-day-picker";document.querySelectorAll(`${t} .day-btn`).forEach(s=>{const n=parseInt(s.getAttribute("data-day"));s.classList.toggle("active",n===a),n>this.realToday?s.disabled=!0:s.disabled=!1}),this.isReadOnly=a!==this.realToday,this.applyLockdownUI()},applyLockdownUI(){var i,s;const e=document.querySelector(".icon-btn.red"),a=(i=document.querySelector(".icon-btn:not(.red) i.bx-trash"))==null?void 0:i.parentElement,t=document.querySelector(".brand");this.isReadOnly?(e&&e.classList.add("crud-hidden"),a&&a.classList.add("crud-hidden"),t&&!document.querySelector(".archive-mode-indicator")&&t.insertAdjacentHTML("beforebegin",'<span class="archive-mode-indicator">[ ARCHIVE_LOCKED ]</span>')):(e&&e.classList.remove("crud-hidden"),a&&a.classList.remove("crud-hidden"),(s=document.querySelector(".archive-mode-indicator"))==null||s.remove())},toggleReadOnlyMode(e){var i;const a=document.querySelector(".icon-btn.red"),t=(i=document.querySelector(".icon-btn:not(.red) i.bx-trash"))==null?void 0:i.parentElement;a&&a.classList.toggle("crud-hidden",e),t&&t.classList.toggle("crud-hidden",e),this.isReadOnly=e},async toggleLogCheckout(e,a){if(!this.isReadOnly)try{let t=new Date().toISOString();try{const{data:n,error:o}=await supabaseClient.rpc("get_server_time");if(!o&&n){const r=Array.isArray(n)?n[0]:n;if(typeof r=="string")t=new Date(r).toISOString();else if(r&&typeof r=="object"){const l=r.server_iso_timestamp||r.server_time||r.now||r.timestamp;l&&(t=new Date(l).toISOString())}}}catch(n){}const i=a?null:t,{error:s}=await supabaseClient.from("check_in_logs").update({time_out:i}).eq("id",e);if(s)throw s;window.wolfAudio&&window.wolfAudio.play("notif"),await this.loadLogbook()}catch(t){console.error("Wolf OS Checkout Toggle Fault:",t),window.wolfAudio&&window.wolfAudio.play("error")}},async toggleLogPaid(e,a,t=0){var i,s,n;if(!this.isReadOnly)try{const{data:o,error:r}=await supabaseClient.from("check_in_logs").select("*").eq("id",e).single();if(r||!o)throw r||new Error("Log row not found");const l=this.parseLogNotes(o.notes),d=String(o.membership_label||l.membershipLabel||(o.profile_id?"MONTHLY MEMBERSHIP":"REGULAR (NON-MEMBER)")).trim().toUpperCase(),m=Number((n=(s=(i=o.entry_fee)!=null?i:l.paidAmountFromNote)!=null?s:t)!=null?n:o.profile_id?0:this.defaultWalkInFee),f=!a,c=f?m:0,g=f?new Date().toISOString():null,p=this.buildLogNotes(l.baseNote,d,f,c),h={notes:p,membership_label:d,entry_fee:m,is_paid:f,paid_amount:c,paid_at:g};let{error:y}=await supabaseClient.from("check_in_logs").update(h).eq("id",e);if(y&&/column .* does not exist|schema cache|invalid input syntax/i.test(String(y.message||""))&&(y=(await supabaseClient.from("check_in_logs").update({notes:p}).eq("id",e)).error),y)throw y;window.wolfAudio&&window.wolfAudio.play("success"),await this.loadLogbook()}catch(o){console.error("Wolf OS Payment Toggle Fault:",o),window.wolfAudio&&window.wolfAudio.play("error")}},async deleteLog(e){if(!(!window.Swal||!(await window.Swal.fire({title:"REMOVE ENTRY?",html:'<p class="wolf-swal-text">WARNING: THIS RECORD WILL BE MOVED TO TRASH bin. PROCEED?</p>',showCancelButton:!0,confirmButtonText:"REMOVE",cancelButtonText:"CANCEL",background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup-orange",confirmButton:"wolf-swal-confirm-orange",cancelButton:"wolf-swal-cancel"}})).isConfirmed))try{const t=document.getElementById(`row-${e}`);t&&(t.classList.add("removing"),await new Promise(s=>setTimeout(s,400)),t.remove());const{data:i}=await supabaseClient.from("check_in_logs").select("*").eq("id",e).single();await supabaseClient.from("trash_bin").insert([{original_id:e,table_name:"check_in_logs",deleted_data:i}]),await supabaseClient.from("check_in_logs").delete().eq("id",e),window.wolfAudio&&window.wolfAudio.play("notif"),await this.loadLogbook()}catch(t){console.error(t)}},async adjustSaleQty(e,a=0){var i,s,n,o;if(this.isReadOnly)return;const t=Number(a);if(!(t!==1&&t!==-1))try{const r=(this.allSales||[]).find(b=>b.id===e),{data:l,error:d}=await supabaseClient.from("sales").select("id, product_id, qty, unit_price, total_amount").eq("id",e).single();if(d||!l)throw d||new Error("SALE_NOT_FOUND");const m=Number(l.qty||0),f=m+t;if(f<1){(i=window.salesManager)==null||i.showSystemAlert("MINIMUM QTY IS 1. USE DELETE TO REMOVE ITEM.","warning");return}const{data:c,error:g}=await supabaseClient.from("products").select("qty, name").eq("productid",l.product_id).single();if(g||!c)throw g||new Error("PRODUCT_NOT_FOUND");const p=Number(c.qty||0),h=p<999999;if(t>0&&h&&p<1){(n=window.salesManager)==null||n.showSystemAlert(`OUT OF STOCK: ${String(c.name||((s=r==null?void 0:r.products)==null?void 0:s.name)||"PRODUCT").toUpperCase()}`,"error");return}if(h){const b=t>0?p-1:p+1,{error:T}=await supabaseClient.from("products").update({qty:b}).eq("productid",l.product_id);if(T)throw T}const u=Number(l.unit_price||(m>0?Number(l.total_amount||0)/m:0))*f,{error:w}=await supabaseClient.from("sales").update({qty:f,total_amount:u}).eq("id",e);if(w)throw w;window.wolfAudio&&window.wolfAudio.play("click"),await this.loadSales(),this.scheduleGoalActualsSync()}catch(r){console.error("Sale qty adjust fault:",r),window.wolfAudio&&window.wolfAudio.play("error"),(o=window.salesManager)==null||o.showSystemAlert("FAILED TO UPDATE SALE QTY","error")}},async deleteSale(e){if(!window.Swal||!(await window.Swal.fire({title:"REMOVE PRODUCT?",html:`
      <div style="color: #b47023; font-size: 4.5rem; margin-bottom: 10px;">
        <i class='bx bx-error-alt'></i>
      </div>
      <p class="wolf-swal-text" style="text-transform: uppercase; letter-spacing: 1px;">
        WARNING: THIS RECORD WILL BE MOVED TO TRASH BIN. PROCEED?
      </p>
    `,showCancelButton:!0,confirmButtonText:"REMOVE",cancelButtonText:"CANCEL",reverseButtons:!0,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup-orange",title:"wolf-swal-title",confirmButton:"wolf-swal-confirm-orange",cancelButton:"wolf-swal-cancel"}})).isConfirmed)return;const t=document.getElementById(`row-${e}`);try{t&&(t.classList.add("removing"),await new Promise(l=>setTimeout(l,400)),t.remove());const{data:i,error:s}=await supabaseClient.from("sales").select("*").eq("id",e).single();if(s||!i)throw s;const{data:n}=await supabaseClient.from("products").select("qty, name").eq("productid",i.product_id).single();n&&n.qty<999999&&await supabaseClient.from("products").update({qty:n.qty+i.qty}).eq("productid",i.product_id),await supabaseClient.from("trash_bin").insert([{original_id:e,table_name:"sales",deleted_data:i}]),await supabaseClient.from("sales").delete().eq("id",e),this.allSales=(this.allSales||[]).filter(l=>l.id!==e);const o=this.allSales.reduce((l,d)=>l+Number(d.total_amount||0),0);this.refreshSummaryHUD(o),this.scheduleGoalActualsSync();const r=`${(n==null?void 0:n.name)||"Product"}, X${i.qty} WAS REMOVED`;window.salesManager.showSystemAlert(r,"success"),Toastify({text:r,duration:5e3,gravity:"top",position:"right",stopOnFocus:!0,style:{border:"1px solid #ff9800",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast(),window.wolfAudio&&window.wolfAudio.play("success")}catch(i){console.error("Void Protocol Fault:",i),window.wolfAudio&&window.wolfAudio.play("error"),this.loadSales()}},async reopenLog(e){await supabaseClient.from("check_in_logs").update({time_out:null}).eq("id",e),this.loadLogbook(this.currentLogDay)},addLogbookRow(){this.loadLogbook()},updateLogbookRow(){this.loadLogbook()},removeLogbookRow(){this.loadLogbook()}};window.wolfData=wolfData,wolfData.addSaleRow=function(e){Array.isArray(this.salesData)||(this.salesData=[]),this.salesData.push(e);const a=document.querySelector("#sales-table-body");if(a){const t=document.createElement("tr");t.id=`sale-row-${e.id}`,t.innerHTML=`
      <td>${e.id}</td>
      <td>${e.product_name}</td>
      <td>${e.quantity}</td>
      <td>${e.price}</td>
      <td>${(e.quantity*e.price).toFixed(2)}</td>
      <td><button onclick="wolfData.deleteSale('${e.id}')">Delete</button></td>
    `,a.appendChild(t)}this.updateLedgerRevenue(),this.scheduleGoalActualsSync()},wolfData.removeSaleRow=function(e){this.allSales=(this.allSales||[]).filter(t=>t.id!==e);const a=document.getElementById(`row-${e}`);a&&a.remove(),this.updateLedgerRevenue(),this.scheduleGoalActualsSync()},wolfData.initRealtime=async function(){if(this.updateLedgerRevenue(),this.scheduleGoalActualsSync(50),this.realtimeChannel)return;this.selectedDate||await this.syncServerTime();const e=supabaseClient.channel("wolf-ledger-sync-stable").on("postgres_changes",{event:"INSERT",schema:"public",table:"sales"},t=>{if(this.scheduleGoalActualsSync(80),this.activeMode!=="sales")return;const i=t.new;this.allSales.unshift(i),this.renderSales(this.selectedDate.getDay())}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"sales"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="sales"&&(this.updateSaleRow(t.new),this.updateLedgerRevenue(),Toastify({text:`Sale updated: ${t.new.id}`,duration:5e3,gravity:"top",position:"right"}).showToast())}).on("postgres_changes",{event:"DELETE",schema:"public",table:"sales"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="sales"&&this.removeSaleRow(t.old.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"check_in_logs"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="logbook"&&(this.addLogbookRow(t.new),Toastify({text:`Log added: ${t.new.id}`,duration:5e3,gravity:"top",position:"right",style:{border:"1px solid #4dff00",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast())}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"check_in_logs"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="logbook"&&(this.updateLogbookRow(t.new),Toastify({text:`Log updated: ${t.new.id}`,duration:5e3,gravity:"top",position:"right",style:{border:"1px solid #6fff00",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast())}).on("postgres_changes",{event:"DELETE",schema:"public",table:"check_in_logs"},t=>{this.scheduleGoalActualsSync(80),this.activeMode==="logbook"&&(this.removeLogbookRow(t.old.id),Toastify({text:`Log removed: ${t.old.id}`,duration:5e3,gravity:"top",position:"right",style:{border:"1prgb(255, 0, 0) #ff9800",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast())}),{error:a}=await e.subscribe(t=>{var i;t==="SUBSCRIBED"&&((i=this.showRealtimeToast)==null||i.call(this))});if(a){Toastify({text:"Realtime subscription failed",duration:5e3,gravity:"top",position:"right",backgroundColor:"#f44336"}).showToast(),console.error("Realtime subscription failed:",a);return}this.realtimeChannel=e},wolfData.updateLedgerRevenue=function(){const e=document.getElementById("ledger-summary-amount");if(!e)return;const a=(this.allSales||[]).reduce((t,i)=>t+Number(i.total_amount||0),0);e.textContent=this.formatCurrency(a)},wolfData.showRealtimeToast=function(){const e=document.createElement("span");e.innerHTML=DOMPurify.sanitize(`
    <i class="bx bx-rfid" style="margin-right: 8px; font-size:18px; color:var(--wolf-red);"></i>
    LIVE_SYNC_ESTABLISHED
  `),Toastify({node:e,duration:5e3,gravity:"top",position:"right",style:{background:"#0a0a0a",border:"1px solid #ffffff",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast()},document.addEventListener("input",e=>{if(e.target.id==="ledger-main-search"){const a=e.target.value.trim(),t=document.getElementById("search-clear-btn");t&&(t.style.display=a.length>0?"block":"none"),wolfData.currentLedgerPage=1,wolfData.activeMode==="sales"?wolfData.renderSales(wolfData.selectedDate.getDay(),a):wolfData.loadLogbook()}if(e.target.id==="sales-min-amount"){const a=Number(e.target.value||0);if(wolfData.salesMinAmount=Number.isFinite(a)?Math.max(0,a):0,wolfData.activeMode==="sales"){const t=document.getElementById("ledger-main-search");wolfData.renderSales(wolfData.selectedDate.getDay(),t?t.value:"")}}}),document.addEventListener("change",e=>{if(e.target.id==="sales-sort-select"&&(wolfData.salesSortMode=String(e.target.value||"latest"),wolfData.activeMode==="sales")){const a=document.getElementById("ledger-main-search");wolfData.renderSales(wolfData.selectedDate.getDay(),a?a.value:"")}}),document.addEventListener("click",async e=>{if(e.target.closest("#muteToggleBtn")){e.preventDefault(),e.stopPropagation(),window.wolfAudio.toggleMute()||window.wolfAudio.play("notif");return}const t=wolfData.activeMode,i=(wolfData.serverToday||new Date).toLocaleDateString("en-CA"),s=e.target.closest("[data-sales-filter]");if(s&&wolfData.activeMode==="sales"){const d=String(s.getAttribute("data-sales-filter")||"all");wolfData.salesFilterMode=d,document.querySelectorAll("[data-sales-filter]").forEach(f=>f.classList.toggle("is-active",f.getAttribute("data-sales-filter")===d));const m=document.getElementById("ledger-main-search");wolfData.renderSales(wolfData.selectedDate.getDay(),m?m.value:"");return}if(e.target.closest("#toggle-search-btn"))return;const o=e.target.closest("#prev-week-btn, #next-week-btn");if(o){const d=o.id==="prev-week-btn"?-7:7,m=new Date,f=m.toLocaleDateString("en-CA"),c=new Date(wolfData.selectedDate);c.setDate(c.getDate()+d);const g=c.toLocaleDateString("en-CA");if(d>0)if(g>f)if(wolfData.selectedDate.toLocaleDateString("en-CA")===f){window.salesManager&&window.salesManager.showSystemAlert("CHRONOLOCK_ACTIVE: FUTURE PROJECTION BLOCKED","error");return}else console.log("WolfChrono: Jump exceeds today. Snapping to current date."),wolfData.selectedDate=m;else wolfData.selectedDate=c;else wolfData.selectedDate=c;wolfData.calculateWeek(t);return}if(e.target.closest("#chrono-picker-trigger")){wolfData.fp&&wolfData.fp.open();return}const r=e.target.closest(".day-btn");if(r){const d=r.getAttribute("data-date");if(d){if(d>i){window.salesManager&&window.salesManager.showSystemAlert("INVALID_PROTOCOL: FUTURE_DATE_LOCKED","error");return}const m=d.split("-");wolfData.selectedDate=new Date(m[0],m[1]-1,m[2]),wolfData.calculateWeek(t)}}if(e.target.closest("#add-ledger-btn")){const d=wolfData.activeMode;window.wolfAudio&&window.wolfAudio.play("notif"),wolfData.activeMode==="sales"?window.salesManager.openSaleTerminal():window.logbookManager.openLogbookTerminal()}if(e.target.closest("#clear-ledger-btn")){const d=wolfData.activeMode;Toastify({text:`Opening ${d.toUpperCase()} Trash Bin...`,duration:5e3,gravity:"top",position:"right",style:{background:"#343434",borderRadius:"10px",fontWeight:"bold",color:"#fff"}}).showToast(),window.salesManager&&window.salesManager.openTrashBin(d)}const l=e.target.closest("#snap-today-btn");if(l){if(!l.classList.contains("visible")||l.disabled)return;console.log("WolfChrono: Snap-to-Today triggered."),await wolfData.syncServerTime(),wolfData.fp&&wolfData.fp.setDate(wolfData.selectedDate,!1),wolfData.calculateWeek(wolfData.activeMode),window.salesManager&&window.salesManager.showSystemAlert("RETURNED TO TODAY'S WEEK!","success");return}}),document.addEventListener("click",()=>{setTimeout(()=>{const e=document.getElementById("week-range-display");if(e&&(e.innerText==="--- - ---"||e.innerText==="")){const a=document.getElementById("sales-day-picker")?"sales":"logbook";console.log(`WolfChrono: Auto-initializing ${a} view...`),wolfData.initChrono(a)}},100)}),window.addEventListener("load",()=>{const a=new URLSearchParams(window.location.search).get("p")||"home";wolfData.syncNavigationUI(a),setTimeout(()=>{wolfData.loadGoalTargets().catch(()=>{})},300),(a==="sales"||a==="logbook")&&setTimeout(async()=>{document.getElementById("ledger-page")&&(wolfData.syncServerTime&&await wolfData.syncServerTime(),await wolfData.initLedger(a),wolfData.initRealtime())},500)});
