window.logbookManager={selectedProfileId:null,selectedMember:null,selectedEntryType:"regular",selectedEntryFee:80,selectedPaid:!1,entryTypeLocked:!1,memberSearchTimer:null,clockInterval:null,serverOffset:0,getEntryFeeByType(e){const t=String(e||"").toLowerCase();return t==="member"?0:t==="student"?50:80},getEntryLabelByType(e){const t=String(e||"").toLowerCase();return t==="member"?"MEMBER":t==="student"?"STUDENT":"REGULAR (NON-MEMBER)"},getEntryDisplayName(e){const t=String(e||"").toLowerCase();return t==="member"?"MEMBER":t==="student"?"STUDENT":"REGULAR"},hideMemberSearchResults(e){const t=e==null?void 0:e.querySelector("#log-member-search-results");t&&(t.classList.remove("active"),t.innerHTML="")},renderMemberSearchResults(e,t=[]){const n=e==null?void 0:e.querySelector("#log-member-search-results");if(n){if(n.innerHTML="",!t||t.length===0){n.classList.remove("active");return}t.forEach(s=>{const r=String(s.member_code||s.sku||"").trim().toUpperCase(),o=String(s.full_name||"UNKNOWN MEMBER").trim().toUpperCase(),c=document.createElement("button");c.type="button",c.className="member-search-item",c.dataset.memberId=String(s.member_id||""),c.dataset.profileId=String(s.profile_id||""),c.dataset.memberCode=r,c.dataset.memberName=o;const a=document.createElement("span");a.className="member-search-main";const i=document.createElement("i");i.className="bx bx-badge-check";const l=document.createElement("span");l.className="member-search-name",l.textContent=o,a.appendChild(i),a.appendChild(l);const u=document.createElement("span");u.className="member-search-code",u.textContent=r||"MEMBER",c.appendChild(a),c.appendChild(u),n.appendChild(c)}),n.classList.add("active")}},async searchMembers(e){const t=String(e||"").trim();if(!t||!window.supabaseClient)return[];const n=t.replace(/[%(),]/g," "),{data:s,error:r}=await window.supabaseClient.from("members").select("member_id, profile_id, member_code, sku, full_name").or(`full_name.ilike.%${n}%,member_code.ilike.%${n}%,sku.ilike.%${n}%`).order("full_name",{ascending:!0}).limit(6);return r?[]:(s||[]).filter(o=>String(o.full_name||o.member_code||o.sku||"").trim().length>0)},clearSelectedMember(e){this.selectedProfileId=null,this.selectedMember=null;const t=e==null?void 0:e.querySelector("#log-guest-search");t&&(delete t.dataset.selectedMemberId,delete t.dataset.selectedMemberCode,delete t.dataset.selectedMemberLabel)},isInputPinnedToSelectedMember(e,t){const n=e==null?void 0:e.querySelector("#log-guest-search");if(!n||!this.selectedMember)return!1;const s=String(t||n.value||"").trim().toUpperCase(),r=String(n.dataset.selectedMemberLabel||"").trim().toUpperCase(),o=String(n.dataset.selectedMemberCode||"").trim().toUpperCase();return s?s===r||s===o:!1},applySelectedMember(e,t,n={}){if(!t)return;const{useCode:s=!1}=n,r=String(t.member_code||t.sku||"").trim().toUpperCase(),o=String(t.full_name||r||"MEMBER").trim().toUpperCase(),c=s&&r?r:o,a=e==null?void 0:e.querySelector("#log-guest-search");this.selectedProfileId=t.profile_id||null,this.selectedMember={member_id:t.member_id||null,profile_id:t.profile_id||null,member_code:r,sku:r,full_name:o},a&&(a.value=c,a.dataset.selectedMemberId=String(t.member_id||""),a.dataset.selectedMemberCode=r,a.dataset.selectedMemberLabel=c);const i=r?`MEMBER_LOCKED [${r}]`:"MEMBER_LOCKED";this.updateProtocolState(e,i,"status-member"),this.setEntryType(e,"member",{lock:!0}),this.hideMemberSearchResults(e)},updateEntrySummary(e){var o;const t=e==null?void 0:e.querySelector(".summary-val");if(!t)return;const n=((o=window.wolfData)==null?void 0:o.currencySymbol)||"PHP ",s=Number(this.selectedEntryFee||0),r=this.selectedPaid?"PAID":"UNPAID";t.innerText=`CHECK-IN | ${this.getEntryDisplayName(this.selectedEntryType)} | ${n}${s} | ${r}`},setEntryType(e,t,n={}){const{lock:s=!1}=n,r=String(t||"regular").toLowerCase(),o=["member","student","regular"].includes(r)?r:"regular";this.entryTypeLocked=!!s,this.selectedEntryType=this.entryTypeLocked?"member":o,this.selectedEntryFee=this.getEntryFeeByType(this.selectedEntryType),((e==null?void 0:e.querySelectorAll("[data-entry-tier]"))||[]).forEach(a=>{const i=String(a.dataset.entryTier||"").toLowerCase();a.classList.toggle("is-active",i===this.selectedEntryType),a.disabled=this.entryTypeLocked&&i!=="member"}),this.updateEntrySummary(e)},async openLogbookTerminal(e=""){console.log("Wolf OS: Initializing Logbook Entry Protocol..."),window.wolfAudio&&window.wolfAudio.play("notif"),window.wolfData&&window.wolfData.syncServerTime&&await window.wolfData.syncServerTime();const t=document.getElementById("logbook-modal-overlay");t&&t.remove();try{const s=await(await fetch("/assets/components/record-logbook-modal.html")).text();document.body.insertAdjacentHTML("beforeend",s);const r=document.getElementById("logbook-modal-overlay");if(await this.syncClockOffset(),r&&(this.selectedEntryType="regular",this.selectedEntryFee=this.getEntryFeeByType("regular"),this.selectedPaid=!1,this.entryTypeLocked=!1,this.memberSearchTimer=null,r.style.display="flex",this.attachLogbookListeners(r),this.startTerminalClock(r),this.setEntryType(r,"regular"),this.updateEntrySummary(r),e)){const o=r.querySelector("#log-guest-search");o&&(o.value=String(e).trim().toUpperCase(),await this.syncIdentityFromInput(r,o.value,{forceResolve:!0}))}}catch(n){console.error("Wolf OS: Modal Load Fault:",n)}},updateProtocolState(e,t,n="status-ready"){const s=e.querySelector(".node-value.status-ready, .node-value.status-warn, .node-value.status-member");s&&(s.className=`node-value ${n}`,s.innerText=t)},async resolveMemberIdentity(e,t={}){const n=String(e||"").trim(),s=String(t.mode||"strict").toLowerCase();if(!n||!window.supabaseClient)return null;const r="member_id, profile_id, member_code, sku, full_name";if(/^ME-[A-Z0-9]{2,}$/i.test(n)){const a=n.toUpperCase(),{data:i,error:l}=await window.supabaseClient.from("members").select(r).or(`member_code.eq.${a},sku.eq.${a}`).limit(1);return l?null:(i==null?void 0:i[0])||null}if(s==="fuzzy"){const a=n.replace(/[%(),]/g," "),{data:i,error:l}=await window.supabaseClient.from("members").select(r).or(`full_name.ilike.%${a}%,member_code.ilike.%${a}%,sku.ilike.%${a}%`).order("full_name",{ascending:!0}).limit(1);return l?null:(i==null?void 0:i[0])||null}const{data:o,error:c}=await window.supabaseClient.from("members").select(r).ilike("full_name",n).limit(1);return c?null:(o==null?void 0:o[0])||null},async syncIdentityFromInput(e,t,n={}){var a,i;const s=String(t||"").trim();if(!s){this.clearSelectedMember(e),this.hideMemberSearchResults(e),this.updateProtocolState(e,"AWAITING_AUTH","status-ready"),this.setEntryType(e,"regular",{lock:!1});return}if(this.isInputPinnedToSelectedMember(e,s)){const l=String(((a=this.selectedMember)==null?void 0:a.member_code)||((i=this.selectedMember)==null?void 0:i.sku)||"").trim().toUpperCase(),u=l?`MEMBER_LOCKED [${l}]`:"MEMBER_LOCKED";this.updateProtocolState(e,u,"status-member"),this.setEntryType(e,"member",{lock:!0});return}let r=null;const o=!!n.forceResolve;if((/^ME-[A-Z0-9]{2,}$/i.test(s)||o)&&(r=await this.resolveMemberIdentity(s,{mode:"strict"})),r){this.applySelectedMember(e,r,{useCode:/^ME-[A-Z0-9]{2,}$/i.test(s)});return}this.clearSelectedMember(e),this.updateProtocolState(e,"WALK-IN_PENDING","status-warn");const c=this.selectedEntryType==="member"?"regular":this.selectedEntryType;this.setEntryType(e,c,{lock:!1})},async syncClockOffset(){try{const{data:e,error:t}=await supabaseClient.rpc("get_server_time");if(t)throw t;const n=Array.isArray(e)?e[0].server_iso_timestamp||e[0]:e;if(!n)throw new Error("Null Timestamp Received");const s=new Date(n).getTime(),r=Date.now();this.serverOffset=s-r,console.log(`Wolf OS: Time Delta Calibrated [${this.serverOffset}ms]`)}catch(e){console.warn("Wolf OS: RPC Sync Failed, defaulting to Local Time."),this.serverOffset=0}},startTerminalClock(e){const t=e.querySelector("#log-current-time");t&&(this.clockInterval&&clearInterval(this.clockInterval),this.clockInterval=setInterval(()=>{const n=new Date(Date.now()+this.serverOffset);if(isNaN(n.getTime())){t.innerText="SYNCING...";return}t.innerText=n.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0})},1e3))},attachLogbookListeners(e){const t=e.querySelector("#record-logbook-form"),n=e.querySelector("#closeLogModal"),s=e.querySelector("#log-guest-search"),r=e.querySelector("#log-member-search-results"),o=e.querySelectorAll("[data-entry-tier]"),c=e.querySelector("#log-paid-toggle");o&&o.length>0&&o.forEach(i=>{i.addEventListener("click",()=>{const l=i.dataset.entryTier||"regular";this.setEntryType(e,l,{lock:!1})})}),c&&(c.checked=!1,c.addEventListener("change",()=>{this.selectedPaid=!!c.checked,this.updateEntrySummary(e)})),r&&r.addEventListener("click",i=>{const l=i.target.closest(".member-search-item");if(!l)return;const u={member_id:l.dataset.memberId||null,profile_id:l.dataset.profileId||null,member_code:l.dataset.memberCode||"",sku:l.dataset.memberCode||"",full_name:l.dataset.memberName||""};this.applySelectedMember(e,u,{useCode:!1}),s&&s.focus()}),t.onsubmit=async i=>{i.preventDefault();const l=s.value.trim(),u=e.querySelector("#log-submit-btn");l&&(u.disabled=!0,u.querySelector("span").innerText="AUTHORIZING...",await this.processCheckIn(l,{entryType:this.selectedEntryType,isPaid:this.selectedPaid}),this.closeLogbookTerminal())},s&&(s.addEventListener("input",()=>{s.value=s.value.toUpperCase();const i=String(s.value||"").trim();this.isInputPinnedToSelectedMember(e,i)||this.clearSelectedMember(e),this.memberSearchTimer&&clearTimeout(this.memberSearchTimer),this.memberSearchTimer=setTimeout(async()=>{if(!i){this.hideMemberSearchResults(e),await this.syncIdentityFromInput(e,i);return}if(/^ME-[A-Z0-9]{2,}$/i.test(i)){this.hideMemberSearchResults(e),await this.syncIdentityFromInput(e,i,{forceResolve:!0});return}const l=await this.searchMembers(i);this.renderMemberSearchResults(e,l),await this.syncIdentityFromInput(e,i)},170)}),s.addEventListener("focus",async()=>{const i=String(s.value||"").trim();if(!i||/^ME-[A-Z0-9]{2,}$/i.test(i)||this.isInputPinnedToSelectedMember(e,i))return;const l=await this.searchMembers(i);this.renderMemberSearchResults(e,l)}),s.addEventListener("blur",()=>{setTimeout(()=>this.hideMemberSearchResults(e),120)})),n&&(n.onclick=i=>{i.preventDefault(),this.closeLogbookTerminal()}),e.onclick=i=>{i.target.id==="logbook-modal-overlay"&&this.closeLogbookTerminal()};const a=i=>{i.key==="Escape"&&(this.closeLogbookTerminal(),document.removeEventListener("keydown",a))};document.addEventListener("keydown",a),setTimeout(()=>{s&&s.focus()},200)},closeLogbookTerminal(){const e=document.getElementById("logbook-modal-overlay");if(e){const t=e.querySelector(".wolf-modal-card");e.classList.add("closing"),t&&t.classList.add("closing"),clearInterval(this.clockInterval),setTimeout(()=>e.remove(),260)}this.memberSearchTimer&&(clearTimeout(this.memberSearchTimer),this.memberSearchTimer=null)},async processCheckIn(e,t={}){var n;try{const s=String(e||"").trim(),r=this.selectedMember||await this.resolveMemberIdentity(s),o=String(t.entryType||this.selectedEntryType||"regular").toLowerCase(),c=r?"member":["member","student","regular"].includes(o)?o:"regular",a=this.getEntryFeeByType(c),i=!!t.isPaid,l=i?a:0,u=(r==null?void 0:r.full_name)||s,h=String((r==null?void 0:r.member_code)||(r==null?void 0:r.sku)||"").trim().toUpperCase(),y=this.getEntryLabelByType(c),p=[h,u.toUpperCase()].filter(Boolean).join(" ").trim(),f=r?`MEMBER_ENTRY: ${p}`:`WALK-IN: ${u.toUpperCase()}`,b=typeof((n=window.wolfData)==null?void 0:n.buildLogNotes)=="function"?window.wolfData.buildLogNotes(f,y,i,l):f,d={profile_id:(r==null?void 0:r.profile_id)||this.selectedProfileId||null,source:r?"MEMBER":"TERMINAL",notes:b,membership_label:y,entry_fee:a,is_paid:i,paid_amount:l,paid_at:i?new Date().toISOString():null};let{error:m}=await supabaseClient.from("check_in_logs").insert([d]);if(m&&/column .* does not exist|schema cache/i.test(String(m.message||""))){const{error:g}=await supabaseClient.from("check_in_logs").insert([{profile_id:d.profile_id,source:d.source,notes:d.notes}]);m=g}if(m)throw m;window.salesManager&&window.salesManager.showSystemAlert(`ACCESS GRANTED: ${u}`,"success"),window.wolfAudio&&window.wolfAudio.play("success"),window.wolfData&&window.wolfData.loadLogbook&&window.wolfData.loadLogbook()}catch(s){console.error("Logbook Protocol Fault:",s),window.wolfAudio&&window.wolfAudio.play("error"),window.salesManager&&window.salesManager.showSystemAlert("DATABASE_REJECTED_ENTRY","error")}}};
