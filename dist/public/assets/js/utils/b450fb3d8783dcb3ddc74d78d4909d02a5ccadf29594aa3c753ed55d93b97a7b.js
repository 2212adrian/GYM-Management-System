(function(){if(window.__wolfSystemToolsManagersBooted)return;window.__wolfSystemToolsManagersBooted=!0;const q="wolf_local_equipments",O="wolf_local_feedback_entries",M="wolf_local_goal_targets",P="wolf_action_sounds_muted",F="wolf_victory_visuals_enabled",z="wolf_ui_scale_percent",B="wolf_display_name",x="adrianangeles2212@gmail.com",V=new Set([x,"ktorrazo123@gmail.com"]),Y=new Set(["adrianangeles2213@gmail.com"]);function C(e){return String(e||"").trim().toLowerCase()}function K(){const e=window.WOLF_ACCESS_CONTEXT||{},t=C(e.email||window.WOLF_USER_EMAIL);if(t&&V.has(t))return"admin";if(t&&Y.has(t))return"staff";const a=String(e.role||window.WOLF_USER_ROLE||"").trim().toLowerCase();return a==="admin"||a==="staff"?a:null}function w(){var i;const e=K(),t=C(((i=window.WOLF_ACCESS_CONTEXT)==null?void 0:i.email)||window.WOLF_USER_EMAIL),a=e==="admin";return{role:e,email:t,isAdmin:a,isStaff:e==="staff",isSuperAdmin:t===x,canHardDelete:a}}function l(e){return String(e!=null?e:"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function b(e){const t=Number(e);return Number.isFinite(t)?t:0}function _(e=0){return`PHP ${b(e).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`}function L(e){if(!e)return"N/A";const t=new Date(e);return Number.isNaN(t.getTime())?"N/A":t.toLocaleString(void 0,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"})}function H(e){if(!e)return"N/A";const t=new Date(e);return Number.isNaN(t.getTime())?"N/A":t.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"})}function c(e,t="info"){const a=String(e||"").trim();if(a){if(window.salesManager&&typeof window.salesManager.showSystemAlert=="function"){const s=t==="error"||t==="warning"?"error":"success";window.salesManager.showSystemAlert(a,s)}typeof window.Toastify=="function"&&window.Toastify({text:a,duration:3200,gravity:"top",position:"right",style:{background:t==="error"?"#3a1111":t==="warning"?"#3a2b11":"#102119",color:"#f4f6f9",border:`1px solid ${t==="error"?"#ef4444":t==="warning"?"#f59e0b":"#22c55e"}`,borderRadius:"10px",fontWeight:"700"}}).showToast()}}function $(e){try{const t=window.localStorage.getItem(e);if(!t)return[];const a=JSON.parse(t);return Array.isArray(a)?a:[]}catch(t){return[]}}function U(e,t){try{window.localStorage.setItem(e,JSON.stringify(t||[]))}catch(a){}}function y(e){const t=String((e==null?void 0:e.message)||"").toLowerCase();return(e==null?void 0:e.code)==="PGRST204"||/column .* does not exist/.test(t)||/could not find the .* column/.test(t)||/schema cache/.test(t)}function k(e){const t=String((e==null?void 0:e.message)||"").toLowerCase();return(e==null?void 0:e.code)==="PGRST205"||(e==null?void 0:e.code)==="42P01"||/relation .* does not exist/.test(t)||/could not find the table/.test(t)||/table .* does not exist/.test(t)}function D(e){const t=String((e==null?void 0:e.message)||"").toLowerCase();return(e==null?void 0:e.code)==="42501"||/row-level security policy/.test(t)||/permission denied/.test(t)||/insufficient privileges/.test(t)}async function h(){if(window.supabaseClient)return window.supabaseClient;if(window.supabaseReady&&typeof window.supabaseReady.then=="function")try{await window.supabaseReady}catch(e){}return window.supabaseClient||null}function A(e){const t=new Date(e);return t.setHours(0,0,0,0),t}function G(e){const t=A(e);return t.setDate(t.getDate()+1),t}function Q(e){const t=A(e);return t.setDate(t.getDate()-t.getDay()),t}function J(e){const t=A(e);return t.setDate(1),t}function j(e,t){for(const a of t){const s=e==null?void 0:e[a];if(!s)continue;const i=new Date(s);if(!Number.isNaN(i.getTime()))return i}return null}async function W(e,t,a,s,i,r){if(!e)return{data:[],error:null};for(const m of r){const{data:g,error:p}=await e.from(t).select(a).gte(m,s).lt(m,i);if(!p)return{data:g||[],error:null};if(!y(p))return{data:[],error:p}}const{data:n,error:o}=await e.from(t).select(a);if(o)return{data:[],error:o};const d=new Date(s),u=new Date(i);return{data:(n||[]).filter(m=>{const g=j(m,r);return g?g>=d&&g<u:!1}),error:null}}function X(e){return(e||[]).reduce((t,a)=>{const s=b(a.total_amount);if(s>0)return t+s;const i=b(a.qty),r=b(a.unit_price);return t+i*r},0)}function Z(e){return(e||[]).reduce((t,a)=>{const s=b(a.paid_amount);return s>0?t+s:a.is_paid?t+b(a.entry_fee):t},0)}async function T(e,t,a){const s=t.toISOString(),i=a.toISOString(),r=await W(e,"sales","id,total_amount,qty,unit_price,created_at",s,i,["created_at"]),n=await W(e,"check_in_logs","id,entry_fee,paid_amount,is_paid,time_in,created_at",s,i,["time_in","created_at"]);return{salesAmount:X(r.data),logbookAmount:Z(n.data),salesCount:(r.data||[]).length,trafficCount:(n.data||[]).length,salesError:r.error,logbookError:n.error}}window.DashboardManager={_timer:null,async init(){document.getElementById("page-wrapper")&&(await this.load(),this._timer&&window.clearInterval(this._timer),this._timer=window.setInterval(()=>this.load(),45e3))},async load(){const e=document.getElementById("dashboard-total-net");if(!e)return;const t=await h();if(!t){e.textContent=_(0);return}const a=new Date,s=A(a),i=G(a),r=new Date(s);r.setDate(r.getDate()-1);const[n,o,d]=await Promise.all([T(t,s,i),T(t,r,s),t.from("members").select("member_id",{count:"exact",head:!0})]),u=n.salesAmount+n.logbookAmount,f=o.salesAmount+o.logbookAmount,m=f>0?(u-f)/f*100:0,g=document.getElementById("dashboard-vs-yesterday"),p=document.getElementById("dashboard-products-total"),v=document.getElementById("dashboard-log-fees-total"),S=document.getElementById("dashboard-active-members"),I=document.getElementById("dashboard-floor-traffic"),E=document.getElementById("dashboard-trend-icon");if(e.textContent=_(u),p&&(p.textContent=_(n.salesAmount)),v&&(v.textContent=_(n.logbookAmount)),S&&(S.textContent=String(b(d.count||0))),I&&(I.textContent=`${n.trafficCount}/30`),g){const N=Math.abs(m).toFixed(1);f<=0&&u>0?g.textContent="NEW REVENUE ACTIVITY TODAY":g.textContent=`${N}% VS YESTERDAY`}E&&(m>=0?(E.className="bx bx-trending-up",E.style.color="#22c55e"):(E.className="bx bx-trending-down",E.style.color="var(--accent-red)"))}},window.GoalCenterManager={useLocalCache:!1,pickLatestGoalRow(e){const t=Array.isArray(e)?e.slice():[];return t.length?(t.sort((a,s)=>{const i=new Date((a==null?void 0:a.start_date)||0).getTime(),r=new Date((s==null?void 0:s.start_date)||0).getTime(),n=new Date((a==null?void 0:a.created_at)||0).getTime(),o=new Date((s==null?void 0:s.created_at)||0).getTime(),d=b(a==null?void 0:a.id),u=b(s==null?void 0:s.id);return(Number.isFinite(r)?r:0)-(Number.isFinite(i)?i:0)||(Number.isFinite(o)?o:0)-(Number.isFinite(n)?n:0)||u-d}),t[0]||null):null},getLocalTargets(){const e=$(M),t=new Map;return e.forEach(a=>{a!=null&&a.period_type&&t.set(String(a.period_type).toUpperCase(),b(a.target_amount))}),t},setLocalTarget(e,t){const a=$(M).filter(s=>String(s.period_type||"").toUpperCase()!==e);a.push({id:`local-${e}-${Date.now()}`,period_type:e,target_amount:b(t),start_date:new Date().toISOString().slice(0,10)}),U(M,a)},async init(){const e=document.getElementById("goal-center-page");if(!e||e.dataset.boundGoalCenter==="1"){await this.load();return}e.dataset.boundGoalCenter="1",e.addEventListener("click",async t=>{const a=t.target.closest("#goal-daily-save, #goal-weekly-save, #goal-monthly-save");if(!a)return;const s=a.id.includes("daily")?"DAILY":a.id.includes("weekly")?"WEEKLY":"MONTHLY";await this.save(s)}),await this.load()},getInput(e){const t=`goal-${e.toLowerCase()}-input`;return document.getElementById(t)},async save(e){const t=this.getInput(e);if(!t)return;const a=b(t.value);if(a<=0){c("Target must be greater than zero.","error");return}const s=await h();if(!s||this.useLocalCache){this.setLocalTarget(e,a),await this.load(),c("Target saved locally.","success");return}const i={period_type:e,target_amount:a,start_date:new Date().toISOString().slice(0,10)};let{error:r}=await s.from("goal_target").upsert(i,{onConflict:"period_type"});if(r&&y(r)&&({error:r}=await s.from("goal_target").upsert({period_type:e,target_amount:a},{onConflict:"period_type"})),r){const n=await s.from("goal_target").select("id,period_type,target_amount,start_date,created_at").eq("period_type",e).limit(200),o=this.pickLatestGoalRow(n.data||[]);!n.error&&(o!=null&&o.id)&&({error:r}=await s.from("goal_target").update(i).eq("id",o.id))}if(r){if(k(r)){this.useLocalCache=!0,this.setLocalTarget(e,a),await this.load(),c("Goal table missing. Saved locally for now.","warning");return}if(D(r)){this.useLocalCache=!0,this.setLocalTarget(e,a),await this.load(),c("Goal target blocked by RLS. Saved locally. Run docs/sql/goal_target_rls_policy.sql.","warning");return}c(`Failed to save target: ${r.message}`,"error");return}window.wolfData&&typeof window.wolfData.loadGoalTargets=="function"&&await window.wolfData.loadGoalTargets(),await this.load(),c(`${e} target saved.`,"success")},async loadTargetsFromDatabase(e){const t=["DAILY","WEEKLY","MONTHLY"],a=new Map;for(const s of t){const{data:i,error:r}=await e.from("goal_target").select("*").eq("period_type",s).limit(200);if(r)return{error:r,map:a};const n=this.pickLatestGoalRow(i||[]);a.set(s,b(n==null?void 0:n.target_amount))}return{error:null,map:a}},async load(){if(!document.getElementById("goal-center-page"))return;const t=await h();let a=this.getLocalTargets();if(t&&!this.useLocalCache){const{error:g,map:p}=await this.loadTargetsFromDatabase(t);g?k(g)?this.useLocalCache=!0:D(g)?(this.useLocalCache=!0,c("Goal target read blocked by RLS. Using local cache. Run docs/sql/goal_target_rls_policy.sql.","warning")):c(`Unable to load goal targets: ${g.message}`,"error"):a=p}const s=new Date,i=A(s),r=G(s),n=Q(s),o=J(s),[d,u,f]=t?await Promise.all([T(t,i,r),T(t,n,r),T(t,o,r)]):[{salesAmount:0,logbookAmount:0},{salesAmount:0,logbookAmount:0},{salesAmount:0,logbookAmount:0}],m={DAILY:d.salesAmount+d.logbookAmount,WEEKLY:u.salesAmount+u.logbookAmount,MONTHLY:f.salesAmount+f.logbookAmount};["DAILY","WEEKLY","MONTHLY"].forEach(g=>{const p=b(a.get(g)),v=b(m[g]),S=p>0?Math.min(100,Math.round(v/p*100)):0,I=document.getElementById(`goal-${g.toLowerCase()}-amount`),E=document.getElementById(`goal-${g.toLowerCase()}-progress`),N=document.getElementById(`goal-${g.toLowerCase()}-window`),R=this.getInput(g);I&&(I.textContent=_(p)),E&&(E.style.width=`${S}%`),R&&!R.value&&(R.value=p>0?String(p):""),N&&(N.textContent=`ACTUAL ${_(v)} | ${S}% OF TARGET`)})}},window.EquipmentManager={useLocalCache:!1,items:[],currentPage:1,pageSize:8,getListContainer(){return document.getElementById("equip-list")},mapRowToItem(e){return{id:e.id||e.equipment_id||e.eq_id||`tmp-${Date.now()}`,equipment_code:e.equipment_code||e.code||"",name:e.name||"UNKNOWN EQUIPMENT",condition:e.condition||"GOOD",status:e.status||(e.is_active===!1?"INACTIVE":"ACTIVE"),image_url:e.image_url||"",notes:e.notes||"",created_at:e.created_at||null}},async init(){const e=document.querySelector(".equip-wrapper");e&&(e.dataset.boundEquipManager!=="1"&&(e.dataset.boundEquipManager="1",e.addEventListener("click",async t=>{if(t.target.closest("#equip-add-btn")){await this.openEditor();return}const s=t.target.closest("[data-equip-action]"),i=t.target.closest("[data-equip-page]");if(i){const d=Number(i.getAttribute("data-equip-page"));Number.isFinite(d)&&d>0&&(this.currentPage=d,this.render());return}if(!s)return;const r=s.getAttribute("data-equip-id"),n=s.getAttribute("data-equip-action"),o=this.items.find(d=>String(d.id)===String(r));o&&(n==="edit"&&await this.openEditor(o),n==="delete"&&await this.remove(o))})),await this.load())},loadLocalItems(){this.items=$(q).map(e=>this.mapRowToItem(e))},saveLocalItems(){U(q,this.items)},async load(){if(!this.getListContainer())return;const t=await h();if(!t||this.useLocalCache){this.loadLocalItems(),this.render();return}const{data:a,error:s}=await t.from("equipments").select("*").order("created_at",{ascending:!1});if(s){if(k(s)){this.useLocalCache=!0,this.loadLocalItems(),this.render(),c("Equipments table not found. Using local cache mode.","warning");return}c(`Failed to load equipments: ${s.message}`,"error");return}this.items=(a||[]).map(i=>this.mapRowToItem(i)),this.render()},render(){const e=this.getListContainer();if(!e)return;if(!this.items.length){e.innerHTML=`
          <div class="equip-card" style="justify-content:center;">
            <div class="equip-sub">NO EQUIPMENT RECORDS YET. TAP + TO ADD.</div>
          </div>
        `;return}const t=this.items.length,a=Math.max(1,Math.ceil(t/this.pageSize));this.currentPage>a&&(this.currentPage=a);const s=(this.currentPage-1)*this.pageSize,r=this.items.slice(s,s+this.pageSize).map(n=>{const o=String(n.status).toUpperCase()==="ACTIVE"?"#22c55e":"#f97316";return`
            <div class="equip-card">
              <div class="equip-info">
                <div class="equip-thumb">
                  <img src="${l(n.image_url||"/assets/images/placeholder.png")}" alt="${l(n.name)}" />
                </div>
                <div>
                  <div class="equip-name">${l(n.name)}</div>
                  <div class="equip-sub">${l(n.equipment_code||"UNASSIGNED")} - ${l(n.condition||"GOOD")}</div>
                  <div class="equip-status" style="color:${o};">${l(n.status||"ACTIVE")}</div>
                </div>
              </div>
              <div class="equip-actions">
                <i class="bx bx-edit" data-equip-action="edit" data-equip-id="${l(n.id)}"></i>
                <i class="bx bx-trash" data-equip-action="delete" data-equip-id="${l(n.id)}"></i>
              </div>
            </div>
          `}).join("")},async openEditor(e=null){if(!window.Swal)return;const t=!!e,a=await window.Swal.fire({title:t?"EDIT EQUIPMENT":"ADD EQUIPMENT",background:"#0d0f12",color:"#e6ebf5",showCancelButton:!0,confirmButtonText:t?"SAVE CHANGES":"ADD EQUIPMENT",html:`
          <input id="equip-name" class="swal2-input" placeholder="Equipment Name" value="${l((e==null?void 0:e.name)||"")}">
          <input id="equip-code" class="swal2-input" placeholder="Code (e.g. EQ-101)" value="${l((e==null?void 0:e.equipment_code)||"")}">
          <input id="equip-condition" class="swal2-input" placeholder="Condition (GOOD/NEEDS_SERVICE)" value="${l((e==null?void 0:e.condition)||"")}">
          <input id="equip-status" class="swal2-input" placeholder="Status (ACTIVE/INACTIVE)" value="${l((e==null?void 0:e.status)||"ACTIVE")}">
          <input id="equip-image" class="swal2-input" placeholder="Image URL (optional)" value="${l((e==null?void 0:e.image_url)||"")}">
          <textarea id="equip-notes" class="swal2-textarea" placeholder="Notes">${l((e==null?void 0:e.notes)||"")}</textarea>
        `,preConfirm:()=>{var i,r,n,o,d,u,f,m,g,p,v,S;const s=(r=(i=document.getElementById("equip-name"))==null?void 0:i.value)==null?void 0:r.trim();return s?{name:s,equipment_code:((o=(n=document.getElementById("equip-code"))==null?void 0:n.value)==null?void 0:o.trim().toUpperCase())||null,condition:((u=(d=document.getElementById("equip-condition"))==null?void 0:d.value)==null?void 0:u.trim().toUpperCase())||"GOOD",status:((m=(f=document.getElementById("equip-status"))==null?void 0:f.value)==null?void 0:m.trim().toUpperCase())||"ACTIVE",image_url:((p=(g=document.getElementById("equip-image"))==null?void 0:g.value)==null?void 0:p.trim())||null,notes:((S=(v=document.getElementById("equip-notes"))==null?void 0:v.value)==null?void 0:S.trim())||null}:(window.Swal.showValidationMessage("Equipment name is required."),null)}});!a.isConfirmed||!a.value||(t?await this.update(e,a.value):await this.create(a.value))},async create(e){const t=await h();if(!t||this.useLocalCache){this.items.unshift({id:`local-eq-${Date.now()}`,...e,created_at:new Date().toISOString()}),this.saveLocalItems(),this.render(),c("Equipment added (local cache).","success");return}const{data:a,error:s}=await t.from("equipments").insert(e).select("*").single();if(s){if(k(s)){this.useLocalCache=!0,await this.create(e),c("Equipments table missing. Stored locally.","warning");return}c(`Add equipment failed: ${s.message}`,"error");return}this.items.unshift(this.mapRowToItem(a||e)),this.render(),c("Equipment added.","success")},async update(e,t){const a=await h();if(!a||this.useLocalCache){this.items=this.items.map(i=>String(i.id)===String(e.id)?{...i,...t}:i),this.saveLocalItems(),this.render(),c("Equipment updated (local cache).","success");return}let s=await a.from("equipments").update(t).eq("id",e.id).select("*").maybeSingle();if(s.error&&y(s.error)&&(s=await a.from("equipments").update(t).eq("equipment_id",e.id).select("*").maybeSingle()),s.error){c(`Update failed: ${s.error.message}`,"error");return}this.items=this.items.map(i=>String(i.id)===String(e.id)?this.mapRowToItem(s.data||{...i,...t}):i),this.render(),c("Equipment updated.","success")},async remove(e){if(!w().canHardDelete){c("Only admin can hard delete records.","warning");return}if(!window.Swal)return;const{isConfirmed:a}=await window.Swal.fire({title:"DELETE EQUIPMENT?",text:`${e.name} will be removed from the equipment list.`,icon:"warning",showCancelButton:!0,confirmButtonText:"DELETE",background:"#0d0f12",color:"#e6ebf5"});if(!a)return;const s=await h();if(!s||this.useLocalCache){this.items=this.items.filter(r=>String(r.id)!==String(e.id)),this.saveLocalItems(),this.render(),c("Equipment deleted (local cache).","success");return}let i=await s.from("equipments").delete().eq("id",e.id);if(i.error&&y(i.error)&&(i=await s.from("equipments").delete().eq("equipment_id",e.id)),i.error){c(`Delete failed: ${i.error.message}`,"error");return}this.items=this.items.filter(r=>String(r.id)!==String(e.id)),this.render(),c("Equipment removed.","success")}},window.FeedbackManager={entries:[],useLocalCache:!1,access:w(),tagOptionsCache:[],tagMetaLookup:new Map,composeOpen:!1,composeTags:[],composeSearchTerm:"",composeMessage:"",composeLoadingTags:!1,currentPage:1,pageSize:6,autoDeleteWarned:!1,expandedEntryIds:new Set,getListContainer(){return document.getElementById("feedback-list")},mapRowToEntry(e){return{id:e.id||e.feedback_id||`local-feedback-${Date.now()}`,author_name:e.author_name||"SYSTEM USER",author_role:e.author_role||"STAFF",message:e.message||"",tagged_assets:Array.isArray(e.tagged_assets)?e.tagged_assets:typeof e.tagged_assets=="string"?e.tagged_assets.split(",").map(t=>t.trim()).filter(Boolean):[],is_read:!!e.is_read,created_at:e.created_at||new Date().toISOString()}},async init(){const e=document.getElementById("feedback-page");e&&(this.access=w(),e.dataset.boundFeedbackManager!=="1"&&(e.dataset.boundFeedbackManager="1",e.addEventListener("click",async t=>{if(t.target.closest("#feedback-add-btn")){await this.openComposeInline();return}if(t.target.closest("[data-feedback-compose-cancel]")){this.closeComposeInline();return}if(t.target.closest("[data-feedback-compose-submit]")){await this.submitComposeInline();return}const a=t.target.closest("[data-feedback-tag-add]");if(a){this.addComposeTag(a.getAttribute("data-feedback-tag-add"));return}const s=t.target.closest("[data-feedback-toggle-id]");if(s){const m=String(s.getAttribute("data-feedback-toggle-id")||"");if(!m)return;this.expandedEntryIds.has(m)?this.expandedEntryIds.delete(m):this.expandedEntryIds.add(m),this.render();return}const i=t.target.closest("[data-feedback-tag-remove]");if(i){this.removeComposeTag(i.getAttribute("data-feedback-tag-remove"));return}const r=t.target.closest("[data-feedback-delete-id]");if(r){const m=r.getAttribute("data-feedback-delete-id"),g=this.entries.find(p=>String(p.id)===String(m));if(!g)return;await this.remove(g);return}const n=t.target.closest("[data-feedback-edit-id]");if(n){const m=n.getAttribute("data-feedback-edit-id"),g=this.entries.find(p=>String(p.id)===String(m));if(!g)return;await this.editEntry(g);return}const o=t.target.closest("[data-feedback-page]");if(o){const m=Number(o.getAttribute("data-feedback-page"));Number.isFinite(m)&&m>0&&(this.currentPage=m,this.render());return}const d=t.target.closest("[data-feedback-read-id]");if(!d)return;const u=d.getAttribute("data-feedback-read-id"),f=this.entries.find(m=>String(m.id)===String(u));f&&await this.toggleRead(f)}),e.addEventListener("input",t=>{if(t.target.id==="feedback-compose-search"){this.composeSearchTerm=t.target.value||"",this.refreshComposeUi();return}t.target.id==="feedback-compose-message"&&(this.composeMessage=t.target.value||"")}),e.addEventListener("keydown",t=>{const a=t.target.closest(".feedback-row-summary[data-feedback-toggle-id]");if(!a||t.key!=="Enter"&&t.key!==" ")return;t.preventDefault();const s=String(a.getAttribute("data-feedback-toggle-id")||"");s&&(this.expandedEntryIds.has(s)?this.expandedEntryIds.delete(s):this.expandedEntryIds.add(s),this.render())})),await this.load())},loadLocalEntries(){this.entries=$(O).map(e=>this.mapRowToEntry(e))},saveLocalEntries(){U(O,this.entries)},async load(){if(!this.getListContainer())return;this.expandedEntryIds=new Set;const t=await h();if(!t||this.useLocalCache){this.loadLocalEntries(),await this.autoDeleteExpiredReadEntries(),this.currentPage=1,this.render(),await this.hydrateTagMetadata(),this.render();return}const{data:a,error:s}=await t.from("feedback_entries").select("*").order("created_at",{ascending:!1});if(s){if(k(s)){this.useLocalCache=!0,this.loadLocalEntries(),this.render(),c("Feedback table missing. Using local cache mode.","warning");return}c(`Unable to load feedback: ${s.message}`,"error");return}this.entries=(a||[]).map(i=>this.mapRowToEntry(i)),await this.autoDeleteExpiredReadEntries(),this.currentPage=1,this.render(),await this.hydrateTagMetadata(),this.render()},render(){const e=this.getListContainer();if(!e)return;this.access=w();const t=document.getElementById("feedback-add-btn");t&&(t.style.display=this.access.isStaff?"":"none");const a=this.renderComposeCard(),s=this.renderAdminNote(),i=this.renderStaffCaution(),r=this.entries.length,n=Math.max(1,Math.ceil(r/this.pageSize));this.currentPage>n&&(this.currentPage=n);const o=(this.currentPage-1)*this.pageSize,d=this.entries.slice(o,o+this.pageSize),u=d.length?(()=>{const m=d.filter(p=>!p.is_read),g=d.filter(p=>p.is_read);return`
            ${this.renderFeedbackSection("Unread",m,"is-unread")}
            ${this.renderFeedbackSection("Read",g,"is-read")}
          `})():`
          <div class="feedback-empty-state">
            <div class="feedback-empty-hero" aria-hidden="true">
              <i class="bx bxs-badge-check"></i>
            </div>
            <div class="feedback-empty-title">You're all good, no caused troubles so far.</div>
            <div class="feedback-empty-note">
              Guide: Staff can file operational issues by tagging members, products, or equipment.
              Reports are tracked here for admin review and follow-up.
            </div>
          </div>
        `,f=this.renderPagination(r,n);e.innerHTML=`${a}${s}${i}${u}${f}`},renderFeedbackSection(e,t,a=""){const s=a?` ${a}`:"",i=t.length?t.map(r=>this.renderFeedbackCard(r)).join(""):`<div class="feedback-section-empty">No ${l(e.toLowerCase())} feedback on this page.</div>`;return`
        <section class="feedback-section${s}">
          <div class="feedback-section-head">
            <h3 class="feedback-section-title">${l(e)}</h3>
            <span class="feedback-section-count">${t.length}</span>
          </div>
          <div class="feedback-section-list">
            ${i}
          </div>
        </section>
      `},renderFeedbackCard(e){const t=String(e.id||""),a=this.expandedEntryIds.has(t),s=this.renderTaggedAssets(e.tagged_assets),i=e.is_read?"MARK UNREAD":"MARK READ",r=e.is_read?"READ":"UNREAD",n=this.access.isAdmin?`
            <button class="btn-mark-read btn-mark-read-toggle" data-feedback-read-id="${l(e.id)}">${i}</button>
          `:this.access.isStaff&&!e.is_read?`
            <button class="btn-mark-read btn-mark-read-edit" data-feedback-edit-id="${l(e.id)}">EDIT</button>
            <button class="btn-mark-read btn-mark-read-delete" data-feedback-delete-id="${l(e.id)}">DELETE</button>
          `:"",o=this.access.isAdmin?"is-single":this.access.isStaff&&!e.is_read?"is-double":"is-none";return`
        <div class="feedback-card ${e.is_read?"is-read":""} ${a?"is-expanded":"is-collapsed"}" data-feedback-id="${l(e.id)}">
          <div class="feedback-row-summary" role="button" tabindex="0" data-feedback-toggle-id="${l(e.id)}" aria-expanded="${a?"true":"false"}" aria-label="${a?"Collapse feedback details":"Expand feedback details"}">
            <div class="feedback-row-summary-copy">
              <div class="feedback-row-summary-author">${l(e.author_name)}</div>
              <div class="feedback-row-summary-preview">${l(this.getFeedbackPreview(e.message))}</div>
            </div>
            <div class="feedback-row-summary-tools">
              <span class="feedback-row-status ${e.is_read?"is-read":"is-unread"}">${r}</span>
              <button type="button" class="feedback-row-toggle" data-feedback-toggle-id="${l(e.id)}" aria-expanded="${a?"true":"false"}" aria-label="${a?"Collapse feedback details":"Expand feedback details"}">
                <i class="bx ${a?"bx-chevron-up":"bx-chevron-down"}"></i>
              </button>
            </div>
          </div>
          <div class="feedback-card-body">
          <div class="feedback-card-header">
            <div>
              <div class="feedback-author">
                <span class="feedback-author-name">${l(e.author_name)}</span>
                <span class="feedback-author-sep">-</span>
                <span class="feedback-author-role">${l(e.author_role)}</span>
              </div>
              <div class="feedback-meta">${L(e.created_at)}</div>
            </div>
            <div class="feedback-card-actions ${o}">${n}</div>
          </div>
          <div class="tagged-label">TAGGED ASSETS</div>
          ${s}
          <div class="feedback-text">"${l(e.message)}"</div>
          </div>
        </div>
      `},getFeedbackPreview(e){const t=String(e||"").trim().replace(/\s+/g," ");return t?t.length<=54?t:`${t.slice(0,51)}...`:"No feedback details"},renderAdminNote(){return this.access.isAdmin?`
        <div class="feedback-admin-note">
          <div class="feedback-admin-note-title">Admin Note</div>
          <div class="feedback-admin-note-copy">
            Feedback submission is staff-only to preserve operational accountability.
            Admin can only review and mark read/unread. Staff can edit/delete while unread.
          </div>
        </div>
      `:""},renderStaffCaution(){return this.access.isStaff?`
        <div class="feedback-staff-note">
          <div class="feedback-staff-note-title">Staff Caution</div>
          <div class="feedback-staff-note-copy">
            Write only factual incidents.
            Tag related assets so admins can verify quickly.
            You can edit or delete only while status is UNREAD.
          </div>
        </div>
      `:""},getAutoDeleteCutoffIso(){return new Date(Date.now()-2592e6).toISOString()},async autoDeleteExpiredReadEntries(){const e=this.getAutoDeleteCutoffIso();if(!this.entries.filter(i=>{if(!i.is_read||!i.created_at)return!1;const r=new Date(i.created_at).getTime();return Number.isFinite(r)?r<=new Date(e).getTime():!1}).length)return;const a=await h();if(!a||this.useLocalCache){this.entries=this.entries.filter(i=>{if(!i.is_read||!i.created_at)return!0;const r=new Date(i.created_at).getTime();return Number.isFinite(r)?r>new Date(e).getTime():!0}),this.saveLocalEntries();return}const s=await a.from("feedback_entries").delete().eq("is_read",!0).lt("created_at",e);if(s.error){if(D(s.error)){this.autoDeleteWarned||(c("30-day auto-delete blocked by RLS. Run docs/sql/feedback_entries_rls_policy.sql.","warning"),this.autoDeleteWarned=!0);return}return}this.entries=this.entries.filter(i=>{if(!i.is_read||!i.created_at)return!0;const r=new Date(i.created_at).getTime();return Number.isFinite(r)?r>new Date(e).getTime():!0})},renderPagination(e,t){if(e<=this.pageSize)return"";const a=this.currentPage<=1,s=this.currentPage>=t;return`
        <div class="feedback-pagination">
          <button class="feedback-page-btn" data-feedback-page="${this.currentPage-1}" ${a?"disabled":""}>
            <i class="bx bx-chevron-left"></i>
          </button>
          <span class="feedback-page-info">Page ${this.currentPage} of ${t}</span>
          <button class="feedback-page-btn" data-feedback-page="${this.currentPage+1}" ${s?"disabled":""}>
            <i class="bx bx-chevron-right"></i>
          </button>
        </div>
      `},async hydrateTagMetadata(){const e=await this.loadTagOptions(),t=new Map;(e||[]).forEach(a=>{const s=this.normalizeTagValue(a.value);s&&t.set(s,a)}),this.tagMetaLookup=t},getFallbackTagType(e){const t=this.normalizeTagValue(e);return/^PR-/.test(t)?"PRODUCT":/^ME-/.test(t)?"MEMBER":/^EQ-/.test(t)?"EQUIPMENT":"ASSET"},getTagTypeIcon(e){return e==="PRODUCT"?"bx-package":e==="MEMBER"?"bx-user":e==="EQUIPMENT"?"bx-dumbbell":"bx-tag"},resolveTagMetadata(e){const t=this.normalizeTagValue(e),a=this.tagMetaLookup.get(t);if(a)return{value:t,title:a.title||t,subtitle:a.subtitle||t,detail:a.detail||"",type:a.type||this.getFallbackTagType(t),image_url:a.image_url||""};const s=this.getFallbackTagType(t);return{value:t,title:t,subtitle:`${t} - ${s}`,detail:"",type:s,image_url:""}},renderTaggedAssets(e=[]){const t=Array.isArray(e)?e:[];return t.length?`
        <div class="feedback-tag-list">
          ${t.map(a=>{const s=this.resolveTagMetadata(a),i=s.image_url?`<div class="feedback-tag-media"><img src="${l(s.image_url)}" alt="${l(s.title)}"></div>`:`<div class="feedback-tag-media is-icon"><i class="bx ${l(this.getTagTypeIcon(s.type))}" aria-hidden="true"></i></div>`,r=s.detail?`<div class="feedback-tag-detail">${l(s.detail)}</div>`:"";return`
                <div class="feedback-tag-item">
                  ${i}
                  <div class="feedback-tag-copy">
                    <div class="feedback-tag-title">${l(s.title)}</div>
                    <div class="feedback-tag-sub">${l(s.subtitle)}</div>
                    ${r}
                  </div>
                </div>
              `}).join("")}
        </div>
      `:'<div class="feedback-tag-empty">No tagged assets</div>'},renderComposeCard(){if(!this.access.isStaff||!this.composeOpen)return"";const e=this.getComposeChipsHtml(),t=this.getComposeOptionsHtml(),a=this.getComposeCountLabel();return`
        <div class="feedback-compose-card">
          <div class="feedback-compose-head">
            <div>
              <div class="feedback-compose-title">Staff Audit Report</div>
              <div class="feedback-compose-subtitle">Tag assets and submit an official feedback report.</div>
            </div>
            <button type="button" class="feedback-compose-close" data-feedback-compose-cancel aria-label="Close report form">
              <i class="bx bx-x"></i>
            </button>
          </div>

          <div class="feedback-compose-grid">
            <div class="feedback-compose-field">
              <label class="feedback-compose-label" for="feedback-compose-search">Tag Involved Assets</label>
              <div class="feedback-compose-search-wrap">
                <input id="feedback-compose-search" class="feedback-compose-search" placeholder="Search product/member/equipment..." value="${l(this.composeSearchTerm)}" />
                <i class="bx bx-search feedback-compose-search-icon" aria-hidden="true"></i>
              </div>
              <div class="feedback-compose-options">${t}</div>
              <div class="feedback-compose-chip-row">${e}</div>
              <div class="feedback-compose-count">${l(a)}</div>
            </div>

            <div class="feedback-compose-field">
              <label class="feedback-compose-label" for="feedback-compose-message">Report Details</label>
              <textarea id="feedback-compose-message" class="feedback-compose-message" placeholder="Describe the issue or observation...">${l(this.composeMessage)}</textarea>
            </div>
          </div>

          <div class="feedback-compose-actions">
            <button type="button" class="feedback-compose-btn feedback-compose-btn-secondary" data-feedback-compose-cancel>Cancel</button>
            <button type="button" class="feedback-compose-btn feedback-compose-btn-primary" data-feedback-compose-submit>
              <i class="bx bxs-send" aria-hidden="true"></i>
              <span>Submit Official Report</span>
            </button>
          </div>
        </div>
      `},getComposeCountLabel(){return this.composeLoadingTags?"Loading asset suggestions...":`Selected tags: ${this.composeTags.length}/20`},getComposeFilteredOptions(){const e=this.normalizeTagValue(this.composeSearchTerm);return(this.tagOptionsCache||[]).filter(t=>e?this.normalizeTagValue(t.value).includes(e)||this.normalizeTagValue(t.title).includes(e)||this.normalizeTagValue(t.subtitle).includes(e)||this.normalizeTagValue(t.detail).includes(e):!0).slice(0,30)},getComposeChipsHtml(){return this.composeTags.map(e=>`
            <button type="button" class="feedback-compose-chip is-selected" data-feedback-tag-remove="${l(e)}">
              <span>${l(this.getComposeChipLabel(e))}</span>
              <i class="bx bx-x" aria-hidden="true"></i>
            </button>
          `).join("")},getComposeChipLabel(e){const t=this.normalizeTagValue(e),a=(this.tagOptionsCache||[]).find(s=>this.normalizeTagValue(s.value)===t);return(a==null?void 0:a.title)||(a==null?void 0:a.value)||t},getComposeOptionsHtml(){const e=this.getComposeFilteredOptions();return e.length?e.map(a=>{const s=this.normalizeTagValue(a.value),i=this.composeTags.includes(s),r=i||this.composeTags.length>=20,n=a.image_url?`<div class="feedback-compose-option-media"><img src="${l(a.image_url)}" alt="${l(a.title||a.value)}"></div>`:`<div class="feedback-compose-option-media is-icon"><i class="bx ${l(a.icon||"bx-tag")}" aria-hidden="true"></i></div>`,o=a.detail?`<div class="feedback-compose-option-detail">${l(a.detail)}</div>`:"";return`
            <button type="button" class="feedback-compose-option ${i?"is-selected":""}" data-feedback-tag-add="${l(s)}" ${r?"disabled":""}>
              ${n}
              <div class="feedback-compose-option-copy">
                <div class="feedback-compose-option-title">${l(a.title||a.value)}</div>
                <div class="feedback-compose-option-sub">${l(a.subtitle||"")}</div>
                ${o}
              </div>
              <i class="bx bx-plus feedback-compose-option-icon" aria-hidden="true"></i>
            </button>
          `}).join(""):'<div class="feedback-compose-empty">No matching assets found.</div>'},refreshComposeUi(){if(!this.composeOpen)return;const e=document.querySelector("#feedback-page .feedback-compose-options");e&&(e.innerHTML=this.getComposeOptionsHtml());const t=document.querySelector("#feedback-page .feedback-compose-chip-row");t&&(t.innerHTML=this.getComposeChipsHtml());const a=document.querySelector("#feedback-page .feedback-compose-count");a&&(a.textContent=this.getComposeCountLabel())},normalizeTagValue(e){return String(e||"").trim().replace(/\s+/g," ").toUpperCase()},dedupeTagOptions(e=[]){const t=new Set;return e.filter(a=>{const s=this.normalizeTagValue(a.value);return!s||t.has(s)?!1:(t.add(s),!0)})},async loadTagOptions(){const e=await h();if(!e)return this.tagOptionsCache=[],[];const t=[],a=(n,o)=>{(n||[]).forEach(d=>{const u=o(d);!u||!u.value||t.push(u)})},s=await e.from("products").select("productid,sku,name,brand,image_url,is_active").eq("is_active",!0).order("name",{ascending:!0}).limit(500);if(s.error&&y(s.error)){const n=await e.from("products").select("productid,sku,name").order("name",{ascending:!0}).limit(500);a(n.data,o=>{const d=String(o.sku||"").trim().toUpperCase(),u=String(o.name||d||"UNKNOWN PRODUCT").trim();return{value:d||u,title:u,subtitle:`${d||"N/A"} - PRODUCT`,detail:"",icon:"bx-package",type:"PRODUCT"}})}else a(s.data,n=>{const o=String(n.sku||"").trim().toUpperCase(),d=String(n.name||o||"UNKNOWN PRODUCT").trim(),u=String(n.brand||"").trim();return{value:o||d,title:d,subtitle:`${o||"N/A"} - PRODUCT`,detail:u?`Brand: ${u}`:"",image_url:String(n.image_url||"").trim()||null,icon:"bx-package",type:"PRODUCT"}});const i=await e.from("members").select("member_id,member_code,sku,full_name,membership_plan,is_active").eq("is_active",!0).order("full_name",{ascending:!0}).limit(500);if(i.error&&y(i.error)){const n=await e.from("members").select("member_id,member_code,sku,full_name").order("full_name",{ascending:!0}).limit(500);a(n.data,o=>{const d=String(o.member_code||o.sku||"").trim(),u=String(o.full_name||d||"UNKNOWN MEMBER").trim();return{value:d||u,title:u,subtitle:`${d||"N/A"} - MEMBER`,detail:"",icon:"bx-user",type:"MEMBER"}})}else a(i.data,n=>{const o=String(n.member_code||n.sku||"").trim(),d=String(n.full_name||o||"UNKNOWN MEMBER").trim(),u=String(n.membership_plan||"").trim();return{value:o||d,title:d,subtitle:`${o||"N/A"} - MEMBER`,detail:u?`Subscription: ${u}`:"",icon:"bx-user",type:"MEMBER"}});const r=await e.from("equipments").select("id,equipment_code,name,image_url,is_active").eq("is_active",!0).order("name",{ascending:!0}).limit(500);if(r.error&&y(r.error)){const n=await e.from("equipments").select("id,equipment_code,name").order("name",{ascending:!0}).limit(500);a(n.data,o=>{const d=String(o.equipment_code||"").trim(),u=String(o.name||d||"UNKNOWN EQUIPMENT").trim();return{value:d||u,title:u,subtitle:`${d||"N/A"} - EQUIPMENT`,detail:"",icon:"bx-dumbbell",type:"EQUIPMENT"}})}else a(r.data,n=>{const o=String(n.equipment_code||"").trim(),d=String(n.name||o||"UNKNOWN EQUIPMENT").trim();return{value:o||d,title:d,subtitle:`${o||"N/A"} - EQUIPMENT`,detail:"",image_url:String(n.image_url||"").trim()||null,icon:"bx-dumbbell",type:"EQUIPMENT"}});return this.tagOptionsCache=this.dedupeTagOptions(t),this.tagOptionsCache},async resolveAuthorMeta(){var a,s;const e=await h(),t=this.access.isAdmin?"ADMIN":"STAFF";if(!e)return{name:"SYSTEM USER",role:t};try{const{data:i}=await e.auth.getUser(),r=(i==null?void 0:i.user)||null,n=String((r==null?void 0:r.email)||"SYSTEM USER").trim().toUpperCase();return{name:String(((a=r==null?void 0:r.user_metadata)==null?void 0:a.display_name)||((s=r==null?void 0:r.user_metadata)==null?void 0:s.full_name)||n).trim().toUpperCase()||n,role:t}}catch(i){return{name:"SYSTEM USER",role:t}}},async openComposeInline(){if(this.access=w(),!this.access.isStaff){c("Only staff accounts can write feedback.","warning");return}this.composeOpen=!0,this.composeLoadingTags=!0,this.render(),setTimeout(()=>{const e=document.getElementById("feedback-compose-search");e&&e.focus()},0),this.tagOptionsCache=await this.loadTagOptions(),this.composeLoadingTags=!1,this.refreshComposeUi()},closeComposeInline(){this.composeOpen=!1,this.composeTags=[],this.composeSearchTerm="",this.composeMessage="",this.composeLoadingTags=!1,this.render()},addComposeTag(e){const t=this.normalizeTagValue(e);if(t&&!this.composeTags.includes(t)){if(this.composeTags.length>=20){c("Maximum of 20 tags only.","warning");return}this.composeTags.push(t),this.refreshComposeUi()}},removeComposeTag(e){const t=this.normalizeTagValue(e),a=this.composeTags.findIndex(s=>s===t);a<0||(this.composeTags.splice(a,1),this.refreshComposeUi())},async submitComposeInline(){const e=String(this.composeMessage||"").trim();if(!e){c("Report details are required.","warning");return}if(!this.composeTags.length){c("Add at least one tagged asset.","warning");return}const t=await this.resolveAuthorMeta();await this.create({tagged_assets:[...this.composeTags],message:e,author_name:t.name,author_role:t.role}),this.closeComposeInline()},async create(e){if(this.access=w(),!this.access.isStaff){c("Only staff accounts can write feedback.","warning");return}const t=Array.from(new Set((Array.isArray(e==null?void 0:e.tagged_assets)?e.tagged_assets:[]).map(n=>this.normalizeTagValue(n)).filter(Boolean))).slice(0,20),a=await h(),s={...e,tagged_assets:t,is_read:!1};if(!a||this.useLocalCache){this.entries.unshift({id:`local-feedback-${Date.now()}`,...s,created_at:new Date().toISOString()}),this.saveLocalEntries(),this.render(),c("Feedback saved locally.","success");return}const{data:i,error:r}=await a.from("feedback_entries").insert(s).select("*").single();if(r){if(k(r)){this.useLocalCache=!0,await this.create(e),c("Feedback table missing. Saved locally instead.","warning");return}if(D(r)){c("Feedback blocked by RLS. Run docs/sql/feedback_entries_rls_policy.sql.","warning");return}c(`Failed to save feedback: ${r.message}`,"error");return}this.entries.unshift(this.mapRowToEntry(i||s)),this.render(),c("Feedback saved.","success")},async toggleRead(e){if(this.access=w(),!this.access.isAdmin){c("Only admin accounts can mark feedback status.","warning");return}const t=!e.is_read,a=await h();if(!a||this.useLocalCache){this.entries=this.entries.map(i=>String(i.id)===String(e.id)?{...i,is_read:t}:i),this.saveLocalEntries(),this.render();return}let s=await a.from("feedback_entries").update({is_read:t}).eq("id",e.id).select("*").maybeSingle();if(s.error&&y(s.error)&&(s=await a.from("feedback_entries").update({is_read:t}).eq("feedback_id",e.id).select("*").maybeSingle()),s.error){c(`Failed to update feedback status: ${s.error.message}`,"error");return}this.entries=this.entries.map(i=>String(i.id)===String(e.id)?this.mapRowToEntry(s.data||{...i,is_read:t}):i),this.render()},async remove(e){if(this.access=w(),!this.access.isStaff){c("Only staff accounts can delete feedback.","warning");return}if(e.is_read){c("Read entries are locked and cannot be deleted manually.","warning");return}if(!window.Swal||!(await window.Swal.fire({title:"DELETE FEEDBACK ENTRY?",text:"Use delete only for miswritten staff reports. This action cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonText:"DELETE ENTRY",background:"#0d0f12",color:"#e6ebf5"})).isConfirmed)return;const a=await h();if(!a||this.useLocalCache){this.entries=this.entries.filter(i=>String(i.id)!==String(e.id)),this.saveLocalEntries(),this.render(),c("Feedback deleted (local cache).","success");return}let s=await a.from("feedback_entries").delete().eq("id",e.id);if(s.error&&y(s.error)&&(s=await a.from("feedback_entries").delete().eq("feedback_id",e.id)),s.error){c(`Failed to delete feedback: ${s.error.message}`,"error");return}this.entries=this.entries.filter(i=>String(i.id)!==String(e.id)),this.render(),c("Feedback deleted.","success")},async editEntry(e){if(this.access=w(),!this.access.isStaff){c("Only staff accounts can edit feedback.","warning");return}if(e.is_read){c("Read entries are locked and cannot be edited.","warning");return}if(!window.Swal||!(await window.Swal.fire({title:"EDIT FEEDBACK ENTRY",text:"Use edit only when staff report is miswritten. Keep the original context intact.",icon:"warning",showCancelButton:!0,confirmButtonText:"CONTINUE",background:"#0d0f12",color:"#e6ebf5"})).isConfirmed)return;const a=await window.Swal.fire({title:"UPDATE FEEDBACK",background:"#0d0f12",color:"#e6ebf5",showCancelButton:!0,confirmButtonText:"SAVE CHANGES",html:`
          <textarea id="feedback-edit-message" class="swal2-textarea" style="margin:0; min-height:140px;" placeholder="Update report details...">${l(e.message||"")}</textarea>
        `,preConfirm:()=>{var o,d;const n=(d=(o=document.getElementById("feedback-edit-message"))==null?void 0:o.value)==null?void 0:d.trim();return n?{message:n}:(window.Swal.showValidationMessage("Report details are required."),null)}});if(!a.isConfirmed||!a.value)return;const s=await h(),i={message:a.value.message};if(!s||this.useLocalCache){this.entries=this.entries.map(n=>String(n.id)===String(e.id)?{...n,...i}:n),this.saveLocalEntries(),this.render(),c("Feedback updated (local cache).","success");return}let r=await s.from("feedback_entries").update(i).eq("id",e.id).select("*").maybeSingle();if(r.error&&y(r.error)&&(r=await s.from("feedback_entries").update(i).eq("feedback_id",e.id).select("*").maybeSingle()),r.error){c(`Failed to edit feedback: ${r.error.message}`,"error");return}this.entries=this.entries.map(n=>String(n.id)===String(e.id)?this.mapRowToEntry(r.data||{...n,...i}):n),this.render(),c("Feedback updated.","success")}},window.IdMakerManager={members:[],selected:null,async init(){const e=document.querySelector(".id-maker-wrapper");e&&(e.dataset.boundIdMaker!=="1"&&(e.dataset.boundIdMaker="1",e.addEventListener("input",t=>{if(t.target.id==="id-member-search"){this.handleMemberSearch(t.target.value);return}if(t.target.id==="id-contact"){this.updatePreview({contact_number:t.target.value.trim()});return}if(t.target.id==="id-status"){this.updatePreview({membership_status:t.target.value.trim().toUpperCase()});return}t.target.id==="id-tier"&&this.updatePreview({membership_plan:t.target.value.trim()})}),e.addEventListener("click",t=>{t.target.closest("#id-save-asset-btn")&&this.downloadCardPayload(),t.target.closest("#id-print-card-btn")&&this.printCard()})),await this.loadMembers(),this.autoSelectPendingMember())},async loadMembers(){const e=await h();if(!e)return;let t=await e.from("members").select("*").order("full_name",{ascending:!0});if(t.error){c(`Unable to load members for ID maker: ${t.error.message}`,"error");return}this.members=(t.data||[]).map(s=>({...s,member_code:String(s.member_code||s.sku||s.member_id||"").trim().toUpperCase()}));const a=document.getElementById("id-member-options");a&&(a.innerHTML=this.members.map(s=>`<option value="${l(s.full_name)}">${l(s.member_code)}</option>`).join(""))},autoSelectPendingMember(){const e=window.WOLF_PENDING_MEMBER_ID;if(!e)return;window.WOLF_PENDING_MEMBER_ID=null;const t=this.members.find(a=>String(a.member_id)===String(e));if(t){const a=document.getElementById("id-member-search");a&&(a.value=t.full_name||""),this.selectMember(t)}},handleMemberSearch(e){const t=String(e||"").trim().toLowerCase();if(!t)return;const a=this.members.find(s=>String(s.full_name||"").toLowerCase()===t||String(s.member_code||"").toLowerCase()===t||String(s.email_address||"").toLowerCase()===t);a&&this.selectMember(a)},selectMember(e){this.selected={...e,membership_status:String(e.membership_status||"ACTIVE").toUpperCase()||"ACTIVE",membership_plan:e.membership_plan||"STANDARD MEMBERSHIP"};const t=document.getElementById("id-contact"),a=document.getElementById("id-status"),s=document.getElementById("id-tier");t&&(t.value=e.contact_number||""),a&&(a.value=this.selected.membership_status),s&&(s.value=this.selected.membership_plan),this.updatePreview()},updatePreview(e=null){if(!this.selected)return;e&&typeof e=="object"&&(this.selected={...this.selected,...e});const t=document.getElementById("id-preview-name"),a=document.getElementById("id-preview-code"),s=document.getElementById("id-preview-date"),i=document.getElementById("id-preview-tier"),r=document.getElementById("id-preview-status"),n=document.getElementById("id-preview-badge"),o=document.getElementById("id-preview-qr");if(t&&(t.textContent=this.selected.full_name||"N/A"),a&&(a.textContent=this.selected.member_code||this.selected.member_id||"N/A"),s&&(s.textContent=H(new Date)),i&&(i.textContent=this.selected.membership_plan||"N/A"),r&&(r.textContent=this.selected.membership_status||"ACTIVE"),n&&(n.textContent=`${this.selected.membership_status||"ACTIVE"} STATUS`),o){const d=encodeURIComponent(`${this.selected.member_code||this.selected.member_id}|${this.selected.full_name||""}`);o.src=`https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${d}`}},buildCardPayload(){return this.selected?{exported_at:new Date().toISOString(),member_id:this.selected.member_id||null,member_code:this.selected.member_code||null,full_name:this.selected.full_name||"",contact_number:this.selected.contact_number||"",membership_status:this.selected.membership_status||"ACTIVE",membership_plan:this.selected.membership_plan||""}:null},downloadCardPayload(){const e=this.buildCardPayload();if(!e){c("Select a member first before saving.","warning");return}const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(t),a.download=`${e.member_code||"member"}-id-card.json`,document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(a.href),c("ID payload exported.","success")},printCard(){var s;const e=this.buildCardPayload();if(!e){c("Select a member first before printing.","warning");return}const t=((s=document.getElementById("id-preview-qr"))==null?void 0:s.src)||"",a=window.open("","_blank","width=620,height=860");a&&(a.document.write(`
        <html>
          <head>
            <title>Print ID Card</title>
            <style>
              body { font-family: Arial, sans-serif; background:#0e1014; color:#f4f6f9; display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0; }
              .card { width:340px; border-radius:18px; border:1px solid #2c3546; padding:20px; background:linear-gradient(160deg,#0f1218,#141b25); }
              .brand { font-size:20px; font-weight:900; letter-spacing:1px; margin-bottom:14px; }
              .row { margin:8px 0; font-size:13px; }
              .label { color:#8fa2c8; font-size:11px; text-transform:uppercase; letter-spacing:1px; }
              .value { font-weight:700; }
              img { width:160px; height:160px; background:#fff; border-radius:12px; display:block; margin:14px auto; }
            </style>
          </head>
          <body>
            <div class="card">
              <div class="brand">WOLF PALOMAR ID</div>
              <div class="row"><span class="label">Name</span><div class="value">${l(e.full_name)}</div></div>
              <div class="row"><span class="label">Member Code</span><div class="value">${l(e.member_code||"N/A")}</div></div>
              <div class="row"><span class="label">Plan</span><div class="value">${l(e.membership_plan||"N/A")}</div></div>
              <div class="row"><span class="label">Status</span><div class="value">${l(e.membership_status)}</div></div>
              <img src="${l(t)}" alt="QR code" />
              <div class="row"><span class="label">Generated</span><div class="value">${H(new Date)}</div></div>
            </div>
          </body>
        </html>
      `),a.document.close(),a.focus(),a.print())}},window.AuditManager={rows:[],async init(){const e=document.querySelector(".audit-wrapper");if(!e)return;const t=document.getElementById("audit-from-date"),a=document.getElementById("audit-to-date");if(t&&a&&!t.value&&!a.value){const s=new Date,i=new Date;i.setDate(s.getDate()-7),t.value=i.toISOString().slice(0,10),a.value=s.toISOString().slice(0,10)}e.dataset.boundAuditManager!=="1"&&(e.dataset.boundAuditManager="1",e.addEventListener("click",async s=>{s.target.closest("#audit-apply-btn")&&await this.load(),s.target.closest("#audit-refresh-btn")&&await this.load(!0),s.target.closest("#audit-export-btn")&&this.exportCsv()})),await this.load()},async load(e=!1){const t=document.getElementById("audit-log-list");if(!t)return;e&&(this.rows=[]);const a=document.getElementById("audit-from-date"),s=document.getElementById("audit-to-date"),i=a!=null&&a.value?new Date(a.value):null,r=s!=null&&s.value?new Date(s.value):null;r&&r.setHours(23,59,59,999);const n=await h();if(!n){t.innerHTML='<div class="audit-row"><div class="audit-row-meta">SUPABASE CLIENT IS NOT READY</div></div>';return}const{data:o,error:d}=await n.from("audit_log").select("*").order("created_at",{ascending:!1}).limit(300);if(d){t.innerHTML=`<div class="audit-row"><div class="audit-row-meta">FAILED TO LOAD AUDIT LOGS: ${l(d.message)}</div></div>`;return}this.rows=(o||[]).filter(u=>{const f=j(u,["created_at","updated_at","time_in"]);return!(!f||i&&f<i||r&&f>r)}),this.render()},render(){const e=document.getElementById("audit-log-list"),t=document.getElementById("audit-empty-state");if(e){if(!this.rows.length){e.innerHTML="",t&&(t.style.display="flex");return}t&&(t.style.display="none"),e.innerHTML=this.rows.map(a=>{const s=a.change_payload?JSON.stringify(a.change_payload):"{}",i=s.length>180?`${s.slice(0,177)}...`:s;return`
            <div class="audit-row">
              <div class="audit-row-top">
                <span class="audit-op">${l(a.operation||"UNKNOWN")}</span>
                <span class="audit-time">${L(a.created_at)}</span>
              </div>
              <div class="audit-row-meta">
                TABLE: ${l(a.table_name||"N/A")} - RECORD: ${l(String(a.record_id||"N/A"))}
              </div>
              <div class="audit-row-meta">
                ACTOR: ${l(String(a.changed_by||a.approved_by_email||"SYSTEM"))}
              </div>
              <div class="audit-row-payload">${l(i)}</div>
            </div>
          `}).join("")}},exportCsv(){if(!this.rows.length){c("No audit logs to export.","warning");return}const t=[["created_at","table_name","operation","record_id","changed_by"].join(",")];this.rows.forEach(i=>{t.push([i.created_at||"",i.table_name||"",i.operation||"",i.record_id||"",i.changed_by||""].map(r=>`"${String(r||"").replace(/"/g,'""')}"`).join(","))});const a=new Blob([t.join(`
`)],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(a),s.download=`audit-log-${new Date().toISOString().slice(0,10)}.csv`,document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(s.href)}},window.SettingsManager={access:w(),managedAccounts:[],maxAdmins:3,currentAdmins:0,canCreateAccounts:!1,canManageAccounts:!1,async init(){const e=document.querySelector(".settings-wrapper");e&&(this.access=w(),this.applySavedState(),await this.hydrateProfile(),this.applyAccessPolicy(),e.dataset.boundSettingsManager!=="1"&&(e.dataset.boundSettingsManager="1",e.addEventListener("click",async t=>{const a=t.target.closest("[data-settings-tab-btn]");if(a){this.setActiveTab(a.getAttribute("data-settings-tab"));return}const s=t.target.closest("[data-setting-toggle]");if(s){this.toggleSetting(s.getAttribute("data-setting-toggle"));return}if(t.target.closest("#settings-update-btn")){await this.updateAccount();return}if(t.target.closest("#settings-logout-btn")){typeof window.handleLogout=="function"&&window.handleLogout();return}if(t.target.closest("#settings-export-btn")){await this.exportBackup();return}if(t.target.closest("#settings-restore-btn")){await this.restoreBackup();return}if(t.target.closest("#settings-create-user-btn")){await this.createManagedUser();return}if(t.target.closest("#settings-refresh-users-btn")){await this.loadManagedUsers();return}const i=t.target.closest("[data-settings-user-edit-id]");if(i){const n=String(i.getAttribute("data-settings-user-edit-id")||""),o=this.managedAccounts.find(d=>String(d.id||"")===n);if(!o)return;await this.editManagedUser(o);return}const r=t.target.closest("[data-settings-user-delete-id]");if(r){const n=String(r.getAttribute("data-settings-user-delete-id")||""),o=this.managedAccounts.find(d=>String(d.id||"")===n);if(!o)return;await this.deleteManagedUser(o)}}),e.addEventListener("submit",async t=>{t.target.id==="settings-create-user-form"&&(t.preventDefault(),await this.createManagedUser())}),e.addEventListener("input",t=>{if(t.target.id==="settings-ui-scale"){const a=b(t.target.value);this.applyUiScale(a);try{window.localStorage.setItem(z,String(a))}catch(s){}}})),this.access.isAdmin&&await this.loadManagedUsers())},applySavedState(){const e=String(window.localStorage.getItem(P)||"false")==="true",t=String(window.localStorage.getItem(F)||"true")!=="false",a=b(window.localStorage.getItem(z)||100);this.setToggleState("action-sounds",!e),this.setToggleState("victory-visuals",t);const s=this.applyUiScale(a||100),i=document.getElementById("settings-ui-scale");i&&(i.value=String(s))},async hydrateProfile(){var f,m;const e=await h(),t=document.getElementById("settings-profile-name"),a=document.getElementById("settings-profile-role"),s=document.getElementById("settings-profile-email"),i=document.getElementById("settings-display-name");let r=this.access.email||"",n=window.localStorage.getItem(B)||"";if(e){const{data:g}=await e.auth.getUser(),p=(g==null?void 0:g.user)||null;p!=null&&p.email&&(r=C(p.email)),n||(n=String(((f=p==null?void 0:p.user_metadata)==null?void 0:f.display_name)||((m=p==null?void 0:p.user_metadata)==null?void 0:m.full_name)||"").trim())}n||(n=r?r.split("@")[0]:"Wolf User"),this.access=w();const o=this.access.isSuperAdmin?"SUPERADMIN":this.access.isAdmin?"ADMIN":this.access.isStaff?"STAFF":"UNAUTHORIZED";t&&(t.textContent=String(n).toUpperCase()),a&&(a.textContent=o),s&&(s.textContent=r||"N/A"),i&&(i.value=n),r&&window.localStorage.setItem(B,n);const d=document.querySelector("#wolfSidebar .user-name"),u=document.querySelector("#wolfSidebar .user-email");d&&(d.textContent=String(n).toUpperCase()),u&&r&&(u.textContent=r)},applyAccessPolicy(){this.access=w();const e=document.getElementById("settings-tabs"),t=document.querySelector('[data-settings-tab="users"]'),a=document.querySelector('[data-settings-tab-panel="users"]'),s=document.getElementById("settings-maintenance-card"),i=document.getElementById("settings-superadmin-note"),r=document.getElementById("settings-users-permission"),n=document.getElementById("settings-admin-limit-note");this.access.isAdmin?(e&&(e.style.display=""),t&&(t.style.display="")):(e&&(e.style.display="none"),t&&(t.style.display="none"),a&&a.classList.remove("is-active"),this.setActiveTab("personalize")),s&&(s.style.display=this.access.isStaff?"none":""),this.canCreateAccounts=!!this.access.isSuperAdmin,this.canManageAccounts=!!this.access.isSuperAdmin,this.setCreateControlsEnabled(this.canCreateAccounts),i&&(i.hidden=this.canCreateAccounts),r&&(r.textContent=this.canCreateAccounts?`You are superadmin (${x}). You can create, edit, and delete admin/staff accounts.`:`Only superadmin (${x}) can create, edit, or delete accounts.`),n&&(n.textContent=`ADMIN LIMIT: UP TO ${this.maxAdmins} ADMIN ACCOUNTS ONLY (INCLUDING SUPERADMIN).`)},setActiveTab(e="personalize"){const t=String(e||"personalize").toLowerCase();document.querySelectorAll("[data-settings-tab-btn]").forEach(a=>{const s=String(a.getAttribute("data-settings-tab")||"")===t;a.classList.toggle("is-active",s)}),document.querySelectorAll("[data-settings-tab-panel]").forEach(a=>{const s=String(a.getAttribute("data-settings-tab-panel")||"")===t;a.classList.toggle("is-active",s)})},setCreateControlsEnabled(e){const t=document.getElementById("settings-create-user-btn");t&&(t.disabled=!e),document.querySelectorAll("#settings-create-user-form input, #settings-create-user-form select").forEach(a=>{a.disabled=!e})},setToggleState(e,t){const a=document.querySelector(`[data-setting-toggle="${e}"]`);a&&(a.classList.toggle("active",!!t),a.setAttribute("aria-pressed",t?"true":"false"))},toggleSetting(e){if(!e)return;const t=document.querySelector(`[data-setting-toggle="${e}"]`);if(!t)return;const a=!t.classList.contains("active");e==="action-sounds"?(window.localStorage.setItem(P,a?"false":"true"),c(a?"Action sounds enabled.":"Action sounds muted.","success")):e==="victory-visuals"&&(window.localStorage.setItem(F,a?"true":"false"),c(a?"Victory visuals enabled.":"Victory visuals disabled.","success")),this.setToggleState(e,a)},applyUiScale(e){const t=Math.min(150,Math.max(50,b(e)||100)),a=t/100;document.documentElement.style.fontSize=`${(16*a).toFixed(2)}px`,document.documentElement.style.setProperty("--wolf-ui-scale-factor",String(a));const s=document.getElementById("settings-ui-scale-value");return s&&(s.textContent=`${t}%`),t},async updateAccount(){var o,d,u,f;const e=((d=(o=document.getElementById("settings-display-name"))==null?void 0:o.value)==null?void 0:d.trim())||"Wolf User",t=((f=(u=document.getElementById("settings-new-password"))==null?void 0:u.value)==null?void 0:f.trim())||"";window.localStorage.setItem(B,e);const a=document.getElementById("settings-profile-name");a&&(a.textContent=e.toUpperCase());const s=document.querySelector("#wolfSidebar .user-name");s&&(s.textContent=e.toUpperCase());const i=await h();if(!i){c("Display name saved locally.","success");return}const r={data:{display_name:e,full_name:e}};t&&(r.password=t);const{error:n}=await i.auth.updateUser(r);if(n)c(`Account update partially failed: ${n.message}`,"warning");else{c("Account settings updated.","success");const m=document.getElementById("settings-new-password");m&&(m.value="")}},async getAccessToken(){const e=await h();if(!e)return"";const{data:{session:t}}=await e.auth.getSession();return String((t==null?void 0:t.access_token)||"")},async callUserAccountsApi(e,t={}){const a=await this.getAccessToken();if(!a)throw new Error("No active session token found.");const s=await fetch("/.netlify/functions/manage-user-accounts",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({action:e,...t})});let i={};try{i=await s.json()}catch(r){i={}}if(!s.ok)throw new Error(String(i.error||"User account request failed."));return i},updateAdminCountChip(){const e=document.getElementById("settings-admin-count-chip");e&&(e.textContent=`Admins: ${this.currentAdmins}/${this.maxAdmins}`)},renderManagedUsers(){const e=document.getElementById("settings-users-list"),t=document.getElementById("settings-users-empty");if(e){if(!this.managedAccounts.length){e.innerHTML="",t&&(t.style.display="block");return}t&&(t.style.display="none"),e.innerHTML=this.managedAccounts.map(a=>{const s=a.role==="admin"?"admin":"staff",i=a.isSuperAdmin?"SUPERADMIN":String(a.role||"").toUpperCase(),r=C(a.email||""),n=a.isSuperAdmin||V.has(r)||Y.has(r),o=L(a.createdAt),d=a.lastSignInAt?L(a.lastSignInAt):"Never",f=this.canManageAccounts&&!n?`
                <div class="settings-user-actions">
                  <button type="button" class="settings-user-action-btn" data-settings-user-edit-id="${l(a.id||"")}">Edit</button>
                  <button type="button" class="settings-user-action-btn danger" data-settings-user-delete-id="${l(a.id||"")}">Delete</button>
                </div>
              `:this.canManageAccounts?'<div class="settings-user-lock-note">Fixed system account</div>':"";return`
            <div class="settings-user-row">
              <div class="settings-user-top">
                <div class="settings-user-email">${l(a.email||"N/A")}</div>
                <div class="settings-role-badge ${s}">${l(i)}</div>
              </div>
              <div class="settings-user-meta">Created: ${l(o)}</div>
              <div class="settings-user-meta">Last sign-in: ${l(d)}</div>
              ${f}
            </div>
          `}).join("")}},async loadManagedUsers(){var e,t,a,s,i,r;if(this.access=w(),this.applyAccessPolicy(),!!this.access.isAdmin)try{const n=await this.callUserAccountsApi("list");this.managedAccounts=Array.isArray(n.accounts)?n.accounts:[],this.currentAdmins=b((e=n==null?void 0:n.limits)==null?void 0:e.currentAdmins),this.maxAdmins=Math.max(1,b((t=n==null?void 0:n.limits)==null?void 0:t.maxAdmins)||3),this.canCreateAccounts=!!((a=n==null?void 0:n.permissions)!=null&&a.canCreateAccounts),this.canManageAccounts=!!((r=(s=n==null?void 0:n.permissions)==null?void 0:s.canManageAccounts)!=null?r:(i=n==null?void 0:n.permissions)!=null&&i.canCreateAccounts),this.updateAdminCountChip(),this.setCreateControlsEnabled(this.canCreateAccounts),this.applyAccessPolicy(),this.renderManagedUsers()}catch(n){this.managedAccounts=[],this.renderManagedUsers(),c(`Unable to load managed users: ${n.message}`,"error")}},async createManagedUser(){var r,n,o,d,u;if(this.access=w(),!this.access.isSuperAdmin){c("Only superadmin can create new accounts.","warning");return}const e=document.getElementById("settings-create-user-btn"),t=C((r=document.getElementById("settings-create-email"))==null?void 0:r.value),a=String(((n=document.getElementById("settings-create-role"))==null?void 0:n.value)||"staff").trim().toLowerCase(),s=String(((o=document.getElementById("settings-create-display-name"))==null?void 0:o.value)||"").trim(),i=String(((d=document.getElementById("settings-create-password"))==null?void 0:d.value)||"").trim();if(!t){c("Email is required.","warning");return}e&&(e.disabled=!0);try{const f=await this.callUserAccountsApi("create",{email:t,role:a,displayName:s,password:i}),m=!!((u=f==null?void 0:f.defaults)!=null&&u.usedDefaultPassword);c(m?"Account created with default password 12345.":"Account created successfully.","success");const g=document.getElementById("settings-create-user-form");g&&g.reset();const p=document.getElementById("settings-create-role");p&&(p.value="staff"),await this.loadManagedUsers()}catch(f){c(`Create account failed: ${f.message}`,"error")}finally{e&&(e.disabled=!1)}},async editManagedUser(e){if(this.access=w(),!this.access.isSuperAdmin){c("Only superadmin can edit accounts.","warning");return}if(!(e!=null&&e.id)){c("Invalid account selected.","error");return}const t=String(e.role||"staff").toLowerCase(),a=String(e.displayName||"").trim();let s=a,i=t==="admin"?"admin":"staff",r="";if(window.Swal){const n=await window.Swal.fire({title:"Edit Account",html:`
            <div style="display:grid; gap:10px; text-align:left;">
              <label style="font-size:11px; font-weight:800; letter-spacing:0.7px; text-transform:uppercase; color:#b9c5db;">Display Name</label>
              <input id="settings-edit-display-name" class="swal2-input" value="${l(a)}" placeholder="Optional display name" style="margin:0;" />
              <label style="font-size:11px; font-weight:800; letter-spacing:0.7px; text-transform:uppercase; color:#b9c5db;">Role</label>
              <select id="settings-edit-role" class="swal2-select" style="margin:0;">
                <option value="staff" ${i==="staff"?"selected":""}>Staff</option>
                <option value="admin" ${i==="admin"?"selected":""}>Admin</option>
              </select>
              <label style="font-size:11px; font-weight:800; letter-spacing:0.7px; text-transform:uppercase; color:#b9c5db;">Reset Password (Optional)</label>
              <input id="settings-edit-password" type="password" class="swal2-input" placeholder="Leave blank to keep current password" style="margin:0;" />
            </div>
          `,showCancelButton:!0,confirmButtonText:"Save",cancelButtonText:"Cancel",preConfirm:()=>{var f,m,g;const o=String(((f=document.getElementById("settings-edit-display-name"))==null?void 0:f.value)||"").trim(),d=String(((m=document.getElementById("settings-edit-role"))==null?void 0:m.value)||"").trim().toLowerCase(),u=String(((g=document.getElementById("settings-edit-password"))==null?void 0:g.value)||"").trim();return d!=="admin"&&d!=="staff"?(window.Swal.showValidationMessage("Role must be admin or staff"),null):{displayName:o,role:d,password:u}}});if(!n.isConfirmed||!n.value)return;s=String(n.value.displayName||"").trim(),i=String(n.value.role||"").trim().toLowerCase(),r=String(n.value.password||"").trim()}else{const n=window.prompt(`Role for ${e.email} (admin/staff):`,i);if(n===null)return;if(i=String(n||"").trim().toLowerCase(),i!=="admin"&&i!=="staff"){c("Role must be admin or staff.","warning");return}const o=window.prompt(`Display name for ${e.email}:`,a);if(o===null)return;s=String(o||"").trim()}try{await this.callUserAccountsApi("update",{userId:e.id,role:i,displayName:s,password:r}),c("Account updated successfully.","success"),await this.loadManagedUsers()}catch(n){c(`Update account failed: ${n.message}`,"error")}},async deleteManagedUser(e){if(this.access=w(),!this.access.isSuperAdmin){c("Only superadmin can delete accounts.","warning");return}if(!(e!=null&&e.id)){c("Invalid account selected.","error");return}let t=!1;if(window.Swal?t=!!(await window.Swal.fire({title:"Delete Account?",html:`<div style="font-size:13px; color:#dbe4f4;">This will permanently delete <b>${l(e.email||"account")}</b>.</div>`,icon:"warning",showCancelButton:!0,confirmButtonText:"Delete",cancelButtonText:"Cancel",confirmButtonColor:"#b91c1c"})).isConfirmed:t=window.confirm(`Delete account ${e.email}? This action cannot be undone.`),!!t)try{await this.callUserAccountsApi("delete",{userId:e.id}),c("Account deleted successfully.","success"),await this.loadManagedUsers()}catch(a){c(`Delete account failed: ${a.message}`,"error")}},async exportBackup(){if(this.access=w(),!this.access.isAdmin){c("Only admin accounts can export backups.","warning");return}const e=await h();if(!e){c("Supabase is not ready for export.","error");return}const t=["members","products","sales","check_in_logs","goal_target","equipments","feedback_entries","audit_log"],a={created_at:new Date().toISOString(),version:"wolf-backup-1",tables:{},errors:{}};for(const r of t){const{data:n,error:o}=await e.from(r).select("*").limit(2e3);if(o){a.errors[r]=o.message;continue}a.tables[r]=n||[]}const s=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),i=document.createElement("a");i.href=URL.createObjectURL(s),i.download=`wolf-backup-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(i.href),c("Backup exported.","success")},async restoreBackup(){if(this.access=w(),!this.access.isAdmin){c("Only admin accounts can restore backups.","warning");return}const e=document.createElement("input");e.type="file",e.accept=".json,application/json",e.onchange=async()=>{var u;const t=(u=e.files)==null?void 0:u[0];if(!t)return;const a=await t.text();let s;try{s=JSON.parse(a)}catch(f){c("Invalid backup file format.","error");return}const i=s!=null&&s.tables&&typeof s.tables=="object"?s.tables:s;if(!i||typeof i!="object"){c("Backup file has no table payload.","error");return}const r=await h();if(!r){c("Supabase is not ready for restore.","error");return}const n={members:"member_id",products:"productid",sales:"id",check_in_logs:"id",goal_target:"id",equipments:"id",feedback_entries:"id",audit_log:"id"};let o=0,d=0;for(const[f,m]of Object.entries(i)){if(!Array.isArray(m)||m.length===0)continue;const g=n[f]||"id",{error:p}=await r.from(f).upsert(m,{onConflict:g});if(p){d+=1;continue}o+=m.length}c(`Restore complete. Rows merged: ${o}. Failed tables: ${d}.`,d>0?"warning":"success")},e.click()}}})();
