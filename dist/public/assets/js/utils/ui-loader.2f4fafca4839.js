window.wolfRetry=async function(){const e=document.querySelector(".retry-btn"),n=e==null?void 0:e.querySelector("i"),t=e==null?void 0:e.querySelector("span");e&&(e.disabled=!0,n&&(n.className="bx bx-loader-alt bx-spin"),t&&(t.innerText="RE-ESTABLISHING LINK..."));try{const o=await fetch("/favicon.ico",{mode:"no-cors",cache:"no-store"}),a=window.WOLF_LAST_REQUESTED_PAGE||window.WOLF_CURRENT_PAGE||new URLSearchParams(window.location.search).get("p")||"dashboard";if(typeof navigateTo=="function"){await navigateTo(a,{updateRoute:!1});return}if(window.wolfRouter&&typeof window.wolfRouter.refreshCurrent=="function"){await window.wolfRouter.refreshCurrent({replace:!0});return}window.location.reload()}catch(o){console.warn("Wolf OS: Link attempt failed. Signal still dead."),setTimeout(()=>{e&&(e.disabled=!1,n&&(n.className="bx bx-refresh"),t&&(t.innerText="RETRY CONNECTION"))},1500)}};const WOLF_PURIFIER=e=>DOMPurify.sanitize(e,{ALLOWED_TAGS:["div","span","p","a","button","input","label","ul","li","table","thead","tbody","tr","td","section","header","footer","main","nav","i","h1","h2","h3","h4","h5","h6","style","form","textarea","select","option","img"],ALLOWED_ATTR:["class","id","style","data-page","data-date","data-day","data-id","data-product-id","href","type","value","placeholder","aria-label","role","src","alt","accept","hidden"],KEEP_CONTENT:!0,FORBID_TAGS:["script","iframe","object","embed"],FORBID_ATTR:["onerror","onload","onclick"]}),getSkeletonUI=()=>`
  <div class="skeleton-wrapper">
    <div class="skeleton skeleton-title"></div>
    <div class="skeleton skeleton-text"></div>
    <div class="skeleton skeleton-text" style="width: 80%"></div>
    <div class="skeleton skeleton-box" style="margin-top: 20px;"></div>
    <div class="skeleton skeleton-box"></div>
  </div>
`,themeManager={init(){localStorage.getItem("wolf-theme")==="light"&&document.body.classList.add("light-theme")},toggle(){const e=document.body.classList.toggle("light-theme");localStorage.setItem("wolf-theme",e?"light":"dark"),document.querySelectorAll("#themeToggleBtn i, .theme-icon").forEach(t=>{e?t.classList.replace("bx-moon","bx-sun"):t.classList.replace("bx-sun","bx-moon")})}};themeManager.init();let wolfMainRouter=null,wolfMainRouterSyncing=!1,wolfLogoutInProgress=!1;function getInitialMainPage(){const e=String(window.location.hash||""),n=e.startsWith("#/")?e.slice(2).trim():"",t=new URLSearchParams(window.location.search).get("p");return n||t||"dashboard"}function initMainRouter(){typeof Navigo=="undefined"||wolfMainRouter||(wolfMainRouter=new Navigo("/",{hash:!0}),wolfMainRouter.on("/:page",e=>{var t;if(wolfMainRouterSyncing)return;const n=String(((t=e==null?void 0:e.data)==null?void 0:t.page)||"").trim()||"dashboard";navigateTo(n,{updateRoute:!1})}),wolfMainRouter.notFound(()=>{wolfMainRouterSyncing||navigateTo("dashboard",{updateRoute:!1})}))}async function playLogoutOutro(){if(wolfLogoutInProgress)return;wolfLogoutInProgress=!0,document.body.classList.remove("logout-outro-final"),document.body.classList.add("logout-outro-active");const e=document.getElementById("logout-overlay");e&&e.setAttribute("aria-hidden","false"),window.wolfAudio&&(window.wolfAudio.play("woosh"),setTimeout(()=>{window.wolfAudio.play("logoff")},180)),await new Promise(n=>setTimeout(n,1550)),document.body.classList.add("logout-outro-final"),await new Promise(n=>setTimeout(n,950))}function rollbackLogoutOutro(){document.body.classList.remove("logout-outro-final"),document.body.classList.remove("logout-outro-active");const e=document.getElementById("logout-overlay");e&&e.setAttribute("aria-hidden","true"),wolfLogoutInProgress=!1}window.handleLogout=async function(){const e=window.Swal,n=window.supabaseClient,t=async()=>{var o;if(!wolfLogoutInProgress)try{await playLogoutOutro(),(o=n==null?void 0:n.auth)!=null&&o.signOut?await n.auth.signOut():sessionStorage.clear(),window.wolfRouter&&typeof window.wolfRouter.goToLogin=="function"?await window.wolfRouter.goToLogin({replace:!0,seamless:!0}):window.location.replace("/index.html")}catch(a){rollbackLogoutOutro(),e?e.fire({title:"LOGOUT FAILED",html:`<div style="color:var(--wolf-red); font-size:3rem; margin-bottom:12px;"><i class='bx bx-error-alt'></i></div>
                 <p style="color:#888; font-size:13px;">${a.message||"Unknown error"}</p>`,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-red",title:"wolf-swal-title",confirmButton:"btn-wolf-red"},confirmButtonText:"OK"}):alert(`Logout failed: ${a.message||"Unknown error"}`)}};e?(await e.fire({title:"TERMINATE SESSION?",html:`<div style="color:#ff4d4d; font-size:3rem; margin-bottom:12px;"><i class='bx bx-power-off'></i></div>
             <p style="color:#888; font-size:13px;">You will be logged out of Wolf OS.</p>`,showCancelButton:!0,confirmButtonText:"LOGOUT",cancelButtonText:"CANCEL",reverseButtons:!0,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-red",title:"wolf-swal-title",confirmButton:"btn-wolf-red",cancelButton:"btn-wolf-secondary"}})).isConfirmed&&await t():confirm("Log out of Wolf OS?")&&await t()};async function loadComponent(e,n){const t=document.getElementById(e);if(t)try{const o=await fetch(n);if(!o.ok)throw new Error("Failed to load component");const a=await o.text();t.insertAdjacentHTML("beforeend",a),t.querySelectorAll("style").forEach(w=>{document.head.appendChild(w)})}catch(o){console.error("loadComponent error:",o)}}function updateNavHighlights(e){document.querySelectorAll("[data-page]").forEach(t=>{const o=t.getAttribute("data-page")===e,a=t.querySelector("i");o?(t.classList.add("active"),a&&(a.classList.contains("bx-target")?a.className="bxf bx-target":a.className=a.className.replace(/\bbx-([a-z0-9-]+)\b/g,"bxs-$1"))):(t.classList.remove("active"),a&&(a.classList.contains("bx-target")||a.classList.contains("bxf")?a.className="bx bx-target":a.className=a.className.replace(/\bbxs-([a-z0-9-]+)\b/g,"bx-$1")))}),syncDropdownActiveLabels()}function syncDropdownActiveLabels(){document.querySelectorAll(".nav-dropdown").forEach(e=>{e.querySelector(".sub-item.active")?e.classList.add("active-only"):e.classList.remove("active-only")})}document.querySelectorAll("[data-page]").forEach(e=>{e.onclick=n=>{n.preventDefault();const t=e.getAttribute("data-page");t&&navigateTo(t)}});const themeBtn=document.getElementById("themeToggleBtn");themeBtn&&(themeBtn.onclick=e=>{e.preventDefault(),e.stopPropagation();const n=themeBtn.querySelector("i");n&&(n.classList.toggle("bx-moon"),n.classList.toggle("bx-sun"))});function wolfRefreshView(){var o;const e=((o=document.getElementById("ledger-title"))==null?void 0:o.innerText)||"",n=document.getElementById("ledger-main-search"),t=n?n.value.trim():"";e.includes("LOGBOOK")?window.wolfData&&typeof window.wolfData.loadLogbook=="function"&&window.wolfData.loadLogbook():window.wolfData&&typeof window.wolfData.loadSales=="function"&&window.wolfData.loadSales(),e.includes("LOGBOOK")?window.wolfData&&typeof window.wolfData.loadLogs=="function"&&window.wolfData.loadLogs():window.wolfData&&typeof window.wolfData.loadSales=="function"&&window.wolfData.loadSales()}async function closeAllActiveModals(){const e=t=>{if(!t)return;t.style.display="none",t.style.opacity="0",t.classList.remove("is-open","is-closing","closing");const o=t.querySelector(".master-terminal-container");o&&o.classList.remove("modal-open","modal-closing")},n=t=>{const o=document.getElementById(t);e(o)};try{typeof closeProductModal=="function"&&window.isProductModalOpen&&closeProductModal()}catch(t){console.warn("Wolf OS: Product modal close handler failed.",t)}n("product-modal-overlay"),window.isProductModalOpen=!1;try{window.salesManager&&typeof window.salesManager.closeSaleTerminal=="function"&&window.salesManager.closeSaleTerminal()}catch(t){console.warn("Wolf OS: Sales terminal close handler failed.",t)}n("sale-terminal-overlay");try{window.logbookManager&&typeof window.logbookManager.closeLogbookTerminal=="function"&&window.logbookManager.closeLogbookTerminal()}catch(t){console.warn("Wolf OS: Logbook terminal close handler failed.",t)}n("logbook-modal-overlay");try{window.salesManager&&typeof window.salesManager.closeTrash=="function"&&window.salesManager.closeTrash()}catch(t){console.warn("Wolf OS: Trash modal close handler failed.",t)}n("sales-trash-overlay");try{window.wolfScanner&&typeof window.wolfScanner.stop=="function"&&document.getElementById("wolf-scanner-overlay")&&await window.wolfScanner.stop({skipOnClose:!0})}catch(t){console.warn("Wolf OS: Scanner close handler failed.",t)}n("wolf-scanner-overlay"),n("scanResultModal"),document.querySelectorAll(".master-modal-overlay, .wolf-modal-overlay, .modal-overlay").forEach(t=>e(t))}async function navigateTo(e,n={}){var u;const t=document.getElementById("main-content"),o=document.getElementById("topbar-brand");if(!t)return;const{updateRoute:a=!0}=n;window.WOLF_LAST_REQUESTED_PAGE=e,await closeAllActiveModals();const p={home:{label:"WOLF <span>PALOMAR</span> GYM",parent:null},hub:{label:"COMMAND CENTER",parent:"WOLF OS",section:"main"},members:{label:"MEMBERS",parent:"MANAGEMENT",parentRoute:"hub",section:"admin"},products:{label:"PRODUCTS",parent:"MANAGEMENT",parentRoute:"hub",section:"admin"},"management/products":{label:"PRODUCTS",parent:"MANAGEMENT",parentRoute:"hub",section:"admin"},sales:{label:"SALES",parent:"LEDGER",parentRoute:"hub",section:"main"},logbook:{label:"LOGBOOK",parent:"LEDGER",parentRoute:"hub",section:"main"},settings:{label:"SETTINGS",parent:"SYSTEM",parentRoute:"hub",section:"system"},"audit-log":{label:"AUDIT LOG",parent:"SYSTEM",parentRoute:"hub",section:"system"}},w=`
    <div class="wolf-skeleton">
      <style>
        .wolf-skeleton { padding: 40px; max-width: 1200px; margin: 0 auto; opacity: 0; animation: fadeInSkel 0.3s forwards; }
        .skel-shimmer {
          background: linear-gradient(90deg, var(--skeleton-base, #242a32) 25%, var(--skeleton-mid, #313844) 50%, var(--skeleton-base, #242a32) 75%);
          background-size: 200% 100%;
          animation: skel-loading 1.5s infinite linear;
          border-radius: 8px;
          border: 1px solid var(--border-color, rgba(255, 255, 255, 0.08));
        }
        @keyframes skel-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @keyframes fadeInSkel { from { opacity: 0; } to { opacity: 1; } }
        .skel-title { width: 150px; height: 35px; margin-bottom: 40px; }
        .skel-income-card { width: 100%; height: 180px; border-radius: 20px; margin-bottom: 30px; }
        .skel-nav-bar { width: 100%; height: 50px; margin-bottom: 20px; display: flex; gap: 10px; }
        .skel-entry { width: 100%; height: 80px; margin-bottom: 15px; border-radius: 15px; }
      </style>
      <div class="skel-shimmer skel-title"></div>
      <div class="skel-shimmer skel-income-card"></div>
      <div class="skel-nav-bar"><div class="skel-shimmer" style="flex:1"></div><div class="skel-shimmer" style="flex:3"></div><div class="skel-shimmer" style="flex:1"></div></div>
      <div class="skel-shimmer skel-entry"></div><div class="skel-shimmer skel-entry"></div><div class="skel-shimmer skel-entry"></div><div class="skel-shimmer skel-entry"></div>
    </div>
  `,m=`
    <div class="wolf-page-intro" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:70vh; text-align:center; color:var(--text-main);">
      <i class='bx bx-wifi-off' style="font-size:80px; color:var(--wolf-red); margin-bottom:20px;"></i>
      <h1 style="font-size:32px; font-weight:900; margin:0; letter-spacing:-1px;">SIGNAL LOST</h1>
      <p style="color:var(--text-muted); max-width:400px; margin:15px 0 30px 0; line-height:1.6;">The encrypted uplink to Wolf OS was severed.</p>
      <button class="retry-btn" onclick="window.wolfRetry()" style="background:var(--wolf-red); color:var(--text-on-accent); border:none; padding:12px 30px; font-weight:bold; border-radius:8px; cursor:pointer; text-transform:uppercase; display:flex; align-items:center; gap:10px;">
        <i class='bx bx-refresh' style="font-size:20px;"></i>
        <span>RETRY CONNECTION</span>
      </button>
    </div>
  `;if(!navigator.onLine){t.innerHTML=m,t.style.opacity="1";return}t.innerHTML=w,t.style.opacity="1";const g=new Promise(i=>setTimeout(i,600));try{let i,f=!1;e==="sales"||e==="logbook"?(i="/assets/views/daily-ledger.html",f=!0):e==="members"?i="/pages/management/members.html":e==="management/products"||e==="products"?i="/pages/management/products.html":i=`/pages/${e}.html`;const s=fetch(i),[l]=await Promise.all([s,g]);if(!l.ok)throw new Error("404");const c=await l.text();t.style.opacity="0",setTimeout(()=>{if(t.innerHTML=`<div class="wolf-page-intro">${c}</div>`,o){const r=window.innerWidth<=1024,d=p[e];if(!d||e==="home")o.innerHTML="WOLF <span>PALOMAR</span> GYM",o.style.fontSize="";else{const b=r?"0.85rem":"1rem",y="0.5",h=e===d.parentRoute?`<span style="opacity: ${y};">${d.parent}</span>`:`<span class="breadcrumb-link" 
               onclick="window.pendingHubSection='${d.section}'; navigateTo('hub')" 
               style="cursor:pointer; opacity: ${y}; transition: opacity 0.2s;">
            ${d.parent}
          </span>`;o.style.fontSize=b,o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.innerHTML=`
          <div class="breadcrumb-container" style="display: flex; align-items: center; gap: ${r?"5px":"8px"};">
            ${h}
            <i class='bx bx-chevron-right' style="color: var(--wolf-red); font-size: ${r?"1.1rem":"1.3rem"}; font-weight: bold;"></i>
            <span style="letter-spacing: 1px; font-weight: 800; color: var(--breadcrumb-current-color, var(--text-main));">${d.label}</span>
          </div>
        `}}if(f&&window.wolfData?(wolfData.activeMode=e,wolfData.initLedger(e)):e==="members"&&typeof MemberManager!="undefined"?MemberManager.init():(e==="management/products"||e==="products")&&typeof ProductManager!="undefined"&&ProductManager.init(),t.style.opacity="1",updateNavHighlights(e),window.WOLF_CURRENT_PAGE=e,window.WOLF_LAST_REQUESTED_PAGE=e,a&&e)if(wolfMainRouter){const r=`/${e}`;(String(window.location.hash||"").replace("#","")||"/")!==r&&(wolfMainRouterSyncing=!0,wolfMainRouter.navigate(r),setTimeout(()=>{wolfMainRouterSyncing=!1},0))}else window.history.pushState({page:e},"",`?p=${e}`);window.applyVersioning&&window.applyVersioning()},200)}catch(i){if(console.warn("Wolf OS: Navigation Error ->",i),!navigator.onLine||i instanceof TypeError){t.innerHTML=m,t.style.opacity="1";return}try{const s=await(await fetch("/404.html")).text(),c=new DOMParser().parseFromString(s,"text/html");t.innerHTML=`<div class="wolf-page-intro">
        ${((u=c.querySelector("style"))==null?void 0:u.outerHTML)||""}
        ${c.body.innerHTML}
      </div>`,t.style.opacity="1";const r=document.getElementById("display-path");r&&(r.innerText=e),document.querySelectorAll("[data-page]").forEach(d=>d.classList.remove("active"))}catch(f){o&&(o.innerHTML="WOLF <span>PALOMAR</span> GYM"),t.innerHTML=m,t.style.opacity="1"}}}async function loadHTML(e){const n=await fetch(e);if(!n.ok)throw new Error(`[ERR_503] Failed to fetch: ${e}`);return await n.text()}async function initUI(){themeManager.init(),initMainRouter();const e=document.getElementById("loading-screen"),n=document.getElementById("loading-overlay"),t=document.getElementById("wolf-layout"),o=document.getElementById("stars-container"),a=document.querySelector(".boot-status"),p=document.querySelector(".progress-bar-fill"),w=async()=>{try{const[u,i,f]=await Promise.all([loadHTML("/assets/components/topbar.html"),loadHTML("/assets/components/sidebar.html"),loadHTML("/assets/components/floating-nav.html")]);document.getElementById("topbar-container").innerHTML=u,document.getElementById("sidebar-container").innerHTML=i,document.getElementById("nav-container").innerHTML=f;const s=getInitialMainPage();await navigateTo(s,{updateRoute:!0}),window.applyVersioning&&window.applyVersioning()}catch(u){console.error("Wolf OS: Component Load Error:",u)}};function m(u){const i=[{progress:15,msg:"INITIALIZING CORE SYSTEMS..."},{progress:35,msg:"ESTABLISHING SUPABASE UPLINK..."},{progress:60,msg:"LOADING SECURE ENCRYPTION..."},{progress:85,msg:"SYNCING DATABASE_MEMBERS..."},{progress:100,msg:"SYSTEM READY."}];let f=0;const s=setInterval(()=>{if(f<i.length){const l=i[f];a&&(a.innerText=l.msg),p&&(p.style.width=`${l.progress}%`),f++}else clearInterval(s),u&&u()},300)}function g(){setTimeout(()=>{e&&(e.style.opacity="0"),window.wolfAudio&&window.wolfAudio.play("intro"),setTimeout(()=>{e&&(e.style.display="none"),t&&(t.style.display="block",t.offsetWidth,t.style.opacity="1"),n&&(n.classList.add("fade-out"),setTimeout(()=>n.style.display="none",100))},300)},700)}if(typeof WOLF_CONFIG!="undefined"&&WOLF_CONFIG.noLoadingScreen){e&&(e.style.display="none"),o&&(o.style.display="none"),n&&(n.style.display="none"),await w(),t&&(t.style.display="block",t.style.opacity="1"),setupGlobalClickHandlers();return}console.log("Wolf OS: Cinematic Boot Initialized."),setTimeout(async()=>{o&&(o.style.display="none"),e&&(e.style.display="flex",e.classList.add("show")),setupGlobalClickHandlers(),m(()=>{g()}),await w()},1e3)}function setupGlobalClickHandlers(){if(window.wolfEventHandlersAttached)return;window.wolfEventHandlersAttached=!0;const e=o=>{const a=document.getElementById("moreNavBtn");a&&a.classList.toggle("sidebar-active",!!o)},n=()=>{const o=document.getElementById("wolfSidebar"),a=document.getElementById("sidebar-backdrop");if(!o)return;o.classList.remove("active"),document.body.classList.remove("sidebar-open"),a&&a.classList.remove("active");const p=document.getElementById("closeIcon"),w=o.querySelector(".version");p&&(p.className="bxf bx-caret-big-right"),w&&(w.style.display="none"),e(!1),document.querySelectorAll(".nav-dropdown").forEach(m=>m.classList.remove("open"))};document.addEventListener("click",async o=>{if(o.target.closest(".logout-btn, .logout-btn2")){o.preventDefault(),o.stopPropagation(),window.handleLogout&&window.handleLogout();return}if(o.target.closest("#btn-add-product")){o.preventDefault(),o.stopPropagation();const s=document.getElementById("product-modal-overlay");s?s.style.display="flex":alert("Add Product modal not found in DOM");return}const w=o.target.closest(".nav-dropdown > .nav-item-side");if(w){o.preventDefault();const s=document.getElementById("wolfSidebar"),l=w.parentElement,c=document.getElementById("closeIcon"),r=s?s.querySelector(".version"):null;s&&!s.classList.contains("active")&&(s.classList.add("active"),document.body.classList.add("sidebar-open"),e(!0)),c&&(c.className="bxf bx-caret-big-left"),r&&(r.style.display="none"),document.querySelectorAll(".nav-dropdown").forEach(d=>{d!==l&&d.classList.remove("open")}),l.classList.toggle("open"),window.wolfAudio&&window.wolfAudio.play("notif");return}const m=o.target.closest("#toggle-search-btn");if(m){const s=m.closest("#product-main-view, #member-main-view, #sales-main-view, #logbook-main-view, #main-content, .ledger-page-wrapper")||document,l=s.querySelector("#ledger-search-container"),c=s.querySelector("#ledger-main-search");if(!l||!c)return;o.preventDefault(),o.stopPropagation();const r=l.classList.toggle("active");if(m.classList.toggle("active",r),r)setTimeout(()=>c.focus(),150);else{c.value="";const d=s.querySelector("#search-clear-btn");d&&(d.style.display="none")}return}if(o.target.closest("#clear-sales-btn")){o.preventDefault(),o.stopPropagation(),window.salesManager&&typeof window.salesManager.openTrashBin=="function"?window.salesManager.openTrashBin():console.warn("Wolf OS: salesManager not available for trash modal.");return}const u=o.target.closest("[data-page]");if(u){o.preventDefault();const s=u.getAttribute("data-page");navigateTo(s),window.wolfData&&window.wolfData.syncNavigationUI&&window.wolfData.syncNavigationUI(s),u.closest("#wolfSidebar")&&window.innerWidth<768&&n();return}if(o.target.closest("#themeToggleBtn")){o.preventDefault(),themeManager.toggle();return}const i=document.getElementById("wolfSidebar"),f=document.getElementById("sidebar-backdrop");if(o.target.closest("#moreNavBtn")||o.target.closest("#sidebarToggle")||o.target.closest("#sidebarClose")||o.target===f){if(!i)return;const s=i.classList.toggle("active");document.body.classList.toggle("sidebar-open",s),f&&f.classList.toggle("active",s),e(s);const l=document.getElementById("closeIcon"),c=i.querySelector(".version");s?(l&&(l.className="bxf bx-caret-big-left"),c&&(c.style.display="block")):(l&&(l.className="bxf bx-caret-big-right"),c&&(c.style.display="none"),document.querySelectorAll(".nav-dropdown").forEach(r=>r.classList.remove("open")))}});const t=document.getElementById("wolfSidebar");e(t==null?void 0:t.classList.contains("active")),document.addEventListener("input",o=>{if(o.target.id==="ledger-main-search"){const a=document.getElementById("search-clear-btn");a&&(a.style.display=o.target.value.length>0?"block":"none"),clearTimeout(window.searchDebounce),window.searchDebounce=setTimeout(()=>{window.wolfData&&(window.wolfData.activeMode==="sales"?window.wolfData.loadSales():window.wolfData.loadLogbook())},300)}})}document.addEventListener("DOMContentLoaded",()=>{initUI().catch(e=>console.error("System Boot Failure:",e))});
