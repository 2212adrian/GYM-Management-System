let html5QrCode=null;window.wolfScanner={availableCameras:[],currentCamIndex:0,activeCallback:null,onCloseCallback:null,isProcessingResult:!1,isSwitchingCamera:!1,lastScanTime:0,async init(){if(document.getElementById("wolf-scanner-overlay"))return!0;try{const t=await fetch("/assets/components/scanner-modal.html");if(!t.ok)throw new Error("Scanner component missing");const a=await t.text();return document.body.insertAdjacentHTML("beforeend",a),this.attachListeners(),!0}catch(t){return console.error("Wolf OS: Scanner Init Fault:",t),!1}},async start(t=null,a=!1,l=null){if(!await this.init())return;const r=document.getElementById("wolf-scanner-overlay");if(!r)return;this.activeCallback=t,this.onCloseCallback=typeof l=="function"?l:null,this.isProcessingResult=!1,this.isSwitchingCamera=!1,r.style.display="flex",r.style.opacity="1",r.style.pointerEvents="auto";const i=document.getElementById("manualCodeInput");i&&(i.value="",setTimeout(()=>i.focus(),300));try{const e=await Html5Qrcode.getCameras();if(this.availableCameras=e,e&&e.length>0){const n=document.getElementById("cameraSelect");n.innerHTML=e.map((w,m)=>`<option value="${w.id}">${w.label||"Optic "+(m+1)}</option>`).join(""),n.onchange=w=>this.launchCamera(w.target.value),document.getElementById("flipCameraBtn").onclick=()=>this.cycleCamera();let u=e.findIndex(w=>/back|rear|environment|main/i.test(w.label));this.currentCamIndex=u!==-1?u:0,n.value=e[this.currentCamIndex].id,await this.launchCamera(e[this.currentCamIndex].id)}}catch(e){this.showInactiveUI("PERMISSION_DENIED")}},async launchCamera(t){if(this.isSwitchingCamera)return;if(this.isSwitchingCamera=!0,html5QrCode){try{await html5QrCode.stop()}catch(l){}html5QrCode=null}const a=document.getElementById("reader");a.innerHTML="",html5QrCode=new Html5Qrcode("reader");try{await html5QrCode.start(t,{fps:20,qrbox:{width:250,height:250},aspectRatio:1},l=>this.processResult(l,"SCAN"))}catch(l){this.showInactiveUI("HARDWARE_FAULT")}finally{this.isSwitchingCamera=!1}},async cycleCamera(){if(this.availableCameras.length<2)return;window.wolfAudio&&window.wolfAudio.play("notif"),this.currentCamIndex=(this.currentCamIndex+1)%this.availableCameras.length;const t=this.availableCameras[this.currentCamIndex].id,a=document.getElementById("cameraSelect");a&&(a.value=t),await this.launchCamera(t)},isQuickLoginPayload(t){return typeof t!="string"?!1:t.startsWith("WOLFQL2.")||t.startsWith("WOLFQL1.")},decodeQuickLoginPayload(t){if(!this.isQuickLoginPayload(t))return null;if(t.startsWith("WOLFQL2."))return{qrToken:String(t).trim()};try{const l=t.slice(8).trim().replace(/-/g,"+").replace(/_/g,"/"),s="=".repeat((4-l.length%4)%4),r=atob(l+s),i=JSON.parse(r),e=(i==null?void 0:i.requestId)||(i==null?void 0:i.r);if(!e)return null;const n=Array.isArray(i==null?void 0:i.p)?i.p:null,u=i!=null&&i.previewContext&&typeof i.previewContext=="object"?i.previewContext:n&&n.length>=4?{ip:n[0],city:n[1],region:n[2],country:n[3]}:null;return{requestId:String(e),previewContext:u&&typeof u=="object"?{ip:String(u.ip||""),city:String(u.city||""),region:String(u.region||""),country:String(u.country||""),countryCode:String(u.countryCode||"")}:null,previewSig:String(i.previewSig||i.g||"")}}catch(a){return null}},async handleQuickLoginApproval(t){var k,y,C,v,b,L,I;const a=this.decodeQuickLoginPayload(t);if(!a)throw new Error("Malformed quick-login code");const l=await fetch("/.netlify/functions/quick-login-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a.qrToken?{qrToken:a.qrToken,consume:!1}:{requestId:a.requestId,previewContext:a.previewContext,previewSig:a.previewSig,consume:!1})});let s={};try{s=await l.json()}catch(f){s={}}if(!l.ok)throw new Error(s.error||"Unable to preview quick-login request");if(s.status!=="pending")throw new Error("Quick-login session is no longer pending");const r=s.location||{},i=[r.city,r.region,r.country].filter(Boolean).join(", ")||"Unknown location",e=r.ip||"Unknown IP",n=f=>{const S=String(f!=null?f:"");return window.DOMPurify?window.DOMPurify.sanitize(S,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]}):S.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;")},u=n(e),w=n(i),m=String(a.requestId||s.requestId||"").trim(),d=n((m?m.slice(0,10):"---").toUpperCase());let c=!1;if(window.Swal?c=!!(await window.Swal.fire({title:"APPROVE QUICK LOGIN?",html:`
          <div style="text-align:left; font-size:13px; color:#aab3c2; line-height:1.6;">
            <div style="margin-bottom:8px;">
              <strong style="color:#e7eefc;">Request IP:</strong><br>${u}
            </div>
            <div style="margin-bottom:8px;">
              <strong style="color:#e7eefc;">Location:</strong><br>${w}
            </div>
            <div>
              <strong style="color:#e7eefc;">Session Ref:</strong><br>${d}
            </div>
          </div>
        `,showCancelButton:!0,confirmButtonText:"CONFIRM LOGIN",cancelButtonText:"CANCEL",reverseButtons:!0,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-orange",title:"wolf-swal-title",confirmButton:"btn-wolf-red",cancelButton:"btn-wolf-secondary"}})).isConfirmed:c=window.confirm(`Approve quick login?
IP: ${e}
Location: ${i}`),!c)return;const p=await((C=(y=(k=window.supabaseClient)==null?void 0:k.auth)==null?void 0:y.getSession)==null?void 0:C.call(y));let o=((v=p==null?void 0:p.data)==null?void 0:v.session)||null;if(o!=null&&o.refresh_token&&typeof((L=(b=window.supabaseClient)==null?void 0:b.auth)==null?void 0:L.refreshSession)=="function")try{const f=await window.supabaseClient.auth.refreshSession({refresh_token:o.refresh_token});!(f!=null&&f.error)&&((I=f==null?void 0:f.data)!=null&&I.session)&&(o=f.data.session)}catch(f){}if(!(o!=null&&o.access_token)||!(o!=null&&o.refresh_token))throw new Error("No active authenticated session found for approval");const h=await fetch("/.netlify/functions/quick-login-approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a.qrToken?{qrToken:a.qrToken,accessToken:o.access_token,refreshToken:o.refresh_token}:{requestId:a.requestId,accessToken:o.access_token,refreshToken:o.refresh_token})});let g={};try{g=await h.json()}catch(f){g={}}if(!h.ok)throw new Error(g.error||"Failed to approve quick-login request");window.wolfAudio&&window.wolfAudio.play("success"),window.Toastify&&window.Toastify({text:"Quick login approved successfully.",duration:2800,gravity:"bottom",position:"right",style:{background:"linear-gradient(90deg, #1e734a, #2ea35f)",color:"#f6fff9"}}).showToast()},async processResult(t,a){var s;const l=Date.now();if(!(l-this.lastScanTime<2e3)&&(this.lastScanTime=l,!this.isProcessingResult)){this.isProcessingResult=!0;try{navigator.vibrate&&navigator.vibrate(80),window.wolfAudio&&window.wolfAudio.play("success");const r=(s=document.getElementById("quickAuthToggle"))==null?void 0:s.checked,i=String(t||"").trim();if(this.isQuickLoginPayload(i)){await this.stop(),await this.handleQuickLoginApproval(i);return}const e=i.toUpperCase().replace(/\s+/g,""),n=/^ME-[A-Z0-9]{2,}$/.test(e);if(!this.activeCallback&&n){await this.stop(),window.logbookManager&&r&&typeof window.logbookManager.processCheckIn=="function"?await window.logbookManager.processCheckIn(e,{entryType:"member",isPaid:!1}):window.logbookManager&&typeof window.logbookManager.openLogbookTerminal=="function"?await window.logbookManager.openLogbookTerminal(e):window.salesManager&&window.salesManager.showSystemAlert("LOGBOOK_MODULE_NOT_READY","error");return}await this.stop(),this.activeCallback?this.activeCallback(e):window.salesManager&&(r?await window.salesManager.processQuickSale(e):await window.salesManager.openSaleTerminal(e))}catch(r){window.wolfAudio&&window.wolfAudio.play("error"),window.Swal?window.Swal.fire({title:"QUICK LOGIN REJECTED",text:r.message||"Failed to process QR payload.",background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-red",title:"wolf-swal-title",confirmButton:"btn-wolf-red"},confirmButtonText:"OK"}):alert(r.message||"Failed to process QR payload.")}finally{this.isProcessingResult=!1}}},async stop(t={}){const{skipOnClose:a=!1}=t;if(html5QrCode){try{await html5QrCode.stop(),html5QrCode.clear()}catch(e){}html5QrCode=null}const l=document.getElementById("wolf-scanner-overlay");l&&(l.style.display="none",l.style.opacity="0",l.style.pointerEvents="none");const s=document.getElementById("manualCodeInput"),r=document.getElementById("manualInputGroup");s&&(s.value=""),r&&r.classList.remove("has-content");const i=this.onCloseCallback;if(this.onCloseCallback=null,this.activeCallback=null,this.isProcessingResult=!1,this.isSwitchingCamera=!1,!a&&i)try{i()}catch(e){console.warn("Wolf OS: Scanner close callback failed.",e)}},attachListeners(){const t=document.getElementById("manualCodeInput"),a=document.getElementById("manualInputGroup"),l=document.getElementById("manualConfirmBtn"),s=document.getElementById("custom-search-results");let r=null;t&&(t.addEventListener("input",e=>{e.target.value=e.target.value.toUpperCase(),a.classList.toggle("has-content",e.target.value.trim().length>0)}),t.addEventListener("input",()=>{const e=t.value.trim();if(s){if(r&&clearTimeout(r),e.length<1){s.classList.remove("active"),s.innerHTML="";return}r=setTimeout(async()=>{var w,m;let n=[];const u=d=>{const c=String(d!=null?d:"");return window.DOMPurify?window.DOMPurify.sanitize(c,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]}):c.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")};if(window.supabaseClient){const d=await window.supabaseClient.from("products").select("name, sku, is_active").eq("is_active",!0).or(`name.ilike.%${e}%,sku.ilike.%${e}%`).order("name",{ascending:!0}).limit(6);d.error||(n=(d.data||[]).filter(p=>p.is_active!==!1));const c=await window.supabaseClient.from("members").select("full_name, member_code, sku").or(`full_name.ilike.%${e}%,member_code.ilike.%${e}%,sku.ilike.%${e}%`).order("full_name",{ascending:!0}).limit(4);!c.error&&((w=c.data)!=null&&w.length)?n=[...c.data.filter(o=>String(o.member_code||o.sku||"").trim().length>0).map(o=>({name:o.full_name||"Member",sku:String(o.member_code||o.sku||"").toUpperCase(),type:"MEMBER"})),...n.map(o=>({...o,type:"PRODUCT"}))]:n=n.map(p=>({...p,type:"PRODUCT"}))}if((!n||n.length===0)&&((m=window.ProductManager)!=null&&m.allProducts)){const d=e.toLowerCase();n=window.ProductManager.allProducts.filter(c=>c.name&&c.name.toLowerCase().includes(d)||c.sku&&c.sku.toLowerCase().includes(d)).slice(0,6).map(c=>({name:c.name,sku:c.sku,type:"PRODUCT"}))}if(s){if(!n||n.length===0){s.classList.remove("active"),s.innerHTML="";return}s.innerHTML=n.map(d=>{const c=String(d.type||"PRODUCT").toUpperCase(),p=u(String(d.name||"").toUpperCase()),o=String(d.sku||"").toUpperCase(),h=o.startsWith("PR-")?o:`PR-${o}`,g=u(c==="MEMBER"?o:h);return`
              <div class="dropdown-item" data-sku="${u(o)}" data-kind="${c}">
                <span>${p}</span>
                <span class="sku">${g}</span>
              </div>
            `}).join(""),s.classList.add("active")}},250)}}),t.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();const n=t.value.trim();n&&this.processResult(n,"MANUAL_ENTRY")}})),l&&(l.onclick=()=>{const e=t.value.trim();e&&this.processResult(e,"MANUAL_ENTRY")}),s&&s.addEventListener("click",e=>{const n=e.target.closest(".dropdown-item");if(!n)return;const u=n.getAttribute("data-sku")||"",w=n.getAttribute("data-kind")||"PRODUCT";u&&(t&&(t.value=u.toUpperCase()),s.classList.remove("active"),s.innerHTML="",a&&a.classList.add("has-content"),this.processResult(u,w==="MEMBER"?"MANUAL_MEMBER_PICK":"MANUAL_PICK"))});const i=document.getElementById("exitScannerBtn");i&&(i.onclick=()=>this.stop())},showInactiveUI(t){const a=document.getElementById("reader");window.wolfAudio&&window.wolfAudio.play("error"),a.innerHTML=`
      <div class="camera-inactive-state">
        <i class='bx bx-camera-off' style="color:var(--wolf-red); opacity: 1;"></i>
        <span style="color:var(--wolf-red)">${t}</span>
      </div>`}},document.addEventListener("click",t=>{t.target.closest("#qrScannerBtn")&&window.wolfScanner.start()});
