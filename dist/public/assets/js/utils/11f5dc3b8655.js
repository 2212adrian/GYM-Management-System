let html5QrCode=null;window.wolfScanner={availableCameras:[],currentCamIndex:0,activeCallback:null,onCloseCallback:null,isProcessingResult:!1,isSwitchingCamera:!1,lastScanTime:0,async init(){if(document.getElementById("wolf-scanner-overlay"))return!0;try{const n=await fetch("/assets/components/scanner-modal.html");if(!n.ok)throw new Error("Scanner component missing");const o=await n.text();return document.body.insertAdjacentHTML("beforeend",o),this.attachListeners(),!0}catch(n){return console.error("Wolf OS: Scanner Init Fault:",n),!1}},async start(n=null,o=!1,r=null){if(!await this.init())return;const s=document.getElementById("wolf-scanner-overlay");if(!s)return;this.activeCallback=n,this.onCloseCallback=typeof r=="function"?r:null,this.isProcessingResult=!1,this.isSwitchingCamera=!1,s.style.display="flex",s.style.opacity="1",s.style.pointerEvents="auto";const t=document.getElementById("manualCodeInput");t&&(t.value="",setTimeout(()=>t.focus(),300));try{const e=await Html5Qrcode.getCameras();if(this.availableCameras=e,e&&e.length>0){const i=document.getElementById("cameraSelect");i.innerHTML=e.map((l,p)=>`<option value="${l.id}">${l.label||"Optic "+(p+1)}</option>`).join(""),i.onchange=l=>this.launchCamera(l.target.value),document.getElementById("flipCameraBtn").onclick=()=>this.cycleCamera();let u=e.findIndex(l=>/back|rear|environment|main/i.test(l.label));this.currentCamIndex=u!==-1?u:0,i.value=e[this.currentCamIndex].id,await this.launchCamera(e[this.currentCamIndex].id)}}catch(e){this.showInactiveUI("PERMISSION_DENIED")}},async launchCamera(n){if(this.isSwitchingCamera)return;if(this.isSwitchingCamera=!0,html5QrCode){try{await html5QrCode.stop()}catch(r){}html5QrCode=null}const o=document.getElementById("reader");o.innerHTML="",html5QrCode=new Html5Qrcode("reader");try{await html5QrCode.start(n,{fps:20,qrbox:{width:250,height:250},aspectRatio:1},r=>this.processResult(r,"SCAN"))}catch(r){this.showInactiveUI("HARDWARE_FAULT")}finally{this.isSwitchingCamera=!1}},async cycleCamera(){if(this.availableCameras.length<2)return;window.wolfAudio&&window.wolfAudio.play("notif"),this.currentCamIndex=(this.currentCamIndex+1)%this.availableCameras.length;const n=this.availableCameras[this.currentCamIndex].id,o=document.getElementById("cameraSelect");o&&(o.value=n),await this.launchCamera(n)},isQuickLoginPayload(n){return typeof n=="string"&&n.startsWith("WOLFQL1.")},decodeQuickLoginPayload(n){if(!this.isQuickLoginPayload(n))return null;try{const r=n.slice(8).trim().replace(/-/g,"+").replace(/_/g,"/"),a="=".repeat((4-r.length%4)%4),s=atob(r+a),t=JSON.parse(s),e=(t==null?void 0:t.requestId)||(t==null?void 0:t.r),i=(t==null?void 0:t.requestSecret)||(t==null?void 0:t.s);if(!e||!i)return null;const u=Array.isArray(t==null?void 0:t.p)?t.p:null,l=t!=null&&t.previewContext&&typeof t.previewContext=="object"?t.previewContext:u&&u.length>=4?{ip:u[0],city:u[1],region:u[2],country:u[3]}:null;return{requestId:String(e),requestSecret:String(i),previewContext:l&&typeof l=="object"?{ip:String(l.ip||""),city:String(l.city||""),region:String(l.region||""),country:String(l.country||""),countryCode:String(l.countryCode||"")}:null,previewSig:String(t.previewSig||t.g||"")}}catch(o){return null}},async handleQuickLoginApproval(n){var y,h,C,v;const o=this.decodeQuickLoginPayload(n);if(!o)throw new Error("Malformed quick-login code");const r=await fetch("/.netlify/functions/quick-login-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requestId:o.requestId,requestSecret:o.requestSecret,previewContext:o.previewContext,previewSig:o.previewSig,consume:!1})});let a={};try{a=await r.json()}catch(m){a={}}if(!r.ok)throw new Error(a.error||"Unable to preview quick-login request");if(a.status!=="pending")throw new Error("Quick-login session is no longer pending");const s=a.location||{},t=[s.city,s.region,s.country].filter(Boolean).join(", ")||"Unknown location",e=s.ip||"Unknown IP",i=m=>{const k=String(m!=null?m:"");return window.DOMPurify?window.DOMPurify.sanitize(k,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]}):k.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;")},u=i(e),l=i(t),p=i(String(o.requestId).slice(0,10).toUpperCase());let d=!1;if(window.Swal?d=!!(await window.Swal.fire({title:"APPROVE QUICK LOGIN?",html:`
          <div style="text-align:left; font-size:13px; color:#aab3c2; line-height:1.6;">
            <div style="margin-bottom:8px;">
              <strong style="color:#e7eefc;">Request IP:</strong><br>${u}
            </div>
            <div style="margin-bottom:8px;">
              <strong style="color:#e7eefc;">Location:</strong><br>${l}
            </div>
            <div>
              <strong style="color:#e7eefc;">Session Ref:</strong><br>${p}
            </div>
          </div>
        `,showCancelButton:!0,confirmButtonText:"CONFIRM LOGIN",cancelButtonText:"CANCEL",reverseButtons:!0,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-orange",title:"wolf-swal-title",confirmButton:"btn-wolf-red",cancelButton:"btn-wolf-secondary"}})).isConfirmed:d=window.confirm(`Approve quick login?
IP: ${e}
Location: ${t}`),!d)return;const c=await((C=(h=(y=window.supabaseClient)==null?void 0:y.auth)==null?void 0:h.getSession)==null?void 0:C.call(h)),f=((v=c==null?void 0:c.data)==null?void 0:v.session)||null;if(!(f!=null&&f.access_token)||!(f!=null&&f.refresh_token))throw new Error("No active authenticated session found for approval");const w=await fetch("/.netlify/functions/quick-login-approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requestId:o.requestId,requestSecret:o.requestSecret,accessToken:f.access_token,refreshToken:f.refresh_token})});let g={};try{g=await w.json()}catch(m){g={}}if(!w.ok)throw new Error(g.error||"Failed to approve quick-login request");window.wolfAudio&&window.wolfAudio.play("success"),window.Toastify&&window.Toastify({text:"Quick login approved successfully.",duration:2800,gravity:"bottom",position:"right",style:{background:"linear-gradient(90deg, #1e734a, #2ea35f)",color:"#f6fff9"}}).showToast()},async processResult(n,o){var a;const r=Date.now();if(!(r-this.lastScanTime<2e3)&&(this.lastScanTime=r,!this.isProcessingResult)){this.isProcessingResult=!0;try{navigator.vibrate&&navigator.vibrate(80),window.wolfAudio&&window.wolfAudio.play("success");const s=(a=document.getElementById("quickAuthToggle"))==null?void 0:a.checked,t=String(n||"").trim();if(this.isQuickLoginPayload(t)){await this.stop(),await this.handleQuickLoginApproval(t);return}const e=t.toUpperCase().replace(/\s+/g,""),i=/^ME-[A-Z0-9]{2,}$/.test(e);if(!this.activeCallback&&i){await this.stop(),window.logbookManager&&s&&typeof window.logbookManager.processCheckIn=="function"?await window.logbookManager.processCheckIn(e,{entryType:"member",isPaid:!1}):window.logbookManager&&typeof window.logbookManager.openLogbookTerminal=="function"?await window.logbookManager.openLogbookTerminal(e):window.salesManager&&window.salesManager.showSystemAlert("LOGBOOK_MODULE_NOT_READY","error");return}await this.stop(),this.activeCallback?this.activeCallback(e):window.salesManager&&(s?await window.salesManager.processQuickSale(e):await window.salesManager.openSaleTerminal(e))}catch(s){window.wolfAudio&&window.wolfAudio.play("error"),window.Swal?window.Swal.fire({title:"QUICK LOGIN REJECTED",text:s.message||"Failed to process QR payload.",background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-red",title:"wolf-swal-title",confirmButton:"btn-wolf-red"},confirmButtonText:"OK"}):alert(s.message||"Failed to process QR payload.")}finally{this.isProcessingResult=!1}}},async stop(n={}){const{skipOnClose:o=!1}=n;if(html5QrCode){try{await html5QrCode.stop(),html5QrCode.clear()}catch(e){}html5QrCode=null}const r=document.getElementById("wolf-scanner-overlay");r&&(r.style.display="none",r.style.opacity="0",r.style.pointerEvents="none");const a=document.getElementById("manualCodeInput"),s=document.getElementById("manualInputGroup");a&&(a.value=""),s&&s.classList.remove("has-content");const t=this.onCloseCallback;if(this.onCloseCallback=null,this.activeCallback=null,this.isProcessingResult=!1,this.isSwitchingCamera=!1,!o&&t)try{t()}catch(e){console.warn("Wolf OS: Scanner close callback failed.",e)}},attachListeners(){const n=document.getElementById("manualCodeInput"),o=document.getElementById("manualInputGroup"),r=document.getElementById("manualConfirmBtn"),a=document.getElementById("custom-search-results");let s=null;n&&(n.addEventListener("input",e=>{e.target.value=e.target.value.toUpperCase(),o.classList.toggle("has-content",e.target.value.trim().length>0)}),n.addEventListener("input",()=>{const e=n.value.trim();if(a){if(s&&clearTimeout(s),e.length<1){a.classList.remove("active"),a.innerHTML="";return}s=setTimeout(async()=>{var l,p;let i=[];const u=d=>{const c=String(d!=null?d:"");return window.DOMPurify?window.DOMPurify.sanitize(c,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]}):c.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")};if(window.supabaseClient){const d=await window.supabaseClient.from("products").select("name, sku, is_active").eq("is_active",!0).or(`name.ilike.%${e}%,sku.ilike.%${e}%`).order("name",{ascending:!0}).limit(6);d.error||(i=(d.data||[]).filter(f=>f.is_active!==!1));const c=await window.supabaseClient.from("members").select("full_name, member_code, sku").or(`full_name.ilike.%${e}%,member_code.ilike.%${e}%,sku.ilike.%${e}%`).order("full_name",{ascending:!0}).limit(4);!c.error&&((l=c.data)!=null&&l.length)?i=[...c.data.filter(w=>String(w.member_code||w.sku||"").trim().length>0).map(w=>({name:w.full_name||"Member",sku:String(w.member_code||w.sku||"").toUpperCase(),type:"MEMBER"})),...i.map(w=>({...w,type:"PRODUCT"}))]:i=i.map(f=>({...f,type:"PRODUCT"}))}if((!i||i.length===0)&&((p=window.ProductManager)!=null&&p.allProducts)){const d=e.toLowerCase();i=window.ProductManager.allProducts.filter(c=>c.name&&c.name.toLowerCase().includes(d)||c.sku&&c.sku.toLowerCase().includes(d)).slice(0,6).map(c=>({name:c.name,sku:c.sku,type:"PRODUCT"}))}if(a){if(!i||i.length===0){a.classList.remove("active"),a.innerHTML="";return}a.innerHTML=i.map(d=>{const c=String(d.type||"PRODUCT").toUpperCase(),f=u(String(d.name||"").toUpperCase()),w=String(d.sku||"").toUpperCase(),g=w.startsWith("PR-")?w:`PR-${w}`,y=u(c==="MEMBER"?w:g);return`
              <div class="dropdown-item" data-sku="${u(w)}" data-kind="${c}">
                <span>${f}</span>
                <span class="sku">${y}</span>
              </div>
            `}).join(""),a.classList.add("active")}},250)}}),n.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();const i=n.value.trim();i&&this.processResult(i,"MANUAL_ENTRY")}})),r&&(r.onclick=()=>{const e=n.value.trim();e&&this.processResult(e,"MANUAL_ENTRY")}),a&&a.addEventListener("click",e=>{const i=e.target.closest(".dropdown-item");if(!i)return;const u=i.getAttribute("data-sku")||"",l=i.getAttribute("data-kind")||"PRODUCT";u&&(n&&(n.value=u.toUpperCase()),a.classList.remove("active"),a.innerHTML="",o&&o.classList.add("has-content"),this.processResult(u,l==="MEMBER"?"MANUAL_MEMBER_PICK":"MANUAL_PICK"))});const t=document.getElementById("exitScannerBtn");t&&(t.onclick=()=>this.stop())},showInactiveUI(n){const o=document.getElementById("reader");window.wolfAudio&&window.wolfAudio.play("error"),o.innerHTML=`
      <div class="camera-inactive-state">
        <i class='bx bx-camera-off' style="color:var(--wolf-red); opacity: 1;"></i>
        <span style="color:var(--wolf-red)">${n}</span>
      </div>`}},document.addEventListener("click",n=>{n.target.closest("#qrScannerBtn")&&window.wolfScanner.start()});
