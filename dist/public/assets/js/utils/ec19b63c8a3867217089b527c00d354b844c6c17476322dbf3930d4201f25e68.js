(function(){if(window.__wolfSystemToolsManagersBooted)return;window.__wolfSystemToolsManagersBooted=!0;const ue="wolf_local_equipments",me="wolf_local_feedback_entries",se="wolf_local_goal_targets",ge="wolf_local_goal_custom_config",ne="wolf_action_sounds_muted",ie="wolf_victory_visuals_enabled",oe="wolf_ui_scale_percent",re="wolf_display_name",z="adrianangeles2212@gmail.com",fe=new Set([z,"ktorrazo123@gmail.com"]),pe=new Set(["adrianangeles2213@gmail.com"]);function U(e){return String(e||"").trim().toLowerCase()}function be(){const e=window.WOLF_ACCESS_CONTEXT||{},t=U(e.email||window.WOLF_USER_EMAIL);if(t&&fe.has(t))return"admin";if(t&&pe.has(t))return"staff";const a=String(e.role||window.WOLF_USER_ROLE||"").trim().toLowerCase();return a==="admin"||a==="staff"?a:null}function y(){var i;const e=be(),t=U(((i=window.WOLF_ACCESS_CONTEXT)==null?void 0:i.email)||window.WOLF_USER_EMAIL),a=e==="admin";return{role:e,email:t,isAdmin:a,isStaff:e==="staff",isSuperAdmin:t===z,canHardDelete:a}}function u(e){return String(e!=null?e:"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function f(e){const t=Number(e);return Number.isFinite(t)?t:0}function _(e=0){return`PHP ${f(e).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`}function H(e){if(!e)return"N/A";const t=new Date(e);return Number.isNaN(t.getTime())?"N/A":t.toLocaleString(void 0,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"})}function he(e){if(!e)return"N/A";const t=new Date(e);return Number.isNaN(t.getTime())?"N/A":t.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"})}function d(e,t="info"){const a=String(e||"").trim();if(a){if(window.salesManager&&typeof window.salesManager.showSystemAlert=="function"){const s=t==="error"||t==="warning"?"error":"success";window.salesManager.showSystemAlert(a,s)}typeof window.Toastify=="function"&&window.Toastify({text:a,duration:3200,gravity:"top",position:"right",style:{background:t==="error"?"#3a1111":t==="warning"?"#3a2b11":"#102119",color:"#f4f6f9",border:`1px solid ${t==="error"?"#ef4444":t==="warning"?"#f59e0b":"#22c55e"}`,borderRadius:"10px",fontWeight:"700"}}).showToast()}}function V(e){try{const t=window.localStorage.getItem(e);if(!t)return[];const a=JSON.parse(t);return Array.isArray(a)?a:[]}catch(t){return[]}}function ce(e,t){try{window.localStorage.setItem(e,JSON.stringify(t||[]))}catch(a){}}function k(e){const t=String((e==null?void 0:e.message)||"").toLowerCase();return(e==null?void 0:e.code)==="PGRST204"||/column .* does not exist/.test(t)||/could not find the .* column/.test(t)||/schema cache/.test(t)}function R(e){const t=String((e==null?void 0:e.message)||"").toLowerCase();return(e==null?void 0:e.code)==="PGRST205"||(e==null?void 0:e.code)==="42P01"||/relation .* does not exist/.test(t)||/could not find the table/.test(t)||/table .* does not exist/.test(t)}function j(e){const t=String((e==null?void 0:e.message)||"").toLowerCase();return(e==null?void 0:e.code)==="42501"||/row-level security policy/.test(t)||/permission denied/.test(t)||/insufficient privileges/.test(t)}async function b(){if(window.supabaseClient)return window.supabaseClient;if(window.supabaseReady&&typeof window.supabaseReady.then=="function")try{await window.supabaseReady}catch(e){}return window.supabaseClient||null}function C(e){const t=new Date(e);return t.setHours(0,0,0,0),t}function de(e){const t=C(e);return t.setDate(t.getDate()+1),t}function we(e){const t=C(e);return t.setDate(t.getDate()-t.getDay()),t}function ye(e){const t=C(e);return t.setDate(1),t}function G(e,t){for(const a of t){const s=e==null?void 0:e[a];if(!s)continue;const i=new Date(s);if(!Number.isNaN(i.getTime()))return i}return null}async function W(e,t,a,s,i,o){if(!e)return{data:[],error:null};for(const g of o){const{data:h,error:p}=await e.from(t).select(a).gte(g,s).lt(g,i);if(!p)return{data:h||[],error:null};if(!k(p))return{data:[],error:p}}const{data:n,error:r}=await e.from(t).select(a);if(r)return{data:[],error:r};const c=new Date(s),l=new Date(i);return{data:(n||[]).filter(g=>{const h=G(g,o);return h?h>=c&&h<l:!1}),error:null}}function Se(e){return(e||[]).reduce((t,a)=>{const s=f(a.total_amount);if(s>0)return t+s;const i=f(a.qty),o=f(a.unit_price);return t+i*o},0)}function _e(e){return(e||[]).reduce((t,a)=>{const s=f(a.paid_amount);return s>0?t+s:a.is_paid?t+f(a.entry_fee):t},0)}async function T(e,t,a,s={}){const i=!!(s!=null&&s.includeRows),o=t.toISOString(),n=a.toISOString(),r=await W(e,"sales","id,total_amount,qty,unit_price,created_at",o,n,["created_at"]),c=await W(e,"check_in_logs","id,entry_fee,paid_amount,is_paid,time_in,created_at",o,n,["time_in","created_at"]),l=r.data||[],m=c.data||[],g={salesAmount:Se(r.data),logbookAmount:_e(c.data),salesCount:l.length,trafficCount:m.length,salesError:r.error,logbookError:c.error};return i&&(g.salesRows=l,g.logbookRows=m),g}window.DashboardManager={_timer:null,_lastPayload:null,bindActions(){const e=document.getElementById("dashboard-print-btn");e&&!e.dataset.bound&&(e.dataset.bound="1",e.addEventListener("click",()=>{this.preparePrintReport(),window.print()}));const t=document.getElementById("dashboard-download-btn");t&&!t.dataset.bound&&(t.dataset.bound="1",t.addEventListener("click",()=>this.downloadSnapshot())),this._printHookBound||(this._printHookBound=!0,window.addEventListener("beforeprint",()=>this.preparePrintReport()))},preparePrintReport(){const e=document.getElementById("dashboard-report-generated-at");if(!e)return;const t=new Date;e.textContent=`Generated: ${t.toLocaleString(void 0,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"})}`},toDateKey(e){const t=new Date(e);if(Number.isNaN(t.getTime()))return"";const a=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${a}-${s}-${i}`},formatHourLabel(e){const t=Number.isFinite(Number(e))?Number(e):0,a=t%12||12,s=t>=12?"PM":"AM";return`${a}:00 ${s}`},renderWeekChart(e=[]){const t=document.getElementById("dashboard-week-bars"),a=document.getElementById("dashboard-week-labels"),s=document.getElementById("dashboard-week-caption");if(!t||!a)return;const i=C(new Date),o=[];for(let c=6;c>=0;c-=1){const l=new Date(i);l.setDate(i.getDate()-c);const m=this.toDateKey(l),g=(e||[]).reduce((h,p)=>{const v=G(p,["created_at","time_in"]);if(!v||this.toDateKey(v)!==m)return h;const E=f(p.total_amount);if(E>0)return h+E;const I=f(p.qty),D=f(p.unit_price),L=f(p.paid_amount);return L>0?h+L:p.is_paid?h+f(p.entry_fee):h+I*D},0);o.push({key:m,label:l.toLocaleDateString("en-US",{weekday:"short"}),total:g})}const n=Math.max(...o.map(c=>c.total),0);t.innerHTML=o.map((c,l)=>{const m=n>0?c.total/n:0;return`<div class="dashboard-week-bar" style="--bar-height:${`${Math.max(10,Math.round(m*100))}%`}; --bar-delay:${l*.06}s" title="${c.label}: ${_(c.total)}"></div>`}).join(""),a.innerHTML=o.map(c=>`<span>${u(c.label)}</span>`).join("");const r=o.reduce((c,l)=>c+l.total,0);s&&(s.textContent=r>0?`Total ${_(r)}`:"No revenue this week")},renderTopProducts(e=[],t=[]){const a=document.getElementById("dashboard-top-products");if(!a)return;const s=new Map((t||[]).map(n=>[String((n==null?void 0:n.productid)||""),String((n==null?void 0:n.name)||(n==null?void 0:n.sku)||"UNKNOWN PRODUCT")])),i=new Map;(e||[]).forEach(n=>{const r=String((n==null?void 0:n.product_id)||"unknown"),c=i.get(r)||{qty:0,amount:0},l=Math.max(1,f(n.qty)),m=f(n.total_amount)>0?f(n.total_amount):l*f(n.unit_price);c.qty+=l,c.amount+=m,i.set(r,c)});const o=Array.from(i.entries()).map(([n,r])=>({productId:n,qty:r.qty,amount:r.amount,name:s.get(n)||`PRODUCT ${n==="unknown"?"UNKNOWN":n.slice(0,8).toUpperCase()}`})).sort((n,r)=>r.amount-n.amount).slice(0,5);if(!o.length){a.innerHTML=`
          <div class="dashboard-product-row">
            <strong>No product activity yet</strong>
            <span>${_(0)}</span>
          </div>
        `;return}a.innerHTML=o.map(n=>`
            <div class="dashboard-product-row">
              <strong title="${u(n.name)}">${u(n.name)}</strong>
              <span>${_(n.amount)} | x${Math.round(n.qty)}</span>
            </div>
          `).join("")},setPeakHour(e=[]){const t=document.getElementById("dashboard-peak-hour"),a=document.getElementById("dashboard-peak-count");if(!t||!a)return;const s=new Array(24).fill(0);(e||[]).forEach(n=>{const r=G(n,["time_in","created_at"]);r&&(s[r.getHours()]+=1)});let i=-1,o=0;if(s.forEach((n,r)=>{n>o&&(o=n,i=r)}),i<0||o<1){t.textContent="N/A",a.textContent="0";return}t.textContent=this.formatHourLabel(i),a.textContent=String(o)},downloadSnapshot(){const e=this._lastPayload;if(!e){d("Dashboard report is not ready yet.","warning");return}const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=new Date().toISOString().slice(0,10),s=document.createElement("a");s.href=URL.createObjectURL(t),s.download=`dashboard-report-${a}.json`,document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(s.href),d("Dashboard report downloaded.","success")},async init(){document.getElementById("page-wrapper")&&(this.bindActions(),await this.load(),this._timer&&window.clearInterval(this._timer),this._timer=window.setInterval(()=>this.load(),45e3))},async load(){const e=document.getElementById("dashboard-total-net");if(!e)return;const t=await b();if(!t){e.textContent=_(0);return}const a=new Date,s=C(a),i=de(a),o=new Date(s);o.setDate(o.getDate()-1);const n=new Date(s);n.setDate(n.getDate()-6);const r=new Date(i),[c,l,m,g,h,p]=await Promise.all([T(t,s,i,{includeRows:!0}),T(t,o,s),t.from("members").select("member_id",{count:"exact",head:!0}),W(t,"sales","id,product_id,total_amount,qty,unit_price,created_at",n.toISOString(),r.toISOString(),["created_at"]),W(t,"check_in_logs","id,entry_fee,paid_amount,is_paid,time_in,created_at",n.toISOString(),r.toISOString(),["time_in","created_at"]),t.from("products").select("productid,name,sku").eq("is_active",!0)]),v=c.salesAmount+c.logbookAmount,E=l.salesAmount+l.logbookAmount,I=E>0?(v-E)/E*100:0,D=document.getElementById("dashboard-vs-yesterday"),L=document.getElementById("dashboard-products-total"),O=document.getElementById("dashboard-log-fees-total"),K=document.getElementById("dashboard-active-members"),Q=document.getElementById("dashboard-floor-traffic"),$=document.getElementById("dashboard-sales-income"),q=document.getElementById("dashboard-logbook-income"),J=document.getElementById("dashboard-sales-count"),X=document.getElementById("dashboard-logbook-count"),Z=document.getElementById("dashboard-peak-window");if(e.textContent=_(v),L&&(L.textContent=_(c.salesAmount)),O&&(O.textContent=_(c.logbookAmount)),$&&($.textContent=_(c.salesAmount)),q&&(q.textContent=_(c.logbookAmount)),J&&(J.textContent=String(c.salesCount||0)),X&&(X.textContent=String(c.trafficCount||0)),K&&(K.textContent=String(f(m.count||0))),Q&&(Q.textContent=`${c.trafficCount}/30`),Z&&(Z.textContent="Today (check-ins)"),D){const M=Math.abs(I).toFixed(1),P=I>=0,te=P?"bx-trending-up":"bx-trending-down",w=P?"#22c55e":"var(--accent-red)";let S=`${M}% VS YESTERDAY`;E<=0&&v>0?S="NEW REVENUE ACTIVITY TODAY":S=`${M}% VS YESTERDAY`,D.innerHTML=`<i id="dashboard-trend-icon" class="bx ${te}" style="color:${w}"></i> ${u(S)}`}const ee=[...g.data||[],...h.data||[]];this.renderWeekChart(ee),this.setPeakHour(c.logbookRows||[]),this.renderTopProducts(c.salesRows||[],p.data||[]),this._lastPayload={generated_at:new Date().toISOString(),summary:{total_income_today:v,sales_income_today:c.salesAmount,logbook_income_today:c.logbookAmount,sales_transactions_today:c.salesCount,logbook_entries_today:c.trafficCount,members_total:f(m.count||0),delta_vs_yesterday_percent:Number(I.toFixed(2))},week_income_rows:ee,today_sales_rows:c.salesRows||[],today_logbook_rows:c.logbookRows||[]}}},window.GoalCenterManager={useLocalCache:!1,customRangePicker:null,toIsoDate(e){const t=new Date(e);if(Number.isNaN(t.getTime()))return"";const a=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${a}-${s}-${i}`},formatShortDate(e){const t=new Date(e);return Number.isNaN(t.getTime())?"-- ---":t.toLocaleDateString("en-US",{day:"2-digit",month:"short"})},syncCustomRangeDisplay(e,t){const a=document.getElementById("goal-custom-range-display");a&&(a.textContent=`${this.formatShortDate(e)} -> ${this.formatShortDate(t)}`)},initCustomRangePicker(){const e=document.getElementById("goal-custom-start-input"),t=document.getElementById("goal-custom-end-input"),a=document.getElementById("goal-custom-range-input"),s=document.getElementById("goal-custom-range-trigger");if(!e||!t||!a||!s||typeof flatpickr!="function")return;if(this.customRangePicker&&typeof this.customRangePicker.destroy=="function")try{this.customRangePicker.destroy()}catch(n){}const i=this.getCustomConfig();e.value=i.start_date,t.value=i.end_date;const o=flatpickr(a,{mode:"range",dateFormat:"Y-m-d",disableMobile:!0,clickOpens:!1,defaultDate:[i.start_date,i.end_date],positionElement:s,position:"below",onReady:(n,r,c)=>{const l=c.calendarContainer;l.classList.remove("wolf-calendar-v2","wolf-calendar-v3"),l.classList.add("wolf-calendar"),l.classList.remove("open")},onOpen:(n,r,c)=>{requestAnimationFrame(()=>{c.calendarContainer.classList.add("open")})},onClose:(n,r,c)=>{c.calendarContainer.classList.remove("open")},onChange:n=>{if(!Array.isArray(n)||n.length<1)return;const r=this.toIsoDate(n[0]),c=this.toIsoDate(n[1]||n[0]);!r||!c||(e.value=r,t.value=c,this.syncCustomRangeDisplay(r,c))}});this.customRangePicker=Array.isArray(o)?o[0]:o,s.onclick=n=>{n.preventDefault(),n.stopPropagation(),this.customRangePicker&&(this.customRangePicker.isOpen?this.customRangePicker.close():this.customRangePicker.open())}},getCustomConfig(){const t=C(new Date),a=new Date(t);a.setDate(a.getDate()-14);try{const s=window.localStorage.getItem(ge),i=s?JSON.parse(s):{},o=f(i==null?void 0:i.target_amount),n=String((i==null?void 0:i.start_date)||a.toISOString().slice(0,10)),r=String((i==null?void 0:i.end_date)||t.toISOString().slice(0,10));return{target_amount:o>0?o:5e4,start_date:n,end_date:r}}catch(s){return{target_amount:5e4,start_date:a.toISOString().slice(0,10),end_date:t.toISOString().slice(0,10)}}},setCustomConfig(e={}){const t=new Date().toISOString().slice(0,10),a=String(e.start_date||t),s=String(e.end_date||t),i={target_amount:Math.max(1,f(e.target_amount)),start_date:a,end_date:s};try{window.localStorage.setItem(ge,JSON.stringify(i))}catch(o){}return i},pickLatestGoalRow(e){const t=Array.isArray(e)?e.slice():[];return t.length?(t.sort((a,s)=>{const i=new Date((a==null?void 0:a.start_date)||0).getTime(),o=new Date((s==null?void 0:s.start_date)||0).getTime(),n=new Date((a==null?void 0:a.created_at)||0).getTime(),r=new Date((s==null?void 0:s.created_at)||0).getTime(),c=f(a==null?void 0:a.id),l=f(s==null?void 0:s.id);return(Number.isFinite(o)?o:0)-(Number.isFinite(i)?i:0)||(Number.isFinite(r)?r:0)-(Number.isFinite(n)?n:0)||l-c}),t[0]||null):null},getLocalTargets(){const e=V(se),t=new Map;return e.forEach(a=>{a!=null&&a.period_type&&t.set(String(a.period_type).toUpperCase(),f(a.target_amount))}),t},setLocalTarget(e,t){const a=V(se).filter(s=>String(s.period_type||"").toUpperCase()!==e);a.push({id:`local-${e}-${Date.now()}`,period_type:e,target_amount:f(t),start_date:new Date().toISOString().slice(0,10)}),ce(se,a)},async init(){const e=document.getElementById("goal-center-page");if(!e||e.dataset.boundGoalCenter==="1"){await this.load();return}e.dataset.boundGoalCenter="1",e.addEventListener("click",async t=>{if(t.target.closest("#goal-custom-range-trigger")){this.customRangePicker&&(this.customRangePicker.isOpen?this.customRangePicker.close():this.customRangePicker.open());return}const a=t.target.closest("#goal-daily-save, #goal-weekly-save, #goal-monthly-save, #goal-quarterly-save, #goal-yearly-save, #goal-custom-save");if(!a)return;const s=a.id.includes("daily")?"DAILY":a.id.includes("weekly")?"WEEKLY":a.id.includes("monthly")?"MONTHLY":a.id.includes("quarterly")?"QUARTERLY":a.id.includes("yearly")?"YEARLY":"CUSTOM";await this.save(s)}),await this.load(),this.initCustomRangePicker()},getInput(e){const t=`goal-${e.toLowerCase()}-input`;return document.getElementById(t)},async save(e){if(e==="CUSTOM"){const n=document.getElementById("goal-custom-input"),r=document.getElementById("goal-custom-start-input"),c=document.getElementById("goal-custom-end-input"),l=f(n==null?void 0:n.value),m=String((r==null?void 0:r.value)||"").trim(),g=String((c==null?void 0:c.value)||"").trim();if(l<=0){d("Custom target must be greater than zero.","error");return}if(!m||!g){d("Custom start and end dates are required.","error");return}if(new Date(m).getTime()>new Date(g).getTime()){d("Custom start date cannot be after end date.","error");return}this.setCustomConfig({target_amount:l,start_date:m,end_date:g}),await this.load(),d("Custom target saved.","success");return}if(e==="QUARTERLY"||e==="YEARLY"){const n=this.getInput(e);if(!n)return;const r=f(n.value);if(r<=0){d("Target must be greater than zero.","error");return}this.setLocalTarget(e,r),await this.load(),d(`${e} target saved.`,"success");return}const t=this.getInput(e);if(!t)return;const a=f(t.value);if(a<=0){d("Target must be greater than zero.","error");return}const s=await b();if(!s||this.useLocalCache){this.setLocalTarget(e,a),await this.load(),d("Target saved locally.","success");return}const i={period_type:e,target_amount:a,start_date:new Date().toISOString().slice(0,10)};let{error:o}=await s.from("goal_target").upsert(i,{onConflict:"period_type"});if(o&&k(o)&&({error:o}=await s.from("goal_target").upsert({period_type:e,target_amount:a},{onConflict:"period_type"})),o){const n=await s.from("goal_target").select("id,period_type,target_amount,start_date,created_at").eq("period_type",e).limit(200),r=this.pickLatestGoalRow(n.data||[]);!n.error&&(r!=null&&r.id)&&({error:o}=await s.from("goal_target").update(i).eq("id",r.id))}if(o){if(R(o)){this.useLocalCache=!0,this.setLocalTarget(e,a),await this.load(),d("Goal table missing. Saved locally for now.","warning");return}if(j(o)){this.useLocalCache=!0,this.setLocalTarget(e,a),await this.load(),d("Goal target blocked by RLS. Saved locally. Run docs/sql/goal_target_rls_policy.sql.","warning");return}d(`Failed to save target: ${o.message}`,"error");return}window.wolfData&&typeof window.wolfData.loadGoalTargets=="function"&&await window.wolfData.loadGoalTargets(),await this.load(),d(`${e} target saved.`,"success")},async loadTargetsFromDatabase(e){const t=["DAILY","WEEKLY","MONTHLY"],a=new Map;for(const s of t){const{data:i,error:o}=await e.from("goal_target").select("*").eq("period_type",s).limit(200);if(o)return{error:o,map:a};const n=this.pickLatestGoalRow(i||[]);a.set(s,f(n==null?void 0:n.target_amount))}return{error:null,map:a}},async load(){if(!document.getElementById("goal-center-page"))return;const t=await b();let a=this.getLocalTargets();if(t&&!this.useLocalCache){const{error:w,map:S}=await this.loadTargetsFromDatabase(t);w?R(w)?this.useLocalCache=!0:j(w)?(this.useLocalCache=!0,d("Goal target read blocked by RLS. Using local cache. Run docs/sql/goal_target_rls_policy.sql.","warning")):d(`Unable to load goal targets: ${w.message}`,"error"):S.forEach((N,A)=>{a.set(String(A||"").toUpperCase(),f(N))})}const s=new Date,i=C(s),o=de(s),n=we(s),r=ye(s),c=new Date(s.getFullYear(),Math.floor(s.getMonth()/3)*3,1),l=new Date(s.getFullYear(),0,1),m=this.getCustomConfig(),g=C(new Date(m.start_date)),h=C(new Date(m.end_date)),p=de(h),[v,E,I,D,L,O]=t?await Promise.all([T(t,i,o),T(t,n,o),T(t,r,o),T(t,c,o),T(t,l,o),T(t,g,p)]):[{salesAmount:0,logbookAmount:0},{salesAmount:0,logbookAmount:0},{salesAmount:0,logbookAmount:0},{salesAmount:0,logbookAmount:0},{salesAmount:0,logbookAmount:0},{salesAmount:0,logbookAmount:0}],K={DAILY:v.salesAmount+v.logbookAmount,WEEKLY:E.salesAmount+E.logbookAmount,MONTHLY:I.salesAmount+I.logbookAmount},Q={QUARTERLY:D.salesAmount+D.logbookAmount,YEARLY:L.salesAmount+L.logbookAmount,CUSTOM:O.salesAmount+O.logbookAmount};["DAILY","WEEKLY","MONTHLY"].forEach(w=>{const S=f(a.get(w)),N=f(K[w]),A=S>0?Math.min(100,Math.round(N/S*100)):0,B=document.getElementById(`goal-${w.toLowerCase()}-amount`),F=document.getElementById(`goal-${w.toLowerCase()}-progress`),Y=document.getElementById(`goal-${w.toLowerCase()}-window`),x=this.getInput(w);B&&(B.textContent=_(S)),F&&(F.style.width=`${A}%`),x&&!x.value&&(x.value=S>0?String(S):""),Y&&(Y.textContent=`ACTUAL ${_(N)} | ${A}% OF TARGET`)});const $=f(a.get("MONTHLY")),q=f(a.get("WEEKLY")),J=f(a.get("QUARTERLY"))||($>0?$*3:q*13),X=f(a.get("YEARLY"))||($>0?$*12:q*52),Z=f(m.target_amount),ee={QUARTERLY:f(J),YEARLY:f(X),CUSTOM:f(Z)};["QUARTERLY","YEARLY","CUSTOM"].forEach(w=>{const S=f(ee[w]),N=f(Q[w]),A=S>0?Math.min(100,Math.round(N/S*100)):0,B=w.toLowerCase(),F=document.getElementById(`goal-${B}-amount`),Y=document.getElementById(`goal-${B}-progress`),x=document.getElementById(`goal-${B}-window`);if(F&&(F.textContent=_(S)),Y&&(Y.style.width=`${A}%`),x)if(w==="QUARTERLY"){const ae=Math.floor(s.getMonth()/3)+1;x.textContent=`Q${ae} / ${s.getFullYear()} | ${A}% OF TARGET`}else if(w==="YEARLY")x.textContent=`${s.getFullYear()} | ${A}% OF TARGET`;else{const ae={day:"2-digit",month:"short"},ve=g.toLocaleDateString("en-US",ae),Ee=h.toLocaleDateString("en-US",ae),ke=Math.max(1,Math.round((h.getTime()-g.getTime())/864e5)+1);x.textContent=`${ke} DAYS | ${ve} -> ${Ee} | ${A}% OF TARGET`}const le=this.getInput(w);le&&!le.value&&(le.value=S>0?String(S):"")});const M=document.getElementById("goal-custom-input"),P=document.getElementById("goal-custom-start-input"),te=document.getElementById("goal-custom-end-input");M&&!M.value&&(M.value=String(m.target_amount)),P&&(P.value=String(m.start_date||"")),te&&(te.value=String(m.end_date||"")),this.syncCustomRangeDisplay(m.start_date,m.end_date),this.customRangePicker&&typeof this.customRangePicker.setDate=="function"&&this.customRangePicker.setDate([m.start_date,m.end_date],!1)}},window.EquipmentManager={useLocalCache:!1,items:[],currentPage:1,pageSize:8,getListContainer(){return document.getElementById("equip-list")},mapRowToItem(e){return{id:e.id||e.equipment_id||e.eq_id||`tmp-${Date.now()}`,equipment_code:e.equipment_code||e.code||"",name:e.name||"UNKNOWN EQUIPMENT",condition:e.condition||"GOOD",status:e.status||(e.is_active===!1?"INACTIVE":"ACTIVE"),image_url:e.image_url||"",notes:e.notes||"",created_at:e.created_at||null}},async init(){const e=document.querySelector(".equip-wrapper");e&&(e.dataset.boundEquipManager!=="1"&&(e.dataset.boundEquipManager="1",e.addEventListener("click",async t=>{if(t.target.closest("#equip-add-btn")){await this.openEditor();return}const s=t.target.closest("[data-equip-action]"),i=t.target.closest("[data-equip-page]");if(i){const c=Number(i.getAttribute("data-equip-page"));Number.isFinite(c)&&c>0&&(this.currentPage=c,this.render());return}if(!s)return;const o=s.getAttribute("data-equip-id"),n=s.getAttribute("data-equip-action"),r=this.items.find(c=>String(c.id)===String(o));r&&(n==="edit"&&await this.openEditor(r),n==="delete"&&await this.remove(r))})),await this.load())},loadLocalItems(){this.items=V(ue).map(e=>this.mapRowToItem(e))},saveLocalItems(){ce(ue,this.items)},async load(){if(!this.getListContainer())return;const t=await b();if(!t||this.useLocalCache){this.loadLocalItems(),this.render();return}const{data:a,error:s}=await t.from("equipments").select("*").order("created_at",{ascending:!1});if(s){if(R(s)){this.useLocalCache=!0,this.loadLocalItems(),this.render(),d("Equipments table not found. Using local cache mode.","warning");return}d(`Failed to load equipments: ${s.message}`,"error");return}this.items=(a||[]).map(i=>this.mapRowToItem(i)),this.render()},render(){const e=this.getListContainer();if(!e)return;if(!this.items.length){e.innerHTML=`
          <div class="equip-card" style="justify-content:center;">
            <div class="equip-sub">NO EQUIPMENT RECORDS YET. TAP + TO ADD.</div>
          </div>
        `;return}const t=this.items.length,a=Math.max(1,Math.ceil(t/this.pageSize));this.currentPage>a&&(this.currentPage=a);const s=(this.currentPage-1)*this.pageSize,o=this.items.slice(s,s+this.pageSize).map(n=>{const r=String(n.status).toUpperCase()==="ACTIVE"?"#22c55e":"#f97316";return`
            <div class="equip-card">
              <div class="equip-info">
                <div class="equip-thumb">
                  <img src="${u(n.image_url||"/assets/images/placeholder.png")}" alt="${u(n.name)}" />
                </div>
                <div>
                  <div class="equip-name">${u(n.name)}</div>
                  <div class="equip-sub">${u(n.equipment_code||"UNASSIGNED")} - ${u(n.condition||"GOOD")}</div>
                  <div class="equip-status" style="color:${r};">${u(n.status||"ACTIVE")}</div>
                </div>
              </div>
              <div class="equip-actions">
                <i class="bx bx-edit" data-equip-action="edit" data-equip-id="${u(n.id)}"></i>
                <i class="bx bx-trash" data-equip-action="delete" data-equip-id="${u(n.id)}"></i>
              </div>
            </div>
          `}).join("")},async openEditor(e=null){if(!window.Swal)return;const t=!!e,a=await window.Swal.fire({title:t?"EDIT EQUIPMENT":"ADD EQUIPMENT",background:"#0d0f12",color:"#e6ebf5",showCancelButton:!0,confirmButtonText:t?"SAVE CHANGES":"ADD EQUIPMENT",html:`
          <input id="equip-name" class="swal2-input" placeholder="Equipment Name" value="${u((e==null?void 0:e.name)||"")}">
          <input id="equip-code" class="swal2-input" placeholder="Code (e.g. EQ-101)" value="${u((e==null?void 0:e.equipment_code)||"")}">
          <input id="equip-condition" class="swal2-input" placeholder="Condition (GOOD/NEEDS_SERVICE)" value="${u((e==null?void 0:e.condition)||"")}">
          <input id="equip-status" class="swal2-input" placeholder="Status (ACTIVE/INACTIVE)" value="${u((e==null?void 0:e.status)||"ACTIVE")}">
          <input id="equip-image" class="swal2-input" placeholder="Image URL (optional)" value="${u((e==null?void 0:e.image_url)||"")}">
          <textarea id="equip-notes" class="swal2-textarea" placeholder="Notes">${u((e==null?void 0:e.notes)||"")}</textarea>
        `,preConfirm:()=>{var i,o,n,r,c,l,m,g,h,p,v,E;const s=(o=(i=document.getElementById("equip-name"))==null?void 0:i.value)==null?void 0:o.trim();return s?{name:s,equipment_code:((r=(n=document.getElementById("equip-code"))==null?void 0:n.value)==null?void 0:r.trim().toUpperCase())||null,condition:((l=(c=document.getElementById("equip-condition"))==null?void 0:c.value)==null?void 0:l.trim().toUpperCase())||"GOOD",status:((g=(m=document.getElementById("equip-status"))==null?void 0:m.value)==null?void 0:g.trim().toUpperCase())||"ACTIVE",image_url:((p=(h=document.getElementById("equip-image"))==null?void 0:h.value)==null?void 0:p.trim())||null,notes:((E=(v=document.getElementById("equip-notes"))==null?void 0:v.value)==null?void 0:E.trim())||null}:(window.Swal.showValidationMessage("Equipment name is required."),null)}});!a.isConfirmed||!a.value||(t?await this.update(e,a.value):await this.create(a.value))},async create(e){const t=await b();if(!t||this.useLocalCache){this.items.unshift({id:`local-eq-${Date.now()}`,...e,created_at:new Date().toISOString()}),this.saveLocalItems(),this.render(),d("Equipment added (local cache).","success");return}const{data:a,error:s}=await t.from("equipments").insert(e).select("*").single();if(s){if(R(s)){this.useLocalCache=!0,await this.create(e),d("Equipments table missing. Stored locally.","warning");return}d(`Add equipment failed: ${s.message}`,"error");return}this.items.unshift(this.mapRowToItem(a||e)),this.render(),d("Equipment added.","success")},async update(e,t){const a=await b();if(!a||this.useLocalCache){this.items=this.items.map(i=>String(i.id)===String(e.id)?{...i,...t}:i),this.saveLocalItems(),this.render(),d("Equipment updated (local cache).","success");return}let s=await a.from("equipments").update(t).eq("id",e.id).select("*").maybeSingle();if(s.error&&k(s.error)&&(s=await a.from("equipments").update(t).eq("equipment_id",e.id).select("*").maybeSingle()),s.error){d(`Update failed: ${s.error.message}`,"error");return}this.items=this.items.map(i=>String(i.id)===String(e.id)?this.mapRowToItem(s.data||{...i,...t}):i),this.render(),d("Equipment updated.","success")},async remove(e){if(!y().canHardDelete){d("Only admin can hard delete records.","warning");return}if(!window.Swal)return;const{isConfirmed:a}=await window.Swal.fire({title:"DELETE EQUIPMENT?",text:`${e.name} will be removed from the equipment list.`,icon:"warning",showCancelButton:!0,confirmButtonText:"DELETE",background:"#0d0f12",color:"#e6ebf5"});if(!a)return;const s=await b();if(!s||this.useLocalCache){this.items=this.items.filter(o=>String(o.id)!==String(e.id)),this.saveLocalItems(),this.render(),d("Equipment deleted (local cache).","success");return}let i=await s.from("equipments").delete().eq("id",e.id);if(i.error&&k(i.error)&&(i=await s.from("equipments").delete().eq("equipment_id",e.id)),i.error){d(`Delete failed: ${i.error.message}`,"error");return}this.items=this.items.filter(o=>String(o.id)!==String(e.id)),this.render(),d("Equipment removed.","success")}},window.FeedbackManager={entries:[],useLocalCache:!1,access:y(),tagOptionsCache:[],tagMetaLookup:new Map,composeOpen:!1,composeTags:[],composeSearchTerm:"",composeMessage:"",composeLoadingTags:!1,currentPage:1,pageSize:6,autoDeleteWarned:!1,expandedEntryIds:new Set,getListContainer(){return document.getElementById("feedback-list")},mapRowToEntry(e){return{id:e.id||e.feedback_id||`local-feedback-${Date.now()}`,author_name:e.author_name||"SYSTEM USER",author_role:e.author_role||"STAFF",message:e.message||"",tagged_assets:Array.isArray(e.tagged_assets)?e.tagged_assets:typeof e.tagged_assets=="string"?e.tagged_assets.split(",").map(t=>t.trim()).filter(Boolean):[],is_read:!!e.is_read,created_at:e.created_at||new Date().toISOString()}},async init(){const e=document.getElementById("feedback-page");e&&(this.access=y(),e.dataset.boundFeedbackManager!=="1"&&(e.dataset.boundFeedbackManager="1",e.addEventListener("click",async t=>{if(t.target.closest("#feedback-add-btn")){await this.openComposeInline();return}if(t.target.closest("[data-feedback-compose-cancel]")){this.closeComposeInline();return}if(t.target.closest("[data-feedback-compose-submit]")){await this.submitComposeInline();return}const a=t.target.closest("[data-feedback-tag-add]");if(a){this.addComposeTag(a.getAttribute("data-feedback-tag-add"));return}const s=t.target.closest("[data-feedback-toggle-id]");if(s){const g=String(s.getAttribute("data-feedback-toggle-id")||"");if(!g)return;this.expandedEntryIds.has(g)?this.expandedEntryIds.delete(g):this.expandedEntryIds.add(g),this.render();return}const i=t.target.closest("[data-feedback-tag-remove]");if(i){this.removeComposeTag(i.getAttribute("data-feedback-tag-remove"));return}const o=t.target.closest("[data-feedback-delete-id]");if(o){const g=o.getAttribute("data-feedback-delete-id"),h=this.entries.find(p=>String(p.id)===String(g));if(!h)return;await this.remove(h);return}const n=t.target.closest("[data-feedback-edit-id]");if(n){const g=n.getAttribute("data-feedback-edit-id"),h=this.entries.find(p=>String(p.id)===String(g));if(!h)return;await this.editEntry(h);return}const r=t.target.closest("[data-feedback-page]");if(r){const g=Number(r.getAttribute("data-feedback-page"));Number.isFinite(g)&&g>0&&(this.currentPage=g,this.render());return}const c=t.target.closest("[data-feedback-read-id]");if(!c)return;const l=c.getAttribute("data-feedback-read-id"),m=this.entries.find(g=>String(g.id)===String(l));m&&await this.toggleRead(m)}),e.addEventListener("input",t=>{if(t.target.id==="feedback-compose-search"){this.composeSearchTerm=t.target.value||"",this.refreshComposeUi();return}t.target.id==="feedback-compose-message"&&(this.composeMessage=t.target.value||"")}),e.addEventListener("keydown",t=>{const a=t.target.closest(".feedback-row-summary[data-feedback-toggle-id]");if(!a||t.key!=="Enter"&&t.key!==" ")return;t.preventDefault();const s=String(a.getAttribute("data-feedback-toggle-id")||"");s&&(this.expandedEntryIds.has(s)?this.expandedEntryIds.delete(s):this.expandedEntryIds.add(s),this.render())})),await this.load())},loadLocalEntries(){this.entries=V(me).map(e=>this.mapRowToEntry(e))},saveLocalEntries(){ce(me,this.entries)},async load(){if(!this.getListContainer())return;this.expandedEntryIds=new Set;const t=await b();if(!t||this.useLocalCache){this.loadLocalEntries(),await this.autoDeleteExpiredReadEntries(),this.currentPage=1,this.render(),await this.hydrateTagMetadata(),this.render();return}const{data:a,error:s}=await t.from("feedback_entries").select("*").order("created_at",{ascending:!1});if(s){if(R(s)){this.useLocalCache=!0,this.loadLocalEntries(),this.render(),d("Feedback table missing. Using local cache mode.","warning");return}d(`Unable to load feedback: ${s.message}`,"error");return}this.entries=(a||[]).map(i=>this.mapRowToEntry(i)),await this.autoDeleteExpiredReadEntries(),this.currentPage=1,this.render(),await this.hydrateTagMetadata(),this.render()},render(){const e=this.getListContainer();if(!e)return;this.access=y();const t=document.getElementById("feedback-add-btn");t&&(t.style.display=this.access.isStaff?"":"none");const a=this.renderComposeCard(),s=this.renderAdminNote(),i=this.renderStaffCaution(),o=this.entries.length,n=Math.max(1,Math.ceil(o/this.pageSize));this.currentPage>n&&(this.currentPage=n);const r=(this.currentPage-1)*this.pageSize,c=this.entries.slice(r,r+this.pageSize),l=c.length?(()=>{const g=c.filter(p=>!p.is_read),h=c.filter(p=>p.is_read);return`
            ${this.renderFeedbackSection("Unread",g,"is-unread")}
            ${this.renderFeedbackSection("Read",h,"is-read")}
          `})():`
          <div class="feedback-empty-state">
            <div class="feedback-empty-hero" aria-hidden="true">
              <i class="bx bxs-badge-check"></i>
            </div>
            <div class="feedback-empty-title">You're all good, no caused troubles so far.</div>
            <div class="feedback-empty-note">
              Guide: Staff can file operational issues by tagging members, products, or equipment.
              Reports are tracked here for admin review and follow-up.
            </div>
          </div>
        `,m=this.renderPagination(o,n);e.innerHTML=`${a}${s}${i}${l}${m}`},renderFeedbackSection(e,t,a=""){const s=a?` ${a}`:"",i=t.length?t.map(o=>this.renderFeedbackCard(o)).join(""):`<div class="feedback-section-empty">No ${u(e.toLowerCase())} feedback on this page.</div>`;return`
        <section class="feedback-section${s}">
          <div class="feedback-section-head">
            <h3 class="feedback-section-title">${u(e)}</h3>
            <span class="feedback-section-count">${t.length}</span>
          </div>
          <div class="feedback-section-list">
            ${i}
          </div>
        </section>
      `},renderFeedbackCard(e){const t=String(e.id||""),a=this.expandedEntryIds.has(t),s=this.renderTaggedAssets(e.tagged_assets),i=e.is_read?"MARK UNREAD":"MARK READ",o=e.is_read?"READ":"UNREAD",n=this.access.isAdmin?`
            <button class="btn-mark-read btn-mark-read-toggle" data-feedback-read-id="${u(e.id)}">${i}</button>
          `:this.access.isStaff&&!e.is_read?`
            <button class="btn-mark-read btn-mark-read-edit" data-feedback-edit-id="${u(e.id)}">EDIT</button>
            <button class="btn-mark-read btn-mark-read-delete" data-feedback-delete-id="${u(e.id)}">DELETE</button>
          `:"",r=this.access.isAdmin?"is-single":this.access.isStaff&&!e.is_read?"is-double":"is-none";return`
        <div class="feedback-card ${e.is_read?"is-read":""} ${a?"is-expanded":"is-collapsed"}" data-feedback-id="${u(e.id)}">
          <div class="feedback-row-summary" role="button" tabindex="0" data-feedback-toggle-id="${u(e.id)}" aria-expanded="${a?"true":"false"}" aria-label="${a?"Collapse feedback details":"Expand feedback details"}">
            <div class="feedback-row-summary-copy">
              <div class="feedback-row-summary-author">${u(e.author_name)}</div>
              <div class="feedback-row-summary-preview">${u(this.getFeedbackPreview(e.message))}</div>
            </div>
            <div class="feedback-row-summary-tools">
              <span class="feedback-row-status ${e.is_read?"is-read":"is-unread"}">${o}</span>
              <button type="button" class="feedback-row-toggle" data-feedback-toggle-id="${u(e.id)}" aria-expanded="${a?"true":"false"}" aria-label="${a?"Collapse feedback details":"Expand feedback details"}">
                <i class="bx ${a?"bx-chevron-up":"bx-chevron-down"}"></i>
              </button>
            </div>
          </div>
          <div class="feedback-card-body">
          <div class="feedback-card-header">
            <div>
              <div class="feedback-author">
                <span class="feedback-author-name">${u(e.author_name)}</span>
                <span class="feedback-author-sep">-</span>
                <span class="feedback-author-role">${u(e.author_role)}</span>
              </div>
              <div class="feedback-meta">${H(e.created_at)}</div>
            </div>
            <div class="feedback-card-actions ${r}">${n}</div>
          </div>
          <div class="tagged-label">TAGGED ASSETS</div>
          ${s}
          <div class="feedback-text">"${u(e.message)}"</div>
          </div>
        </div>
      `},getFeedbackPreview(e){const t=String(e||"").trim().replace(/\s+/g," ");return t?t.length<=54?t:`${t.slice(0,51)}...`:"No feedback details"},renderAdminNote(){return this.access.isAdmin?`
        <div class="feedback-admin-note">
          <div class="feedback-admin-note-title">Admin Note</div>
          <div class="feedback-admin-note-copy">
            Feedback submission is staff-only to preserve operational accountability.
            Admin can only review and mark read/unread. Staff can edit/delete while unread.
          </div>
        </div>
      `:""},renderStaffCaution(){return this.access.isStaff?`
        <div class="feedback-staff-note">
          <div class="feedback-staff-note-title">Staff Caution</div>
          <div class="feedback-staff-note-copy">
            Write only factual incidents.
            Tag related assets so admins can verify quickly.
            You can edit or delete only while status is UNREAD.
          </div>
        </div>
      `:""},getAutoDeleteCutoffIso(){return new Date(Date.now()-2592e6).toISOString()},async autoDeleteExpiredReadEntries(){const e=this.getAutoDeleteCutoffIso();if(!this.entries.filter(i=>{if(!i.is_read||!i.created_at)return!1;const o=new Date(i.created_at).getTime();return Number.isFinite(o)?o<=new Date(e).getTime():!1}).length)return;const a=await b();if(!a||this.useLocalCache){this.entries=this.entries.filter(i=>{if(!i.is_read||!i.created_at)return!0;const o=new Date(i.created_at).getTime();return Number.isFinite(o)?o>new Date(e).getTime():!0}),this.saveLocalEntries();return}const s=await a.from("feedback_entries").delete().eq("is_read",!0).lt("created_at",e);if(s.error){if(j(s.error)){this.autoDeleteWarned||(d("30-day auto-delete blocked by RLS. Run docs/sql/feedback_entries_rls_policy.sql.","warning"),this.autoDeleteWarned=!0);return}return}this.entries=this.entries.filter(i=>{if(!i.is_read||!i.created_at)return!0;const o=new Date(i.created_at).getTime();return Number.isFinite(o)?o>new Date(e).getTime():!0})},renderPagination(e,t){if(e<=this.pageSize)return"";const a=this.currentPage<=1,s=this.currentPage>=t;return`
        <div class="feedback-pagination">
          <button class="feedback-page-btn" data-feedback-page="${this.currentPage-1}" ${a?"disabled":""}>
            <i class="bx bx-chevron-left"></i>
          </button>
          <span class="feedback-page-info">Page ${this.currentPage} of ${t}</span>
          <button class="feedback-page-btn" data-feedback-page="${this.currentPage+1}" ${s?"disabled":""}>
            <i class="bx bx-chevron-right"></i>
          </button>
        </div>
      `},async hydrateTagMetadata(){const e=await this.loadTagOptions(),t=new Map;(e||[]).forEach(a=>{const s=this.normalizeTagValue(a.value);s&&t.set(s,a)}),this.tagMetaLookup=t},getFallbackTagType(e){const t=this.normalizeTagValue(e);return/^PR-/.test(t)?"PRODUCT":/^ME-/.test(t)?"MEMBER":/^EQ-/.test(t)?"EQUIPMENT":"ASSET"},getTagTypeIcon(e){return e==="PRODUCT"?"bx-package":e==="MEMBER"?"bx-user":e==="EQUIPMENT"?"bx-dumbbell":"bx-tag"},resolveTagMetadata(e){const t=this.normalizeTagValue(e),a=this.tagMetaLookup.get(t);if(a)return{value:t,title:a.title||t,subtitle:a.subtitle||t,detail:a.detail||"",type:a.type||this.getFallbackTagType(t),image_url:a.image_url||""};const s=this.getFallbackTagType(t);return{value:t,title:t,subtitle:`${t} - ${s}`,detail:"",type:s,image_url:""}},renderTaggedAssets(e=[]){const t=Array.isArray(e)?e:[];return t.length?`
        <div class="feedback-tag-list">
          ${t.map(a=>{const s=this.resolveTagMetadata(a),i=s.image_url?`<div class="feedback-tag-media"><img src="${u(s.image_url)}" alt="${u(s.title)}"></div>`:`<div class="feedback-tag-media is-icon"><i class="bx ${u(this.getTagTypeIcon(s.type))}" aria-hidden="true"></i></div>`,o=s.detail?`<div class="feedback-tag-detail">${u(s.detail)}</div>`:"";return`
                <div class="feedback-tag-item">
                  ${i}
                  <div class="feedback-tag-copy">
                    <div class="feedback-tag-title">${u(s.title)}</div>
                    <div class="feedback-tag-sub">${u(s.subtitle)}</div>
                    ${o}
                  </div>
                </div>
              `}).join("")}
        </div>
      `:'<div class="feedback-tag-empty">No tagged assets</div>'},renderComposeCard(){if(!this.access.isStaff||!this.composeOpen)return"";const e=this.getComposeChipsHtml(),t=this.getComposeOptionsHtml(),a=this.getComposeCountLabel();return`
        <div class="feedback-compose-card">
          <div class="feedback-compose-head">
            <div>
              <div class="feedback-compose-title">Staff Audit Report</div>
              <div class="feedback-compose-subtitle">Tag assets and submit an official feedback report.</div>
            </div>
            <button type="button" class="feedback-compose-close" data-feedback-compose-cancel aria-label="Close report form">
              <i class="bx bx-x"></i>
            </button>
          </div>

          <div class="feedback-compose-grid">
            <div class="feedback-compose-field">
              <label class="feedback-compose-label" for="feedback-compose-search">Tag Involved Assets</label>
              <div class="feedback-compose-search-wrap">
                <input id="feedback-compose-search" class="feedback-compose-search" placeholder="Search product/member/equipment..." value="${u(this.composeSearchTerm)}" />
                <i class="bx bx-search feedback-compose-search-icon" aria-hidden="true"></i>
              </div>
              <div class="feedback-compose-options">${t}</div>
              <div class="feedback-compose-chip-row">${e}</div>
              <div class="feedback-compose-count">${u(a)}</div>
            </div>

            <div class="feedback-compose-field">
              <label class="feedback-compose-label" for="feedback-compose-message">Report Details</label>
              <textarea id="feedback-compose-message" class="feedback-compose-message" placeholder="Describe the issue or observation...">${u(this.composeMessage)}</textarea>
            </div>
          </div>

          <div class="feedback-compose-actions">
            <button type="button" class="feedback-compose-btn feedback-compose-btn-secondary" data-feedback-compose-cancel>Cancel</button>
            <button type="button" class="feedback-compose-btn feedback-compose-btn-primary" data-feedback-compose-submit>
              <i class="bx bxs-send" aria-hidden="true"></i>
              <span>Submit Official Report</span>
            </button>
          </div>
        </div>
      `},getComposeCountLabel(){return this.composeLoadingTags?"Loading asset suggestions...":`Selected tags: ${this.composeTags.length}/20`},getComposeFilteredOptions(){const e=this.normalizeTagValue(this.composeSearchTerm);return(this.tagOptionsCache||[]).filter(t=>e?this.normalizeTagValue(t.value).includes(e)||this.normalizeTagValue(t.title).includes(e)||this.normalizeTagValue(t.subtitle).includes(e)||this.normalizeTagValue(t.detail).includes(e):!0).slice(0,30)},getComposeChipsHtml(){return this.composeTags.map(e=>`
            <button type="button" class="feedback-compose-chip is-selected" data-feedback-tag-remove="${u(e)}">
              <span>${u(this.getComposeChipLabel(e))}</span>
              <i class="bx bx-x" aria-hidden="true"></i>
            </button>
          `).join("")},getComposeChipLabel(e){const t=this.normalizeTagValue(e),a=(this.tagOptionsCache||[]).find(s=>this.normalizeTagValue(s.value)===t);return(a==null?void 0:a.title)||(a==null?void 0:a.value)||t},getComposeOptionsHtml(){const e=this.getComposeFilteredOptions();return e.length?e.map(a=>{const s=this.normalizeTagValue(a.value),i=this.composeTags.includes(s),o=i||this.composeTags.length>=20,n=a.image_url?`<div class="feedback-compose-option-media"><img src="${u(a.image_url)}" alt="${u(a.title||a.value)}"></div>`:`<div class="feedback-compose-option-media is-icon"><i class="bx ${u(a.icon||"bx-tag")}" aria-hidden="true"></i></div>`,r=a.detail?`<div class="feedback-compose-option-detail">${u(a.detail)}</div>`:"";return`
            <button type="button" class="feedback-compose-option ${i?"is-selected":""}" data-feedback-tag-add="${u(s)}" ${o?"disabled":""}>
              ${n}
              <div class="feedback-compose-option-copy">
                <div class="feedback-compose-option-title">${u(a.title||a.value)}</div>
                <div class="feedback-compose-option-sub">${u(a.subtitle||"")}</div>
                ${r}
              </div>
              <i class="bx bx-plus feedback-compose-option-icon" aria-hidden="true"></i>
            </button>
          `}).join(""):'<div class="feedback-compose-empty">No matching assets found.</div>'},refreshComposeUi(){if(!this.composeOpen)return;const e=document.querySelector("#feedback-page .feedback-compose-options");e&&(e.innerHTML=this.getComposeOptionsHtml());const t=document.querySelector("#feedback-page .feedback-compose-chip-row");t&&(t.innerHTML=this.getComposeChipsHtml());const a=document.querySelector("#feedback-page .feedback-compose-count");a&&(a.textContent=this.getComposeCountLabel())},normalizeTagValue(e){return String(e||"").trim().replace(/\s+/g," ").toUpperCase()},dedupeTagOptions(e=[]){const t=new Set;return e.filter(a=>{const s=this.normalizeTagValue(a.value);return!s||t.has(s)?!1:(t.add(s),!0)})},async loadTagOptions(){const e=await b();if(!e)return this.tagOptionsCache=[],[];const t=[],a=(n,r)=>{(n||[]).forEach(c=>{const l=r(c);!l||!l.value||t.push(l)})},s=await e.from("products").select("productid,sku,name,brand,image_url,is_active").eq("is_active",!0).order("name",{ascending:!0}).limit(500);if(s.error&&k(s.error)){const n=await e.from("products").select("productid,sku,name").order("name",{ascending:!0}).limit(500);a(n.data,r=>{const c=String(r.sku||"").trim().toUpperCase(),l=String(r.name||c||"UNKNOWN PRODUCT").trim();return{value:c||l,title:l,subtitle:`${c||"N/A"} - PRODUCT`,detail:"",icon:"bx-package",type:"PRODUCT"}})}else a(s.data,n=>{const r=String(n.sku||"").trim().toUpperCase(),c=String(n.name||r||"UNKNOWN PRODUCT").trim(),l=String(n.brand||"").trim();return{value:r||c,title:c,subtitle:`${r||"N/A"} - PRODUCT`,detail:l?`Brand: ${l}`:"",image_url:String(n.image_url||"").trim()||null,icon:"bx-package",type:"PRODUCT"}});const i=await e.from("members").select("member_id,member_code,sku,full_name,membership_plan,is_active").eq("is_active",!0).order("full_name",{ascending:!0}).limit(500);if(i.error&&k(i.error)){const n=await e.from("members").select("member_id,member_code,sku,full_name").order("full_name",{ascending:!0}).limit(500);a(n.data,r=>{const c=String(r.member_code||r.sku||"").trim(),l=String(r.full_name||c||"UNKNOWN MEMBER").trim();return{value:c||l,title:l,subtitle:`${c||"N/A"} - MEMBER`,detail:"",icon:"bx-user",type:"MEMBER"}})}else a(i.data,n=>{const r=String(n.member_code||n.sku||"").trim(),c=String(n.full_name||r||"UNKNOWN MEMBER").trim(),l=String(n.membership_plan||"").trim();return{value:r||c,title:c,subtitle:`${r||"N/A"} - MEMBER`,detail:l?`Subscription: ${l}`:"",icon:"bx-user",type:"MEMBER"}});const o=await e.from("equipments").select("id,equipment_code,name,image_url,is_active").eq("is_active",!0).order("name",{ascending:!0}).limit(500);if(o.error&&k(o.error)){const n=await e.from("equipments").select("id,equipment_code,name").order("name",{ascending:!0}).limit(500);a(n.data,r=>{const c=String(r.equipment_code||"").trim(),l=String(r.name||c||"UNKNOWN EQUIPMENT").trim();return{value:c||l,title:l,subtitle:`${c||"N/A"} - EQUIPMENT`,detail:"",icon:"bx-dumbbell",type:"EQUIPMENT"}})}else a(o.data,n=>{const r=String(n.equipment_code||"").trim(),c=String(n.name||r||"UNKNOWN EQUIPMENT").trim();return{value:r||c,title:c,subtitle:`${r||"N/A"} - EQUIPMENT`,detail:"",image_url:String(n.image_url||"").trim()||null,icon:"bx-dumbbell",type:"EQUIPMENT"}});return this.tagOptionsCache=this.dedupeTagOptions(t),this.tagOptionsCache},async resolveAuthorMeta(){var a,s;const e=await b(),t=this.access.isAdmin?"ADMIN":"STAFF";if(!e)return{name:"SYSTEM USER",role:t};try{const{data:i}=await e.auth.getUser(),o=(i==null?void 0:i.user)||null,n=String((o==null?void 0:o.email)||"SYSTEM USER").trim().toUpperCase();return{name:String(((a=o==null?void 0:o.user_metadata)==null?void 0:a.display_name)||((s=o==null?void 0:o.user_metadata)==null?void 0:s.full_name)||n).trim().toUpperCase()||n,role:t}}catch(i){return{name:"SYSTEM USER",role:t}}},async openComposeInline(){if(this.access=y(),!this.access.isStaff){d("Only staff accounts can write feedback.","warning");return}this.composeOpen=!0,this.composeLoadingTags=!0,this.render(),setTimeout(()=>{const e=document.getElementById("feedback-compose-search");e&&e.focus()},0),this.tagOptionsCache=await this.loadTagOptions(),this.composeLoadingTags=!1,this.refreshComposeUi()},closeComposeInline(){this.composeOpen=!1,this.composeTags=[],this.composeSearchTerm="",this.composeMessage="",this.composeLoadingTags=!1,this.render()},addComposeTag(e){const t=this.normalizeTagValue(e);if(t&&!this.composeTags.includes(t)){if(this.composeTags.length>=20){d("Maximum of 20 tags only.","warning");return}this.composeTags.push(t),this.refreshComposeUi()}},removeComposeTag(e){const t=this.normalizeTagValue(e),a=this.composeTags.findIndex(s=>s===t);a<0||(this.composeTags.splice(a,1),this.refreshComposeUi())},async submitComposeInline(){const e=String(this.composeMessage||"").trim();if(!e){d("Report details are required.","warning");return}if(!this.composeTags.length){d("Add at least one tagged asset.","warning");return}const t=await this.resolveAuthorMeta();await this.create({tagged_assets:[...this.composeTags],message:e,author_name:t.name,author_role:t.role}),this.closeComposeInline()},async create(e){if(this.access=y(),!this.access.isStaff){d("Only staff accounts can write feedback.","warning");return}const t=Array.from(new Set((Array.isArray(e==null?void 0:e.tagged_assets)?e.tagged_assets:[]).map(n=>this.normalizeTagValue(n)).filter(Boolean))).slice(0,20),a=await b(),s={...e,tagged_assets:t,is_read:!1};if(!a||this.useLocalCache){this.entries.unshift({id:`local-feedback-${Date.now()}`,...s,created_at:new Date().toISOString()}),this.saveLocalEntries(),this.render(),d("Feedback saved locally.","success");return}const{data:i,error:o}=await a.from("feedback_entries").insert(s).select("*").single();if(o){if(R(o)){this.useLocalCache=!0,await this.create(e),d("Feedback table missing. Saved locally instead.","warning");return}if(j(o)){d("Feedback blocked by RLS. Run docs/sql/feedback_entries_rls_policy.sql.","warning");return}d(`Failed to save feedback: ${o.message}`,"error");return}this.entries.unshift(this.mapRowToEntry(i||s)),this.render(),d("Feedback saved.","success")},async toggleRead(e){if(this.access=y(),!this.access.isAdmin){d("Only admin accounts can mark feedback status.","warning");return}const t=!e.is_read,a=await b();if(!a||this.useLocalCache){this.entries=this.entries.map(i=>String(i.id)===String(e.id)?{...i,is_read:t}:i),this.saveLocalEntries(),this.render();return}let s=await a.from("feedback_entries").update({is_read:t}).eq("id",e.id).select("*").maybeSingle();if(s.error&&k(s.error)&&(s=await a.from("feedback_entries").update({is_read:t}).eq("feedback_id",e.id).select("*").maybeSingle()),s.error){d(`Failed to update feedback status: ${s.error.message}`,"error");return}this.entries=this.entries.map(i=>String(i.id)===String(e.id)?this.mapRowToEntry(s.data||{...i,is_read:t}):i),this.render()},async remove(e){if(this.access=y(),!this.access.isStaff){d("Only staff accounts can delete feedback.","warning");return}if(e.is_read){d("Read entries are locked and cannot be deleted manually.","warning");return}if(!window.Swal||!(await window.Swal.fire({title:"DELETE FEEDBACK ENTRY?",text:"Use delete only for miswritten staff reports. This action cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonText:"DELETE ENTRY",background:"#0d0f12",color:"#e6ebf5"})).isConfirmed)return;const a=await b();if(!a||this.useLocalCache){this.entries=this.entries.filter(i=>String(i.id)!==String(e.id)),this.saveLocalEntries(),this.render(),d("Feedback deleted (local cache).","success");return}let s=await a.from("feedback_entries").delete().eq("id",e.id);if(s.error&&k(s.error)&&(s=await a.from("feedback_entries").delete().eq("feedback_id",e.id)),s.error){d(`Failed to delete feedback: ${s.error.message}`,"error");return}this.entries=this.entries.filter(i=>String(i.id)!==String(e.id)),this.render(),d("Feedback deleted.","success")},async editEntry(e){if(this.access=y(),!this.access.isStaff){d("Only staff accounts can edit feedback.","warning");return}if(e.is_read){d("Read entries are locked and cannot be edited.","warning");return}if(!window.Swal||!(await window.Swal.fire({title:"EDIT FEEDBACK ENTRY",text:"Use edit only when staff report is miswritten. Keep the original context intact.",icon:"warning",showCancelButton:!0,confirmButtonText:"CONTINUE",background:"#0d0f12",color:"#e6ebf5"})).isConfirmed)return;const a=await window.Swal.fire({title:"UPDATE FEEDBACK",background:"#0d0f12",color:"#e6ebf5",showCancelButton:!0,confirmButtonText:"SAVE CHANGES",html:`
          <textarea id="feedback-edit-message" class="swal2-textarea" style="margin:0; min-height:140px;" placeholder="Update report details...">${u(e.message||"")}</textarea>
        `,preConfirm:()=>{var r,c;const n=(c=(r=document.getElementById("feedback-edit-message"))==null?void 0:r.value)==null?void 0:c.trim();return n?{message:n}:(window.Swal.showValidationMessage("Report details are required."),null)}});if(!a.isConfirmed||!a.value)return;const s=await b(),i={message:a.value.message};if(!s||this.useLocalCache){this.entries=this.entries.map(n=>String(n.id)===String(e.id)?{...n,...i}:n),this.saveLocalEntries(),this.render(),d("Feedback updated (local cache).","success");return}let o=await s.from("feedback_entries").update(i).eq("id",e.id).select("*").maybeSingle();if(o.error&&k(o.error)&&(o=await s.from("feedback_entries").update(i).eq("feedback_id",e.id).select("*").maybeSingle()),o.error){d(`Failed to edit feedback: ${o.error.message}`,"error");return}this.entries=this.entries.map(n=>String(n.id)===String(e.id)?this.mapRowToEntry(o.data||{...n,...i}):n),this.render(),d("Feedback updated.","success")}},window.IdMakerManager={members:[],selected:null,async init(){const e=document.querySelector(".id-maker-wrapper");e&&(e.dataset.boundIdMaker!=="1"&&(e.dataset.boundIdMaker="1",e.addEventListener("input",t=>{if(t.target.id==="id-member-search"){this.handleMemberSearch(t.target.value);return}if(t.target.id==="id-contact"){this.updatePreview({contact_number:t.target.value.trim()});return}if(t.target.id==="id-status"){this.updatePreview({membership_status:t.target.value.trim().toUpperCase()});return}t.target.id==="id-tier"&&this.updatePreview({membership_plan:t.target.value.trim()})}),e.addEventListener("click",t=>{t.target.closest("#id-save-asset-btn")&&this.downloadCardPayload(),t.target.closest("#id-print-card-btn")&&this.printCard()})),await this.loadMembers(),this.autoSelectPendingMember())},async loadMembers(){const e=await b();if(!e)return;let t=await e.from("members").select("*").order("full_name",{ascending:!0});if(t.error){d(`Unable to load members for ID maker: ${t.error.message}`,"error");return}this.members=(t.data||[]).map(s=>({...s,member_code:String(s.member_code||s.sku||s.member_id||"").trim().toUpperCase()}));const a=document.getElementById("id-member-options");a&&(a.innerHTML=this.members.map(s=>`<option value="${u(s.full_name)}">${u(s.member_code)}</option>`).join(""))},autoSelectPendingMember(){const e=window.WOLF_PENDING_MEMBER_ID;if(!e)return;window.WOLF_PENDING_MEMBER_ID=null;const t=this.members.find(a=>String(a.member_id)===String(e));if(t){const a=document.getElementById("id-member-search");a&&(a.value=t.full_name||""),this.selectMember(t)}},handleMemberSearch(e){const t=String(e||"").trim().toLowerCase();if(!t)return;const a=this.members.find(s=>String(s.full_name||"").toLowerCase()===t||String(s.member_code||"").toLowerCase()===t||String(s.email_address||"").toLowerCase()===t);a&&this.selectMember(a)},selectMember(e){this.selected={...e,membership_status:String(e.membership_status||"ACTIVE").toUpperCase()||"ACTIVE",membership_plan:e.membership_plan||"STANDARD MEMBERSHIP"};const t=document.getElementById("id-contact"),a=document.getElementById("id-status"),s=document.getElementById("id-tier");t&&(t.value=e.contact_number||""),a&&(a.value=this.selected.membership_status),s&&(s.value=this.selected.membership_plan),this.updatePreview()},updatePreview(e=null){if(!this.selected)return;e&&typeof e=="object"&&(this.selected={...this.selected,...e});const t=document.getElementById("id-preview-name"),a=document.getElementById("id-preview-code"),s=document.getElementById("id-preview-date"),i=document.getElementById("id-preview-tier"),o=document.getElementById("id-preview-status"),n=document.getElementById("id-preview-badge"),r=document.getElementById("id-preview-qr");if(t&&(t.textContent=this.selected.full_name||"N/A"),a&&(a.textContent=this.selected.member_code||this.selected.member_id||"N/A"),s&&(s.textContent=he(new Date)),i&&(i.textContent=this.selected.membership_plan||"N/A"),o&&(o.textContent=this.selected.membership_status||"ACTIVE"),n&&(n.textContent=`${this.selected.membership_status||"ACTIVE"} STATUS`),r){const c=encodeURIComponent(`${this.selected.member_code||this.selected.member_id}|${this.selected.full_name||""}`);r.src=`https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${c}`}},buildCardPayload(){return this.selected?{exported_at:new Date().toISOString(),member_id:this.selected.member_id||null,member_code:this.selected.member_code||null,full_name:this.selected.full_name||"",contact_number:this.selected.contact_number||"",membership_status:this.selected.membership_status||"ACTIVE",membership_plan:this.selected.membership_plan||""}:null},downloadCardPayload(){const e=this.buildCardPayload();if(!e){d("Select a member first before saving.","warning");return}const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(t),a.download=`${e.member_code||"member"}-id-card.json`,document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(a.href),d("ID payload exported.","success")},printCard(){var s;const e=this.buildCardPayload();if(!e){d("Select a member first before printing.","warning");return}const t=((s=document.getElementById("id-preview-qr"))==null?void 0:s.src)||"",a=window.open("","_blank","width=620,height=860");a&&(a.document.write(`
        <html>
          <head>
            <title>Print ID Card</title>
            <style>
              body { font-family: Arial, sans-serif; background:#0e1014; color:#f4f6f9; display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0; }
              .card { width:340px; border-radius:18px; border:1px solid #2c3546; padding:20px; background:linear-gradient(160deg,#0f1218,#141b25); }
              .brand { font-size:20px; font-weight:900; letter-spacing:1px; margin-bottom:14px; }
              .row { margin:8px 0; font-size:13px; }
              .label { color:#8fa2c8; font-size:11px; text-transform:uppercase; letter-spacing:1px; }
              .value { font-weight:700; }
              img { width:160px; height:160px; background:#fff; border-radius:12px; display:block; margin:14px auto; }
            </style>
          </head>
          <body>
            <div class="card">
              <div class="brand">WOLF PALOMAR ID</div>
              <div class="row"><span class="label">Name</span><div class="value">${u(e.full_name)}</div></div>
              <div class="row"><span class="label">Member Code</span><div class="value">${u(e.member_code||"N/A")}</div></div>
              <div class="row"><span class="label">Plan</span><div class="value">${u(e.membership_plan||"N/A")}</div></div>
              <div class="row"><span class="label">Status</span><div class="value">${u(e.membership_status)}</div></div>
              <img src="${u(t)}" alt="QR code" />
              <div class="row"><span class="label">Generated</span><div class="value">${he(new Date)}</div></div>
            </div>
          </body>
        </html>
      `),a.document.close(),a.focus(),a.print())}},window.AuditManager={rows:[],async init(){const e=document.querySelector(".audit-wrapper");if(!e)return;const t=document.getElementById("audit-from-date"),a=document.getElementById("audit-to-date");if(t&&a&&!t.value&&!a.value){const s=new Date,i=new Date;i.setDate(s.getDate()-7),t.value=i.toISOString().slice(0,10),a.value=s.toISOString().slice(0,10)}e.dataset.boundAuditManager!=="1"&&(e.dataset.boundAuditManager="1",e.addEventListener("click",async s=>{s.target.closest("#audit-apply-btn")&&await this.load(),s.target.closest("#audit-refresh-btn")&&await this.load(!0),s.target.closest("#audit-export-btn")&&this.exportCsv()})),await this.load()},async load(e=!1){const t=document.getElementById("audit-log-list");if(!t)return;e&&(this.rows=[]);const a=document.getElementById("audit-from-date"),s=document.getElementById("audit-to-date"),i=a!=null&&a.value?new Date(a.value):null,o=s!=null&&s.value?new Date(s.value):null;o&&o.setHours(23,59,59,999);const n=await b();if(!n){t.innerHTML='<div class="audit-row"><div class="audit-row-meta">SUPABASE CLIENT IS NOT READY</div></div>';return}const{data:r,error:c}=await n.from("audit_log").select("*").order("created_at",{ascending:!1}).limit(300);if(c){t.innerHTML=`<div class="audit-row"><div class="audit-row-meta">FAILED TO LOAD AUDIT LOGS: ${u(c.message)}</div></div>`;return}this.rows=(r||[]).filter(l=>{const m=G(l,["created_at","updated_at","time_in"]);return!(!m||i&&m<i||o&&m>o)}),this.render()},render(){const e=document.getElementById("audit-log-list"),t=document.getElementById("audit-empty-state");if(e){if(!this.rows.length){e.innerHTML="",t&&(t.style.display="flex");return}t&&(t.style.display="none"),e.innerHTML=this.rows.map(a=>{const s=a.change_payload?JSON.stringify(a.change_payload):"{}",i=s.length>180?`${s.slice(0,177)}...`:s;return`
            <div class="audit-row">
              <div class="audit-row-top">
                <span class="audit-op">${u(a.operation||"UNKNOWN")}</span>
                <span class="audit-time">${H(a.created_at)}</span>
              </div>
              <div class="audit-row-meta">
                TABLE: ${u(a.table_name||"N/A")} - RECORD: ${u(String(a.record_id||"N/A"))}
              </div>
              <div class="audit-row-meta">
                ACTOR: ${u(String(a.changed_by||a.approved_by_email||"SYSTEM"))}
              </div>
              <div class="audit-row-payload">${u(i)}</div>
            </div>
          `}).join("")}},exportCsv(){if(!this.rows.length){d("No audit logs to export.","warning");return}const t=[["created_at","table_name","operation","record_id","changed_by"].join(",")];this.rows.forEach(i=>{t.push([i.created_at||"",i.table_name||"",i.operation||"",i.record_id||"",i.changed_by||""].map(o=>`"${String(o||"").replace(/"/g,'""')}"`).join(","))});const a=new Blob([t.join(`
`)],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(a),s.download=`audit-log-${new Date().toISOString().slice(0,10)}.csv`,document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(s.href)}},window.SettingsManager={access:y(),managedAccounts:[],maxAdmins:3,currentAdmins:0,canCreateAccounts:!1,canManageAccounts:!1,async init(){const e=document.querySelector(".settings-wrapper");if(e){this.access=y(),this.applySavedState(),await this.hydrateProfile(),this.applyAccessPolicy(),e.dataset.boundSettingsManager!=="1"&&(e.dataset.boundSettingsManager="1",e.addEventListener("click",async t=>{const a=t.target.closest("[data-settings-tab-btn]");if(a){this.setActiveTab(a.getAttribute("data-settings-tab"));return}const s=t.target.closest("[data-setting-toggle]");if(s){this.toggleSetting(s.getAttribute("data-setting-toggle"));return}if(t.target.closest("#settings-update-btn")){await this.updateAccount();return}if(t.target.closest("#settings-reset-btn")){await this.resetToDefaults();return}if(t.target.closest("#settings-logout-btn")){typeof window.handleLogout=="function"&&window.handleLogout();return}if(t.target.closest("#settings-export-btn")){await this.exportBackup();return}if(t.target.closest("#settings-restore-btn")){await this.restoreBackup();return}if(t.target.closest("#settings-create-user-btn")){await this.createManagedUser();return}if(t.target.closest("#settings-refresh-users-btn")){await this.loadManagedUsers();return}const i=t.target.closest("[data-settings-user-edit-id]");if(i){const n=String(i.getAttribute("data-settings-user-edit-id")||""),r=this.managedAccounts.find(c=>String(c.id||"")===n);if(!r)return;await this.editManagedUser(r);return}const o=t.target.closest("[data-settings-user-delete-id]");if(o){const n=String(o.getAttribute("data-settings-user-delete-id")||""),r=this.managedAccounts.find(c=>String(c.id||"")===n);if(!r)return;await this.deleteManagedUser(r)}}),e.addEventListener("submit",async t=>{t.target.id==="settings-create-user-form"&&(t.preventDefault(),await this.createManagedUser())}),e.addEventListener("input",t=>{if(t.target.id==="settings-ui-scale"){const a=f(t.target.value);this.applyUiScale(a);try{window.localStorage.setItem(oe,String(a))}catch(s){}}})),this.access.isAdmin&&await this.loadManagedUsers();try{const t=String(window.localStorage.getItem("wolf_settings_open_tab")||"").trim().toLowerCase();t&&(this.setActiveTab(t),window.localStorage.removeItem("wolf_settings_open_tab"))}catch(t){}}},applySavedState(){const e=String(window.localStorage.getItem(ne)||"false")==="true",t=String(window.localStorage.getItem(ie)||"true")!=="false",a=f(window.localStorage.getItem(oe)||100);this.setToggleState("action-sounds",!e),this.setToggleState("victory-visuals",t);const s=this.applyUiScale(a||100),i=document.getElementById("settings-ui-scale");i&&(i.value=String(s))},async hydrateProfile(){var m,g;const e=await b(),t=document.getElementById("settings-profile-name"),a=document.getElementById("settings-profile-role"),s=document.getElementById("settings-profile-email"),i=document.getElementById("settings-display-name");let o=this.access.email||"",n=window.localStorage.getItem(re)||"";if(e){const{data:h}=await e.auth.getUser(),p=(h==null?void 0:h.user)||null;p!=null&&p.email&&(o=U(p.email)),n||(n=String(((m=p==null?void 0:p.user_metadata)==null?void 0:m.display_name)||((g=p==null?void 0:p.user_metadata)==null?void 0:g.full_name)||"").trim())}n||(n=o?o.split("@")[0]:"Wolf User"),this.access=y();const r=this.access.isSuperAdmin?"SUPERADMIN":this.access.isAdmin?"ADMIN":this.access.isStaff?"STAFF":"UNAUTHORIZED";t&&(t.textContent=String(n).toUpperCase()),a&&(a.textContent=r),s&&(s.textContent=o||"N/A"),i&&(i.value=n),o&&window.localStorage.setItem(re,n);const c=document.querySelector("#wolfSidebar .user-name"),l=document.querySelector("#wolfSidebar .user-email");c&&(c.textContent=String(n).toUpperCase()),l&&o&&(l.textContent=o)},applyAccessPolicy(){this.access=y();const e=document.querySelector(".settings-wrapper"),t=document.getElementById("settings-tabs"),a=document.querySelector('[data-settings-tab="users"]'),s=document.querySelector('[data-settings-tab-panel="users"]'),i=document.getElementById("settings-maintenance-card"),o=document.getElementById("settings-superadmin-note"),n=document.getElementById("settings-users-permission"),r=document.getElementById("settings-admin-limit-note");this.access.isAdmin?(e&&e.classList.remove("settings-single-column"),t&&(t.style.display=""),a&&(a.style.display="")):(e&&e.classList.add("settings-single-column"),t&&(t.style.display="none"),a&&(a.style.display="none"),s&&s.classList.remove("is-active"),this.setActiveTab("personalize")),i&&(i.style.display=this.access.isStaff?"none":""),this.canCreateAccounts=!!this.access.isSuperAdmin,this.canManageAccounts=!!this.access.isSuperAdmin,this.setCreateControlsEnabled(this.canCreateAccounts),o&&(o.hidden=this.canCreateAccounts),n&&(n.textContent=this.canCreateAccounts?`You are superadmin (${z}). You can create, edit, and delete admin/staff accounts.`:`Only superadmin (${z}) can create, edit, or delete accounts.`),r&&(r.textContent=`ADMIN LIMIT: UP TO ${this.maxAdmins} ADMIN ACCOUNTS ONLY (INCLUDING SUPERADMIN).`)},setActiveTab(e="personalize"){const t=String(e||"personalize").toLowerCase();document.querySelectorAll("[data-settings-tab-btn]").forEach(a=>{const s=String(a.getAttribute("data-settings-tab")||"")===t;a.classList.toggle("is-active",s)}),document.querySelectorAll("[data-settings-tab-panel]").forEach(a=>{const s=String(a.getAttribute("data-settings-tab-panel")||"")===t;a.classList.toggle("is-active",s)})},setCreateControlsEnabled(e){const t=document.getElementById("settings-create-user-btn");t&&(t.disabled=!e),document.querySelectorAll("#settings-create-user-form input, #settings-create-user-form select").forEach(a=>{a.disabled=!e})},setToggleState(e,t){const a=document.querySelector(`[data-setting-toggle="${e}"]`);a&&(a.classList.toggle("active",!!t),a.setAttribute("aria-pressed",t?"true":"false"))},toggleSetting(e){if(!e)return;const t=document.querySelector(`[data-setting-toggle="${e}"]`);if(!t)return;const a=!t.classList.contains("active");e==="action-sounds"?(window.localStorage.setItem(ne,a?"false":"true"),d(a?"Action sounds enabled.":"Action sounds muted.","success")):e==="victory-visuals"&&(window.localStorage.setItem(ie,a?"true":"false"),d(a?"Victory visuals enabled.":"Victory visuals disabled.","success")),this.setToggleState(e,a)},applyUiScale(e){const t=Math.min(150,Math.max(50,f(e)||100)),a=t/100;document.documentElement.style.fontSize=`${(16*a).toFixed(2)}px`,document.documentElement.style.setProperty("--wolf-ui-scale-factor",String(a));const s=document.getElementById("settings-ui-scale-value");return s&&(s.textContent=`${t}%`),t},async resetToDefaults(){if(!await confirmAction({title:"Reset settings to defaults?",text:"This will reset action sounds, victory visuals, and interface scale to default values.",confirmButtonText:"Reset",cancelButtonText:"Cancel",icon:"warning"}))return;try{window.localStorage.setItem(ne,"false"),window.localStorage.setItem(ie,"true"),window.localStorage.setItem(oe,"100")}catch(s){}this.setToggleState("action-sounds",!0),this.setToggleState("victory-visuals",!0);const t=this.applyUiScale(100),a=document.getElementById("settings-ui-scale");a&&(a.value=String(t)),d("Settings restored to defaults.","success")},async updateAccount(){var r,c,l,m;const e=((c=(r=document.getElementById("settings-display-name"))==null?void 0:r.value)==null?void 0:c.trim())||"Wolf User",t=((m=(l=document.getElementById("settings-new-password"))==null?void 0:l.value)==null?void 0:m.trim())||"";window.localStorage.setItem(re,e);const a=document.getElementById("settings-profile-name");a&&(a.textContent=e.toUpperCase());const s=document.querySelector("#wolfSidebar .user-name");s&&(s.textContent=e.toUpperCase());const i=await b();if(!i){d("Display name saved locally.","success");return}const o={data:{display_name:e,full_name:e}};t&&(o.password=t);const{error:n}=await i.auth.updateUser(o);if(n)d(`Account update partially failed: ${n.message}`,"warning");else{d("Account settings updated.","success");const g=document.getElementById("settings-new-password");g&&(g.value="")}},async getAccessToken(){const e=await b();if(!e)return"";const{data:{session:t}}=await e.auth.getSession();return String((t==null?void 0:t.access_token)||"")},async callUserAccountsApi(e,t={}){const a=await this.getAccessToken();if(!a)throw new Error("No active session token found.");const s=await fetch("/.netlify/functions/manage-user-accounts",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({action:e,...t})});let i={};try{i=await s.json()}catch(o){i={}}if(!s.ok)throw new Error(String(i.error||"User account request failed."));return i},updateAdminCountChip(){const e=document.getElementById("settings-admin-count-chip");e&&(e.textContent=`Admins: ${this.currentAdmins}/${this.maxAdmins}`)},renderManagedUsers(){const e=document.getElementById("settings-users-list"),t=document.getElementById("settings-users-empty");if(e){if(!this.managedAccounts.length){e.innerHTML="",t&&(t.style.display="block");return}t&&(t.style.display="none"),e.innerHTML=this.managedAccounts.map(a=>{const s=a.role==="admin"?"admin":"staff",i=a.isSuperAdmin?"SUPERADMIN":String(a.role||"").toUpperCase(),o=U(a.email||""),n=a.isSuperAdmin||fe.has(o)||pe.has(o),r=H(a.createdAt),c=a.lastSignInAt?H(a.lastSignInAt):"Never",m=this.canManageAccounts&&!n?`
                <div class="settings-user-actions">
                  <button type="button" class="settings-user-action-btn" data-settings-user-edit-id="${u(a.id||"")}">Edit</button>
                  <button type="button" class="settings-user-action-btn danger" data-settings-user-delete-id="${u(a.id||"")}">Delete</button>
                </div>
              `:this.canManageAccounts?'<div class="settings-user-lock-note">Fixed system account</div>':"";return`
            <div class="settings-user-row">
              <div class="settings-user-top">
                <div class="settings-user-email">${u(a.email||"N/A")}</div>
                <div class="settings-role-badge ${s}">${u(i)}</div>
              </div>
              <div class="settings-user-meta">Created: ${u(r)}</div>
              <div class="settings-user-meta">Last sign-in: ${u(c)}</div>
              ${m}
            </div>
          `}).join("")}},async loadManagedUsers(){var e,t,a,s,i,o;if(this.access=y(),this.applyAccessPolicy(),!!this.access.isAdmin)try{const n=await this.callUserAccountsApi("list");this.managedAccounts=Array.isArray(n.accounts)?n.accounts:[],this.currentAdmins=f((e=n==null?void 0:n.limits)==null?void 0:e.currentAdmins),this.maxAdmins=Math.max(1,f((t=n==null?void 0:n.limits)==null?void 0:t.maxAdmins)||3),this.canCreateAccounts=!!((a=n==null?void 0:n.permissions)!=null&&a.canCreateAccounts),this.canManageAccounts=!!((o=(s=n==null?void 0:n.permissions)==null?void 0:s.canManageAccounts)!=null?o:(i=n==null?void 0:n.permissions)!=null&&i.canCreateAccounts),this.updateAdminCountChip(),this.setCreateControlsEnabled(this.canCreateAccounts),this.applyAccessPolicy(),this.renderManagedUsers()}catch(n){this.managedAccounts=[],this.renderManagedUsers(),d(`Unable to load managed users: ${n.message}`,"error")}},async createManagedUser(){var o,n,r,c,l;if(this.access=y(),!this.access.isSuperAdmin){d("Only superadmin can create new accounts.","warning");return}const e=document.getElementById("settings-create-user-btn"),t=U((o=document.getElementById("settings-create-email"))==null?void 0:o.value),a=String(((n=document.getElementById("settings-create-role"))==null?void 0:n.value)||"staff").trim().toLowerCase(),s=String(((r=document.getElementById("settings-create-display-name"))==null?void 0:r.value)||"").trim(),i=String(((c=document.getElementById("settings-create-password"))==null?void 0:c.value)||"").trim();if(!t){d("Email is required.","warning");return}e&&(e.disabled=!0);try{const m=await this.callUserAccountsApi("create",{email:t,role:a,displayName:s,password:i}),g=!!((l=m==null?void 0:m.defaults)!=null&&l.usedDefaultPassword);d(g?"Account created with default password 12345.":"Account created successfully.","success");const h=document.getElementById("settings-create-user-form");h&&h.reset();const p=document.getElementById("settings-create-role");p&&(p.value="staff"),await this.loadManagedUsers()}catch(m){d(`Create account failed: ${m.message}`,"error")}finally{e&&(e.disabled=!1)}},async editManagedUser(e){if(this.access=y(),!this.access.isSuperAdmin){d("Only superadmin can edit accounts.","warning");return}if(!(e!=null&&e.id)){d("Invalid account selected.","error");return}const t=String(e.role||"staff").toLowerCase(),a=String(e.displayName||"").trim();let s=a,i=t==="admin"?"admin":"staff",o="";if(window.Swal){const n=await window.Swal.fire({title:"Edit Account",html:`
            <div style="display:grid; gap:10px; text-align:left;">
              <label style="font-size:11px; font-weight:800; letter-spacing:0.7px; text-transform:uppercase; color:#b9c5db;">Display Name</label>
              <input id="settings-edit-display-name" class="swal2-input" value="${u(a)}" placeholder="Optional display name" style="margin:0;" />
              <label style="font-size:11px; font-weight:800; letter-spacing:0.7px; text-transform:uppercase; color:#b9c5db;">Role</label>
              <select id="settings-edit-role" class="swal2-select" style="margin:0;">
                <option value="staff" ${i==="staff"?"selected":""}>Staff</option>
                <option value="admin" ${i==="admin"?"selected":""}>Admin</option>
              </select>
              <label style="font-size:11px; font-weight:800; letter-spacing:0.7px; text-transform:uppercase; color:#b9c5db;">Reset Password (Optional)</label>
              <input id="settings-edit-password" type="password" class="swal2-input" placeholder="Leave blank to keep current password" style="margin:0;" />
            </div>
          `,showCancelButton:!0,confirmButtonText:"Save",cancelButtonText:"Cancel",preConfirm:()=>{var m,g,h;const r=String(((m=document.getElementById("settings-edit-display-name"))==null?void 0:m.value)||"").trim(),c=String(((g=document.getElementById("settings-edit-role"))==null?void 0:g.value)||"").trim().toLowerCase(),l=String(((h=document.getElementById("settings-edit-password"))==null?void 0:h.value)||"").trim();return c!=="admin"&&c!=="staff"?(window.Swal.showValidationMessage("Role must be admin or staff"),null):{displayName:r,role:c,password:l}}});if(!n.isConfirmed||!n.value)return;s=String(n.value.displayName||"").trim(),i=String(n.value.role||"").trim().toLowerCase(),o=String(n.value.password||"").trim()}else{const n=window.prompt(`Role for ${e.email} (admin/staff):`,i);if(n===null)return;if(i=String(n||"").trim().toLowerCase(),i!=="admin"&&i!=="staff"){d("Role must be admin or staff.","warning");return}const r=window.prompt(`Display name for ${e.email}:`,a);if(r===null)return;s=String(r||"").trim()}try{await this.callUserAccountsApi("update",{userId:e.id,role:i,displayName:s,password:o}),d("Account updated successfully.","success"),await this.loadManagedUsers()}catch(n){d(`Update account failed: ${n.message}`,"error")}},async deleteManagedUser(e){if(this.access=y(),!this.access.isSuperAdmin){d("Only superadmin can delete accounts.","warning");return}if(!(e!=null&&e.id)){d("Invalid account selected.","error");return}let t=!1;if(window.Swal?t=!!(await window.Swal.fire({title:"Delete Account?",html:`<div style="font-size:13px; color:#dbe4f4;">This will permanently delete <b>${u(e.email||"account")}</b>.</div>`,icon:"warning",showCancelButton:!0,confirmButtonText:"Delete",cancelButtonText:"Cancel",confirmButtonColor:"#b91c1c"})).isConfirmed:t=window.confirm(`Delete account ${e.email}? This action cannot be undone.`),!!t)try{await this.callUserAccountsApi("delete",{userId:e.id}),d("Account deleted successfully.","success"),await this.loadManagedUsers()}catch(a){d(`Delete account failed: ${a.message}`,"error")}},async exportBackup(){if(this.access=y(),!this.access.isAdmin){d("Only admin accounts can export backups.","warning");return}const e=await b();if(!e){d("Supabase is not ready for export.","error");return}const t=["members","products","sales","check_in_logs","goal_target","equipments","feedback_entries","audit_log"],a={created_at:new Date().toISOString(),version:"wolf-backup-1",tables:{},errors:{}};for(const o of t){const{data:n,error:r}=await e.from(o).select("*").limit(2e3);if(r){a.errors[o]=r.message;continue}a.tables[o]=n||[]}const s=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),i=document.createElement("a");i.href=URL.createObjectURL(s),i.download=`wolf-backup-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(i.href),d("Backup exported.","success")},async restoreBackup(){if(this.access=y(),!this.access.isAdmin){d("Only admin accounts can restore backups.","warning");return}const e=document.createElement("input");e.type="file",e.accept=".json,application/json",e.onchange=async()=>{var l;const t=(l=e.files)==null?void 0:l[0];if(!t)return;const a=await t.text();let s;try{s=JSON.parse(a)}catch(m){d("Invalid backup file format.","error");return}const i=s!=null&&s.tables&&typeof s.tables=="object"?s.tables:s;if(!i||typeof i!="object"){d("Backup file has no table payload.","error");return}const o=await b();if(!o){d("Supabase is not ready for restore.","error");return}const n={members:"member_id",products:"productid",sales:"id",check_in_logs:"id",goal_target:"id",equipments:"id",feedback_entries:"id",audit_log:"id"};let r=0,c=0;for(const[m,g]of Object.entries(i)){if(!Array.isArray(g)||g.length===0)continue;const h=n[m]||"id",{error:p}=await o.from(m).upsert(g,{onConflict:h});if(p){c+=1;continue}r+=g.length}d(`Restore complete. Rows merged: ${r}. Failed tables: ${c}.`,c>0?"warning":"success")},e.click()}}})();
