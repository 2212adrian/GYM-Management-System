let html5QrCode=null;window.wolfScanner={availableCameras:[],currentCamIndex:0,activeCallback:null,onCloseCallback:null,isProcessingResult:!1,isSwitchingCamera:!1,lastScanTime:0,async init(){if(document.getElementById("wolf-scanner-overlay"))return!0;try{const t=await fetch("/assets/components/scanner-modal.html");if(!t.ok)throw new Error("Scanner component missing");const o=await t.text();return document.body.insertAdjacentHTML("beforeend",o),this.attachListeners(),!0}catch(t){return console.error("Wolf OS: Scanner Init Fault:",t),!1}},async start(t=null,o=!1,r=null){if(!await this.init())return;const s=document.getElementById("wolf-scanner-overlay");if(!s)return;this.activeCallback=t,this.onCloseCallback=typeof r=="function"?r:null,this.isProcessingResult=!1,this.isSwitchingCamera=!1,s.style.display="flex",s.style.opacity="1",s.style.pointerEvents="auto";const i=document.getElementById("manualCodeInput");i&&(i.value="",setTimeout(()=>i.focus(),300));try{const e=await Html5Qrcode.getCameras();if(this.availableCameras=e,e&&e.length>0){const n=document.getElementById("cameraSelect");n.innerHTML=e.map((f,p)=>`<option value="${f.id}">${f.label||"Optic "+(p+1)}</option>`).join(""),n.onchange=f=>this.launchCamera(f.target.value),document.getElementById("flipCameraBtn").onclick=()=>this.cycleCamera();let c=e.findIndex(f=>/back|rear|environment|main/i.test(f.label));this.currentCamIndex=c!==-1?c:0,n.value=e[this.currentCamIndex].id,await this.launchCamera(e[this.currentCamIndex].id)}}catch(e){this.showInactiveUI("PERMISSION_DENIED")}},async launchCamera(t){if(this.isSwitchingCamera)return;if(this.isSwitchingCamera=!0,html5QrCode){try{await html5QrCode.stop()}catch(r){}html5QrCode=null}const o=document.getElementById("reader");o.innerHTML="",html5QrCode=new Html5Qrcode("reader");try{await html5QrCode.start(t,{fps:20,qrbox:{width:250,height:250},aspectRatio:1},r=>this.processResult(r,"SCAN"))}catch(r){this.showInactiveUI("HARDWARE_FAULT")}finally{this.isSwitchingCamera=!1}},async cycleCamera(){if(this.availableCameras.length<2)return;window.wolfAudio&&window.wolfAudio.play("notif"),this.currentCamIndex=(this.currentCamIndex+1)%this.availableCameras.length;const t=this.availableCameras[this.currentCamIndex].id,o=document.getElementById("cameraSelect");o&&(o.value=t),await this.launchCamera(t)},isQuickLoginPayload(t){return typeof t=="string"&&t.startsWith("WOLFQL1.")},decodeQuickLoginPayload(t){if(!this.isQuickLoginPayload(t))return null;try{const r=t.slice(8).trim().replace(/-/g,"+").replace(/_/g,"/"),a="=".repeat((4-r.length%4)%4),s=atob(r+a),i=JSON.parse(s),e=(i==null?void 0:i.requestId)||(i==null?void 0:i.r);if(!e)return null;const n=Array.isArray(i==null?void 0:i.p)?i.p:null,c=i!=null&&i.previewContext&&typeof i.previewContext=="object"?i.previewContext:n&&n.length>=4?{ip:n[0],city:n[1],region:n[2],country:n[3]}:null;return{requestId:String(e),previewContext:c&&typeof c=="object"?{ip:String(c.ip||""),city:String(c.city||""),region:String(c.region||""),country:String(c.country||""),countryCode:String(c.countryCode||"")}:null,previewSig:String(i.previewSig||i.g||"")}}catch(o){return null}},async handleQuickLoginApproval(t){var y,h,C,v;const o=this.decodeQuickLoginPayload(t);if(!o)throw new Error("Malformed quick-login code");const r=await fetch("/.netlify/functions/quick-login-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requestId:o.requestId,previewContext:o.previewContext,previewSig:o.previewSig,consume:!1})});let a={};try{a=await r.json()}catch(m){a={}}if(!r.ok)throw new Error(a.error||"Unable to preview quick-login request");if(a.status!=="pending")throw new Error("Quick-login session is no longer pending");const s=a.location||{},i=[s.city,s.region,s.country].filter(Boolean).join(", ")||"Unknown location",e=s.ip||"Unknown IP",n=m=>{const k=String(m!=null?m:"");return window.DOMPurify?window.DOMPurify.sanitize(k,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]}):k.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;")},c=n(e),f=n(i),p=n(String(o.requestId).slice(0,10).toUpperCase());let u=!1;if(window.Swal?u=!!(await window.Swal.fire({title:"APPROVE QUICK LOGIN?",html:`
          <div style="text-align:left; font-size:13px; color:#aab3c2; line-height:1.6;">
            <div style="margin-bottom:8px;">
              <strong style="color:#e7eefc;">Request IP:</strong><br>${c}
            </div>
            <div style="margin-bottom:8px;">
              <strong style="color:#e7eefc;">Location:</strong><br>${f}
            </div>
            <div>
              <strong style="color:#e7eefc;">Session Ref:</strong><br>${p}
            </div>
          </div>
        `,showCancelButton:!0,confirmButtonText:"CONFIRM LOGIN",cancelButtonText:"CANCEL",reverseButtons:!0,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-orange",title:"wolf-swal-title",confirmButton:"btn-wolf-red",cancelButton:"btn-wolf-secondary"}})).isConfirmed:u=window.confirm(`Approve quick login?
IP: ${e}
Location: ${i}`),!u)return;const l=await((C=(h=(y=window.supabaseClient)==null?void 0:y.auth)==null?void 0:h.getSession)==null?void 0:C.call(h)),w=((v=l==null?void 0:l.data)==null?void 0:v.session)||null;if(!(w!=null&&w.access_token)||!(w!=null&&w.refresh_token))throw new Error("No active authenticated session found for approval");const d=await fetch("/.netlify/functions/quick-login-approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requestId:o.requestId,accessToken:w.access_token,refreshToken:w.refresh_token})});let g={};try{g=await d.json()}catch(m){g={}}if(!d.ok)throw new Error(g.error||"Failed to approve quick-login request");window.wolfAudio&&window.wolfAudio.play("success"),window.Toastify&&window.Toastify({text:"Quick login approved successfully.",duration:2800,gravity:"bottom",position:"right",style:{background:"linear-gradient(90deg, #1e734a, #2ea35f)",color:"#f6fff9"}}).showToast()},async processResult(t,o){var a;const r=Date.now();if(!(r-this.lastScanTime<2e3)&&(this.lastScanTime=r,!this.isProcessingResult)){this.isProcessingResult=!0;try{navigator.vibrate&&navigator.vibrate(80),window.wolfAudio&&window.wolfAudio.play("success");const s=(a=document.getElementById("quickAuthToggle"))==null?void 0:a.checked,i=String(t||"").trim();if(this.isQuickLoginPayload(i)){await this.stop(),await this.handleQuickLoginApproval(i);return}const e=i.toUpperCase().replace(/\s+/g,""),n=/^ME-[A-Z0-9]{2,}$/.test(e);if(!this.activeCallback&&n){await this.stop(),window.logbookManager&&s&&typeof window.logbookManager.processCheckIn=="function"?await window.logbookManager.processCheckIn(e,{entryType:"member",isPaid:!1}):window.logbookManager&&typeof window.logbookManager.openLogbookTerminal=="function"?await window.logbookManager.openLogbookTerminal(e):window.salesManager&&window.salesManager.showSystemAlert("LOGBOOK_MODULE_NOT_READY","error");return}await this.stop(),this.activeCallback?this.activeCallback(e):window.salesManager&&(s?await window.salesManager.processQuickSale(e):await window.salesManager.openSaleTerminal(e))}catch(s){window.wolfAudio&&window.wolfAudio.play("error"),window.Swal?window.Swal.fire({title:"QUICK LOGIN REJECTED",text:s.message||"Failed to process QR payload.",background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-red",title:"wolf-swal-title",confirmButton:"btn-wolf-red"},confirmButtonText:"OK"}):alert(s.message||"Failed to process QR payload.")}finally{this.isProcessingResult=!1}}},async stop(t={}){const{skipOnClose:o=!1}=t;if(html5QrCode){try{await html5QrCode.stop(),html5QrCode.clear()}catch(e){}html5QrCode=null}const r=document.getElementById("wolf-scanner-overlay");r&&(r.style.display="none",r.style.opacity="0",r.style.pointerEvents="none");const a=document.getElementById("manualCodeInput"),s=document.getElementById("manualInputGroup");a&&(a.value=""),s&&s.classList.remove("has-content");const i=this.onCloseCallback;if(this.onCloseCallback=null,this.activeCallback=null,this.isProcessingResult=!1,this.isSwitchingCamera=!1,!o&&i)try{i()}catch(e){console.warn("Wolf OS: Scanner close callback failed.",e)}},attachListeners(){const t=document.getElementById("manualCodeInput"),o=document.getElementById("manualInputGroup"),r=document.getElementById("manualConfirmBtn"),a=document.getElementById("custom-search-results");let s=null;t&&(t.addEventListener("input",e=>{e.target.value=e.target.value.toUpperCase(),o.classList.toggle("has-content",e.target.value.trim().length>0)}),t.addEventListener("input",()=>{const e=t.value.trim();if(a){if(s&&clearTimeout(s),e.length<1){a.classList.remove("active"),a.innerHTML="";return}s=setTimeout(async()=>{var f,p;let n=[];const c=u=>{const l=String(u!=null?u:"");return window.DOMPurify?window.DOMPurify.sanitize(l,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]}):l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")};if(window.supabaseClient){const u=await window.supabaseClient.from("products").select("name, sku, is_active").eq("is_active",!0).or(`name.ilike.%${e}%,sku.ilike.%${e}%`).order("name",{ascending:!0}).limit(6);u.error||(n=(u.data||[]).filter(w=>w.is_active!==!1));const l=await window.supabaseClient.from("members").select("full_name, member_code, sku").or(`full_name.ilike.%${e}%,member_code.ilike.%${e}%,sku.ilike.%${e}%`).order("full_name",{ascending:!0}).limit(4);!l.error&&((f=l.data)!=null&&f.length)?n=[...l.data.filter(d=>String(d.member_code||d.sku||"").trim().length>0).map(d=>({name:d.full_name||"Member",sku:String(d.member_code||d.sku||"").toUpperCase(),type:"MEMBER"})),...n.map(d=>({...d,type:"PRODUCT"}))]:n=n.map(w=>({...w,type:"PRODUCT"}))}if((!n||n.length===0)&&((p=window.ProductManager)!=null&&p.allProducts)){const u=e.toLowerCase();n=window.ProductManager.allProducts.filter(l=>l.name&&l.name.toLowerCase().includes(u)||l.sku&&l.sku.toLowerCase().includes(u)).slice(0,6).map(l=>({name:l.name,sku:l.sku,type:"PRODUCT"}))}if(a){if(!n||n.length===0){a.classList.remove("active"),a.innerHTML="";return}a.innerHTML=n.map(u=>{const l=String(u.type||"PRODUCT").toUpperCase(),w=c(String(u.name||"").toUpperCase()),d=String(u.sku||"").toUpperCase(),g=d.startsWith("PR-")?d:`PR-${d}`,y=c(l==="MEMBER"?d:g);return`
              <div class="dropdown-item" data-sku="${c(d)}" data-kind="${l}">
                <span>${w}</span>
                <span class="sku">${y}</span>
              </div>
            `}).join(""),a.classList.add("active")}},250)}}),t.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();const n=t.value.trim();n&&this.processResult(n,"MANUAL_ENTRY")}})),r&&(r.onclick=()=>{const e=t.value.trim();e&&this.processResult(e,"MANUAL_ENTRY")}),a&&a.addEventListener("click",e=>{const n=e.target.closest(".dropdown-item");if(!n)return;const c=n.getAttribute("data-sku")||"",f=n.getAttribute("data-kind")||"PRODUCT";c&&(t&&(t.value=c.toUpperCase()),a.classList.remove("active"),a.innerHTML="",o&&o.classList.add("has-content"),this.processResult(c,f==="MEMBER"?"MANUAL_MEMBER_PICK":"MANUAL_PICK"))});const i=document.getElementById("exitScannerBtn");i&&(i.onclick=()=>this.stop())},showInactiveUI(t){const o=document.getElementById("reader");window.wolfAudio&&window.wolfAudio.play("error"),o.innerHTML=`
      <div class="camera-inactive-state">
        <i class='bx bx-camera-off' style="color:var(--wolf-red); opacity: 1;"></i>
        <span style="color:var(--wolf-red)">${t}</span>
      </div>`}},document.addEventListener("click",t=>{t.target.closest("#qrScannerBtn")&&window.wolfScanner.start()});
