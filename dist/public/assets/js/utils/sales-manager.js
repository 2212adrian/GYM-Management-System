(function(){document.getElementById("wolf-system-alert")||document.body.insertAdjacentHTML("beforeend",`<div id="wolf-system-alert">
         <i class='bx alert-icon'></i>
         <span class="alert-text"></span>
       </div>`)})(),window.salesManager={allProducts:[],selectedProductId:null,placeholderImg:"/assets/images/placeholder.png",_alertTimeout:null,showSystemAlert(e,t="success",s="#28a745"){if(!window.matchMedia("(max-width: 767px)").matches)return;const a=document.getElementById("wolf-system-alert");a&&(this._alertTimeout&&clearTimeout(this._alertTimeout),a.className="",a.style.backgroundColor=s,setTimeout(()=>{const i={success:"bx-check-shield",error:"bx-error-alt",warning:"bx-shield-quarter"};a.querySelector(".alert-icon").className=`bx alert-icon ${i[t]||"bx-notification"}`,a.querySelector(".alert-text").innerText=e.toUpperCase(),a.classList.add("show",t),window.wolfAudio&&window.wolfAudio.play(t==="success"?"success":"error")},10),this._alertTimeout=setTimeout(()=>{a.classList.remove("show")},4e3))},showTopInstruction(e=!0){let t=document.getElementById("wolf-system-instruction");if(!e){t&&t.remove();return}t||(document.body.insertAdjacentHTML("beforeend",'<div id="wolf-system-instruction" class="system-instruction-banner"><div class="instruction-pulse"></div><span class="instruction-text">SCAN OR TYPE PRODUCT TO VALIDATE</span></div>'),t=document.getElementById("wolf-system-instruction")),t.classList.toggle("active",e)},async openSaleTerminal(e=null){this.allProducts.length===0&&await this.fetchProducts();let t;if(e&&(t=this.allProducts.find(i=>i.sku===e),!t)){this.showSystemAlert(`SKU [${e}] NOT FOUND`,"error");return}let s=document.getElementById("sale-terminal-overlay"),o=document.getElementById("sale-terminal-style");if(!s){const n=await(await fetch("/assets/components/record-sale-modal.html")).text(),c=document.createElement("div");c.innerHTML=n;const r=c.querySelector("style");r&&!o&&(r.id="sale-terminal-style",document.head.appendChild(r));const d=c.querySelector("#sale-terminal-overlay");if(!d)return;document.body.appendChild(d),s=d}const a=s.querySelector(".master-terminal-container");if(a&&(s.style.display="",s.style.visibility="",s.style.opacity="",s.classList.remove("is-closing"),a.classList.remove("modal-closing"),s.classList.add("is-open"),a.classList.add("modal-open"),this.showTopInstruction(!0),await this.fetchProducts(),this.attachSaleListeners(s),this.resetPreview(),t)){const i=s.querySelector("#sale-product-search");i&&(i.value=t.name),this.lockProduct(t);const n=s.querySelector("#sale-qty");n&&(n.value=1,n.classList.add("auto-filled")),this.validateTransaction()}},closeSaleTerminal(){const e=document.getElementById("sale-terminal-overlay");if(!e)return;this.showTopInstruction(!1);const t=e.querySelector(".master-terminal-container");e.classList.remove("is-open"),t.classList.remove("modal-open"),e.classList.add("is-closing"),t.classList.add("modal-closing"),setTimeout(()=>{e.remove();const s=document.getElementById("sale-terminal-style");s&&s.remove()},300)},async processQuickSale(e){if(!this.isProcessingQuick){this.isProcessingQuick=!0;try{const{data:t,error:s}=await supabaseClient.from("products").select("*").eq("sku",e).eq("is_active",!0).single();if(s||!t){this.showSystemAlert(`SKU [${e}] NOT RECOGNIZED`,"error");return}const o=Number(t.qty);if(o<1&&o<999999){this.showSystemAlert(`OUT OF STOCK: ${t.name}`,"error");return}const a=`AUTO-${Date.now().toString().slice(-4)}`,{error:i}=await supabaseClient.from("sales").insert([{sale_reference:a,product_id:t.productid,qty:1,unit_price:t.price,payment_status:"paid"}]);if(i)throw i;o<999999&&await supabaseClient.from("products").update({qty:o-1}).eq("productid",t.productid),this.showSystemAlert(`QUICK AUTH: ${t.name} x1`,"success"),window.wolfAudio&&window.wolfAudio.play("success"),window.wolfData&&typeof window.wolfData.loadSales=="function"&&window.wolfData.loadSales()}catch(t){console.error("Quick Sale Error:",t),this.showSystemAlert("TRANSACTION_FAILED","error"),window.wolfAudio&&window.wolfAudio.play("error")}finally{setTimeout(()=>{this.isProcessingQuick=!1},1500)}}},async fetchProducts(){const{data:e,error:t}=await supabaseClient.from("products").select("*").eq("is_active",!0);t||(this.allProducts=e)},attachSaleListeners(e){const t=e.querySelector("#record-sale-form"),s=e.querySelector("#sale-product-search"),o=e.querySelector("#custom-search-results"),a=e.querySelector("#sale-qty"),i=e.querySelector("#qrScanTrigger"),n=e.querySelector("#clearSearchBtn"),c=e.querySelector("#closeSaleModal");!s||!o||(s.addEventListener("input",()=>{const r=s.value.trim().toLowerCase();if(r.length<1){o.classList.remove("active");return}const d=this.allProducts.filter(l=>l.name&&l.name.toLowerCase().includes(r)||l.sku&&l.sku.toLowerCase().includes(r));d.length>0?(o.innerHTML=d.map(l=>`
            <div class="dropdown-item" data-id="${l.productid}">
                <span class="item-name">${l.name}</span>
                <span class="item-sku">SKU: ${l.sku}</span>
            </div>
        `).join(""),o.classList.add("active")):o.classList.remove("active")}),o.onclick=r=>{const d=r.target.closest(".dropdown-item");if(d){const l=d.getAttribute("data-id"),m=this.allProducts.find(f=>f.productid===l);m&&(s.value=m.name,o.classList.remove("active"),this.lockProduct(m)),a&&(a.value=1,a.classList.add("auto-filled"),setTimeout(()=>{a.classList.remove("auto-filled")},500),this.validateTransaction())}},i&&(i.onclick=()=>{window.wolfScanner&&(e.style.display="none",window.wolfScanner.start(r=>{e.style.display="flex";const d=this.allProducts.find(l=>l.sku===r);d?(s.value=d.name,this.lockProduct(d)):this.showSystemAlert(`SKU [${r}] UNKNOWN`,"error"),this.openSaleTerminal(r)},!0,()=>{e.style.display="flex"}))}),n.onclick=()=>{e.querySelector("#searchWrapper").classList.remove("is-locked"),n.style.display="none",i.style.display="flex",s.readOnly=!1,s.value="",this.selectedProductId=null,this.resetPreview(),window.wolfAudio&&window.wolfAudio.play("notif"),s.focus()},c.onclick=()=>{o.classList.remove("active"),this.closeSaleTerminal(),this.showTopInstruction(!1),this.selectedProductId=null},a.oninput=()=>{(parseInt(a.value)||0)===1&&(a.classList.add("auto-filled"),setTimeout(()=>a.classList.remove("auto-filled"),500)),this.validateTransaction()},t.onsubmit=async r=>{r.preventDefault(),this.processTransaction()},document.addEventListener("click",r=>{r.target.closest("#searchWrapper")||o.classList.remove("active"),r.target.closest("#closeSaleModal")&&r.preventDefault()}))},lockProduct(e){const t=document.getElementById("sale-product-search"),s=document.getElementById("searchWrapper"),o=document.getElementById("qrScanTrigger"),a=document.getElementById("clearSearchBtn"),i=document.getElementById("sale-qty");this.selectedProductId=e.productid,t.readOnly=!0,s.classList.add("is-locked"),o&&(o.style.display="none"),a&&(a.style.display="flex"),this.showTopInstruction(!1),this.updatePreview(e),Number(e.qty||0)>0?i&&(i.value=1,i.classList.add("auto-filled"),setTimeout(()=>i.classList.remove("auto-filled"),500)):(i&&(i.value=0),this.showSystemAlert(`No stock available for ${e.name}`,"error")),this.validateTransaction(),window.wolfAudio&&window.wolfAudio.play("success")},updatePreview(e){const t=document.getElementById("sale-qty"),s=document.getElementById("meta-price"),o=document.getElementById("meta-stock"),a=document.getElementById("asset-preview-img"),i=document.getElementById("asset-preview-desc");s&&(s.innerText=`₱${Number(e.price).toFixed(2)}`);const n=Number(e.qty||0);o&&(o.innerText=n>=999999?"∞":n,o.style.color=n<=0?"var(--wolf-red)":"#fff"),t&&(n<=0?(t.disabled=!0,t.style.opacity="0.3",this.showSystemAlert(`INVENTORY DEPLETED: ${e.name}`,"error")):(t.disabled=!1,t.style.opacity="1")),a&&(a.src=e.image_url||this.placeholderImg),i&&(i.innerText=e.description||"NO TECHNICAL DATA FILED.")},validateTransaction(){const e=document.getElementById("sale-qty"),t=document.getElementById("sale-submit-btn"),s=document.getElementById("sale-total-display"),o=parseInt(e.value)||0,a=this.allProducts.find(n=>n.productid===this.selectedProductId);if(!a){t&&(t.disabled=!0);return}const i=Number(a.qty||0);i<999999&&o>i?(e.classList.add("input-error"),window.wolfAudio&&window.wolfAudio.play("denied"),this.showSystemAlert(`No stock available for ${a.name}`,"error"),e.value="",s&&(s.innerText="₱0.00"),t.disabled=!0,setTimeout(()=>e.classList.remove("input-error"),500)):o<=0?t.disabled=!0:(e.classList.remove("input-error"),t.disabled=!1),this.calculateTotal()},resetPreview(){const e=document.getElementById("asset-preview-img"),t=document.getElementById("asset-preview-desc"),s=document.getElementById("meta-price"),o=document.getElementById("meta-stock"),a=document.getElementById("sale-submit-btn"),i=document.getElementById("sale-qty");i&&(i.value="",i.disabled=!0,i.style.opacity="0.3"),e&&(e.src=this.placeholderImg),t&&(t.innerText="SELECT AN ASSET TO LOAD TECHNICAL DATA PROTOCOL..."),s&&(s.innerText="₱0.00"),o&&(o.innerText="--"),a&&(a.disabled=!0),this.calculateTotal()},calculateTotal(){const e=document.getElementById("sale-qty"),t=document.getElementById("sale-total-display");if(!this.selectedProductId){t&&(t.innerText="₱0.00");return}const s=this.allProducts.find(a=>a.productid===this.selectedProductId),o=parseInt(e.value)||0;if(s&&t){const a=Number(s.price)*o;t.innerText=`₱${a.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`}else t&&(t.innerText="₱0.00")},async processTransaction(){const e=document.getElementById("sale-submit-btn"),t=document.getElementById("record-sale-form"),s=document.getElementById("sale-qty"),o=parseInt(s.value);e.disabled=!0,e.textContent="SYNCHRONIZING...";try{const{data:a,error:i}=await supabaseClient.from("products").select("*").eq("productid",this.selectedProductId).single();if(i||!a)throw new Error("Asset validation failed.");const n=Number(a.qty);if(n<999999&&n<o)throw new Error("INSUFFICIENT_STOCK");const c=`SALE-${Date.now().toString().slice(-4)}`,{error:r}=await supabaseClient.from("sales").insert([{sale_reference:c,product_id:this.selectedProductId,qty:o,unit_price:a.price,payment_status:"paid"}]);if(r)throw r;n<999999&&await supabaseClient.from("products").update({qty:n-o}).eq("productid",this.selectedProductId),this.showSystemAlert(`PRODUCT ADDED: ${a.name.toUpperCase()} x${o}`),Toastify({text:`PRODUCT ADDED: ${a.name.toUpperCase()} x${o}`,duration:2500,gravity:"top",position:"right",style:{border:"1px solid #77ff00",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast(),window.wolfData&&window.wolfData.loadSales();const d=document.getElementById("sale-terminal-overlay");d&&(d.style.display="none"),document.getElementById("sale-terminal-overlay").style.display="none",t&&t.reset(),this.selectedProductId=null,window.wolfData&&typeof window.wolfData.loadSales=="function"&&window.wolfData.loadSales(),window.wolfAudio&&window.wolfAudio.play("success")}catch(a){this.showSystemAlert(a.message,"error"),window.wolfAudio&&window.wolfAudio.play("error")}finally{e.disabled=!1,e.textContent="AUTHORIZE TRANSACTION"}},async processQuickSale(e){if(!this.isProcessingQuick){this.isProcessingQuick=!0;try{const{data:t,error:s}=await supabaseClient.from("products").select("*").eq("sku",e).eq("is_active",!0).single();if(s||!t){this.showSystemAlert(`SKU [${e}] NOT FOUND`,"error");return}const o=Number(t.qty);if(o<1&&o<999999){this.showSystemAlert(`OUT OF STOCK: ${t.name}`,"error");return}const a=`AUTO-${Date.now().toString().slice(-4)}`,{error:i}=await supabaseClient.from("sales").insert([{sale_reference:a,product_id:t.productid,qty:1,unit_price:t.price,payment_status:"paid"}]);if(i)throw i;o<999999&&await supabaseClient.from("products").update({qty:o-1}).eq("productid",t.productid),this.showSystemAlert(`PRODUCT ADDED: ${t.name} x1`,"success"),Toastify({text:`PRODUCT ADDED: ${t.name.toUpperCase()} x1`,duration:2500,gravity:"top",position:"right",style:{border:"1px solid #77ff00",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast(),window.wolfAudio&&window.wolfAudio.play("success"),window.wolfData&&window.wolfData.loadSales&&window.wolfData.loadSales()}catch(t){console.error(t),this.showSystemAlert("TRANSACTION_FAULT","error")}finally{setTimeout(()=>{this.isProcessingQuick=!1},1e3)}}},async initModal(){if(document.getElementById("product-modal-overlay"))return!0;try{const t=await(await fetch("/assets/components/add-product-modal.html")).text();return document.body.insertAdjacentHTML("beforeend",t),this.attachEventListeners(),!0}catch(e){return!1}},async openAddTerminal(){if(!await this.initModal())return;const t=document.getElementById("product-modal-overlay"),s=document.getElementById("master-product-form"),o=document.getElementById("master-qty");s&&s.reset(),o&&(o.disabled=!1,o.placeholder="0",o.style.opacity="1"),this.generateRandomID(),t.style.display="flex",window.wolfAudio&&window.wolfAudio.play("notif")},generateRandomID(){const e=document.getElementById("master-asset-id");e&&(e.value=Math.floor(1e3+Math.random()*9e3))},attachEventListeners(){const e=document.getElementById("product-modal-overlay"),t=document.getElementById("master-product-form"),s=document.getElementById("closeProductModal"),o=document.getElementById("master-asset-id"),a=document.getElementById("generateRandomId"),i=document.getElementById("master-unlimited"),n=document.getElementById("master-qty");a&&(a.onclick=()=>{this.generateRandomID(),window.wolfAudio.play("notif")}),o&&(o.oninput=c=>{c.target.value=c.target.value.replace(/[^0-9]/g,"")}),i&&(i.onchange=c=>{n.disabled=c.target.checked,n.value="",n.placeholder=c.target.checked?"∞":"0",n.style.opacity=c.target.checked?"0.3":"1"}),t&&(t.onsubmit=async c=>{c.preventDefault();const r=t.querySelector(".btn-commit");r.disabled=!0,r.textContent="COMMITTING...";const d={sku:"PR-"+o.value,name:document.getElementById("master-name").value.toUpperCase(),description:document.getElementById("master-desc").value,price:parseFloat(document.getElementById("master-price").value),qty:i.checked?999999:parseInt(n.value||0),is_active:!0};try{const{error:l}=await supabaseClient.from("products").insert([d]);if(l)throw l;window.wolfAudio&&window.wolfAudio.play("success"),e.style.display="none",t.reset()}catch(l){window.wolfAudio&&window.wolfAudio.play("error"),alert("PROTOCOL_FAULT: Database rejected entry.")}finally{r.disabled=!1,r.textContent="COMMIT RECORD CHANGES"}})},async openTrashBin(){const e=this.currentTrashMode||"sales",t="/assets/components/trash-modal.html";if(!document.getElementById("sales-trash-overlay")){const i=await(await fetch(t)).text();document.body.insertAdjacentHTML("beforeend",i)}await new Promise(a=>setTimeout(a,50));const s=document.getElementById("sales-trash-overlay");if(!s)return;const o=s.querySelector(".terminal-title");if(o){const a=e==="sales"?"SALES":"LOGBOOK";o.innerHTML=`${a} <span>TRASH BIN</span>`}document.getElementById("closeTrashModal").onclick=()=>this.closeTrash(),document.getElementById("closeTrashBtn").onclick=()=>this.closeTrash(),s.style.display="flex",window.wolfAudio&&window.wolfAudio.play("notif"),this.loadTrashItems(e)},closeTrash(){const e=document.getElementById("sales-trash-overlay");e&&(e.classList.add("closing"),setTimeout(()=>{e.style.display="none",e.classList.remove("closing")},300))},async loadTrashItems(e){const t=document.getElementById("trash-list-container");if(!t)return;e==="sales"&&this.allProducts.length===0&&await this.fetchProducts();const s=e==="sales"?"sales":"check_in_logs",a=(window.wolfData&&window.wolfData.serverToday?window.wolfData.serverToday:new Date).toLocaleDateString("en-CA"),i=`${a}T00:00:00+08:00`,n=`${a}T23:59:59+08:00`,{data:c,error:r}=await supabaseClient.from("trash_bin").select("*").eq("table_name",s).gte("deleted_at",i).lte("deleted_at",n).order("deleted_at",{ascending:!1});if(r||!c||c.length===0){t.innerHTML=`
        <div style="text-align:center; padding:60px; opacity:0.3;">
          <i class='bx bx-folder-open' style='font-size:4rem;'></i>
          <p style='font-size:12px; font-weight:900; margin-top:15px; text-transform: uppercase;'>
            ARCHIVE_EMPTY_FOR_TODAY
          </p>
        </div>`;return}t.innerHTML=c.map(d=>{var u;const l=d.deleted_data;let m="",f="";if(e==="sales"){const w=this.allProducts.find(h=>h.productid===l.product_id);m=w?w.name:"DELETED_PRODUCT";const p=Number(l.total_amount||0).toLocaleString(void 0,{minimumFractionDigits:2}),y=w?w.sku:l.product_id?l.product_id.slice(0,8):"N/A";f=`₱${p} | SKU: ${y}`}else{m=((u=l.notes)==null?void 0:u.replace("WALK-IN: ",""))||"MEMBER_ENTRY";const w=new Date(l.time_in).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),p=l.time_out?new Date(l.time_out).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"STILL_ACTIVE";f=`IN: ${w} | OUT: ${p}`}return`
        <div class="trash-item-card">
            <div class="trash-item-info">
                <span class="trash-prod-name">${m.toUpperCase()}</span>
                <div class="trash-tech-row" style="text-transform: uppercase;">
                    ${f.toUpperCase()}
                </div>
            </div>
            <div class="trash-actions">
                <button class="btn-restore" title="RESTORE" onclick="salesManager.restoreSale('${d.id}', '${e}')">
                    <i class='bx bx-undo'></i>
                </button>
                <button class="btn-purge" title="DELETE_PERMANENT" onclick="salesManager.purgeSale('${d.id}', '${e}')">
                    <i class='bx bx-trash'></i>
                </button>
            </div>
        </div>`}).join("")},async purgeSale(e,t){if(!(!window.Swal||!(await window.Swal.fire({title:"DELETE PERMANENTLY?",html:`
        <div style="color: #b47023; font-size: 4.5rem; margin-bottom: 10px;">
          <i class='bx bx-trash-alt'></i>
        </div>
        <p class="wolf-swal-text" style="text-transform: uppercase;">
          CRITICAL: THIS ACTION CANNOT BE UNDONE. RECORD WILL BE REMOVED FOREVER. PROCEED?
        </p>
      `,showCancelButton:!0,confirmButtonText:"DELETE",cancelButtonText:"ABORT",reverseButtons:!0,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup-orange",confirmButton:"wolf-swal-confirm-orange",cancelButton:"wolf-swal-cancel"}})).isConfirmed))try{const{error:o}=await supabaseClient.from("trash_bin").delete().eq("id",e);if(o)throw o;this.showSystemAlert("RECORD_PERMANENTLY_PURGED","success"),window.wolfAudio&&window.wolfAudio.play("success"),this.loadTrashItems(t)}catch(o){console.error("Purge Fault:",o),window.wolfAudio&&window.wolfAudio.play("error"),this.showSystemAlert("PURGE_PROTOCOL_FAILED","error")}},async restoreSale(e,t){if(window.Swal)try{const s=t==="sales",o=s?"PROCEED WITH RESTORATION: THIS WILL RE-DEDUCT QUANTITY FROM STOCK.":"PROCEED WITH RESTORATION: THIS RECORD WILL RETURN TO THE LOGBOOK.";if(!(await Swal.fire({title:"RESTORE PRODUCT?",html:`<p class="wolf-swal-text" style="text-transform: uppercase;">${o}</p>`,showCancelButton:!0,confirmButtonText:"RESTORE",background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup-green",cancelButton:"wolf-swal-cancel",confirmButton:"wolf-swal-confirm-green"}})).isConfirmed)return;const{data:i,error:n}=await supabaseClient.from("trash_bin").select("*").eq("id",e).single();if(n||!i)throw new Error("ARCHIVE_RECORD_NOT_FOUND");const c={...i.deleted_data},r=s?"sales":"check_in_logs";let d=null;if(s){const{data:u}=await supabaseClient.from("products").select("qty, name, sku").eq("productid",c.product_id).single();if(u){if(u.qty<c.qty&&u.qty<999999)throw new Error("INSUFFICIENT_STOCK");u.qty<999999&&await supabaseClient.from("products").update({qty:u.qty-c.qty}).eq("productid",c.product_id),d={name:u.name,sku:u.sku}}}const l={...c};delete l.id,delete l.total_amount,delete l.created_at,delete l.products;const{data:m,error:f}=await supabaseClient.from(r).insert([l]).select().single();if(f)throw f;if(await supabaseClient.from("trash_bin").delete().eq("id",e),this.closeTrash(),window.wolfData)if(s){const u={...m,products:d};window.wolfData.allSales=[u,...window.wolfData.allSales];const w=window.wolfData.allSales.reduce((p,y)=>p+Number(y.total_amount||0),0);window.wolfData.refreshSummaryHUD(w),window.wolfData.renderSales(window.wolfData.selectedDate.getDay())}else await window.wolfData.loadLogbook();if(s&&d){const u=c.qty||1;this.showSystemAlert(`${d.name}, X${u} WAS RESTORED`,"success"),Toastify({text:`${d.name}, ${c.qty} WAS RESTORED`,duration:4e3,gravity:"top",position:"right",stopOnFocus:!0,style:{border:"1px solid #77ff00",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast()}window.wolfAudio&&window.wolfAudio.play("success")}catch(s){console.error("Restore Error:",s),window.wolfAudio&&window.wolfAudio.play("error"),this.showSystemAlert(s.message.toUpperCase(),"error")}}},document.addEventListener("click",e=>{e.target.closest("#clear-sales-btn")&&window.salesManager.openTrashBin()});
