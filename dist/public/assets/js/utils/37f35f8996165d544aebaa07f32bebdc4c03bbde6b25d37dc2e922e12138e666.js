window.logbookManager={selectedProfileId:null,selectedMember:null,selectedEntryType:"regular",selectedEntryFee:80,selectedPaid:!1,entryTypeLocked:!1,memberSearchTimer:null,clockInterval:null,serverOffset:0,membershipSnapshotCache:new Map,membershipSnapshotTtlMs:3e4,pricing:{regular:80,student:50,memberDefault:0,yearlyDiscountedEntry:60},getEntryFeeByType(e){const t=String(e||"").toLowerCase();return t==="member"?this.pricing.memberDefault:t==="student"?this.pricing.student:this.pricing.regular},getEntryLabelByType(e){const t=String(e||"").toLowerCase();return t==="member"?"MEMBER":t==="student"?"STUDENT":"REGULAR (NON-MEMBER)"},getEntryDisplayName(e){const t=String(e||"").toLowerCase();return t==="member"?"MEMBER":t==="student"?"STUDENT":"REGULAR"},isMissingRelationError(e){const t=String((e==null?void 0:e.code)||"").toUpperCase(),i=String((e==null?void 0:e.message)||"").toLowerCase();return t==="42P01"||/relation .* does not exist/.test(i)||/table .* does not exist/.test(i)},isMissingColumnError(e){const t=String((e==null?void 0:e.message)||"").toLowerCase();return String((e==null?void 0:e.code)||"").toUpperCase()==="PGRST204"||/column .* does not exist/.test(t)||/schema cache/.test(t)},getPlanKind(e){const t=String((e==null?void 0:e.name)||"").toLowerCase(),i=String((e==null?void 0:e.billing_period_unit)||"").toLowerCase(),s=Number((e==null?void 0:e.billing_period_interval)||0);return/month/.test(t)||/month/.test(i)||!i&&s===1&&/monthly/.test(t)?"monthly":/year|annual/.test(t)||/year/.test(i)||!i&&/year|annual/.test(t)?"yearly":"custom"},isMembershipActive(e,t){if(!e)return!1;const i=String(e.status||"").toLowerCase();if(i&&i!=="active")return!1;const s=e.started_at?new Date(e.started_at).getTime():null,r=e.expires_at?new Date(e.expires_at).getTime():null;return!(Number.isFinite(s)&&s>t||Number.isFinite(r)&&r<t)},async fetchMembershipSnapshot(e){if(!e||!window.supabaseClient)return{supported:!1,activeMembership:null,plan:null,planKind:null};const t=String(e),i=this.membershipSnapshotCache.get(t),s=Date.now()+Number(this.serverOffset||0);if(i&&i.expiresAt>s)return i.value;let r=await window.supabaseClient.from("memberships").select("id, profile_id, plan_id, status, started_at, expires_at, created_at").eq("profile_id",e).order("created_at",{ascending:!1}).limit(12);if(r.error&&this.isMissingColumnError(r.error)&&(r=await window.supabaseClient.from("memberships").select("id, profile_id, plan_id, status, started_at, expires_at").eq("profile_id",e).order("started_at",{ascending:!1}).limit(12)),r.error){const m={supported:!this.isMissingRelationError(r.error),activeMembership:null,plan:null,planKind:null};return this.membershipSnapshotCache.set(t,{value:m,expiresAt:s+this.membershipSnapshotTtlMs}),m}const l=(Array.isArray(r.data)?r.data:[]).find(u=>this.isMembershipActive(u,s))||null;if(!l||!l.plan_id){const u={supported:!0,activeMembership:null,plan:null,planKind:null};return this.membershipSnapshotCache.set(t,{value:u,expiresAt:s+this.membershipSnapshotTtlMs}),u}const o=await window.supabaseClient.from("membership_plans").select("id, name, price, billing_period_interval, billing_period_unit").eq("id",l.plan_id).maybeSingle();if(o.error){const u={supported:!this.isMissingRelationError(o.error),activeMembership:l,plan:null,planKind:null};return this.membershipSnapshotCache.set(t,{value:u,expiresAt:s+this.membershipSnapshotTtlMs}),u}const n=o.data||null,c={supported:!0,activeMembership:l,plan:n,planKind:this.getPlanKind(n)};return this.membershipSnapshotCache.set(t,{value:c,expiresAt:s+this.membershipSnapshotTtlMs}),c},async resolveCheckInPricing(e,t){var l;const i=String(t||"").toLowerCase(),s=["member","student","regular"].includes(i)?i:"regular";if(!e||!e.profile_id)return{entryType:s,entryFee:this.getEntryFeeByType(s),membershipLabel:this.getEntryLabelByType(s)};const r=await this.fetchMembershipSnapshot(e.profile_id),a=String(((l=r==null?void 0:r.plan)==null?void 0:l.name)||"").trim().toUpperCase();return r.supported?r.activeMembership?r.planKind==="monthly"?{entryType:"member",entryFee:0,membershipLabel:a||"MONTHLY SUBSCRIPTION (FREE ENTRY)"}:r.planKind==="yearly"?{entryType:"member",entryFee:this.pricing.yearlyDiscountedEntry,membershipLabel:a||"YEARLY SUBSCRIPTION (REGULAR ENTRY DISCOUNT)"}:{entryType:"member",entryFee:this.getEntryFeeByType("member"),membershipLabel:a||"ACTIVE MEMBERSHIP"}:{entryType:"member",entryFee:this.pricing.regular,membershipLabel:"MEMBER (NO ACTIVE SUBSCRIPTION)"}:{entryType:"member",entryFee:this.getEntryFeeByType("member"),membershipLabel:this.getEntryLabelByType("member")}},hideMemberSearchResults(e){const t=e==null?void 0:e.querySelector("#log-member-search-results");t&&(t.classList.remove("active"),t.innerHTML="")},renderMemberSearchResults(e,t=[]){const i=e==null?void 0:e.querySelector("#log-member-search-results");if(i){if(i.innerHTML="",!t||t.length===0){i.classList.remove("active");return}t.forEach(s=>{const r=String(s.member_code||s.sku||"").trim().toUpperCase(),a=String(s.full_name||"UNKNOWN MEMBER").trim().toUpperCase(),l=document.createElement("button");l.type="button",l.className="member-search-item",l.dataset.memberId=String(s.member_id||""),l.dataset.profileId=String(s.profile_id||""),l.dataset.memberCode=r,l.dataset.memberName=a;const o=document.createElement("span");o.className="member-search-main";const n=document.createElement("i");n.className="bx bx-badge-check";const c=document.createElement("span");c.className="member-search-name",c.textContent=a,o.appendChild(n),o.appendChild(c);const u=document.createElement("span");u.className="member-search-code",u.textContent=r||"MEMBER",l.appendChild(o),l.appendChild(u),i.appendChild(l)}),i.classList.add("active")}},async searchMembers(e){const t=String(e||"").trim();if(!t||!window.supabaseClient)return[];const i=t.replace(/[%(),]/g," "),{data:s,error:r}=await window.supabaseClient.from("members").select("member_id, profile_id, member_code, sku, full_name").or(`full_name.ilike.%${i}%,member_code.ilike.%${i}%,sku.ilike.%${i}%`).order("full_name",{ascending:!0}).limit(6);return r?[]:(s||[]).filter(a=>String(a.full_name||a.member_code||a.sku||"").trim().length>0)},clearSelectedMember(e){this.selectedProfileId=null,this.selectedMember=null;const t=e==null?void 0:e.querySelector("#log-guest-search");t&&(delete t.dataset.selectedMemberId,delete t.dataset.selectedMemberCode,delete t.dataset.selectedMemberLabel)},isInputPinnedToSelectedMember(e,t){const i=e==null?void 0:e.querySelector("#log-guest-search");if(!i||!this.selectedMember)return!1;const s=String(t||i.value||"").trim().toUpperCase(),r=String(i.dataset.selectedMemberLabel||"").trim().toUpperCase(),a=String(i.dataset.selectedMemberCode||"").trim().toUpperCase();return s?s===r||s===a:!1},applySelectedMember(e,t,i={}){if(!t)return;const{useCode:s=!1}=i,r=String(t.member_code||t.sku||"").trim().toUpperCase(),a=String(t.full_name||r||"MEMBER").trim().toUpperCase(),l=s&&r?r:a,o=e==null?void 0:e.querySelector("#log-guest-search");this.selectedProfileId=t.profile_id||null,this.selectedMember={member_id:t.member_id||null,profile_id:t.profile_id||null,member_code:r,sku:r,full_name:a},o&&(o.value=l,o.dataset.selectedMemberId=String(t.member_id||""),o.dataset.selectedMemberCode=r,o.dataset.selectedMemberLabel=l);const n=r?`MEMBER_LOCKED [${r}]`:"MEMBER_LOCKED";this.updateProtocolState(e,n,"status-member"),this.setEntryType(e,"member",{lock:!0}),this.hideMemberSearchResults(e)},updateEntrySummary(e){var a;const t=e==null?void 0:e.querySelector(".summary-val");if(!t)return;const i=((a=window.wolfData)==null?void 0:a.currencySymbol)||"PHP ",s=Number(this.selectedEntryFee||0),r=this.selectedPaid?"PAID":"UNPAID";t.innerText=`CHECK-IN | ${this.getEntryDisplayName(this.selectedEntryType)} | ${i}${s} | ${r}`},setEntryType(e,t,i={}){const{lock:s=!1}=i,r=String(t||"regular").toLowerCase(),a=["member","student","regular"].includes(r)?r:"regular";this.entryTypeLocked=!!s,this.selectedEntryType=this.entryTypeLocked?"member":a,this.selectedEntryFee=this.getEntryFeeByType(this.selectedEntryType),((e==null?void 0:e.querySelectorAll("[data-entry-tier]"))||[]).forEach(o=>{const n=String(o.dataset.entryTier||"").toLowerCase();o.classList.toggle("is-active",n===this.selectedEntryType),o.disabled=this.entryTypeLocked&&n!=="member"}),this.updateEntrySummary(e)},async openLogbookTerminal(e=""){console.log("Wolf OS: Initializing Logbook Entry Protocol..."),window.wolfAudio&&window.wolfAudio.play("notif"),window.wolfData&&window.wolfData.syncServerTime&&await window.wolfData.syncServerTime();const t=document.getElementById("logbook-modal-overlay");t&&t.remove();try{const s=await(await fetch("/assets/components/record-logbook-modal.html")).text();document.body.insertAdjacentHTML("beforeend",s);const r=document.getElementById("logbook-modal-overlay");if(await this.syncClockOffset(),r&&(this.selectedEntryType="regular",this.selectedEntryFee=this.getEntryFeeByType("regular"),this.selectedPaid=!1,this.entryTypeLocked=!1,this.memberSearchTimer=null,r.style.display="flex",this.attachLogbookListeners(r),this.startTerminalClock(r),this.setEntryType(r,"regular"),this.updateEntrySummary(r),e)){const a=r.querySelector("#log-guest-search");a&&(a.value=String(e).trim().toUpperCase(),await this.syncIdentityFromInput(r,a.value,{forceResolve:!0}))}}catch(i){console.error("Wolf OS: Modal Load Fault:",i)}},updateProtocolState(e,t,i="status-ready"){const s=e.querySelector(".node-value.status-ready, .node-value.status-warn, .node-value.status-member");s&&(s.className=`node-value ${i}`,s.innerText=t)},async resolveMemberIdentity(e,t={}){const i=String(e||"").trim(),s=String(t.mode||"strict").toLowerCase();if(!i||!window.supabaseClient)return null;const r="member_id, profile_id, member_code, sku, full_name";if(/^ME-[A-Z0-9]{2,}$/i.test(i)){const o=i.toUpperCase(),{data:n,error:c}=await window.supabaseClient.from("members").select(r).or(`member_code.eq.${o},sku.eq.${o}`).limit(1);return c?null:(n==null?void 0:n[0])||null}if(s==="fuzzy"){const o=i.replace(/[%(),]/g," "),{data:n,error:c}=await window.supabaseClient.from("members").select(r).or(`full_name.ilike.%${o}%,member_code.ilike.%${o}%,sku.ilike.%${o}%`).order("full_name",{ascending:!0}).limit(1);return c?null:(n==null?void 0:n[0])||null}const{data:a,error:l}=await window.supabaseClient.from("members").select(r).ilike("full_name",i).limit(1);return l?null:(a==null?void 0:a[0])||null},async syncIdentityFromInput(e,t,i={}){var o,n;const s=String(t||"").trim();if(!s){this.clearSelectedMember(e),this.hideMemberSearchResults(e),this.updateProtocolState(e,"AWAITING_AUTH","status-ready"),this.setEntryType(e,"regular",{lock:!1});return}if(this.isInputPinnedToSelectedMember(e,s)){const c=String(((o=this.selectedMember)==null?void 0:o.member_code)||((n=this.selectedMember)==null?void 0:n.sku)||"").trim().toUpperCase(),u=c?`MEMBER_LOCKED [${c}]`:"MEMBER_LOCKED";this.updateProtocolState(e,u,"status-member"),this.setEntryType(e,"member",{lock:!0});return}let r=null;const a=!!i.forceResolve;if((/^ME-[A-Z0-9]{2,}$/i.test(s)||a)&&(r=await this.resolveMemberIdentity(s,{mode:"strict"})),r){this.applySelectedMember(e,r,{useCode:/^ME-[A-Z0-9]{2,}$/i.test(s)});return}this.clearSelectedMember(e),this.updateProtocolState(e,"WALK-IN_PENDING","status-warn");const l=this.selectedEntryType==="member"?"regular":this.selectedEntryType;this.setEntryType(e,l,{lock:!1})},async syncClockOffset(){try{const{data:e,error:t}=await supabaseClient.rpc("get_server_time");if(t)throw t;const i=Array.isArray(e)?e[0].server_iso_timestamp||e[0]:e;if(!i)throw new Error("Null Timestamp Received");const s=new Date(i).getTime(),r=Date.now();this.serverOffset=s-r,console.log(`Wolf OS: Time Delta Calibrated [${this.serverOffset}ms]`)}catch(e){console.warn("Wolf OS: RPC Sync Failed, defaulting to Local Time."),this.serverOffset=0}},startTerminalClock(e){const t=e.querySelector("#log-current-time");t&&(this.clockInterval&&clearInterval(this.clockInterval),this.clockInterval=setInterval(()=>{const i=new Date(Date.now()+this.serverOffset);if(isNaN(i.getTime())){t.innerText="SYNCING...";return}t.innerText=i.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0})},1e3))},attachLogbookListeners(e){const t=e.querySelector("#record-logbook-form"),i=e.querySelector("#closeLogModal"),s=e.querySelector("#log-guest-search"),r=e.querySelector("#log-member-search-results"),a=e.querySelectorAll("[data-entry-tier]"),l=e.querySelector("#log-paid-toggle");a&&a.length>0&&a.forEach(n=>{n.addEventListener("click",()=>{const c=n.dataset.entryTier||"regular";this.setEntryType(e,c,{lock:!1})})}),l&&(l.checked=!1,l.addEventListener("change",()=>{this.selectedPaid=!!l.checked,this.updateEntrySummary(e)})),r&&r.addEventListener("click",n=>{const c=n.target.closest(".member-search-item");if(!c)return;const u={member_id:c.dataset.memberId||null,profile_id:c.dataset.profileId||null,member_code:c.dataset.memberCode||"",sku:c.dataset.memberCode||"",full_name:c.dataset.memberName||""};this.applySelectedMember(e,u,{useCode:!1}),s&&s.focus()}),t.onsubmit=async n=>{n.preventDefault();const c=s.value.trim(),u=e.querySelector("#log-submit-btn");c&&(u.disabled=!0,u.querySelector("span").innerText="AUTHORIZING...",await this.processCheckIn(c,{entryType:this.selectedEntryType,isPaid:this.selectedPaid}),this.closeLogbookTerminal())},s&&(s.addEventListener("input",()=>{s.value=s.value.toUpperCase();const n=String(s.value||"").trim();this.isInputPinnedToSelectedMember(e,n)||this.clearSelectedMember(e),this.memberSearchTimer&&clearTimeout(this.memberSearchTimer),this.memberSearchTimer=setTimeout(async()=>{if(!n){this.hideMemberSearchResults(e),await this.syncIdentityFromInput(e,n);return}if(/^ME-[A-Z0-9]{2,}$/i.test(n)){this.hideMemberSearchResults(e),await this.syncIdentityFromInput(e,n,{forceResolve:!0});return}const c=await this.searchMembers(n);this.renderMemberSearchResults(e,c),await this.syncIdentityFromInput(e,n)},170)}),s.addEventListener("focus",async()=>{const n=String(s.value||"").trim();if(!n||/^ME-[A-Z0-9]{2,}$/i.test(n)||this.isInputPinnedToSelectedMember(e,n))return;const c=await this.searchMembers(n);this.renderMemberSearchResults(e,c)}),s.addEventListener("blur",()=>{setTimeout(()=>this.hideMemberSearchResults(e),120)})),i&&(i.onclick=n=>{n.preventDefault(),this.closeLogbookTerminal()}),e.onclick=n=>{n.target.id==="logbook-modal-overlay"&&this.closeLogbookTerminal()};const o=n=>{n.key==="Escape"&&(this.closeLogbookTerminal(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o),setTimeout(()=>{s&&s.focus()},200)},closeLogbookTerminal(){const e=document.getElementById("logbook-modal-overlay");if(e){const t=e.querySelector(".wolf-modal-card");e.classList.add("closing"),t&&t.classList.add("closing"),clearInterval(this.clockInterval),setTimeout(()=>e.remove(),260)}this.memberSearchTimer&&(clearTimeout(this.memberSearchTimer),this.memberSearchTimer=null)},async processCheckIn(e,t={}){var i;try{const s=String(e||"").trim(),r=this.selectedMember||await this.resolveMemberIdentity(s),a=String(t.entryType||this.selectedEntryType||"regular").toLowerCase(),l=r?"member":["member","student","regular"].includes(a)?a:"regular",o=await this.resolveCheckInPricing(r,l),n=o.entryType,c=Number(o.entryFee||0),u=!!t.isPaid,m=u?c:0,h=(r==null?void 0:r.full_name)||s,f=String((r==null?void 0:r.member_code)||(r==null?void 0:r.sku)||"").trim().toUpperCase(),y=o.membershipLabel||this.getEntryLabelByType(n),g=[f,h.toUpperCase()].filter(Boolean).join(" ").trim(),b=r?`MEMBER_ENTRY: ${g}`:`WALK-IN: ${h.toUpperCase()}`,S=typeof((i=window.wolfData)==null?void 0:i.buildLogNotes)=="function"?window.wolfData.buildLogNotes(b,y,u,m):b,p={profile_id:(r==null?void 0:r.profile_id)||this.selectedProfileId||null,source:r?"MEMBER":"TERMINAL",notes:S,membership_label:y,entry_fee:c,is_paid:u,paid_amount:m,paid_at:u?new Date().toISOString():null};let{error:d}=await supabaseClient.from("check_in_logs").insert([p]);if(d&&/column .* does not exist|schema cache/i.test(String(d.message||""))){const{error:w}=await supabaseClient.from("check_in_logs").insert([{profile_id:p.profile_id,source:p.source,notes:p.notes}]);d=w}if(d)throw d;window.salesManager&&window.salesManager.showSystemAlert(`ACCESS GRANTED: ${h}`,"success"),window.wolfAudio&&window.wolfAudio.play("success"),window.wolfData&&window.wolfData.loadLogbook&&window.wolfData.loadLogbook()}catch(s){console.error("Logbook Protocol Fault:",s),window.wolfAudio&&window.wolfAudio.play("error"),window.salesManager&&window.salesManager.showSystemAlert("DATABASE_REJECTED_ENTRY","error")}}};
