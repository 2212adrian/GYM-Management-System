async function moveToTrash(e,t,a){console.log(`Wolf OS: Moving ${t} from ${e} to Trash...`);const{error:o}=await supabaseClient.from("trash_bin").insert([{original_table:e,original_id:t,payload:a}]);if(o)throw o}window.wolfData=null;const wolfData={selectedDate:new Date,serverToday:new Date,activeMode:"sales",isFetching:!1,allSales:[],lastTotal:0,activeAF:null,lastTraffic:0,summaryHUDReady:!1,currencySymbol:"₱",defaultWalkInFee:80,goalTargets:{DAILY:0,WEEKLY:0,MONTHLY:0},formatCurrency(e=0){return`${this.currencySymbol}${Number(e||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`},isMoneyMode(){return this.activeMode==="sales"||this.activeMode==="logbook"},syncNavigationUI(e){console.log(`Wolf OS: Navigation UI Lock engaged for [${e}]`),document.querySelectorAll(".nav-item[data-page], .sidebar-link[data-page]").forEach(a=>{a.getAttribute("data-page")===e?a.classList.add("active"):a.classList.remove("active")})},animateValue(e,t,a,o){this.activeAF&&cancelAnimationFrame(this.activeAF);let n=null;const s=this.isMoneyMode(),d=l=>{n||(n=l);const r=Math.min((l-n)/o,1),u=r*(a-t)+t;s?e.textContent=this.formatCurrency(u):e.textContent=Math.floor(u),r<1?this.activeAF=window.requestAnimationFrame(d):(this.activeAF=null,setTimeout(()=>{this.activeAF||e.classList.remove("increasing","decreasing")},300))};this.activeAF=window.requestAnimationFrame(d)},refreshSummaryHUD(e=null){const t=document.getElementById("ledger-summary-amount");if(!t)return;let a=e!==null?e:(this.allSales||[]).reduce((o,n)=>o+Number(n.total_amount||0),0);if(!this.summaryHUDReady){this.lastTotal=a,t.textContent=this.isMoneyMode()?this.formatCurrency(a):a,this.summaryHUDReady=!0;return}a!==this.lastTotal&&(t.classList.remove("increasing","decreasing"),t.offsetWidth,a>this.lastTotal?t.classList.add("increasing"):t.classList.add("decreasing"),this.animateValue(t,this.lastTotal,a,800),this.lastTotal=a,this.activeMode==="sales"&&this.updateTargetBox(a))},async loadGoalTargets(){if(!window.supabaseClient)return;const e=["DAILY","WEEKLY","MONTHLY"];for(const t of e){const{data:a,error:o}=await supabaseClient.from("goal_target").select("*").eq("period_type",t).order("start_date",{ascending:!1}).limit(1);!o&&a&&a.length>0&&(this.goalTargets[t]=Number(a[0].target_amount||0))}this.updateTargetBox(this.lastTotal)},updateTargetBox(e=0){var s;const t=Number(((s=this.goalTargets)==null?void 0:s.DAILY)||0),a=document.getElementById("sidebar-target-percent"),o=document.getElementById("sidebar-target-bar");if(!a||!o)return;if(t<=0){a.textContent="0%",o.style.width="0%";return}const n=Math.min(100,Math.max(0,e/t*100));a.textContent=`${Math.round(n)}%`,o.style.width=`${n}%`},async addSaleRow(e){const t=document.getElementById("ledger-list-container");if(!t)return;const a=this.renderSingleSaleCard(e,0);t.insertAdjacentHTML("afterbegin",a),form.addEventListener("submit",async o=>{var g,f;o.preventDefault();const n=skuInput.value.trim(),s=nameInput.value.trim(),d=parseFloat(priceInput.value||"0"),l=unlimitedCheckbox!=null&&unlimitedCheckbox.checked?999999:parseInt(qtyInput.value||"0",10),r=((g=document.getElementById("master-desc"))==null?void 0:g.value)||null,u=((f=document.getElementById("master-brand"))==null?void 0:f.value)||null;if(!s||!l||!d){statusEl&&(statusEl.textContent="Name, quantity, and price are required.");return}if(!n&&!selectedImageUrl){statusEl&&(statusEl.textContent="Please select one image before adding to sales.");return}try{let c=form.dataset.productId||null;if(!c){const{data:p,error:y}=await supabaseClient.from("products").insert({sku:n||void 0,name:s,description:r,price:d,qty:l,image_url:selectedImageUrl||null,is_active:!0}).select().single();if(y)throw y;c=p.productid}const{data:m,error:h}=await supabaseClient.from("sales").insert({productid:c,qty:l,price:d}).select().single();if(h)throw h;window.wolfData&&typeof window.wolfData.addSaleRow=="function"&&window.wolfData.addSaleRow(m),statusEl&&(statusEl.textContent="Sale added."),modal.style.display="none"}catch(i){console.error(i),statusEl&&(statusEl.textContent="Error adding sale.")}})},updateSaleRow(e){const t=this.salesData.findIndex(a=>a.id===e.id);t>-1&&(this.salesData[t]=e),this.updateLedgerRevenue(),Toastify({text:`Sale updated: ${e.id}`,duration:2e3,gravity:"top",position:"right"}).showToast()},removeSaleRow(e){const t=document.getElementById(`row-${e}`);t&&(t.classList.add("removing"),setTimeout(()=>t.remove(),400)),this.allSales=(this.allSales||[]).filter(a=>a.id!==e),this.refreshSummaryHUD(),alert("test")},updateProductUI(e){Toastify({text:`Product updated: ${e.name}`,duration:2e3,gravity:"top",position:"right",backgroundColor:"#ff9800"}).showToast()},updateLedgerRevenue(){const e=document.getElementById("ledger-summary-amount");if(!e)return;const t=(this.allSales||[]).reduce((a,o)=>a+Number(o.total_amount||0),0);if(this.currentTotal===0&&t!==0){this.currentTotal=t,e.textContent=this.formatCurrency(t);return}t!==this.currentTotal&&(t>this.currentTotal?e.className="summary-value increasing":e.className="summary-value decreasing",this.animateNumber(e,this.currentTotal,t),this.currentTotal=t)},async syncServerTime(){console.log("Wolf OS: Synchronizing with Atomic Clock...");try{const{data:e,error:t}=await supabaseClient.rpc("get_server_time");if(t)throw t;const a=Array.isArray(e)?e[0]:e;if(a)this.selectedDate=new Date(a),this.serverToday=new Date(a);else throw new Error("No timestamp returned")}catch(e){console.error("Wolf OS: Sync Fault. Falling back to system clock.",e),this.selectedDate=new Date,this.serverToday=new Date}isNaN(this.selectedDate.getTime())&&(this.selectedDate=new Date,this.serverToday=new Date)},async syncTime(){console.log("Wolf OS: Syncing with Atomic Server Clock...");try{const{data:e,error:t}=await supabaseClient.rpc("get_server_time");if(e&&e[0]){const a=e[0].server_date.split("-");this.serverToday=new Date(a[0],a[1]-1,a[2]),this.selectedDate=new Date(this.serverToday)}}catch(e){console.warn("Wolf OS: Time Sync Failed, using local clock.")}return this.selectedDate},get realTodayIndex(){return new Date().getDay()},get realTodayISO(){return new Date().toISOString().split("T")[0]},async initLedger(e){this.activeMode=e,this.lastTotal=0,this.summaryHUDReady=!1,await this.syncTime();const t=document.getElementById("ledger-title"),a=document.getElementById("ledger-summary-label"),o=document.getElementById("ledger-search-container");t&&(e==="sales"?(t.innerText="SALES",a.innerText="Daily Income Summary"):(t.innerText="LOGBOOK",a.innerText="Floor Income Summary")),o&&(o.style.display="block",o.classList.remove("active")),this.syncNavigationUI(e),this.initChrono(e),await this.syncServerTime(),await this.loadGoalTargets()},initChrono(e){if(this.fp&&typeof this.fp.destroy=="function")try{this.fp.destroy()}catch(s){console.warn("Wolf OS: Non-critical - could not destroy old flatpickr instance.")}this.fp=null;const t=document.getElementById("chrono-picker-trigger"),a=document.getElementById("hidden-chrono-input");if(!a){console.error("Wolf OS: Chrono Input not found in DOM.");return}const o=this.serverToday||new Date,n=flatpickr(a,{disableMobile:!0,maxDate:o,animate:!0,positionElement:t,position:"below",onReady:(s,d,l)=>{const r=l.calendarContainer;r.classList.remove("wolf-calendar-v2","wolf-calendar-v3"),r.classList.add("wolf-calendar"),r.classList.remove("open")},onOpen:(s,d,l)=>{requestAnimationFrame(()=>{l.calendarContainer.classList.add("open")})},onClose:(s,d,l)=>{l.calendarContainer.classList.remove("open")},onChange:s=>{s.length>0&&(this.selectedDate=s[0],this.calculateWeek(e))}});this.fp=Array.isArray(n)?n[0]:n,t&&this.fp&&(t.onclick=null,t.onclick=s=>{s.preventDefault(),s.stopPropagation(),this.fp.isOpen?this.fp.close():this.fp.open()}),this.calculateWeek(e)},calculateWeek(e){const t=new Date(this.selectedDate),a=t.getDay(),o=new Date(t);o.setDate(t.getDate()-a);const n=new Date(o);n.setDate(o.getDate()+6),this.updateChronoUI(o,n,a,e)},shiftWeek(e,t){this.selectedDate.setDate(this.selectedDate.getDate()+e),this.calculateWeek(t)},async updateChronoUI(e,t,a){if(!e||isNaN(e.getTime())||!t||isNaN(t.getTime()))return;this.fp&&typeof this.fp.setDate=="function"&&this.fp.setDate(this.selectedDate,!1);const o=c=>c.toLocaleDateString("en-US",{month:"short",day:"numeric"}).toUpperCase(),n=document.getElementById("week-range-display");n&&(n.innerText=`${o(e)} - ${o(t)}`);const s=this.serverToday||new Date,d=s.toLocaleDateString("en-CA"),l=new Date(s);l.setDate(s.getDate()-s.getDay());const r=l.toLocaleDateString("en-CA"),u=e.toLocaleDateString("en-CA"),g=document.getElementById("snap-today-btn");g&&(u<r?g.classList.add("visible"):g.classList.remove("visible")),document.querySelectorAll("#ledger-day-picker .day-btn").forEach((c,m)=>{const h=new Date(e);h.setDate(e.getDate()+m);const p=h.toLocaleDateString("en-CA");c.setAttribute("data-date",p),c.classList.toggle("active",m===a),c.disabled=p>d});const i=this.selectedDate.toLocaleDateString("en-CA");this.isReadOnly=i!==d,this.applyLockdownUI(),this.activeMode==="sales"?await this.loadSales():await this.loadLogbook()},currentLogDay:new Date().getDay(),currentSalesDay:new Date().getDay(),realToday:new Date().getDay(),salesDataCache:[],sanitizePlain(e){const t=String(e!=null?e:"");return window.DOMPurify?window.DOMPurify.sanitize(t,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]}):t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},parseLogNotes(e=""){var l,r,u;const t=String(e||""),a=t.match(/\|MEMBERSHIP:([^|]+)/i),o=t.match(/\|PAID:([0-9]+(?:\.[0-9]+)?)/i),n=t.match(/^WALK-IN:\s*([^|]+)/i),s=t.match(/^MEMBER_ENTRY:\s*([^|]+)/i),d=t.replace(/\|MEMBERSHIP:[^|]*/gi,"").replace(/\|PAID:[^|]*/gi,"").trim();return{raw:t,baseNote:d,membershipLabel:((l=a==null?void 0:a[1])==null?void 0:l.trim())||"",isPaidFromNote:!!o,paidAmountFromNote:o?Number(o[1]):null,walkInName:((r=n==null?void 0:n[1])==null?void 0:r.trim())||"",memberToken:((u=s==null?void 0:s[1])==null?void 0:u.trim())||""}},buildLogNotes(e,t,a,o){const s=[String(e||"").trim()||"WALK-IN: GUEST"];return t&&s.push(`MEMBERSHIP:${String(t).trim().toUpperCase()}`),a&&s.push(`PAID:${Number(o||0).toFixed(2)}`),s.join("|")},async loadLogbook(){window.salesManager&&(window.salesManager.currentTrashMode="logbook");const e=document.getElementById("ledger-list-container");if(!e)return;e.children.length===0&&(e.innerHTML=`<div style="text-align:center; padding:50px; opacity:0.3;"><i class='bx bx-loader-alt bx-spin' style='font-size:2rem;'></i></div>`);const t=this.selectedDate.toLocaleDateString("en-CA");try{const{data:a,error:o}=await supabaseClient.from("check_in_logs").select("*").gte("time_in",`${t}T00:00:00+08:00`).lte("time_in",`${t}T23:59:59+08:00`).order("time_in",{ascending:!1});if(o)throw o;const n=a||[],s=[...new Set(n.map(i=>i.profile_id).filter(Boolean))];let d=new Map;if(s.length>0){const{data:i,error:c}=await supabaseClient.from("members").select("profile_id, full_name, member_code").in("profile_id",s);!c&&i&&(d=new Map(i.map(m=>[m.profile_id,m])))}let l=n.map(i=>{var L,E,C,k,I;const c=this.parseLogNotes(i.notes),m=i.profile_id?d.get(i.profile_id):null,h=((L=c.memberToken.match(/ME-[A-Z0-9]{2,}/i))==null?void 0:L[0])||"",p=c.memberToken.replace(/ME-[A-Z0-9]{2,}/gi,"").trim(),y=!!(m||h||i.profile_id),v=(m==null?void 0:m.full_name)||c.walkInName||p||c.memberToken||"Walk-in Guest",D=this.sanitizePlain(v).toUpperCase(),T=this.sanitizePlain(String((m==null?void 0:m.member_code)||h||"").toUpperCase()),S=this.sanitizePlain(String(i.membership_label||c.membershipLabel||(y?"MONTHLY MEMBERSHIP":"REGULAR (NON-MEMBER)")).toUpperCase()),b=Number((C=(E=i.entry_fee)!=null?E:c.paidAmountFromNote)!=null?C:y?0:this.defaultWalkInFee),w=!!(typeof i.is_paid=="boolean"?i.is_paid:c.isPaidFromNote),x=Number((I=i.paid_amount)!=null?I:w?(k=c.paidAmountFromNote)!=null?k:b:0);return{...i,resolvedName:D,memberCode:T,membershipLabel:S,entryFee:b,isPaid:w,paidAmount:w?x:0,noteBase:c.baseNote}});const r=document.getElementById("ledger-main-search");if(r&&r.value){const i=r.value.toLowerCase();l=l.filter(c=>c.resolvedName.toLowerCase().includes(i)||c.membershipLabel.toLowerCase().includes(i)||c.memberCode.toLowerCase().includes(i))}const u=document.getElementById("ledger-summary-label"),g=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];u&&(u.innerText=`${g[this.selectedDate.getDay()]} Floor Income`);const f=l.reduce((i,c)=>i+(c.isPaid?Number(c.paidAmount||0):0),0);if(this.refreshSummaryHUD(f),l.length===0){e.innerHTML=`<div style="text-align:center; padding:80px; opacity:0.2;"><i class='bx bx-user-x' style='font-size:3rem;'></i><p style="font-size:10px; font-weight:900; margin-top:10px;">NO DATA LOGGED</p></div>`;return}e.innerHTML=l.map((i,c)=>{const m=i.time_out!==null,h=new Date(i.time_in).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),p=m?new Date(i.time_out).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"--:--",y=i.isPaid?"badge-paid":"badge-unpaid",v=i.isPaid?"PAID":"UNPAID",D=m?"UNDO CHECK OUT":"CHECK OUT",T=m?"btn-logbook-neutral":"btn-logbook-danger",S=i.isPaid?"UNDO PAID":`COLLECT ${this.formatCurrency(i.entryFee)}`,b=i.isPaid?"btn-logbook-neutral":"btn-logbook-success",w=this.isReadOnly?"disabled":"";return`
          <div class="list-item-card" id="row-${i.id}" style="animation-delay: ${c*.04}s;">
            <div class="card-header" style="margin-bottom:0;">
              <div class="status-icon ${m?"":"active"}" style="background:var(--bg-dark); color:var(--wolf-red);">
                <i class='bx ${m?"bx-check":"bx-time-five"}'></i>
              </div>
              <div class="item-info">
                <h4 style="font-size:13px; font-weight:800;">${i.resolvedName}</h4>
                <div class="sub" style="font-size:11px;">${i.membershipLabel}${i.memberCode?` • ${i.memberCode}`:""}</div>
                <div class="time" style="font-size:10px; color:#555;">IN: ${h}</div>
              </div>
              <div class="card-actions">
                <span class="${y}">${v}</span>
                ${this.isReadOnly?"":`<i class='bx bx-trash action-small' style="cursor:pointer;" onclick="wolfData.deleteLog('${i.id}')"></i>`}
              </div>
            </div>
            <div class="card-details logbook-details">
              <div class="detail-group">
                <label>ENTRY FEE</label>
                <div class="val">${this.formatCurrency(i.entryFee)}</div>
              </div>
              <div class="detail-group" style="text-align:right;">
                <label>SESSION END</label>
                <div class="val" style="font-size:1rem;">${p}</div>
              </div>
            </div>
            <div class="logbook-action-row">
              <button class="logbook-action-btn ${T}" ${w} onclick="wolfData.toggleLogCheckout('${i.id}', ${m})">${D}</button>
              <button class="logbook-action-btn ${b}" ${w} onclick="wolfData.toggleLogPaid('${i.id}', ${i.isPaid}, ${i.entryFee})">${S}</button>
            </div>
          </div>`}).join("")}catch(a){console.error("Wolf OS Logbook Fault:",a)}},async loadSales(){if(window.salesManager&&(window.salesManager.currentTrashMode="sales"),this.isFetching)return;this.isFetching=!0;const e=document.getElementById("ledger-list-container");if(!e)return;e.children.length===0&&(e.innerHTML=`<div style="text-align:center; padding:50px; opacity:0.3;"><i class='bx bx-loader-alt bx-spin' style='font-size:2rem;'></i></div>`);const t=this.selectedDate.toLocaleDateString("en-CA");try{const{data:a,error:o}=await supabaseClient.from("sales").select("*, products(name, sku)").gte("created_at",`${t}T00:00:00+08:00`).lte("created_at",`${t}T23:59:59+08:00`).order("created_at",{ascending:!1});if(o)throw o;this.allSales=a||[];const n=document.getElementById("ledger-main-search"),s=n?n.value:"";this.renderSales(this.selectedDate.getDay(),s)}catch(a){console.error("Wolf OS Sales Fault:",a)}finally{this.isFetching=!1}},renderSales(e,t=""){const a=document.getElementById("ledger-list-container");if(!a)return;const o=document.getElementById("ledger-summary-label"),n=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];o&&(o.innerText=`${n[e]} Total Income`);let s=[...this.allSales];if(t!==""){const l=t.toLowerCase();s=s.filter(r=>{var f,i;const u=String(((f=r.products)==null?void 0:f.name)||"").toLowerCase(),g=String(((i=r.products)==null?void 0:i.sku)||"").toLowerCase();return u.includes(l)||g.includes(l)})}const d=s.reduce((l,r)=>l+Number(r.total_amount||0),0);if(this.refreshSummaryHUD(d),s.length===0){a.innerHTML=`<div style="text-align:center; padding:80px; opacity:0.2;"><i class='bx bx-shopping-bag' style='font-size:3rem;'></i><p style="font-size:10px; font-weight:900; margin-top:10px;">NO DATA LOGGED</p></div>`;return}a.innerHTML=s.map((l,r)=>{var c,m;const u=Number(l.total_amount||0),g=DOMPurify.sanitize(((c=l.products)==null?void 0:c.name)||"Item"),f=DOMPurify.sanitize(((m=l.products)==null?void 0:m.sku)||"N/A"),i=new Date(l.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return`
        <div class="list-item-card" id="row-${l.id}" style="animation-delay: ${r*.06}s;">
          <div class="card-header" style="margin-bottom: 0;">
            <div class="status-icon" style="background: var(--bg-dark); color: var(--wolf-red);"><i class='bx bx-shopping-bag'></i></div>
            <div class="item-info">
              <h4 style="font-size:13px; font-weight:800;">${g.toUpperCase()}</h4>
              <div class="time" style="font-size:10px; color:#555;">${i} • x${l.qty} • ${f}</div>
            </div>
            <div class="card-actions" style="text-align:right;">
              <div style="color: var(--wolf-red); font-weight: 900; font-family: 'JetBrains Mono'; font-size:14px;">
                ${this.formatCurrency(u)}
              </div>
              ${this.isReadOnly?"":`<i class='bx bx-trash' style="cursor:pointer; color:#333; font-size:14px;" onclick="wolfData.deleteSale('${l.id}')"></i>`}
            </div>
          </div>
        </div>`}).join("")},updateDayUI(e,t){t=parseInt(t),this.realToday=new Date().getDay();const a=e==="logbook"?"#logbook-day-picker":"#sales-day-picker";document.querySelectorAll(`${a} .day-btn`).forEach(n=>{const s=parseInt(n.getAttribute("data-day"));n.classList.toggle("active",s===t),s>this.realToday?n.disabled=!0:n.disabled=!1}),this.isReadOnly=t!==this.realToday,this.applyLockdownUI()},applyLockdownUI(){var o,n;const e=document.querySelector(".icon-btn.red"),t=(o=document.querySelector(".icon-btn:not(.red) i.bx-trash"))==null?void 0:o.parentElement,a=document.querySelector(".brand");this.isReadOnly?(e&&e.classList.add("crud-hidden"),t&&t.classList.add("crud-hidden"),a&&!document.querySelector(".archive-mode-indicator")&&a.insertAdjacentHTML("beforebegin",'<span class="archive-mode-indicator">[ ARCHIVE_LOCKED ]</span>')):(e&&e.classList.remove("crud-hidden"),t&&t.classList.remove("crud-hidden"),(n=document.querySelector(".archive-mode-indicator"))==null||n.remove())},toggleReadOnlyMode(e){var o;const t=document.querySelector(".icon-btn.red"),a=(o=document.querySelector(".icon-btn:not(.red) i.bx-trash"))==null?void 0:o.parentElement;t&&t.classList.toggle("crud-hidden",e),a&&a.classList.toggle("crud-hidden",e),this.isReadOnly=e},async toggleLogCheckout(e,t){if(!this.isReadOnly)try{const a=t?null:new Date().toISOString(),{error:o}=await supabaseClient.from("check_in_logs").update({time_out:a}).eq("id",e);if(o)throw o;window.wolfAudio&&window.wolfAudio.play("notif"),await this.loadLogbook()}catch(a){console.error("Wolf OS Checkout Toggle Fault:",a),window.wolfAudio&&window.wolfAudio.play("error")}},async toggleLogPaid(e,t,a=0){var o,n,s;if(!this.isReadOnly)try{const{data:d,error:l}=await supabaseClient.from("check_in_logs").select("*").eq("id",e).single();if(l||!d)throw l||new Error("Log row not found");const r=this.parseLogNotes(d.notes),u=String(d.membership_label||r.membershipLabel||(d.profile_id?"MONTHLY MEMBERSHIP":"REGULAR (NON-MEMBER)")).trim().toUpperCase(),g=Number((s=(n=(o=d.entry_fee)!=null?o:r.paidAmountFromNote)!=null?n:a)!=null?s:d.profile_id?0:this.defaultWalkInFee),f=!t,i=f?g:0,c=f?new Date().toISOString():null,m=this.buildLogNotes(r.baseNote,u,f,i),h={notes:m,membership_label:u,entry_fee:g,is_paid:f,paid_amount:i,paid_at:c};let{error:p}=await supabaseClient.from("check_in_logs").update(h).eq("id",e);if(p&&/column .* does not exist|schema cache|invalid input syntax/i.test(String(p.message||""))&&(p=(await supabaseClient.from("check_in_logs").update({notes:m}).eq("id",e)).error),p)throw p;window.wolfAudio&&window.wolfAudio.play("success"),await this.loadLogbook()}catch(d){console.error("Wolf OS Payment Toggle Fault:",d),window.wolfAudio&&window.wolfAudio.play("error")}},async deleteLog(e){if(!(!window.Swal||!(await window.Swal.fire({title:"REMOVE ENTRY?",html:'<p class="wolf-swal-text">WARNING: THIS RECORD WILL BE MOVED TO TRASH bin. PROCEED?</p>',showCancelButton:!0,confirmButtonText:"REMOVE",cancelButtonText:"CANCEL",background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup-orange",confirmButton:"wolf-swal-confirm-orange",cancelButton:"wolf-swal-cancel"}})).isConfirmed))try{const a=document.getElementById(`row-${e}`);a&&(a.classList.add("removing"),await new Promise(n=>setTimeout(n,400)),a.remove());const{data:o}=await supabaseClient.from("check_in_logs").select("*").eq("id",e).single();await supabaseClient.from("trash_bin").insert([{original_id:e,table_name:"check_in_logs",deleted_data:o}]),await supabaseClient.from("check_in_logs").delete().eq("id",e),window.wolfAudio&&window.wolfAudio.play("notif"),await this.loadLogbook()}catch(a){console.error(a)}},async deleteSale(e){if(!window.Swal||!(await window.Swal.fire({title:"REMOVE PRODUCT?",html:`
      <div style="color: #b47023; font-size: 4.5rem; margin-bottom: 10px;">
        <i class='bx bx-error-alt'></i>
      </div>
      <p class="wolf-swal-text" style="text-transform: uppercase; letter-spacing: 1px;">
        WARNING: THIS RECORD WILL BE MOVED TO TRASH BIN. PROCEED?
      </p>
    `,showCancelButton:!0,confirmButtonText:"REMOVE",cancelButtonText:"CANCEL",reverseButtons:!0,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup-orange",title:"wolf-swal-title",confirmButton:"wolf-swal-confirm-orange",cancelButton:"wolf-swal-cancel"}})).isConfirmed)return;const a=document.getElementById(`row-${e}`);try{a&&(a.classList.add("removing"),await new Promise(r=>setTimeout(r,400)),a.remove());const{data:o,error:n}=await supabaseClient.from("sales").select("*").eq("id",e).single();if(n||!o)throw n;const{data:s}=await supabaseClient.from("products").select("qty, name").eq("productid",o.product_id).single();s&&s.qty<999999&&await supabaseClient.from("products").update({qty:s.qty+o.qty}).eq("productid",o.product_id),await supabaseClient.from("trash_bin").insert([{original_id:e,table_name:"sales",deleted_data:o}]),await supabaseClient.from("sales").delete().eq("id",e),this.allSales=(this.allSales||[]).filter(r=>r.id!==e);const d=this.allSales.reduce((r,u)=>r+Number(u.total_amount||0),0);this.refreshSummaryHUD(d);const l=`${(s==null?void 0:s.name)||"Product"}, X${o.qty} WAS REMOVED`;window.salesManager.showSystemAlert(l,"success"),Toastify({text:l,duration:5e3,gravity:"top",position:"right",stopOnFocus:!0,style:{border:"1px solid #ff9800",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast(),window.wolfAudio&&window.wolfAudio.play("success")}catch(o){console.error("Void Protocol Fault:",o),window.wolfAudio&&window.wolfAudio.play("error"),this.loadSales()}},async reopenLog(e){await supabaseClient.from("check_in_logs").update({time_out:null}).eq("id",e),this.loadLogbook(this.currentLogDay)},addLogbookRow(){this.loadLogbook()},updateLogbookRow(){this.loadLogbook()},removeLogbookRow(){this.loadLogbook()}};window.wolfData=wolfData,wolfData.addSaleRow=function(e){Array.isArray(this.salesData)||(this.salesData=[]),this.salesData.push(e);const t=document.querySelector("#sales-table-body");if(t){const a=document.createElement("tr");a.id=`sale-row-${e.id}`,a.innerHTML=`
      <td>${e.id}</td>
      <td>${e.product_name}</td>
      <td>${e.quantity}</td>
      <td>${e.price}</td>
      <td>${(e.quantity*e.price).toFixed(2)}</td>
      <td><button onclick="wolfData.deleteSale('${e.id}')">Delete</button></td>
    `,t.appendChild(a)}this.updateLedgerRevenue()},wolfData.removeSaleRow=function(e){this.allSales=(this.allSales||[]).filter(a=>a.id!==e);const t=document.getElementById(`row-${e}`);t&&t.remove(),this.updateLedgerRevenue()},wolfData.initRealtime=async function(){if(this.updateLedgerRevenue(),this.realtimeChannel)return;this.selectedDate||await this.syncServerTime();const e=supabaseClient.channel("wolf-ledger-sync-stable").on("postgres_changes",{event:"INSERT",schema:"public",table:"sales"},a=>{if(this.activeMode!=="sales")return;const o=a.new;this.allSales.unshift(o),this.renderSales(this.selectedDate.getDay())}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"sales"},a=>{this.activeMode==="sales"&&(this.updateSaleRow(a.new),this.updateLedgerRevenue(),Toastify({text:`Sale updated: ${a.new.id}`,duration:5e3,gravity:"top",position:"right"}).showToast())}).on("postgres_changes",{event:"INSERT",schema:"public",table:"check_in_logs"},a=>{this.activeMode==="logbook"&&(this.addLogbookRow(a.new),Toastify({text:`Log added: ${a.new.id}`,duration:5e3,gravity:"top",position:"right",style:{border:"1px solid #4dff00",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast())}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"check_in_logs"},a=>{this.activeMode==="logbook"&&(this.updateLogbookRow(a.new),Toastify({text:`Log updated: ${a.new.id}`,duration:5e3,gravity:"top",position:"right",style:{border:"1px solid #6fff00",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast())}).on("postgres_changes",{event:"DELETE",schema:"public",table:"check_in_logs"},a=>{this.activeMode==="logbook"&&(this.removeLogbookRow(a.old.id),Toastify({text:`Log removed: ${a.old.id}`,duration:5e3,gravity:"top",position:"right",style:{border:"1prgb(255, 0, 0) #ff9800",background:"#0a0a0a",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast())}),{error:t}=await e.subscribe(a=>{var o;a==="SUBSCRIBED"&&((o=this.showRealtimeToast)==null||o.call(this))});if(t){Toastify({text:"Realtime subscription failed",duration:5e3,gravity:"top",position:"right",backgroundColor:"#f44336"}).showToast(),console.error("Realtime subscription failed:",t);return}this.realtimeChannel=e},wolfData.updateLedgerRevenue=function(){const e=document.getElementById("ledger-summary-amount");if(!e)return;const t=(this.allSales||[]).reduce((a,o)=>a+Number(o.total_amount||0),0);e.textContent=this.formatCurrency(t)},wolfData.showRealtimeToast=function(){const e=document.createElement("span");e.innerHTML=DOMPurify.sanitize(`
    <i class="bx bx-rfid" style="margin-right: 8px; font-size:18px; color:var(--wolf-red);"></i>
    LIVE_SYNC_ESTABLISHED
  `),Toastify({node:e,duration:5e3,gravity:"top",position:"right",style:{background:"#0a0a0a",border:"1px solid #ffffff",borderRadius:"12px",fontWeight:"900",fontFamily:"JetBrains Mono, monospace",color:"#fff"}}).showToast()},document.addEventListener("input",e=>{if(e.target.id==="ledger-main-search"){const t=e.target.value.trim(),a=document.getElementById("search-clear-btn");a&&(a.style.display=t.length>0?"block":"none"),wolfData.activeMode==="sales"?wolfData.renderSales(wolfData.selectedDate.getDay(),t):wolfData.loadLogbook()}}),document.addEventListener("click",async e=>{if(e.target.closest("#muteToggleBtn")){e.preventDefault(),e.stopPropagation(),window.wolfAudio.toggleMute()||window.wolfAudio.play("notif");return}const a=wolfData.activeMode,o=(wolfData.serverToday||new Date).toLocaleDateString("en-CA"),n=e.target.closest("#toggle-search-btn");if(n){const r=n.closest("#sales-main-view, #logbook-main-view, #main-content, .ledger-page-wrapper")||document,u=r.querySelector("#ledger-search-container"),g=r.querySelector("#ledger-main-search");if(u&&g){e.preventDefault(),e.stopPropagation();const f=u.classList.toggle("active");if(n.classList.toggle("active",f),f)setTimeout(()=>{g.focus()},180),window.wolfAudio&&window.wolfAudio.play("notif");else{g.value="";const i=r.querySelector("#search-clear-btn");i&&(i.style.display="none"),wolfRefreshView()}return}}const s=e.target.closest("#prev-week-btn, #next-week-btn");if(s){const r=s.id==="prev-week-btn"?-7:7,u=new Date,g=u.toLocaleDateString("en-CA"),f=new Date(wolfData.selectedDate);f.setDate(f.getDate()+r);const i=f.toLocaleDateString("en-CA");if(r>0)if(i>g)if(wolfData.selectedDate.toLocaleDateString("en-CA")===g){window.salesManager&&window.salesManager.showSystemAlert("CHRONOLOCK_ACTIVE: FUTURE PROJECTION BLOCKED","error");return}else console.log("WolfChrono: Jump exceeds today. Snapping to current date."),wolfData.selectedDate=u;else wolfData.selectedDate=f;else wolfData.selectedDate=f;wolfData.calculateWeek(a);return}if(e.target.closest("#chrono-picker-trigger")){wolfData.fp&&wolfData.fp.open();return}const d=e.target.closest(".day-btn");if(d){const r=d.getAttribute("data-date");if(r){if(r>o){window.salesManager&&window.salesManager.showSystemAlert("INVALID_PROTOCOL: FUTURE_DATE_LOCKED","error");return}const u=r.split("-");wolfData.selectedDate=new Date(u[0],u[1]-1,u[2]),wolfData.calculateWeek(a)}}if(e.target.closest("#add-ledger-btn")){const r=wolfData.activeMode;window.wolfAudio&&window.wolfAudio.play("notif"),wolfData.activeMode==="sales"?window.salesManager.openSaleTerminal():window.logbookManager.openLogbookTerminal()}if(e.target.closest("#clear-ledger-btn")){const r=wolfData.activeMode;Toastify({text:`Opening ${r.toUpperCase()} Trash Bin...`,duration:5e3,gravity:"top",position:"right",style:{background:"#343434",borderRadius:"10px",fontWeight:"bold",color:"#fff"}}).showToast(),window.salesManager&&window.salesManager.openTrashBin(r)}if(e.target.closest("#snap-today-btn")){console.log("WolfChrono: Snap-to-Today triggered."),await wolfData.syncServerTime(),wolfData.fp&&wolfData.fp.setDate(wolfData.selectedDate,!1),wolfData.calculateWeek(wolfData.activeMode),window.salesManager&&window.salesManager.showSystemAlert("RETURNED TO TODAY'S WEEK!","success");return}}),document.addEventListener("click",()=>{setTimeout(()=>{const e=document.getElementById("week-range-display");if(e&&(e.innerText==="--- - ---"||e.innerText==="")){const t=document.getElementById("sales-day-picker")?"sales":"logbook";console.log(`WolfChrono: Auto-initializing ${t} view...`),wolfData.initChrono(t)}},100)}),window.addEventListener("load",()=>{const t=new URLSearchParams(window.location.search).get("p")||"home";wolfData.syncNavigationUI(t),(t==="sales"||t==="logbook")&&setTimeout(async()=>{document.getElementById("ledger-page")&&(wolfData.syncServerTime&&await wolfData.syncServerTime(),await wolfData.initLedger(t),wolfData.initRealtime())},500)});
