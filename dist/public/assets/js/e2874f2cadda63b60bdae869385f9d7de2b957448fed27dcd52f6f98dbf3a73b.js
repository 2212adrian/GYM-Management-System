DOMPurify.setConfig({FORBID_TAGS:["img","svg","script","style"],FORBID_ATTR:["onerror","onclick","onload"]});function safeHTML(i){return DOMPurify.sanitize(i,{ALLOWED_TAGS:["br","span","i"],ALLOWED_ATTR:["class"]})}let supabaseClient=window.supabaseClient||null;async function ensureSupabaseClient(){if(supabaseClient)return supabaseClient;if(window.supabaseReady&&await window.supabaseReady,supabaseClient=window.supabaseClient||null,!supabaseClient)throw new Error("Supabase client is not available");return supabaseClient}const MAX_ATTEMPTS=5,LOGIN_LOCKOUT_MINUTES=5,OTP_CLICK_SPAM_WINDOW_MS=1e3,OTP_CLICK_SPAM_THRESHOLD=3,OTP_CLICK_SPAM_LOCK_SECONDS=30,OTP_COOLDOWN_STORAGE_KEY="wolf_otp_cooldown_ends_at",REMEMBER_DEVICE_KEY="wolf_remember_device",QUICK_LOGIN_QR_CACHE_KEY="wolf_quick_login_qr_cache",QUICK_LOGIN_POLL_MS=1800,QUICK_LOGIN_EXPIRE_FALLBACK_SECONDS=120,QUICK_LOGIN_REGEN_COOLDOWN_FALLBACK_SECONDS=8,WOLF_ADMIN_EMAILS=new Set(["adrianangeles2212@gmail.com","ktorrazo123@gmail.com"]),WOLF_STAFF_EMAILS=new Set(["adrianangeles2213@gmail.com"]),typewriterWords=["Beyond Strength","Beyond Limit","Wolf Palomar","Secure. Reliable. Fast."];function normalizeRoleEmail(i){return String(i||"").trim().toLowerCase()}function resolveRoleFromUser(i){var g;const s=normalizeRoleEmail(i==null?void 0:i.email);if(!s)return null;if(WOLF_ADMIN_EMAILS.has(s))return"admin";if(WOLF_STAFF_EMAILS.has(s))return"staff";const r=String(((g=i==null?void 0:i.app_metadata)==null?void 0:g.role)||"").trim().toLowerCase();return r==="admin"||r==="staff"?r:null}let wordIdx=0,charIdx=0,isDeleting=!1;function typeCarousel(){const i=document.getElementById("typewriterText");if(!i)return;const s=typewriterWords[wordIdx];let r=s.substring(0,charIdx);if(r.includes(" ")){const p=r.split(" ");i.innerHTML=safeHTML(`${p[0]} <br> <span>${p[1]}</span>`)}else i.innerHTML=r;let g=isDeleting?50:150;!isDeleting&&charIdx===s.length?(g=3e3,isDeleting=!0):isDeleting&&charIdx===0&&(isDeleting=!1,wordIdx=(wordIdx+1)%typewriterWords.length,g=500),isDeleting?charIdx--:charIdx++,setTimeout(typeCarousel,g)}let loginTimerInterval=null,loginOutputHideTimer=null,loginOutputHideAnimationTimer=null;const resetOutputHideTimers=new WeakMap,resetOutputHideAnimationTimers=new WeakMap;async function getClientIP(){try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch(i){return"unknown_device"}}function isConnectivityAuthError(i){const s=String((i==null?void 0:i.name)||"").toLowerCase(),r=String((i==null?void 0:i.message)||"").toLowerCase(),g=Number(i==null?void 0:i.status),p=Number.isFinite(g);return typeof navigator!="undefined"&&navigator.onLine===!1||p&&g===0||p&&g>=502&&g<=504?!0:s.includes("fetch")||r.includes("failed to fetch")||r.includes("fetch failed")||r.includes("networkerror")||r.includes("network error")||r.includes("network request failed")||r.includes("gateway")||r.includes("service unavailable")||r.includes("timed out")}function isRememberDeviceEnabled(){var i;try{return(i=window.wolfAuthStorage)!=null&&i.shouldRememberDevice?!!window.wolfAuthStorage.shouldRememberDevice():window.localStorage.getItem(REMEMBER_DEVICE_KEY)==="1"}catch(s){return!1}}function setRememberDeviceEnabled(i){var s;try{if((s=window.wolfAuthStorage)!=null&&s.setRememberDevice){window.wolfAuthStorage.setRememberDevice(!!i);return}i?window.localStorage.setItem(REMEMBER_DEVICE_KEY,"1"):window.localStorage.removeItem(REMEMBER_DEVICE_KEY)}catch(r){}}function shakeField(i){i&&(i.classList.remove("shake-error"),i.offsetWidth,i.classList.add("shake-error"),setTimeout(()=>{i.classList.remove("shake-error")},420))}function hideLoginOutput(i=!1){const s=document.getElementById("loginOutput");if(s){if(loginOutputHideTimer&&(clearTimeout(loginOutputHideTimer),loginOutputHideTimer=null),loginOutputHideAnimationTimer&&(clearTimeout(loginOutputHideAnimationTimer),loginOutputHideAnimationTimer=null),i){s.classList.remove("is-entering","is-hiding","is-visible"),s.textContent="";return}s.classList.remove("is-entering"),s.classList.add("is-hiding"),loginOutputHideAnimationTimer=setTimeout(()=>{s.classList.remove("is-hiding","is-visible"),s.textContent="",loginOutputHideAnimationTimer=null},220)}}function showLoginOutput(i,{color:s="var(--wolf-red)",html:r=!1,autoHide:g=!0,duration:p=5e3,animate:v=!0}={}){const d=document.getElementById("loginOutput");d&&(loginOutputHideTimer&&(clearTimeout(loginOutputHideTimer),loginOutputHideTimer=null),loginOutputHideAnimationTimer&&(clearTimeout(loginOutputHideAnimationTimer),loginOutputHideAnimationTimer=null),d.style.color=s,d.classList.remove("is-hiding"),r?d.innerHTML=i:d.textContent=i,v?(d.classList.remove("is-visible","is-entering"),d.offsetWidth,d.classList.add("is-visible","is-entering"),setTimeout(()=>{d.classList.remove("is-entering")},260)):(d.classList.remove("is-entering"),d.classList.add("is-visible")),g&&(loginOutputHideTimer=setTimeout(()=>{hideLoginOutput(!1),loginOutputHideTimer=null},p)))}function getResetOutputElement(i=null){if(i)return i;const s=document.querySelector("#recoveryStep1 #resetOutput"),r=document.querySelector("#recoveryStep2 #resetOutput");return r&&r.offsetParent!==null?r:s||r||document.getElementById("resetOutput")}function clearResetOutputTimers(i){const s=resetOutputHideTimers.get(i);s&&(clearTimeout(s),resetOutputHideTimers.delete(i));const r=resetOutputHideAnimationTimers.get(i);r&&(clearTimeout(r),resetOutputHideAnimationTimers.delete(i))}function hideResetOutput({immediate:i=!1,targetEl:s=null}={}){const r=getResetOutputElement(s);if(!r)return;if(clearResetOutputTimers(r),i){r.classList.remove("is-entering","is-hiding","is-visible"),r.textContent="";return}r.classList.remove("is-entering"),r.classList.add("is-hiding");const g=setTimeout(()=>{r.classList.remove("is-hiding","is-visible"),r.textContent="",resetOutputHideAnimationTimers.delete(r)},220);resetOutputHideAnimationTimers.set(r,g)}function showResetOutput(i,{color:s="var(--wolf-red)",autoHide:r=!1,duration:g=5e3,animate:p=!0,targetEl:v=null}={}){const d=getResetOutputElement(v);if(d){if(clearResetOutputTimers(d),d.style.color=s,d.classList.remove("is-hiding"),d.textContent=i,p){d.classList.remove("is-visible","is-entering"),d.offsetWidth,d.classList.add("is-visible","is-entering");const C=setTimeout(()=>{d.classList.remove("is-entering"),resetOutputHideAnimationTimers.delete(d)},260);resetOutputHideAnimationTimers.set(d,C)}else d.classList.remove("is-entering"),d.classList.add("is-visible");if(r){const C=setTimeout(()=>{hideResetOutput({immediate:!1,targetEl:d}),resetOutputHideTimers.delete(d)},g);resetOutputHideTimers.set(d,C)}}}function startLoginCountdown(i){loginTimerInterval&&clearInterval(loginTimerInterval);const s=document.getElementById("loginBtn"),r=p=>{if(p<=0){s.disabled=!1,s.textContent="AUTHORIZE ACCESS",hideLoginOutput(!0),clearInterval(loginTimerInterval);return}s.disabled=!0;const v=Math.floor(p/60),d=p%60;s.textContent=`LOCKED: ${v}m ${d}s`,showLoginOutput("[ERR_403] Security protocol active. Terminal locked.",{color:"var(--wolf-red)",autoHide:!1,animate:!1})};let g=i;r(g),loginTimerInterval=setInterval(()=>{g--,r(g)},1e3)}async function checkLoginLockoutStatus(){await ensureSupabaseClient();const i=await getClientIP(),{data:s}=await supabaseClient.from("login_attempts").select("*").eq("ip_address",i).maybeSingle();if(s){const r=(Date.now()-new Date(s.last_attempt_at).getTime())/6e4;if(s.attempts>=MAX_ATTEMPTS&&r<LOGIN_LOCKOUT_MINUTES){const g=Math.ceil((LOGIN_LOCKOUT_MINUTES-r)*60);return startLoginCountdown(g),!0}else r>=LOGIN_LOCKOUT_MINUTES&&await supabaseClient.from("login_attempts").delete().eq("ip_address",i)}return!1}document.addEventListener("DOMContentLoaded",async()=>{try{await ensureSupabaseClient()}catch(e){showLoginOutput("[ERR_503] Secure database handshake failed. Try again later.");return}const i=document.getElementById("flipCardInner"),s=document.getElementById("recoveryContainer"),r=document.getElementById("confirmExitModal"),g=document.querySelector(".auth-split-container");let p=null,v=0,d=[],C=null,M=null,O=null,q=0,x=null,B=!1;const h=document.getElementById("quickLoginModal"),J=document.getElementById("quickLoginLaunch"),G=document.getElementById("quickLoginClose"),W=document.getElementById("quickLoginBackdrop"),y=document.getElementById("quickLoginRefresh"),D=document.getElementById("quickLoginStatus"),A=document.getElementById("quickLoginRef"),_=document.getElementById("quickLoginTimer"),L=document.getElementById("quickLoginQrCanvas");setTimeout(()=>{g.classList.add("is-ready"),window.wolfAudio&&window.wolfAudio.play("notif")},100),typeCarousel();async function X(){const e=document.querySelector(".flip-card");g.classList.add("auth-verifying"),showLoginOutput(safeHTML("<i class='bx bx-loader-alt bx-spin'></i> LOGIN SUCCESSFUL. INITIATING SYSTEM..."),{color:"var(--wolf-blue)",html:!0,autoHide:!1}),window.wolfAudio&&window.wolfAudio.play("notif"),setTimeout(async()=>{window.WOLF_IS_ANIMATING_OUT=!0;const t=await getClientIP();await supabaseClient.from("login_attempts").delete().eq("ip_address",t),window.wolfAudio&&(wolfAudio.play("woosh"),wolfAudio.play("success")),g&&g.classList.add("outro"),e&&e.classList.add("outro"),showLoginOutput(safeHTML("<i class='bx bx-check-shield'></i> ACCESS GRANTED. BOOTING SYSTEM..."),{color:"#4ade80",html:!0,autoHide:!1}),window.triggerStarWarp&&window.triggerStarWarp(),setTimeout(()=>{window.wolfRouter&&typeof window.wolfRouter.goToMain=="function"?window.wolfRouter.goToMain("dashboard",{replace:!0,seamless:!0}):window.location.replace("/pages/main.html")},5e3)},1200)}function R(e,t="info"){D&&(D.textContent=e,D.classList.remove("is-error","is-success"),t==="error"&&D.classList.add("is-error"),t==="success"&&D.classList.add("is-success"))}function k(){C&&(clearInterval(C),C=null),M&&(clearInterval(M),M=null)}function oe(){try{const e=localStorage.getItem(QUICK_LOGIN_QR_CACHE_KEY);if(!e)return null;const t=JSON.parse(e);return!t||typeof t!="object"?null:t}catch(e){return null}}function Y(){try{localStorage.removeItem(QUICK_LOGIN_QR_CACHE_KEY)}catch(e){}}function re(){const e=oe();if(!e)return null;const t=e.expiresAt?new Date(e.expiresAt).getTime():0;return t>0&&t<=Date.now()?(Y(),null):e}function se(e){try{localStorage.setItem(QUICK_LOGIN_QR_CACHE_KEY,JSON.stringify(e))}catch(t){}}function N(e,t="bx bx-refresh"){y&&(y.innerHTML=`<i class="${t}"></i><span>${e}</span>`)}function $(e=!0){O&&(clearInterval(O),O=null),q=0,y&&(B||(y.disabled=!1),e&&N("Regenerate QR","bx bx-refresh"))}function ee(e){const t=Math.max(0,Number(e||0));if(t<=0){$(!0);return}O&&(clearInterval(O),O=null),q=Date.now()+t*1e3;const n=()=>{const o=Math.max(0,Math.ceil((q-Date.now())/1e3));if(y){if(o<=0){$(!0);return}y.disabled=!0,N(`Regenerate in ${o}s`,"bx bx-time-five")}};n(),O=setInterval(n,1e3)}function ae(e){const t=Date.now()+QUICK_LOGIN_EXPIRE_FALLBACK_SECONDS*1e3,n=e?new Date(e).getTime():t,o=()=>{const a=Math.max(0,Math.ceil((n-Date.now())/1e3));_&&(_.textContent=`${a}s`),a<=0&&(k(),R("QR session expired. Regenerate to continue.","error"))};o(),M=setInterval(o,1e3)}async function le(e){var m;if(!L)return;L.classList.remove("is-ready");const t=window.matchMedia("(max-width: 640px)").matches?300:340;if((m=window.QRCode)!=null&&m.toCanvas){await window.QRCode.toCanvas(L,e,{width:t,margin:1,errorCorrectionLevel:"L",color:{dark:"#0f1012",light:"#ffffff"}}),L.classList.add("is-ready");return}if(typeof window.qrcode!="function")throw new Error("QR renderer is not available. Reload and try again.");const n=window.qrcode(0,"M");n.addData(String(e||"")),n.make();const o=L.getContext("2d");if(!o)throw new Error("QR canvas context is unavailable");const a=t,l=6,u=n.getModuleCount(),c=a-l*2;L.width=a,L.height=a,o.imageSmoothingEnabled=!1,o.clearRect(0,0,a,a),o.fillStyle="#ffffff",o.fillRect(0,0,a,a),o.fillStyle="#0f1012";for(let f=0;f<u;f++)for(let w=0;w<u;w++){if(!n.isDark(f,w))continue;const S=l+Math.floor(w*c/u),U=l+Math.floor(f*c/u),Z=Math.ceil((w+1)*c/u)-Math.floor(w*c/u),H=Math.ceil((f+1)*c/u)-Math.floor(f*c/u);o.fillRect(S,U,Z,H)}L.classList.add("is-ready")}async function te(e=!1){if(!(!h||B)){B=!0;try{y&&(y.disabled=!0,N("Generating...","bx bx-loader-alt bx-spin")),R("Generating one-time QR session...","info"),k();const t=re(),n=(t==null?void 0:t.previewContext)||null,o=(t==null?void 0:t.previewSig)||null,a=await fetch("/.netlify/functions/quick-login-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({forceNew:!!e,cachedPreviewContext:n,cachedPreviewSig:o})});let l={};try{l=await a.json()}catch(f){l={}}if(!a.ok){if(a.status===429){const f=Number(l.remainingTime||0);f>0&&ee(f)}throw new Error(l.error||"Unable to create quick login request")}let u=l.qrValue,c=l.previewContext||null,m=l.previewSig||null;(!c||!m)&&t&&t.requestId===l.requestId&&t.qrValue&&(u=t.qrValue,c=t.previewContext||c,m=t.previewSig||m),x={...l,qrValue:u,previewContext:c,previewSig:m},A&&(A.textContent=String(l.requestId||"---").slice(0,8).toUpperCase()),await le(u),c&&m&&se({requestId:l.requestId,qrValue:u,expiresAt:l.expiresAt,previewContext:c,previewSig:m}),ae(l.expiresAt),R(l.reusedPending?"Resumed pending QR session on this device.":"Waiting for secure approval from trusted device..."),ee(Number(l.regenerateRemainingSeconds||l.regenerateCooldownSeconds||QUICK_LOGIN_REGEN_COOLDOWN_FALLBACK_SECONDS)),ce()}catch(t){const n=Q(t,String((t==null?void 0:t.message)||t));R(n||"[ERR_500] SYSTEM_FAULT: Quick-login setup failed.","error"),A&&(A.textContent="---"),_&&(_.textContent="--s")}finally{if(B=!1,!y||q>Date.now())return;y.disabled=!1,N("Regenerate QR","bx bx-refresh")}}}async function ne(){if(!(!x||B))try{const e=await fetch("/.netlify/functions/quick-login-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requestId:x.requestId,requestSecret:x.requestSecret,consume:!0})});let t={};try{t=await e.json()}catch(l){t={}}if(!e.ok){if(e.status===404||e.status===410){k(),R("Quick-login request expired. Regenerate QR.","error");return}throw new Error(t.error||"Failed to verify quick-login status")}if(t.status==="pending")return;if(t.status==="expired"||t.status==="rejected"||t.status==="consumed"){k(),Y(),R(t.status==="consumed"?"Quick-login code already used. Regenerate QR.":"Quick-login request was not approved.","error");return}if(t.status!=="approved")return;k(),Y(),R("Approval received. Synchronizing secure session...","success");const{data:n,error:o}=await supabaseClient.auth.setSession({access_token:t.accessToken,refresh_token:t.refreshToken});if(o)throw new Error(o.message||"Unable to restore quick-login session");const a=n==null?void 0:n.user;if(!a||resolveRoleFromUser(a)!=="admin")throw await supabaseClient.auth.signOut(),new Error("Quick-login approval requires an admin account");window.wolfAudio&&window.wolfAudio.play("success"),setTimeout(()=>{h&&(h.classList.remove("is-open"),h.setAttribute("aria-hidden","true")),X()},550)}catch(e){const t=Q(e,String((e==null?void 0:e.message)||e));R(t||"[ERR_500] SYSTEM_FAULT: Quick-login polling failed.","error")}}function ce(){C&&clearInterval(C),C=setInterval(ne,QUICK_LOGIN_POLL_MS),ne()}function z(){h&&(h.classList.remove("is-open"),h.setAttribute("aria-hidden","true"),k(),$(!0),x=null,L&&L.classList.remove("is-ready"),A&&(A.textContent="---"),_&&(_.textContent="--s"),R("Initializing secure QR channel..."))}function ue(){h&&(h.classList.add("is-open"),h.setAttribute("aria-hidden","false"),te(!1))}function de(){!h||!J||(J.addEventListener("click",e=>{e.preventDefault(),ue()}),G==null||G.addEventListener("click",z),W==null||W.addEventListener("click",z),y==null||y.addEventListener("click",async()=>{await te(!0)}),document.addEventListener("keydown",e=>{e.key==="Escape"&&h.classList.contains("is-open")&&z()}))}function P(){p&&(clearInterval(p),p=null),d=[],T=!1;const e=document.getElementById("recoveryStep2");e&&e.remove(),s.classList.remove("step1-exit","step2-enter"),hideResetOutput({immediate:!0}),hideLoginOutput(!0);const t=document.getElementById("otpForm");t&&t.reset();const n=document.getElementById("forgotEmail");n&&(n.value="");const o=document.getElementById("sendOtpBtn"),a=document.getElementById("resendOtpBtn"),l=I();l>0?E(l):(o&&(o.disabled=!1,o.style.pointerEvents="auto",o.style.opacity="1",o.setAttribute("aria-disabled","false"),o.textContent="SEND SECURITY OTP"),a&&(a.style.pointerEvents="auto",a.style.opacity="1",a.textContent="RESEND SECURITY CODE"));const u=document.getElementById("resetBtn");u&&(u.disabled=!1,u.textContent="RESTORE SYSTEM ACCESS"),document.querySelectorAll(".otp-field").forEach(f=>{f.value=""});const m=document.getElementById("newPassword");m&&(m.value=""),r&&(r.style.display="none"),i.classList.remove("flipped")}async function fe(){const e=document.getElementById("loginBtn"),t=document.getElementById("loginAgreement"),n=document.getElementById("rememberDevice");if(!e.disabled){e.disabled=!0,e.textContent="AUTHORIZING...",hideLoginOutput(!0);try{if(t&&!t.checked){showLoginOutput("[ERR_003] AGREE_FAILED: Please agree to the data security policy to continue.",{color:"var(--wolf-red)"}),window.wolfAudio&&window.wolfAudio.play("denied"),e.disabled=!1,e.textContent="AUTHORIZE ACCESS";return}const o=await getClientIP();if(await checkLoginLockoutStatus())return;const l=document.getElementById("email").value,u=document.getElementById("password").value;setRememberDeviceEnabled(!!(n!=null&&n.checked));const{data:c,error:m}=await supabaseClient.auth.signInWithPassword({email:l,password:u});if(m){if(isConnectivityAuthError(m)){showLoginOutput("[ERR_503] LINK_OFFLINE: Security gateway is unreachable. Check internet connection.",{color:"var(--wolf-red)"}),window.wolfAudio&&window.wolfAudio.play("error"),e.disabled=!1,e.textContent="AUTHORIZE ACCESS";return}shakeField(document.getElementById("password")),wolfAudio.play("denied");const{data:f}=await supabaseClient.from("login_attempts").select("*").eq("ip_address",o).maybeSingle();let w=1;f&&(w=(Date.now()-new Date(f.last_attempt_at).getTime())/6e4<LOGIN_LOCKOUT_MINUTES?f.attempts+1:1),await supabaseClient.from("login_attempts").upsert({ip_address:o,attempts:w,last_attempt_at:new Date().toISOString()}),w>=MAX_ATTEMPTS?startLoginCountdown(LOGIN_LOCKOUT_MINUTES*60):(showLoginOutput(`[ERR_101] Access denied. ${MAX_ATTEMPTS-w} attempts left.`,{color:"var(--wolf-red)"}),document.getElementById("password").value="",e.disabled=!1,e.textContent="AUTHORIZE ACCESS")}else resolveRoleFromUser(c==null?void 0:c.user)?await X():(wolfAudio.play("error"),showLoginOutput("[ERR_102] ACCESS_DENIED: Account is not authorized."),await supabaseClient.auth.signOut(),e.disabled=!1,e.textContent="AUTHORIZE ACCESS")}catch(o){showLoginOutput("[ERR_500] System Fault."),window.wolfAudio&&window.wolfAudio.play("error"),window.Swal.fire({title:"[ERR_500] TERMINAL_FAULT",html:`<div style="color:var(--wolf-red); font-size:4rem; margin-bottom:15px;"><i class='bx bx-error-alt'></i></div>
               <p style="color:#888; font-size:14px;">CRITICAL_ERROR: ${o.message}</p>`,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-red",title:"wolf-swal-title",confirmButton:"btn-wolf-red"},confirmButtonText:"RE-INITIALIZE"}),e.disabled=!1}}}checkLoginLockoutStatus(),de();const j=document.getElementById("loginAgreement");j&&j.addEventListener("change",()=>{var e;j.checked&&(((e=document.getElementById("loginOutput"))==null?void 0:e.textContent)||"").includes("Please agree to the data security policy")&&hideLoginOutput(!0)});const F=document.getElementById("rememberDevice");F&&(F.checked=isRememberDeviceEnabled(),F.addEventListener("change",()=>{setRememberDeviceEnabled(!!F.checked)}));function me(){try{const e=localStorage.getItem(OTP_COOLDOWN_STORAGE_KEY);if(!e)return 0;const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}catch(e){return 0}}function K(e){try{if(!Number.isFinite(e)||e<=Date.now()){localStorage.removeItem(OTP_COOLDOWN_STORAGE_KEY);return}localStorage.setItem(OTP_COOLDOWN_STORAGE_KEY,String(Math.ceil(e)))}catch(t){}}function I(){const e=Date.now(),t=me(),n=Math.max(v||0,t||0);return!n||n<=e?(v=0,K(0),0):(v=n,Math.max(0,Math.ceil((n-e)/1e3)))}function b(e){return`Wait for ${Math.max(0,Math.ceil(Number(e||0)))}s to resend code`}function ge(e){return/^\[ERR_[A-Z0-9_]+\]/i.test(String(e||"").trim())}function Q(e,t=""){if(!e||typeof e!="object")return String(t||"").trim();const n=String(e.error||e.message||"").trim();if(ge(n))return n;const o=String(e.errorCode||"").trim(),a=String(e.errorLabel||"").trim();if(o&&a){const l=n||String(e.errorMeaning||"").trim()||t;return`[ERR_${o}] ${a}: ${String(l||"").trim()}`}return n||String(t||"").trim()}function E(e){p&&clearInterval(p);const t=Math.max(0,Number(e||0));v=t>0?Date.now()+t*1e3:0,K(v);const n=a=>{const l=document.getElementById("sendOtpBtn"),u=document.getElementById("resendOtpBtn"),c=a>0?b(a):null;l&&(l.disabled=a>0,l.style.pointerEvents=a>0?"none":"auto",l.style.opacity=a>0?"0.65":"1",l.setAttribute("aria-disabled",a>0?"true":"false"),l.textContent=c||"SEND SECURITY OTP"),u&&(u.style.pointerEvents=a>0?"none":"auto",u.style.opacity=a>0?"0.5":"1",u.textContent=c||"RESEND SECURITY CODE"),a<=0&&(v=0,K(0))};let o=t;n(o),p=setInterval(()=>{o--,n(o),o<=0&&clearInterval(p)},1e3)}async function V(){try{const e=await fetch("/.netlify/functions/check-otp-cooldown",{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)return I();const t=await e.json();return(t==null?void 0:t.canSend)===!1?Number(t.remainingTime||0):0}catch(e){return I()}}async function we(e=0){try{const n=await(await fetch("pages/verifyotp.html")).text(),o=DOMPurify.sanitize(n,{ALLOWED_TAGS:["div","p","form","input","button","a","span","i"],ALLOWED_ATTR:["id","class","type","placeholder","required","maxlength","inputmode","pattern","title","href","style"]}),u=new DOMParser().parseFromString(o,"text/html").getElementById("recoveryStep2");u&&(s.appendChild(u),s.classList.add("step1-exit"),setTimeout(async()=>{s.classList.add("step2-enter"),ye(),pe();const c=I();let m=0;c<=0&&(m=await V());const f=Math.max(Number(e||0),c,m);f>0&&E(f)},50))}catch(t){showResetOutput("[ERR_500] Failed to load verification module.")}}let T=!1;async function ie(){var l;const e=I();if(e>0){E(e),showResetOutput(`[ERR_429] ${b(e)}.`,{color:"var(--wolf-red)",autoHide:!1});return}const t=Date.now();if(d=d.filter(u=>t-u<=OTP_CLICK_SPAM_WINDOW_MS),d.push(t),d.length>=OTP_CLICK_SPAM_THRESHOLD){d=[],E(OTP_CLICK_SPAM_LOCK_SECONDS),showResetOutput(`[ERR_429] ${b(OTP_CLICK_SPAM_LOCK_SECONDS)}.`,{color:"var(--wolf-red)",autoHide:!1}),T=!1;return}if(T)return;const n=document.getElementById("sendOtpBtn"),o=document.getElementById("resendOtpBtn");T=!0,showResetOutput("Establishing connection to server...",{color:"#888",autoHide:!1}),n&&(n.disabled=!0,n.textContent="TRANSMITTING..."),o&&(o.style.pointerEvents="none",o.style.opacity="0.5",o.textContent="RESENDING OTP CODES TO EMAIL...");const a=((l=document.getElementById("forgotEmail"))==null?void 0:l.value)||"";try{const u=I();if(u>0){E(u),showResetOutput(`[ERR_429] ${b(u)}.`,{color:"var(--wolf-red)",autoHide:!1}),T=!1;return}const c=await V();if(c>0){E(c),showResetOutput(`[ERR_429] ${b(c)}.`,{color:"var(--wolf-red)",autoHide:!1}),T=!1;return}showResetOutput("Checking existing email...",{color:"#888",autoHide:!1});const m=await fetch("/.netlify/functions/request-otp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a})});if(m.ok){let f={};try{f=await m.json()}catch(U){f={}}const w=Number((f==null?void 0:f.remainingTime)||0),S=Number.isFinite(w)&&w>0?w:60;E(S),wolfAudio.play("notif"),showResetOutput("Your OTP key has been sent to your email.",{color:"#4ade80",autoHide:!1}),document.getElementById("recoveryStep2")||await we(S)}else{let f=null,w="",S=0;try{f=await m.json(),w=Q(f,"Server error while requesting OTP."),S=Number((f==null?void 0:f.remainingTime)||0)}catch(U){}if(wolfAudio.play("error"),m.status===404)S>0&&E(S),showResetOutput(w||"[ERR_404] RESOURCE_MISSING: Email unauthorized.");else if(m.status===429){const Z=String(w||"").includes("OTP cooldown active")?30:60,H=S>0?S:Z;E(H),showResetOutput(`[ERR_429] ${b(H)}.`,{color:"var(--wolf-red)",autoHide:!1})}else m.status===400?showResetOutput(w||"[ERR_400] REQUEST_INVALID: Invalid request."):showResetOutput(w||"[ERR_500] SYSTEM_FAULT: Server error while requesting OTP.");T=!1,m.status!==429&&S<=0&&(n&&(n.disabled=!1,n.textContent="SEND SECURITY OTP"),o&&(o.style.pointerEvents="auto",o.style.opacity="1",o.textContent="RESEND SECURITY CODE"))}}catch(u){const c=I();c>0?(E(c),showResetOutput(`[ERR_429] ${b(c)}.`,{color:"var(--wolf-red)",autoHide:!1})):showResetOutput("[ERR_503] Gateway timeout. Terminal offline."),T=!1,c<=0&&(n&&(n.disabled=!1,n.style.pointerEvents="auto",n.style.opacity="1",n.setAttribute("aria-disabled","false"),n.textContent="SEND SECURITY OTP"),o&&(o.style.pointerEvents="auto",o.style.opacity="1",o.textContent="RESEND SECURITY CODE"))}finally{setTimeout(()=>{T=!1},1e3)}}function pe(){const e=document.getElementById("verifyResetForm"),t=document.getElementById("recoveryStep2");if(!e||!t)return;const n=t.querySelector("#resetOutput");e.onsubmit=async o=>{o.preventDefault();const a=e.querySelector('button[type="submit"]');a.disabled=!0,a.textContent="RECONFIGURING...",showResetOutput("Verifying OTP Code Credential...",{color:"#888",autoHide:!1,targetEl:n});const l=document.getElementById("forgotEmail").value,u=document.getElementById("newPassword").value,c=Array.from(document.querySelectorAll(".otp-field")).map(m=>m.value).join("");try{const m=await fetch("/.netlify/functions/verify-otp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:l,otp:c,newPassword:u})});if(m.ok)wolfAudio.play("success"),showResetOutput("Protocol success. Password updated.",{color:"#4ade80",autoHide:!1,targetEl:n}),window.wolfAudio&&window.wolfAudio.play("success"),window.Swal.fire({title:"SUCCESS",html:`<div style="color:#08ea1b; font-size:4rem; margin-bottom:15px;"><i class='bx bx-check-shield'></i></div>
               <p style="color:#888; font-size:14px;">Credentials re-mapped successfully. Terminal access granted.</p>`,background:"#111",timer:3e3,timerProgressBar:!0,showConfirmButton:!1,customClass:{popup:"wolf-swal-popup wolf-border-green",title:"wolf-swal-title"},didClose:()=>{P()}});else{let f=null;try{f=await m.json()}catch(S){f=null}wolfAudio.play("denied");const w=Q(f,"Security key invalid or expired.");showResetOutput(w||"[ERR_602] KEY_EXPIRED: Security key invalid or expired.",{targetEl:n}),a.disabled=!1,a.textContent="RESTORE SYSTEM ACCESS"}}catch(m){wolfAudio.play("error"),a.disabled=!1,showResetOutput("[ERR_500] Database synchronization fault.",{targetEl:n})}}}(async()=>{const e=I();e>0&&E(e);const t=await V(),n=Math.max(e,Number(t||0));n>0&&E(n)})(),document.getElementById("loginForm").onsubmit=e=>{e.preventDefault(),fe()},document.getElementById("otpForm").onsubmit=e=>{e.preventDefault();const t=I();if(t>0){E(t),showResetOutput(`[ERR_429] ${b(t)}.`,{color:"var(--wolf-red)",autoHide:!1});return}ie("sendOtpBtn")},document.getElementById("forgotLink").onclick=e=>{e.preventDefault(),i.classList.add("flipped")},document.addEventListener("click",e=>{e.target.id==="forgotLink"&&(e.preventDefault(),document.getElementById("flipCardInner").classList.add("flipped")),(e.target.id==="resendOtpBtn"||e.target.closest("#resendOtpBtn"))&&(e.preventDefault(),console.log("Wolf OS: Resend requested..."),ie()),(e.target.id==="backToLoginTrigger"||e.target.id==="backToLoginTriggerSecondary")&&(e.preventDefault(),document.getElementById("recoveryStep2")?(window.wolfAudio&&window.wolfAudio.play("notif"),window.Swal.fire({title:"ABANDON RECOVERY?",html:`<div style="color:#b47023; font-size:4rem; margin-bottom:15px;"><i class='bx bx-shield-quarter'></i></div>
               <p style="color:#888; font-size:14px;">Terminating handshake will void the current security key. Proceed?</p>`,showCancelButton:!0,confirmButtonText:"YES, EXIT",cancelButtonText:"STAY",reverseButtons:!0,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-orange",title:"wolf-swal-title",confirmButton:"btn-wolf-orange",cancelButton:"btn-wolf-secondary"}}).then(t=>{t.isConfirmed&&P()})):i.classList.remove("flipped"))}),document.getElementById("confirmExitBtn").onclick=()=>{r.style.display="none",P()},document.getElementById("cancelExitBtn").onclick=()=>r.style.display="none",document.getElementById("closeModalBtn").onclick=()=>P(),document.getElementById("descContainer").onclick=function(){this.classList.toggle("expanded")};function ye(){const e=document.querySelectorAll(".otp-field");e.forEach((t,n)=>{t.oninput=o=>{t.value=t.value.replace(/[^0-9]/g,""),t.value&&n<5&&e[n+1].focus()},t.onkeydown=o=>{o.key==="Backspace"&&!t.value&&n>0&&e[n-1].focus()},t.onpaste=o=>{o.preventDefault();const l=(o.clipboardData||window.clipboardData).getData("text").replace(/[^0-9]/g,"");for(let c=0;c<l.length&&n+c<e.length;c++)e[n+c].value=l[c];const u=Math.min(n+l.length,5);e[u].focus()}})}});
