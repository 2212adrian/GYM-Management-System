DOMPurify.setConfig({FORBID_TAGS:["img","svg","script","style"],FORBID_ATTR:["onerror","onclick","onload"]});function safeHTML(o){return DOMPurify.sanitize(o,{ALLOWED_TAGS:["br","span","i"],ALLOWED_ATTR:["class"]})}let supabaseClient=window.supabaseClient||null;async function ensureSupabaseClient(){if(supabaseClient)return supabaseClient;if(window.supabaseReady&&await window.supabaseReady,supabaseClient=window.supabaseClient||null,!supabaseClient)throw new Error("Supabase client is not available");return supabaseClient}const MAX_ATTEMPTS=5,LOGIN_LOCKOUT_MINUTES=5,OTP_CLICK_SPAM_WINDOW_MS=1e3,OTP_CLICK_SPAM_THRESHOLD=3,OTP_CLICK_SPAM_LOCK_SECONDS=30,OTP_COOLDOWN_STORAGE_KEY="wolf_otp_cooldown_ends_at",REMEMBER_DEVICE_KEY="wolf_remember_device",QUICK_LOGIN_QR_CACHE_KEY="wolf_quick_login_qr_cache",QUICK_LOGIN_POLL_MS=1800,QUICK_LOGIN_EXPIRE_FALLBACK_SECONDS=120,QUICK_LOGIN_REGEN_COOLDOWN_FALLBACK_SECONDS=8,typewriterWords=["Beyond Strength","Beyond Limit","Wolf Palomar","Secure. Reliable. Fast."];let wordIdx=0,charIdx=0,isDeleting=!1;function typeCarousel(){const o=document.getElementById("typewriterText");if(!o)return;const l=typewriterWords[wordIdx];let r=l.substring(0,charIdx);if(r.includes(" ")){const p=r.split(" ");o.innerHTML=safeHTML(`${p[0]} <br> <span>${p[1]}</span>`)}else o.innerHTML=r;let g=isDeleting?50:150;!isDeleting&&charIdx===l.length?(g=3e3,isDeleting=!0):isDeleting&&charIdx===0&&(isDeleting=!1,wordIdx=(wordIdx+1)%typewriterWords.length,g=500),isDeleting?charIdx--:charIdx++,setTimeout(typeCarousel,g)}let loginTimerInterval=null,loginOutputHideTimer=null,loginOutputHideAnimationTimer=null;const resetOutputHideTimers=new WeakMap,resetOutputHideAnimationTimers=new WeakMap;async function getClientIP(){try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch(o){return"unknown_device"}}function isConnectivityAuthError(o){const l=String((o==null?void 0:o.name)||"").toLowerCase(),r=String((o==null?void 0:o.message)||"").toLowerCase(),g=Number(o==null?void 0:o.status),p=Number.isFinite(g);return typeof navigator!="undefined"&&navigator.onLine===!1||p&&g===0||p&&g>=502&&g<=504?!0:l.includes("fetch")||r.includes("failed to fetch")||r.includes("fetch failed")||r.includes("networkerror")||r.includes("network error")||r.includes("network request failed")||r.includes("gateway")||r.includes("service unavailable")||r.includes("timed out")}function isRememberDeviceEnabled(){var o;try{return(o=window.wolfAuthStorage)!=null&&o.shouldRememberDevice?!!window.wolfAuthStorage.shouldRememberDevice():window.localStorage.getItem(REMEMBER_DEVICE_KEY)==="1"}catch(l){return!1}}function setRememberDeviceEnabled(o){var l;try{if((l=window.wolfAuthStorage)!=null&&l.setRememberDevice){window.wolfAuthStorage.setRememberDevice(!!o);return}o?window.localStorage.setItem(REMEMBER_DEVICE_KEY,"1"):window.localStorage.removeItem(REMEMBER_DEVICE_KEY)}catch(r){}}function shakeField(o){o&&(o.classList.remove("shake-error"),o.offsetWidth,o.classList.add("shake-error"),setTimeout(()=>{o.classList.remove("shake-error")},420))}function hideLoginOutput(o=!1){const l=document.getElementById("loginOutput");if(l){if(loginOutputHideTimer&&(clearTimeout(loginOutputHideTimer),loginOutputHideTimer=null),loginOutputHideAnimationTimer&&(clearTimeout(loginOutputHideAnimationTimer),loginOutputHideAnimationTimer=null),o){l.classList.remove("is-entering","is-hiding","is-visible"),l.textContent="";return}l.classList.remove("is-entering"),l.classList.add("is-hiding"),loginOutputHideAnimationTimer=setTimeout(()=>{l.classList.remove("is-hiding","is-visible"),l.textContent="",loginOutputHideAnimationTimer=null},220)}}function showLoginOutput(o,{color:l="var(--wolf-red)",html:r=!1,autoHide:g=!0,duration:p=5e3,animate:h=!0}={}){const d=document.getElementById("loginOutput");d&&(loginOutputHideTimer&&(clearTimeout(loginOutputHideTimer),loginOutputHideTimer=null),loginOutputHideAnimationTimer&&(clearTimeout(loginOutputHideAnimationTimer),loginOutputHideAnimationTimer=null),d.style.color=l,d.classList.remove("is-hiding"),r?d.innerHTML=o:d.textContent=o,h?(d.classList.remove("is-visible","is-entering"),d.offsetWidth,d.classList.add("is-visible","is-entering"),setTimeout(()=>{d.classList.remove("is-entering")},260)):(d.classList.remove("is-entering"),d.classList.add("is-visible")),g&&(loginOutputHideTimer=setTimeout(()=>{hideLoginOutput(!1),loginOutputHideTimer=null},p)))}function getResetOutputElement(o=null){if(o)return o;const l=document.querySelector("#recoveryStep1 #resetOutput"),r=document.querySelector("#recoveryStep2 #resetOutput");return r&&r.offsetParent!==null?r:l||r||document.getElementById("resetOutput")}function clearResetOutputTimers(o){const l=resetOutputHideTimers.get(o);l&&(clearTimeout(l),resetOutputHideTimers.delete(o));const r=resetOutputHideAnimationTimers.get(o);r&&(clearTimeout(r),resetOutputHideAnimationTimers.delete(o))}function hideResetOutput({immediate:o=!1,targetEl:l=null}={}){const r=getResetOutputElement(l);if(!r)return;if(clearResetOutputTimers(r),o){r.classList.remove("is-entering","is-hiding","is-visible"),r.textContent="";return}r.classList.remove("is-entering"),r.classList.add("is-hiding");const g=setTimeout(()=>{r.classList.remove("is-hiding","is-visible"),r.textContent="",resetOutputHideAnimationTimers.delete(r)},220);resetOutputHideAnimationTimers.set(r,g)}function showResetOutput(o,{color:l="var(--wolf-red)",autoHide:r=!1,duration:g=5e3,animate:p=!0,targetEl:h=null}={}){const d=getResetOutputElement(h);if(d){if(clearResetOutputTimers(d),d.style.color=l,d.classList.remove("is-hiding"),d.textContent=o,p){d.classList.remove("is-visible","is-entering"),d.offsetWidth,d.classList.add("is-visible","is-entering");const C=setTimeout(()=>{d.classList.remove("is-entering"),resetOutputHideAnimationTimers.delete(d)},260);resetOutputHideAnimationTimers.set(d,C)}else d.classList.remove("is-entering"),d.classList.add("is-visible");if(r){const C=setTimeout(()=>{hideResetOutput({immediate:!1,targetEl:d}),resetOutputHideTimers.delete(d)},g);resetOutputHideTimers.set(d,C)}}}function startLoginCountdown(o){loginTimerInterval&&clearInterval(loginTimerInterval);const l=document.getElementById("loginBtn"),r=p=>{if(p<=0){l.disabled=!1,l.textContent="AUTHORIZE ACCESS",hideLoginOutput(!0),clearInterval(loginTimerInterval);return}l.disabled=!0;const h=Math.floor(p/60),d=p%60;l.textContent=`LOCKED: ${h}m ${d}s`,showLoginOutput("[ERR_403] Security protocol active. Terminal locked.",{color:"var(--wolf-red)",autoHide:!1,animate:!1})};let g=o;r(g),loginTimerInterval=setInterval(()=>{g--,r(g)},1e3)}async function checkLoginLockoutStatus(){await ensureSupabaseClient();const o=await getClientIP(),{data:l}=await supabaseClient.from("login_attempts").select("*").eq("ip_address",o).maybeSingle();if(l){const r=(Date.now()-new Date(l.last_attempt_at).getTime())/6e4;if(l.attempts>=MAX_ATTEMPTS&&r<LOGIN_LOCKOUT_MINUTES){const g=Math.ceil((LOGIN_LOCKOUT_MINUTES-r)*60);return startLoginCountdown(g),!0}else r>=LOGIN_LOCKOUT_MINUTES&&await supabaseClient.from("login_attempts").delete().eq("ip_address",o)}return!1}document.addEventListener("DOMContentLoaded",async()=>{try{await ensureSupabaseClient()}catch(e){showLoginOutput("[ERR_503] Secure database handshake failed. Try again later.");return}const o=document.getElementById("flipCardInner"),l=document.getElementById("recoveryContainer"),r=document.getElementById("confirmExitModal"),g=document.querySelector(".auth-split-container");let p=null,h=0,d=[],C=null,M=null,O=null,q=0,x=null,B=!1;const S=document.getElementById("quickLoginModal"),J=document.getElementById("quickLoginLaunch"),G=document.getElementById("quickLoginClose"),W=document.getElementById("quickLoginBackdrop"),y=document.getElementById("quickLoginRefresh"),D=document.getElementById("quickLoginStatus"),_=document.getElementById("quickLoginRef"),A=document.getElementById("quickLoginTimer"),R=document.getElementById("quickLoginQrCanvas");setTimeout(()=>{g.classList.add("is-ready"),window.wolfAudio&&window.wolfAudio.play("notif")},100),typeCarousel();async function X(){const e=document.querySelector(".flip-card");g.classList.add("auth-verifying"),showLoginOutput(safeHTML("<i class='bx bx-loader-alt bx-spin'></i> LOGIN SUCCESSFUL. INITIATING SYSTEM..."),{color:"var(--wolf-blue)",html:!0,autoHide:!1}),window.wolfAudio&&window.wolfAudio.play("notif"),setTimeout(async()=>{window.WOLF_IS_ANIMATING_OUT=!0;const t=await getClientIP();await supabaseClient.from("login_attempts").delete().eq("ip_address",t),window.wolfAudio&&(wolfAudio.play("woosh"),wolfAudio.play("success")),g&&g.classList.add("outro"),e&&e.classList.add("outro"),showLoginOutput(safeHTML("<i class='bx bx-check-shield'></i> ACCESS GRANTED. BOOTING SYSTEM..."),{color:"#4ade80",html:!0,autoHide:!1}),window.triggerStarWarp&&window.triggerStarWarp(),setTimeout(()=>{window.wolfRouter&&typeof window.wolfRouter.goToMain=="function"?window.wolfRouter.goToMain("dashboard",{replace:!0,seamless:!0}):window.location.replace("/pages/main.html")},5e3)},1200)}function I(e,t="info"){D&&(D.textContent=e,D.classList.remove("is-error","is-success"),t==="error"&&D.classList.add("is-error"),t==="success"&&D.classList.add("is-success"))}function k(){C&&(clearInterval(C),C=null),M&&(clearInterval(M),M=null)}function oe(){try{const e=localStorage.getItem(QUICK_LOGIN_QR_CACHE_KEY);if(!e)return null;const t=JSON.parse(e);return!t||typeof t!="object"?null:t}catch(e){return null}}function Y(){try{localStorage.removeItem(QUICK_LOGIN_QR_CACHE_KEY)}catch(e){}}function re(){const e=oe();if(!e)return null;const t=e.expiresAt?new Date(e.expiresAt).getTime():0;return t>0&&t<=Date.now()?(Y(),null):e}function se(e){try{localStorage.setItem(QUICK_LOGIN_QR_CACHE_KEY,JSON.stringify(e))}catch(t){}}function N(e,t="bx bx-refresh"){y&&(y.innerHTML=`<i class="${t}"></i><span>${e}</span>`)}function $(e=!0){O&&(clearInterval(O),O=null),q=0,y&&(B||(y.disabled=!1),e&&N("Regenerate QR","bx bx-refresh"))}function ee(e){const t=Math.max(0,Number(e||0));if(t<=0){$(!0);return}O&&(clearInterval(O),O=null),q=Date.now()+t*1e3;const n=()=>{const i=Math.max(0,Math.ceil((q-Date.now())/1e3));if(y){if(i<=0){$(!0);return}y.disabled=!0,N(`Regenerate in ${i}s`,"bx bx-time-five")}};n(),O=setInterval(n,1e3)}function ae(e){const t=Date.now()+QUICK_LOGIN_EXPIRE_FALLBACK_SECONDS*1e3,n=e?new Date(e).getTime():t,i=()=>{const a=Math.max(0,Math.ceil((n-Date.now())/1e3));A&&(A.textContent=`${a}s`),a<=0&&(k(),I("QR session expired. Regenerate to continue.","error"))};i(),M=setInterval(i,1e3)}async function le(e){var m;if(!R)return;R.classList.remove("is-ready");const t=window.matchMedia("(max-width: 640px)").matches?300:340;if((m=window.QRCode)!=null&&m.toCanvas){await window.QRCode.toCanvas(R,e,{width:t,margin:1,errorCorrectionLevel:"L",color:{dark:"#0f1012",light:"#ffffff"}}),R.classList.add("is-ready");return}if(typeof window.qrcode!="function")throw new Error("QR renderer is not available. Reload and try again.");const n=window.qrcode(0,"M");n.addData(String(e||"")),n.make();const i=R.getContext("2d");if(!i)throw new Error("QR canvas context is unavailable");const a=t,s=6,c=n.getModuleCount(),u=a-s*2;R.width=a,R.height=a,i.imageSmoothingEnabled=!1,i.clearRect(0,0,a,a),i.fillStyle="#ffffff",i.fillRect(0,0,a,a),i.fillStyle="#0f1012";for(let f=0;f<c;f++)for(let w=0;w<c;w++){if(!n.isDark(f,w))continue;const v=s+Math.floor(w*u/c),U=s+Math.floor(f*u/c),Z=Math.ceil((w+1)*u/c)-Math.floor(w*u/c),H=Math.ceil((f+1)*u/c)-Math.floor(f*u/c);i.fillRect(v,U,Z,H)}R.classList.add("is-ready")}async function te(e=!1){if(!(!S||B)){B=!0;try{y&&(y.disabled=!0,N("Generating...","bx bx-loader-alt bx-spin")),I("Generating one-time QR session...","info"),k();const t=re(),n=(t==null?void 0:t.previewContext)||null,i=(t==null?void 0:t.previewSig)||null,a=await fetch("/.netlify/functions/quick-login-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({forceNew:!!e,cachedPreviewContext:n,cachedPreviewSig:i})});let s={};try{s=await a.json()}catch(f){s={}}if(!a.ok){if(a.status===429){const f=Number(s.remainingTime||0);f>0&&ee(f)}throw new Error(s.error||"Unable to create quick login request")}let c=s.qrValue,u=s.previewContext||null,m=s.previewSig||null;(!u||!m)&&t&&t.requestId===s.requestId&&t.qrValue&&(c=t.qrValue,u=t.previewContext||u,m=t.previewSig||m),x={...s,qrValue:c,previewContext:u,previewSig:m},_&&(_.textContent=String(s.requestId||"---").slice(0,8).toUpperCase()),await le(c),u&&m&&se({requestId:s.requestId,qrValue:c,expiresAt:s.expiresAt,previewContext:u,previewSig:m}),ae(s.expiresAt),I(s.reusedPending?"Resumed pending QR session on this device.":"Waiting for secure approval from trusted device..."),ee(Number(s.regenerateRemainingSeconds||s.regenerateCooldownSeconds||QUICK_LOGIN_REGEN_COOLDOWN_FALLBACK_SECONDS)),ce()}catch(t){const n=F(t,String((t==null?void 0:t.message)||t));I(n||"[ERR_500] SYSTEM_FAULT: Quick-login setup failed.","error"),_&&(_.textContent="---"),A&&(A.textContent="--s")}finally{if(B=!1,!y||q>Date.now())return;y.disabled=!1,N("Regenerate QR","bx bx-refresh")}}}async function ne(){var e;if(!(!x||B))try{const t=await fetch("/.netlify/functions/quick-login-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requestId:x.requestId,requestSecret:x.requestSecret,consume:!0})});let n={};try{n=await t.json()}catch(c){n={}}if(!t.ok){if(t.status===404||t.status===410){k(),I("Quick-login request expired. Regenerate QR.","error");return}throw new Error(n.error||"Failed to verify quick-login status")}if(n.status==="pending")return;if(n.status==="expired"||n.status==="rejected"||n.status==="consumed"){k(),Y(),I(n.status==="consumed"?"Quick-login code already used. Regenerate QR.":"Quick-login request was not approved.","error");return}if(n.status!=="approved")return;k(),Y(),I("Approval received. Synchronizing secure session...","success");const{data:i,error:a}=await supabaseClient.auth.setSession({access_token:n.accessToken,refresh_token:n.refreshToken});if(a)throw new Error(a.message||"Unable to restore quick-login session");const s=i==null?void 0:i.user;if(!s||((e=s.user_metadata)==null?void 0:e.role)!=="admin")throw await supabaseClient.auth.signOut(),new Error("Quick-login approved by a non-admin account");window.wolfAudio&&window.wolfAudio.play("success"),setTimeout(()=>{S&&(S.classList.remove("is-open"),S.setAttribute("aria-hidden","true")),X()},550)}catch(t){const n=F(t,String((t==null?void 0:t.message)||t));I(n||"[ERR_500] SYSTEM_FAULT: Quick-login polling failed.","error")}}function ce(){C&&clearInterval(C),C=setInterval(ne,QUICK_LOGIN_POLL_MS),ne()}function j(){S&&(S.classList.remove("is-open"),S.setAttribute("aria-hidden","true"),k(),$(!0),x=null,R&&R.classList.remove("is-ready"),_&&(_.textContent="---"),A&&(A.textContent="--s"),I("Initializing secure QR channel..."))}function ue(){S&&(S.classList.add("is-open"),S.setAttribute("aria-hidden","false"),te(!1))}function de(){!S||!J||(J.addEventListener("click",e=>{e.preventDefault(),ue()}),G==null||G.addEventListener("click",j),W==null||W.addEventListener("click",j),y==null||y.addEventListener("click",async()=>{await te(!0)}),document.addEventListener("keydown",e=>{e.key==="Escape"&&S.classList.contains("is-open")&&j()}))}function P(){p&&(clearInterval(p),p=null),d=[],T=!1;const e=document.getElementById("recoveryStep2");e&&e.remove(),l.classList.remove("step1-exit","step2-enter"),hideResetOutput({immediate:!0}),hideLoginOutput(!0);const t=document.getElementById("otpForm");t&&t.reset();const n=document.getElementById("forgotEmail");n&&(n.value="");const i=document.getElementById("sendOtpBtn"),a=document.getElementById("resendOtpBtn"),s=L();s>0?E(s):(i&&(i.disabled=!1,i.style.pointerEvents="auto",i.style.opacity="1",i.setAttribute("aria-disabled","false"),i.textContent="SEND SECURITY OTP"),a&&(a.style.pointerEvents="auto",a.style.opacity="1",a.textContent="RESEND SECURITY CODE"));const c=document.getElementById("resetBtn");c&&(c.disabled=!1,c.textContent="RESTORE SYSTEM ACCESS"),document.querySelectorAll(".otp-field").forEach(f=>{f.value=""});const m=document.getElementById("newPassword");m&&(m.value=""),r&&(r.style.display="none"),o.classList.remove("flipped")}async function fe(){const e=document.getElementById("loginBtn"),t=document.getElementById("loginAgreement"),n=document.getElementById("rememberDevice");if(!e.disabled){e.disabled=!0,e.textContent="AUTHORIZING...",hideLoginOutput(!0);try{if(t&&!t.checked){showLoginOutput("[ERR_003] AGREE_FAILED: Please agree to the data security policy to continue.",{color:"var(--wolf-red)"}),window.wolfAudio&&window.wolfAudio.play("denied"),e.disabled=!1,e.textContent="AUTHORIZE ACCESS";return}const i=await getClientIP();if(await checkLoginLockoutStatus())return;const s=document.getElementById("email").value,c=document.getElementById("password").value;setRememberDeviceEnabled(!!(n!=null&&n.checked));const{data:u,error:m}=await supabaseClient.auth.signInWithPassword({email:s,password:c});if(m){if(isConnectivityAuthError(m)){showLoginOutput("[ERR_503] LINK_OFFLINE: Security gateway is unreachable. Check internet connection.",{color:"var(--wolf-red)"}),window.wolfAudio&&window.wolfAudio.play("error"),e.disabled=!1,e.textContent="AUTHORIZE ACCESS";return}shakeField(document.getElementById("password")),wolfAudio.play("denied");const{data:f}=await supabaseClient.from("login_attempts").select("*").eq("ip_address",i).maybeSingle();let w=1;f&&(w=(Date.now()-new Date(f.last_attempt_at).getTime())/6e4<LOGIN_LOCKOUT_MINUTES?f.attempts+1:1),await supabaseClient.from("login_attempts").upsert({ip_address:i,attempts:w,last_attempt_at:new Date().toISOString()}),w>=MAX_ATTEMPTS?startLoginCountdown(LOGIN_LOCKOUT_MINUTES*60):(showLoginOutput(`[ERR_101] Access denied. ${MAX_ATTEMPTS-w} attempts left.`,{color:"var(--wolf-red)"}),document.getElementById("password").value="",e.disabled=!1,e.textContent="AUTHORIZE ACCESS")}else u.user.user_metadata.role==="admin"?await X():(wolfAudio.play("error"),showLoginOutput("[ERR_102] Unauthorized role."),await supabaseClient.auth.signOut(),e.disabled=!1,e.textContent="AUTHORIZE ACCESS")}catch(i){showLoginOutput("[ERR_500] System Fault."),window.wolfAudio&&window.wolfAudio.play("error"),window.Swal.fire({title:"[ERR_500] TERMINAL_FAULT",html:`<div style="color:var(--wolf-red); font-size:4rem; margin-bottom:15px;"><i class='bx bx-error-alt'></i></div>
               <p style="color:#888; font-size:14px;">CRITICAL_ERROR: ${i.message}</p>`,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-red",title:"wolf-swal-title",confirmButton:"btn-wolf-red"},confirmButtonText:"RE-INITIALIZE"}),e.disabled=!1}}}checkLoginLockoutStatus(),de();const K=document.getElementById("loginAgreement");K&&K.addEventListener("change",()=>{var e;K.checked&&(((e=document.getElementById("loginOutput"))==null?void 0:e.textContent)||"").includes("Please agree to the data security policy")&&hideLoginOutput(!0)});const Q=document.getElementById("rememberDevice");Q&&(Q.checked=isRememberDeviceEnabled(),Q.addEventListener("change",()=>{setRememberDeviceEnabled(!!Q.checked)}));function me(){try{const e=localStorage.getItem(OTP_COOLDOWN_STORAGE_KEY);if(!e)return 0;const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}catch(e){return 0}}function z(e){try{if(!Number.isFinite(e)||e<=Date.now()){localStorage.removeItem(OTP_COOLDOWN_STORAGE_KEY);return}localStorage.setItem(OTP_COOLDOWN_STORAGE_KEY,String(Math.ceil(e)))}catch(t){}}function L(){const e=Date.now(),t=me(),n=Math.max(h||0,t||0);return!n||n<=e?(h=0,z(0),0):(h=n,Math.max(0,Math.ceil((n-e)/1e3)))}function b(e){return`Wait for ${Math.max(0,Math.ceil(Number(e||0)))}s to resend code`}function ge(e){return/^\[ERR_[A-Z0-9_]+\]/i.test(String(e||"").trim())}function F(e,t=""){if(!e||typeof e!="object")return String(t||"").trim();const n=String(e.error||e.message||"").trim();if(ge(n))return n;const i=String(e.errorCode||"").trim(),a=String(e.errorLabel||"").trim();if(i&&a){const s=n||String(e.errorMeaning||"").trim()||t;return`[ERR_${i}] ${a}: ${String(s||"").trim()}`}return n||String(t||"").trim()}function E(e){p&&clearInterval(p);const t=Math.max(0,Number(e||0));h=t>0?Date.now()+t*1e3:0,z(h);const n=a=>{const s=document.getElementById("sendOtpBtn"),c=document.getElementById("resendOtpBtn"),u=a>0?b(a):null;s&&(s.disabled=a>0,s.style.pointerEvents=a>0?"none":"auto",s.style.opacity=a>0?"0.65":"1",s.setAttribute("aria-disabled",a>0?"true":"false"),s.textContent=u||"SEND SECURITY OTP"),c&&(c.style.pointerEvents=a>0?"none":"auto",c.style.opacity=a>0?"0.5":"1",c.textContent=u||"RESEND SECURITY CODE"),a<=0&&(h=0,z(0))};let i=t;n(i),p=setInterval(()=>{i--,n(i),i<=0&&clearInterval(p)},1e3)}async function V(){try{const e=await fetch("/.netlify/functions/check-otp-cooldown",{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)return L();const t=await e.json();return(t==null?void 0:t.canSend)===!1?Number(t.remainingTime||0):0}catch(e){return L()}}async function we(e=0){try{const n=await(await fetch("pages/verifyotp.html")).text(),i=DOMPurify.sanitize(n,{ALLOWED_TAGS:["div","p","form","input","button","a","span","i"],ALLOWED_ATTR:["id","class","type","placeholder","required","maxlength","inputmode","pattern","title","href","style"]}),c=new DOMParser().parseFromString(i,"text/html").getElementById("recoveryStep2");c&&(l.appendChild(c),l.classList.add("step1-exit"),setTimeout(async()=>{l.classList.add("step2-enter"),ye(),pe();const u=L();let m=0;u<=0&&(m=await V());const f=Math.max(Number(e||0),u,m);f>0&&E(f)},50))}catch(t){showResetOutput("[ERR_500] Failed to load verification module.")}}let T=!1;async function ie(){var s;const e=L();if(e>0){E(e),showResetOutput(`[ERR_429] ${b(e)}.`,{color:"var(--wolf-red)",autoHide:!1});return}const t=Date.now();if(d=d.filter(c=>t-c<=OTP_CLICK_SPAM_WINDOW_MS),d.push(t),d.length>=OTP_CLICK_SPAM_THRESHOLD){d=[],E(OTP_CLICK_SPAM_LOCK_SECONDS),showResetOutput(`[ERR_429] ${b(OTP_CLICK_SPAM_LOCK_SECONDS)}.`,{color:"var(--wolf-red)",autoHide:!1}),T=!1;return}if(T)return;const n=document.getElementById("sendOtpBtn"),i=document.getElementById("resendOtpBtn");T=!0,showResetOutput("Establishing connection to server...",{color:"#888",autoHide:!1}),n&&(n.disabled=!0,n.textContent="TRANSMITTING..."),i&&(i.style.pointerEvents="none",i.style.opacity="0.5",i.textContent="RESENDING OTP CODES TO EMAIL...");const a=((s=document.getElementById("forgotEmail"))==null?void 0:s.value)||"";try{const c=L();if(c>0){E(c),showResetOutput(`[ERR_429] ${b(c)}.`,{color:"var(--wolf-red)",autoHide:!1}),T=!1;return}const u=await V();if(u>0){E(u),showResetOutput(`[ERR_429] ${b(u)}.`,{color:"var(--wolf-red)",autoHide:!1}),T=!1;return}showResetOutput("Checking existing email...",{color:"#888",autoHide:!1});const m=await fetch("/.netlify/functions/request-otp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a})});if(m.ok){let f={};try{f=await m.json()}catch(U){f={}}const w=Number((f==null?void 0:f.remainingTime)||0),v=Number.isFinite(w)&&w>0?w:60;E(v),wolfAudio.play("notif"),showResetOutput("Your OTP key has been sent to your email.",{color:"#4ade80",autoHide:!1}),document.getElementById("recoveryStep2")||await we(v)}else{let f=null,w="",v=0;try{f=await m.json(),w=F(f,"Server error while requesting OTP."),v=Number((f==null?void 0:f.remainingTime)||0)}catch(U){}if(wolfAudio.play("error"),m.status===404)v>0&&E(v),showResetOutput(w||"[ERR_404] RESOURCE_MISSING: Email unauthorized.");else if(m.status===429){const Z=String(w||"").includes("OTP cooldown active")?30:60,H=v>0?v:Z;E(H),showResetOutput(`[ERR_429] ${b(H)}.`,{color:"var(--wolf-red)",autoHide:!1})}else m.status===400?showResetOutput(w||"[ERR_400] REQUEST_INVALID: Invalid request."):showResetOutput(w||"[ERR_500] SYSTEM_FAULT: Server error while requesting OTP.");T=!1,m.status!==429&&v<=0&&(n&&(n.disabled=!1,n.textContent="SEND SECURITY OTP"),i&&(i.style.pointerEvents="auto",i.style.opacity="1",i.textContent="RESEND SECURITY CODE"))}}catch(c){const u=L();u>0?(E(u),showResetOutput(`[ERR_429] ${b(u)}.`,{color:"var(--wolf-red)",autoHide:!1})):showResetOutput("[ERR_503] Gateway timeout. Terminal offline."),T=!1,u<=0&&(n&&(n.disabled=!1,n.style.pointerEvents="auto",n.style.opacity="1",n.setAttribute("aria-disabled","false"),n.textContent="SEND SECURITY OTP"),i&&(i.style.pointerEvents="auto",i.style.opacity="1",i.textContent="RESEND SECURITY CODE"))}finally{setTimeout(()=>{T=!1},1e3)}}function pe(){const e=document.getElementById("verifyResetForm"),t=document.getElementById("recoveryStep2");if(!e||!t)return;const n=t.querySelector("#resetOutput");e.onsubmit=async i=>{i.preventDefault();const a=e.querySelector('button[type="submit"]');a.disabled=!0,a.textContent="RECONFIGURING...",showResetOutput("Verifying OTP Code Credential...",{color:"#888",autoHide:!1,targetEl:n});const s=document.getElementById("forgotEmail").value,c=document.getElementById("newPassword").value,u=Array.from(document.querySelectorAll(".otp-field")).map(m=>m.value).join("");try{const m=await fetch("/.netlify/functions/verify-otp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,otp:u,newPassword:c})});if(m.ok)wolfAudio.play("success"),showResetOutput("Protocol success. Password updated.",{color:"#4ade80",autoHide:!1,targetEl:n}),window.wolfAudio&&window.wolfAudio.play("success"),window.Swal.fire({title:"SUCCESS",html:`<div style="color:#08ea1b; font-size:4rem; margin-bottom:15px;"><i class='bx bx-check-shield'></i></div>
               <p style="color:#888; font-size:14px;">Credentials re-mapped successfully. Terminal access granted.</p>`,background:"#111",timer:3e3,timerProgressBar:!0,showConfirmButton:!1,customClass:{popup:"wolf-swal-popup wolf-border-green",title:"wolf-swal-title"},didClose:()=>{P()}});else{let f=null;try{f=await m.json()}catch(v){f=null}wolfAudio.play("denied");const w=F(f,"Security key invalid or expired.");showResetOutput(w||"[ERR_602] KEY_EXPIRED: Security key invalid or expired.",{targetEl:n}),a.disabled=!1,a.textContent="RESTORE SYSTEM ACCESS"}}catch(m){wolfAudio.play("error"),a.disabled=!1,showResetOutput("[ERR_500] Database synchronization fault.",{targetEl:n})}}}(async()=>{const e=L();e>0&&E(e);const t=await V(),n=Math.max(e,Number(t||0));n>0&&E(n)})(),document.getElementById("loginForm").onsubmit=e=>{e.preventDefault(),fe()},document.getElementById("otpForm").onsubmit=e=>{e.preventDefault();const t=L();if(t>0){E(t),showResetOutput(`[ERR_429] ${b(t)}.`,{color:"var(--wolf-red)",autoHide:!1});return}ie("sendOtpBtn")},document.getElementById("forgotLink").onclick=e=>{e.preventDefault(),o.classList.add("flipped")},document.addEventListener("click",e=>{e.target.id==="forgotLink"&&(e.preventDefault(),document.getElementById("flipCardInner").classList.add("flipped")),(e.target.id==="resendOtpBtn"||e.target.closest("#resendOtpBtn"))&&(e.preventDefault(),console.log("Wolf OS: Resend requested..."),ie()),(e.target.id==="backToLoginTrigger"||e.target.id==="backToLoginTriggerSecondary")&&(e.preventDefault(),document.getElementById("recoveryStep2")?(window.wolfAudio&&window.wolfAudio.play("notif"),window.Swal.fire({title:"ABANDON RECOVERY?",html:`<div style="color:#b47023; font-size:4rem; margin-bottom:15px;"><i class='bx bx-shield-quarter'></i></div>
               <p style="color:#888; font-size:14px;">Terminating handshake will void the current security key. Proceed?</p>`,showCancelButton:!0,confirmButtonText:"YES, EXIT",cancelButtonText:"STAY",reverseButtons:!0,background:"#111",buttonsStyling:!1,customClass:{popup:"wolf-swal-popup wolf-border-orange",title:"wolf-swal-title",confirmButton:"btn-wolf-orange",cancelButton:"btn-wolf-secondary"}}).then(t=>{t.isConfirmed&&P()})):o.classList.remove("flipped"))}),document.getElementById("confirmExitBtn").onclick=()=>{r.style.display="none",P()},document.getElementById("cancelExitBtn").onclick=()=>r.style.display="none",document.getElementById("closeModalBtn").onclick=()=>P(),document.getElementById("descContainer").onclick=function(){this.classList.toggle("expanded")};function ye(){const e=document.querySelectorAll(".otp-field");e.forEach((t,n)=>{t.oninput=i=>{t.value=t.value.replace(/[^0-9]/g,""),t.value&&n<5&&e[n+1].focus()},t.onkeydown=i=>{i.key==="Backspace"&&!t.value&&n>0&&e[n-1].focus()},t.onpaste=i=>{i.preventDefault();const s=(i.clipboardData||window.clipboardData).getData("text").replace(/[^0-9]/g,"");for(let u=0;u<s.length&&n+u<e.length;u++)e[n+u].value=s[u];const c=Math.min(n+s.length,5);e[c].focus()}})}});
