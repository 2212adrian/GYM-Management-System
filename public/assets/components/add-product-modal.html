<div id="product-modal-overlay" class="master-modal-overlay">
  <div class="master-terminal-container optional-expanded">
    <div class="terminal-header">
      <div class="terminal-title-group">
        <h1 class="terminal-title">ADD <span>PRODUCT</span></h1>
        <p class="terminal-protocol">
          MANUAL PRODUCT ENTRY - ADDS TO SALES INVENTORY
        </p>
      </div>
      <button class="terminal-close-btn" id="closeProductModal" type="button">
        <i class="bx bx-x"></i>
      </button>
    </div>

    <div class="master-terminal-body">
      <form id="master-product-form" class="terminal-form">
        <div class="terminal-main-grid">
          <!-- LEFT: FORM DETAILS -->
          <div class="terminal-left">
            <!-- Name -->
            <div class="terminal-section">
              <label class="field-label">Product Name</label>
              <input
                type="text"
                id="master-name"
                class="terminal-input"
                placeholder="E.G.: MILK 500G"
                autocomplete="off"
                required
              />
            </div>

            <!-- Price + Qty -->
            <div class="terminal-grid">
              <div class="terminal-section">
                <label class="field-label">Price (₱)</label>
                <input
                  type="number"
                  id="master-price"
                  class="terminal-input"
                  placeholder="0.00"
                  step="0.01"
                  required
                />
              </div>
              <div class="terminal-section">
                <label class="field-label">Stock / Qty</label>
                <div class="stock-action-row">
                  <input
                    type="number"
                    id="master-qty"
                    class="terminal-input"
                    placeholder="0"
                    required
                  />
                  <label
                    class="cyber-checkbox-symbol"
                    title="Toggle Unlimited Stock"
                  >
                    <input type="checkbox" id="master-unlimited" />
                    <span class="symbol-box">
                      <i class="bx bx-infinite"></i>
                    </span>
                  </label>
                </div>
              </div>
            </div>

            <!-- OPTIONAL DETAILS -->
            <div class="optional-protocol-box is-expanded">
              <div class="optional-toggle-bar">
                <span class="optional-tag">OPTIONAL DETAILS</span>
                <i class="bx bx-chevron-down optional-toggle-icon"></i>
              </div>
              <div class="optional-body">
                <div class="terminal-section">
                  <label class="field-label">Brand Name</label>
                  <input
                    type="text"
                    id="master-brand"
                    class="terminal-input"
                    placeholder="E.G.: NESTLÉ"
                  />
                </div>

                <div class="terminal-section no-margin">
                  <label class="field-label">Product Description</label>
                  <textarea
                    id="master-desc"
                    class="terminal-input static-area"
                    placeholder="E.G.: 500G CARTON BOX OF MILK..."
                    rows="3"
                  ></textarea>
                </div>
              </div>
            </div>

            <button type="submit" class="btn-terminal-commit">
              ADD TO PRODUCT
            </button>
          </div>

          <!-- RIGHT: IMAGE + BARCODE -->
          <div class="terminal-right">
            <div class="image-panel">
              <!-- Lookup -->
              <div class="terminal-section">
                <label class="field-label">Lookup Product</label>
                <div class="id-wrapper-group">
                  <span class="id-prefix">ID:</span>
                  <input
                    type="text"
                    id="lookup-input"
                    placeholder="TYPE NAME OR BARCODE"
                    maxlength="50"
                    autocomplete="off"
                  />
                  <button
                    type="button"
                    id="lookupBtn"
                    class="terminal-icon-btn"
                    title="Lookup by name or barcode"
                  >
                    <i class="bx bx-search"></i>
                  </button>
                </div>
              </div>

              <div class="image-panel-header">
                <span class="image-panel-title">IMAGE PICKER</span>
                <span class="image-panel-badge">WEB / BARCODE</span>
              </div>
              <p class="image-panel-subtitle">
                Choose one image to attach as the product thumbnail.
              </p>

              <!-- 2x2 grid for images -->
              <div class="image-box" id="imageContainer"></div>
              <div class="status" id="status"></div>

              <!-- Barcode -->
              <div class="terminal-section">
                <label class="field-label">Barcode ID</label>
                <div class="id-wrapper-group">
                  <span class="id-prefix">PR -</span>
                  <input
                    type="text"
                    id="master-asset-id"
                    placeholder="0000"
                    maxlength="4"
                    autocomplete="off"
                    readonly
                  />
                  <button
                    type="button"
                    id="roll-barcode-btn"
                    class="terminal-icon-btn"
                    title="Randomize ID"
                  >
                    <i class="bx bx-dice-4"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- /RIGHT -->
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const PIXABAY_KEY = '54360015-81e98130630ae3ed1faf5a9b9';

  const lookupInput = document.getElementById('lookup-input');
  const lookupBtn = document.getElementById('lookupBtn');
  const closeProductModalBtn = document.getElementById('closeProductModal');
  const productOverlay = document.getElementById('product-modal-overlay');

  // Close logic to match your other modals
  if (closeProductModalBtn && productOverlay) {
    closeProductModalBtn.addEventListener('click', () => {
      productOverlay.style.display = 'none';
      productOverlay.classList.remove('is-open');
    });

    productOverlay.addEventListener('click', (e) => {
      if (e.target === productOverlay) {
        productOverlay.style.display = 'none';
        productOverlay.classList.remove('is-open');
      }
    });
  }

  // Lookup wiring
  lookupBtn.addEventListener('click', handleLookup);
  lookupInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleLookup();
    }
  });

  function handleLookup() {
    const value = lookupInput.value.trim();
    if (!value) return;

    const firstChar = value.charAt(0);

    if (/\d/.test(firstChar)) {
      document.getElementById('master-asset-id').value = value;
      searchBarcode(value);
    } else {
      document.getElementById('master-name').value = value;
      fetchPixabayImages(value);
    }
  }

  async function searchBarcode(barcode) {
    const statusEl = document.getElementById('status');
    const container = document.getElementById('imageContainer');
    const productNameEl = document.getElementById('master-name');
    const productBrandEl = document.getElementById('master-brand');

    container.innerHTML = '';
    statusEl.textContent = 'Fetching product info from barcode...';

    try {
      const res = await fetch(
        `https://world.openfoodfacts.org/api/v0/product/${barcode}.json`,
      );
      const data = await res.json();

      if (data.status === 1) {
        const product = data.product;
        productNameEl.value = product.product_name || '';
        productBrandEl.value = product.brands || '';
        statusEl.textContent = 'Product info found!';

        if (product.image_url) {
          const img = document.createElement('img');
          img.src = product.image_url;
          img.alt = product.product_name || 'Product Image';
          img.addEventListener('click', () => selectImage(img));
          container.appendChild(img);
        } else {
          statusEl.textContent += ' (No image available)';
        }
      } else {
        statusEl.textContent = 'Product not found with this barcode.';
      }
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Error fetching barcode data.';
    }
  }

  async function fetchPixabayImages(query) {
    const statusEl = document.getElementById('status');
    const container = document.getElementById('imageContainer');

    statusEl.textContent = 'Searching images on Pixabay...';
    container.innerHTML = '';

    try {
      const res = await fetch(
        `https://pixabay.com/api/?key=${PIXABAY_KEY}&q=${encodeURIComponent(
          query,
        )}&image_type=photo&per_page=4`,
      );

      if (!res.ok) {
        if (res.status === 429) {
          statusEl.textContent = 'Pixabay API limit reached. Try again later.';
        } else {
          statusEl.textContent = 'Error fetching images from Pixabay.';
        }
        return;
      }

      const data = await res.json();

      if (data.hits && data.hits.length > 0) {
        data.hits.forEach((photo) => {
          const img = document.createElement('img');
          img.src = photo.webformatURL;
          img.alt = query;
          img.addEventListener('click', () => selectImage(img));
          container.appendChild(img);
        });

        statusEl.textContent = 'Images found!';
      } else {
        statusEl.textContent = 'No images found for this query.';
      }
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Error fetching images. Try again later.';
    }
  }

  function selectImage(imgEl) {
    const container = document.getElementById('imageContainer');
    container.querySelectorAll('img').forEach((img) => {
      img.classList.remove('selected');
    });
    imgEl.classList.add('selected');
  }

  const optionalBox = document.querySelector('.optional-protocol-box');
  const optionalToggle = document.getElementById('optionalToggle');
  const modalContainer = document.querySelector('.master-terminal-container');

  if (optionalBox && optionalToggle && modalContainer) {
    optionalToggle.addEventListener('click', () => {
      const isExpanded = optionalBox.classList.contains('is-expanded');
      optionalBox.classList.toggle('is-expanded', !isExpanded);
      optionalBox.classList.toggle('is-collapsed', isExpanded);

      modalContainer.classList.toggle('optional-expanded', !isExpanded);
      modalContainer.classList.toggle('optional-collapsed', isExpanded);
    });
  }
</script>
