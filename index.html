<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GYM Management System</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="flip-card">
    <div class="flip-card-inner" id="flipCardInner">

      <!-- Front: Login -->
      <div class="flip-card-front">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email"><br><br>
        <input type="password" id="password" placeholder="Password"><br><br>
        <button id="loginBtn">Login</button>
        <button id="session">Get Session</button>
        <button id="logout">Logout</button>
        <p><a href="#" id="forgotLink">Forgot Password?</a></p>
        <div id="loginOutput"></div>
      </div>

      <!-- Back: Forgot Password -->
      <div class="flip-card-back">
        <h2>Forgot Password</h2>
        <input type="email" id="forgotEmail" placeholder="Enter your email"><br><br>
        <button id="sendOtpBtn">Send OTP</button>
        <p><a href="#" id="backToLogin">Back to Login</a></p>
        <div id="resetOutput"></div>
      </div>

    </div>
  </div>

  <pre id="output"></pre>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // Flip card functions
    const flipCardInner = document.getElementById('flipCardInner');
    document.getElementById('forgotLink').addEventListener('click', () => {
      flipCardInner.style.transform = 'rotateY(180deg)';
    });
    document.getElementById('backToLogin').addEventListener('click', () => {
      flipCardInner.style.transform = 'rotateY(0deg)';
    });

    // Initialize Supabase client
    const supabaseUrl = 'https://xhahdzyjhwutgqfcrzfc.supabase.co';
    const supabaseKey = 'sb_publishable_mQ_GJf4mu4nC0uGpR7QkVQ_PXKlR6HT';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, {
      auth: { persistSession: true }
    });

    const output = document.getElementById('output');

    // ---------------- OTP Request Logic ----------------
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    sendOtpBtn.addEventListener('click', async () => {
      const email = document.getElementById('forgotEmail').value;
      const resetOutput = document.getElementById('resetOutput');

      if (!email) {
        resetOutput.textContent = "Enter your email!";
        return;
      }

      try {
        // âœ… Call backend API route
        const res = await fetch('/api/request-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const data = await res.json();

        if (res.ok) {
          resetOutput.textContent = data.message;
          // Redirect to verify page after 2s with email as query param
          setTimeout(() => {
            window.location.href = `verifyotp.html?email=${encodeURIComponent(email)}`;
          }, 2000);
        } else {
          resetOutput.textContent = data.error;
        }
      } catch (err) {
        resetOutput.textContent = "Unexpected error: " + err.message;
      }
    });

    // ---------------- Login Logic ----------------
    const loginButton = document.getElementById('loginBtn');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    loginButton.addEventListener('click', async () => {
      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email: emailInput.value,
        password: passwordInput.value,
      });
      if (error) {
        output.textContent = "Email or Password is incorrect! Please try again.";
      } else {
        output.textContent = "Login Successful! User ID: " + data.user.id;
      }
    });

    // ---------------- Session Logic ----------------
    const sessionButton = document.getElementById('session');
    sessionButton.addEventListener('click', async () => {
      const { data: { session } } = await supabaseClient.auth.getSession();
      output.textContent = "Check your console for privacy";
      console.log(JSON.stringify(session, null, 2));
    });

    // ---------------- Logout Logic ----------------
    const logoutButton = document.getElementById('logout');
    logoutButton.addEventListener('click', async () => {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        output.textContent = "No active session to log out.";
        return;
      }
      const { error } = await supabaseClient.auth.signOut();
      if (error) {
        output.textContent = "Error during logout: " + error.message;
      } else {
        output.textContent = "Logout Successful! Redirecting...";
        setTimeout(() => {
          window.location.href = "/index.html";
        }, 1000);
      }
    });
  </script>
</body>
</html>