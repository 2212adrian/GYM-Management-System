-- Ensure required extension for gen_random_uuid()
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- Enum types referenced
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'payment_status') THEN
    CREATE TYPE payment_status AS ENUM ('pending','completed','failed','refunded');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'membership_status') THEN
    CREATE TYPE membership_status AS ENUM ('active','expired','cancelled','pending');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'incident_status') THEN
    CREATE TYPE incident_status AS ENUM ('open','in_progress','resolved','closed');
  END IF;
END$$;

-- profiles (minimal)
CREATE TABLE IF NOT EXISTS public.profiles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  auth_user_id uuid UNIQUE,
  email text UNIQUE,
  full_name text,
  phone text,
  date_of_birth date,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- facilities placeholder (referenced by sales previously)
CREATE TABLE IF NOT EXISTS public.facilities (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- products
CREATE TABLE IF NOT EXISTS public.products (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  sku text UNIQUE,
  name text,
  description text,
  price numeric NOT NULL DEFAULT 0,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- membership_plans
CREATE TABLE IF NOT EXISTS public.membership_plans (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text,
  description text,
  billing_period_interval integer NOT NULL DEFAULT 1,
  billing_period_unit text NOT NULL DEFAULT 'month',
  price numeric NOT NULL DEFAULT 0,
  allow_pauses boolean NOT NULL DEFAULT false,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- memberships
CREATE TABLE IF NOT EXISTS public.memberships (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  profile_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,
  plan_id uuid REFERENCES public.membership_plans(id) ON DELETE CASCADE,
  facility_id uuid,
  started_at timestamptz NOT NULL DEFAULT now(),
  expires_at timestamptz,
  status membership_status NOT NULL DEFAULT 'pending',
  auto_renew boolean NOT NULL DEFAULT true,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- audit_log
CREATE TABLE IF NOT EXISTS public.audit_log (
  id bigserial PRIMARY KEY,
  table_name text,
  operation text,
  record_id text,
  changed_by uuid,
  changed_at timestamptz NOT NULL DEFAULT now(),
  change_payload jsonb
);

-- notifications
CREATE TABLE IF NOT EXISTS public.notifications (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  profile_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,
  title text,
  body text,
  is_read boolean NOT NULL DEFAULT false,
  delivered_at timestamptz,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- equipment
CREATE TABLE IF NOT EXISTS public.equipment (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text,
  model text,
  serial_number text UNIQUE,
  purchase_date date,
  warranty_expiry date,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- equipment_incidents
CREATE TABLE IF NOT EXISTS public.equipment_incidents (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  equipment_id uuid REFERENCES public.equipment(id) ON DELETE CASCADE,
  reported_by uuid REFERENCES public.profiles(id) ON DELETE SET NULL,
  description text,
  status incident_status NOT NULL DEFAULT 'open',
  priority integer NOT NULL DEFAULT 3,
  reported_at timestamptz NOT NULL DEFAULT now(),
  resolved_at timestamptz,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- check_in_logs (updated: facility_id dropped; profile_id nullable)
CREATE TABLE IF NOT EXISTS public.check_in_logs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  profile_id uuid REFERENCES public.profiles(id) ON DELETE SET NULL, -- nullable allowed for non-members
  time_in timestamptz NOT NULL DEFAULT now(),
  time_out timestamptz,
  source text,
  notes text,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- sales (your provided simplified sales table)
CREATE TABLE IF NOT EXISTS public.sales (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  sale_reference text UNIQUE,
  profile_id uuid REFERENCES public.profiles(id) ON DELETE SET NULL,
  facility_id uuid REFERENCES public.facilities(id) ON DELETE SET NULL,
  product_id uuid REFERENCES public.products(id) ON DELETE SET NULL,
  qty integer NOT NULL DEFAULT 1,
  unit_price numeric(10,2) NOT NULL DEFAULT 0,
  total_amount numeric(12,2) GENERATED ALWAYS AS (qty * unit_price) STORED,
  currency text NOT NULL DEFAULT 'USD',
  payment_provider text,
  payment_provider_id text,
  payment_status payment_status NOT NULL DEFAULT 'pending',
  processed_at timestamptz,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_sales_profile ON public.sales(profile_id);
CREATE INDEX IF NOT EXISTS idx_sales_facility_time ON public.sales(facility_id, created_at);
CREATE INDEX IF NOT EXISTS idx_sales_product ON public.sales(product_id);

-- Trigger to update updated_at on sales
CREATE OR REPLACE FUNCTION public.sales_set_timestamp()
RETURNS TRIGGER LANGUAGE plpgsql AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$;
DROP TRIGGER IF EXISTS sales_set_timestamp_tr ON public.sales;
CREATE TRIGGER sales_set_timestamp_tr
BEFORE UPDATE ON public.sales
FOR EACH ROW EXECUTE FUNCTION public.sales_set_timestamp();

-- Ensure total_amount constraint
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint c
    JOIN pg_class t ON c.conrelid = t.oid
    WHERE c.conname = 'chk_sales_total_positive' AND t.relname = 'sales'
  ) THEN
    ALTER TABLE public.sales
      ADD CONSTRAINT chk_sales_total_positive CHECK (total_amount >= 0);
  END IF;
END$$;

-- pos_transactions
CREATE TABLE IF NOT EXISTS public.pos_transactions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  transaction_reference text UNIQUE,
  profile_id uuid REFERENCES public.profiles(id) ON DELETE SET NULL,
  total_amount numeric NOT NULL DEFAULT 0 CHECK (total_amount >= 0),
  currency text NOT NULL DEFAULT 'USD',
  status payment_status NOT NULL DEFAULT 'pending',
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

-- pos_line_items
CREATE TABLE IF NOT EXISTS public.pos_line_items (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  transaction_id uuid REFERENCES public.pos_transactions(id) ON DELETE CASCADE,
  product_id uuid REFERENCES public.products(id) ON DELETE SET NULL,
  qty integer NOT NULL DEFAULT 1,
  unit_price numeric NOT NULL DEFAULT 0,
  line_total numeric GENERATED ALWAYS AS (qty * unit_price) STORED,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- payments
CREATE TABLE IF NOT EXISTS public.payments (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  transaction_id uuid REFERENCES public.pos_transactions(id) ON DELETE SET NULL,
  provider text,
  provider_payment_id text,
  amount numeric NOT NULL DEFAULT 0 CHECK (amount >= 0),
  currency text NOT NULL DEFAULT 'USD',
  status payment_status NOT NULL DEFAULT 'pending',
  processed_at timestamptz,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- indexes used in original schema
CREATE INDEX IF NOT EXISTS idx_memberships_profile_id ON public.memberships(profile_id);
CREATE INDEX IF NOT EXISTS idx_notifications_profile_id ON public.notifications(profile_id);
CREATE INDEX IF NOT EXISTS idx_pos_transactions_profile_id ON public.pos_transactions(profile_id);
CREATE INDEX IF NOT EXISTS idx_pos_line_items_transaction_id ON public.pos_line_items(transaction_id);
CREATE INDEX IF NOT EXISTS idx_payments_transaction_id ON public.payments(transaction_id);

-- Trigger helpers to update updated_at for other tables (optional)
CREATE OR REPLACE FUNCTION public.set_updated_at()
RETURNS TRIGGER LANGUAGE plpgsql AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$;

-- Attach generic updated_at trigger where applicable
ALTER TABLE IF EXISTS public.profiles DROP CONSTRAINT IF EXISTS profiles_updated_at_tr;
DROP TRIGGER IF EXISTS profiles_set_timestamp_tr ON public.profiles;
CREATE TRIGGER profiles_set_timestamp_tr
BEFORE UPDATE ON public.profiles
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

ALTER TABLE IF EXISTS public.products DROP CONSTRAINT IF EXISTS products_updated_at_tr;
DROP TRIGGER IF EXISTS products_set_timestamp_tr ON public.products;
CREATE TRIGGER products_set_timestamp_tr
BEFORE UPDATE ON public.products
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

ALTER TABLE IF EXISTS public.memberships DROP CONSTRAINT IF EXISTS memberships_updated_at_tr;
DROP TRIGGER IF EXISTS memberships_set_timestamp_tr ON public.memberships;
CREATE TRIGGER memberships_set_timestamp_tr
BEFORE UPDATE ON public.memberships
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

ALTER TABLE IF EXISTS public.equipment DROP CONSTRAINT IF EXISTS equipment_updated_at_tr;
DROP TRIGGER IF EXISTS equipment_set_timestamp_tr ON public.equipment;
CREATE TRIGGER equipment_set_timestamp_tr
BEFORE UPDATE ON public.equipment
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

ALTER TABLE IF EXISTS public.equipment_incidents DROP CONSTRAINT IF EXISTS equipment_incidents_updated_at_tr;
DROP TRIGGER IF EXISTS equipment_incidents_set_timestamp_tr ON public.equipment_incidents;
CREATE TRIGGER equipment_incidents_set_timestamp_tr
BEFORE UPDATE ON public.equipment_incidents
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- End of schema recreation script